---
title: "MSHS Lab Turnaround Time Performance Trends"
output:
  flexdashboard::flex_dashboard:
    # orientation: rows
    vertical_layout: scroll
---

<style>                     
.navbar {
  background-color:#221F72;
  border-color:white;
  color:white;
}

.navbar .navbar-nav > .active > a,
.navbar .navbar-nav > .active > a:hover,
.navbar .navbar-nav > .active > a:focus {
  color: white;
  background-color: #ACACAD;
}

.navbar .navbar-nav > li > a:hover,
.navbar .navbar-nav > li > a:focus {
  color: white;
  background-color: #ACACAD;
}

.navbar .dropdown-menu > .active > a,
.navbar .dropdown-menu > .active > a:hover,
.navbar .dropdown-menu > .active > a:focus {
  color: white;
  background-color: #ACACAD;
}

.navbar .dropdown-menu > li > a:hover,
.navbar .dropdown-menu > li > a:focus {
  color: white;
  background-color: #ACACAD;
}

.navbar .nav li.dropdown.open > .dropdown-toggle,
.navbar .nav li.dropdown.active > .dropdown-toggle,
.navbar .nav li.dropdown.open.active > .dropdown-toggle {
  color: white;
  background-color: #ACACAD;
}

.nav-tabs-custom > .nav-tabs > li.active {
  border-top-color: #221F72;
}

</style>

<h3><em><b>Lab Receipt to Result Turnaround Time Compliance </h3></em></b>
<h4><em><span style = "color:red">Draft - Not For Distribution</h4></em></span style = "color:red">

```{r global_options, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r package_ref file, warning = FALSE, message = FALSE, echo = FALSE}
#######
# Source code for importing the needed packages, constants, reference files, etc.-----
#######
source(here::here("TrendedData/Packages_Reference_Info.R"))
```

```{r Summarize troponin data, warning = FALSE, message = FALSE, echo = FALSE}
# Code for summarizing and visualizing data
filtered_df <- monthly_repo %>%
  filter(Year >= 2021,
         !(Site %in% "MSSN" & Year == 2021 & MonthNo == 1),
         Division %in% c("Chemistry", "Hematology"),
         !(MasterSetting %in% c("Amb", "Other"))) %>%
  rename(CareSetting = MasterSetting,
         TestPriority = DashboardPriority)


test_targets <- filtered_df %>%
  select(Test,
         CareSetting, TestPriority,
         ReceiveResultTarget) %>%
  distinct() %>%
  arrange(Test, TestPriority, CareSetting)

test_summary <- filtered_df %>%
  group_by(Test, CareSetting, TestPriority, Site, MonthRollUp) %>%
  summarize(ReceiveResultVolume = sum(ReceiveTime_VolIncl, na.rm = TRUE),
            ReceiveResultInTarget = sum(TotalReceiveResultInTarget, na.rm = TRUE),
            ReceiveResultPercent = ReceiveResultInTarget / ReceiveResultVolume) %>%
  ungroup() %>%
  rename(Month = MonthRollUp)
```

<!-- # Custom functions for creating graphs -->
```{r Custom functions for creating graphs}
graphing_function <- function(test, priority, setting) {
  
  data <- test_summary %>%
    filter(Test == test,
           TestPriority == priority,
           CareSetting == setting,
           ReceiveResultVolume > 0)
  
  turnaround_target <- test_targets %>%
                          filter(Test == test,
                                 TestPriority == priority,
                                 CareSetting == setting) %>%
                          distinct(ReceiveResultTarget) %>%
                          pull()
  
  month_vector <- format(seq.Date(from = min(data$Month),
                               to = max(data$Month),
                               by = "2 months"),
                      "%m/%y")
  
  empty_vector <- rep(" ", length(month_vector))
  
  tick_text <- c(rbind(month_vector, empty_vector))
  
  if(month_vector[length(month_vector)] == format(max(data$Month), "%m/%y")){
    tick_text <- tick_text[1:(length(tick_text) - 1)]
  } else {
    tick_text <- tick_text
  }

  receive_result_trend <- ggplot(data = data,
                                 mapping = aes(x = Month,
                                               y = ReceiveResultPercent)) +
    geom_line(aes(color = Site)) +
    geom_point(aes(color = Site), size = 0.5) +
    scale_x_date(limits = c(min(data$Month),
                          max(data$Month)),
                 date_breaks = "1 months",
                 # date_minor_breaks = "1 month",
                 # minor_breaks = waiver(),
                 date_labels = "%m/%y",
                 expand = c(0, 0, 0, 0)
                 ) +
    scale_y_continuous(limits = c(.9*min(data$ReceiveResultPercent),
                                  1.1*max(data$ReceiveResultPercent)),
                       breaks = seq(from = plyr::round_any(
                         .9*min(data$ReceiveResultPercent),
                         0.1, f = floor),
                         to = plyr::round_any(
                           1.1*max(data$ReceiveResultPercent),
                           0.1, f = ceiling),
                       length.out = 5),
                       expand = c(0, 0, 0, 0),
                       labels = label_percent(accuracy = 1)) +
    theme(axis.text.x = element_text(face="bold", angle=45)) +
    scale_color_MountSinai(palette = "main") +
    labs(title = "% Labs within Receive to Result Target Turnaround Time",
         subtitle = paste0("Target Turnaround Time for ",
                           priority, 
                           " ",    
                           test,
                           " Orders in ",
                           setting,
                           ": ",
                           turnaround_target,
                           " min"),
       x = "Month",
       y = "Percentage of Labs")
  
  receive_result_trend <- ggplotly(receive_result_trend) %>%
    layout(
      title = list(text = paste0(
        '% Labs within Target Turnaround Time',
        '<br>',
        '<sup>',
        paste0("Target Turnaround Time for ",
               priority,
               " ",
               setting,
               " ",
               test,
               " Orders: ",
               turnaround_target,
               " min"),
        '</sup>')),
        xaxis = list(
          type = 'date',
          tickvals = as.list(
            as.numeric(seq.Date(from = min(data$Month),
                       to = max(data$Month),
                       by = "1 month"))
          ),
          ticktext = as.list(tick_text)
          )
      ) %>%
    config(displayModeBar = FALSE)
  
  return(receive_result_trend)
    
  
  
  
}

```

# Troponin {data-navmenu="Chemistry"}

<h4> **Troponin Labs** </h4>

Column {.tabset .tabset-fade}
------------------------
### ED Stat Labs
```{r Troponin ED, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "Troponin", priority = "All", setting = "ED")


```

### ICU Stat Labs
```{r Troponin ICU, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "Troponin", priority = "All", setting = "ICU")
```

### IP Non-ICU Stat Labs
```{r Troponin IP Non-ICU, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "Troponin", priority = "All", setting = "IP Non-ICU")
```

# Lactate WB {data-navmenu="Chemistry"}

<h4> **Lactate WB Labs** </h4>

Column {.tabset .tabset-fade}
------------------------

### ED Stat Labs
```{r Lactate WB ED, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "Lactate WB", priority = "All", setting = "ED")
```

### ICU Stat Labs
```{r Lactate WB ICU, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "Lactate WB", priority = "All", setting = "ICU")
```

### IP Non-ICU Stat Labs
```{r Lactate WB IP Non-ICU, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "Lactate WB", priority = "All", setting = "IP Non-ICU")
```

# BUN {data-navmenu="Chemistry"}

<h4> **BUN Labs** </h4>

Column {.tabset .tabset-fade}
------------------------

### ED Stat Labs
```{r BUN ED, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "BUN", priority = "Stat", setting = "ED")
```

### ICU Stat Labs
```{r BUN ICU, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "BUN", priority = "Stat", setting = "ICU")
```

### IP Non-ICU Stat Labs
```{r BUN IP Non-ICU Stat, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "BUN", priority = "Stat", setting = "IP Non-ICU")
```

### IP Non-ICU Routine Labs
```{r BUN IP Non-ICU Routine, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "BUN", priority = "Routine", setting = "IP Non-ICU")
```

# PT {data-navmenu="Hematology"}

<h4> **PT Labs** </h4>

Column {.tabset .tabset-fade}
------------------------

### ED Stat Labs
```{r PT ED, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "PT", priority = "Stat", setting = "ED")
```

### ICU Stat Labs
```{r PT ICU, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "PT", priority = "Stat", setting = "ICU")
```

### IP Non-ICU Stat Labs
```{r PT IP Non-ICU Stat, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "PT", priority = "Stat", setting = "IP Non-ICU")
```

### IP Non-ICU Routine Labs
```{r PT IP Non-ICU Routine, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "PT", priority = "Routine", setting = "IP Non-ICU")
```

# HGB {data-navmenu="Hematology"}

<h4> **HGB Labs** </h4>

Column {.tabset .tabset-fade}
------------------------

### ED Stat Labs
``` {r HGB ED, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "HGB", priority = "Stat", setting = "ED")
```

### ICU Stat Labs
```{r HGB ICU, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "HGB", priority = "Stat", setting = "ICU")
```

### IP Non-ICU Stat Labs
```{r HGB IP Non-ICU Stat, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "HGB", priority = "Stat", setting = "IP Non-ICU")
```

### IP Non-ICU Routine Labs
```{r HGB IP Non-ICU Routine, warning = FALSE, message = FALSE, echo = FALSE}
graphing_function(test = "HGB", priority = "Routine", setting = "IP Non-ICU")

```

Reference
================================

Column {.tabset .tabset-fade}
------------------------

### Data Sources & Methodology
<h4><b>Definition table</b></h4>
The table below summarizes the definitions for the terminology used in this dashboard.
```{r Data Definitions and Assumptions}

definition_table <-
  data.frame(read_excel(reference_file, sheet = "Definitions_Trended"),
             stringsAsFactors = FALSE)

definition_table  %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Terminology Used", "Terminology Definition")) %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white")


```

<h4><b>Data Sources</b></h4>
MSH and MSQ: Based on repository of summarized daily SCC reports.</br>
MSBI, MSB, MSW, MSM: Based on repository of summarized daily Sunquest reports.</br>
The table below summarizes the test codes and IDs used from these daily reports.
```{r Test codes}

test_codes_kable <- full_join(scc_test_code, sun_test_code,
                              by = c("Test" = "Test",
                                     "Division" = "Division"))

test_codes_kable <- test_codes_kable %>%
  filter(Division %in% c("Chemistry", "Hematology")) %>%
  select(Division, Test, SCC_TestID, SUN_TestCode) %>%
  mutate(Test = factor(Test, levels = cp_lab_order, ordered = TRUE)) %>%
  arrange(Test)

test_codes_kable %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Lab Division", "Test", "SCC Test ID",
                      "Sunquest Test Code")) %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2, 3, 4), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white") %>%
  collapse_rows()

```

### Target Turnaround Times
```{r Target Turnaround Times}
targets_table <- filtered_df %>%
  select(Division, Test, TestPriority, CareSetting, ReceiveResultTarget) %>%
  distinct() %>%
  mutate(Test = factor(Test, levels = cp_lab_order, ordered = TRUE)) %>%
  arrange(Division, Test, desc(TestPriority), CareSetting)

kable(targets_table,
      escape = FALSE,
      align = "c",
      col.names = c("Lab Division", "Test", "Order Priority", "Care Setting",
                    "Receive to Result Target Turnaround Time (min)")) %>%
  kable_styling(bootstrap_options = "hover",
                position = "center",
                font_size = 11,
                full_width = FALSE) %>%
  column_spec(column = c(1:ncol(targets_table)),
              border_right = "thin solid lightgray") %>%
  row_spec(row = 0,
           bold = TRUE,
           color = "white",
           background = MountSinai_colors["dark purple"]) %>%
  collapse_rows(columns = 1:2)

```
<h4><b>Additional notes on target turnaround times:</b></h4>

* ED & ICU Labs:
    + All labs are treated as stat regardless of documented priority.
* Troponin and Lactate WB:
    + All labs are treated as stat regardless of documented priority and patient setting.
* Exclusions:
    + Turnaround time analysis excludes labs with out of order steps (ie, collect after receive), missing timestamps, add-on orders (order time more than 5 min after receive time), and labs not originating in IP or ED (ie, Outreach).
    + MSH BUN & HGB labs exclude RTC labs.
