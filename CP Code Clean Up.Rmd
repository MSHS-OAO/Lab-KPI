---
title: "MSHS Laboratory KPI Dashboard"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---


```{r include = FALSE}
#Install packages only the first time you run the code
# install.packages("timeDate")
# install.packages("lubridate")
# install.packages("readxl")
# install.packages("dplyr")
# install.packages("reshape2")
# install.packages("knitr")
# install.packages("gdtools")
# install.packages("kableExtra")
# install.packages("formattable")
# install.packages("bizdays")
# install.packages("rmarkdown")
# install.packages("stringr")
# install.packages("writexl")

#-------------------------------Required packages------------------------------#

#Required packages: run these every time you run the code
library(timeDate)
library(readxl)
library(bizdays)
library(dplyr)
library(lubridate)
library(reshape2)
library(knitr)
# library(gdtools)
library(kableExtra)
library(formattable)
library(rmarkdown)
library(stringr)
library(writexl)


```


<h4><span style = "color:red">Draft - Not For Distribution</h4></span style = "color:red">


```{r global_options, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r Determine date, warning = FALSE, message = FALSE, echo = FALSE}
#Clear existing history
rm(list = ls())
#-------------------------------holiday/weekend-------------------------------#
# Get today and yesterday's date

Today <- as.timeDate(format(Sys.Date(), "%m/%d/%Y"))
# Today <- as.timeDate(as.Date("12/10/2020", format = "%m/%d/%Y"))


#Determine if yesterday was a holiday/weekend
#get yesterday's DOW
Yesterday <- as.timeDate(format(Sys.Date() - 1, "%m/%d/%Y"))
# Yesterday <- as.timeDate(as.Date("12/9/2020", format = "%m/%d/%Y"))

#Get yesterday's DOW
Yesterday_Day <- dayOfWeek(Yesterday)

#Remove Good Friday from MSHS Holidays
NYSE_Holidays <- as.Date(holidayNYSE(year = 1990:2100))
GoodFriday <- as.Date(GoodFriday())
MSHS_Holiday <- NYSE_Holidays[GoodFriday != NYSE_Holidays]

#Determine whether yesterday was a holiday/weekend
Holiday_Det <- isHoliday(Yesterday, holidays = MSHS_Holiday)

#Set up a calendar for collect to received TAT calculations for Path & Cyto
create.calendar("MSHS_working_days", MSHS_Holiday,
                weekdays = c("saturday", "sunday"))
bizdays.options$set(default.calendar = "MSHS_working_days")
```

#### *Dashboard Creation Date: `r format(Today, "%m/%d/%Y")`*

```{r Import all data, warning = FALSE, message = FALSE, echo = FALSE}
# Select file/folder path for easier file selection and navigation
# user_wd <- choose.dir(caption = "Select your working directory")
#user_wd <- "J:\\deans\\Presidents\\HSPI-PM\\Operations Analytics and Optimization\\Projects\\Service Lines\\Lab KPI\\Data"
#user_path <- paste0(user_wd, "\\*.*")

if (list.files("J://") == "Presidents") {
  user_directory <- paste0("J:/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "Service Lines/Lab Kpi/Data")
} else {
  user_directory <- paste0("J:/deans/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/", 
                           "Service Lines/Lab Kpi/Data")
}
user_path <- paste0(user_directory, "/*.*")


#------------------------------Read Excel sheets------------------------------#

# The if-statement below determines the number of raw data files to import
# based on the day of week and holidays. The user is then prompted to select
# each file from the relevant folder.

if (((Holiday_Det) & (Yesterday_Day == "Mon")) |
   ((Yesterday_Day == "Sun") & (isHoliday(Yesterday - (86400*2))))) { 
  # Scenario 1: Mon Holiday or Friday Holiday (Need to select 4 files)
  # Save scenario
  scenario <- 1
  # Import SCC data
  SCC_Holiday_Monday_or_Friday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on 
                 Recent Holiday"), 
    sheet = 1, col_names = TRUE)
  SCC_Sunday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on Sunday"), 
    sheet = 1, col_names = TRUE)
  SCC_Saturday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on Saturday"), 
    sheet = 1, col_names = TRUE)
  #Merge the weekend data with the holiday data in one data frame
  SCC_Not_Weekday <- rbind(SCC_Holiday_Monday_or_Friday, 
                           SCC_Sunday, 
                           SCC_Saturday)
  SCC_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on 
                 Most Recent Weekday"), 
    sheet = 1, col_names = TRUE)
  # 
  # Import Sunquest data
  SQ_Holiday_Monday_or_Friday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Recent Holiday"), 
    sheet = 1, col_names = TRUE))
  SQ_Sunday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Sunday"), 
    sheet = 1, col_names = TRUE))
  SQ_Saturday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Saturday"), 
    sheet = 1, col_names = TRUE))
  #Merge the weekend data with the holiday data in one data frame
  SQ_Not_Weekday <- rbind(SQ_Holiday_Monday_or_Friday, SQ_Sunday, SQ_Saturday)
  SQ_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE))
  # #
  # # Import Powerpath data
  # PP_Holiday_Monday_or_Friday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Recent Holiday"), 
  #   skip = 1, 1)
  # PP_Holiday_Monday_or_Friday  <- PP_Holiday_Monday_or_Friday[
  #   -nrow(PP_Holiday_Monday_or_Friday), ]
  # PP_Sunday <- read_excel(
  #   choose.files(default = paste0(user_directory,
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Sunday"), 
  #   skip = 1, 1)
  # PP_Sunday <- PP_Sunday[-nrow(PP_Sunday), ]
  # PP_Saturday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Saturday"), 
  #   skip = 1, 1)
  # PP_Saturday <- PP_Saturday[-nrow(PP_Saturday), ]
  # #Merge the weekend data with the holiday data in one data frame
  # PP_Not_Weekday <- data.frame(rbind(PP_Holiday_Monday_or_Friday, 
  #                                    PP_Sunday, 
  #                                    PP_Saturday), stringsAsFactors = FALSE)
  # PP_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"),
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Most Recent Weekday"),
  #   skip = 1, 1)
  # PP_Weekday <- data.frame(PP_Weekday[-nrow(PP_Weekday), ], 
  #                          stringsAsFactors = FALSE)
  # #
  # # Import EPIC Cytology data
  # Epic_Holiday_Monday_or_Friday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Recent Holiday"), 1)
  # Epic_Sunday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Sunday"), 1)
  # Epic_Saturday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Saturday"), 1)
  # #Merge the weekend data with the holiday data in one data frame
  # Epic_Not_Weekday <- data.frame(rbind(Epic_Holiday_Monday_or_Friday, 
  #                                      Epic_Sunday, 
  #                                      Epic_Saturday),stringsAsFactors = FALSE)
  # Epic_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 1)
} else if ((Holiday_Det) & (Yesterday_Day == "Sun")){
  # Scenario 2: Regular Monday (Need to select 3 files)
  # Save scenario
  scenario <- 2
  #
  # Import SCC data
  SCC_Sunday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on Sunday"), 
    sheet = 1, col_names = TRUE)
  SCC_Saturday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on Saturday"), 
    sheet = 1, col_names = TRUE)
  #Merge the weekend data with the holiday data in one data frame
  SCC_Not_Weekday <- rbind(SCC_Sunday, SCC_Saturday)
  SCC_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE)
  #
  # Import Sunquest data
  SQ_Sunday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Sunday"), 
    sheet = 1, col_names = TRUE))
  SQ_Saturday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Saturday"), 
    sheet = 1, col_names = TRUE))
  #Merge the weekend data with the holiday data in one data frame
  SQ_Not_Weekday <- rbind(SQ_Sunday,SQ_Saturday)
  SQ_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE))
  #
  # # Import Powerpath data
  # PP_Sunday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Sunday"), 
  #   skip = 1, 1)
  # PP_Sunday <- PP_Sunday[-nrow(PP_Sunday), ]
  # PP_Saturday <- read_excel(
  #   choose.files(default = paste0(user_directory,
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Saturday"),
  #   skip = 1, 1)
  # PP_Saturday <- PP_Saturday[-nrow(PP_Saturday), ]
  # #Merge the weekend data with the holiday data in one data frame
  # PP_Not_Weekday <- data.frame(rbind(PP_Sunday, 
  #                                    PP_Saturday), stringsAsFactors = FALSE)
  # PP_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   skip = 1, 1)
  # PP_Weekday <- data.frame(PP_Weekday[-nrow(PP_Weekday), ], 
  #                          stringsAsFactors = FALSE)
  # #
  # # Import Epic Cytology data
  # Epic_Sunday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Sunday"), 
  #   1)
  # Epic_Saturday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Saturday"), 
  #   1)
  # #Merge the weekend data with the holiday data in one data frame
  # Epic_Not_Weekday <- data.frame(rbind(Epic_Sunday, 
  #                                      Epic_Saturday), 
  #                                stringsAsFactors = FALSE)
  # Epic_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   1)
} else if ((Holiday_Det) & ((Yesterday_Day != "Mon") | 
                            (Yesterday_Day != "Sun"))){ 
  #Scenario 3: Midweek holiday (Need to select 2 files)
  # Save scenario
  scenario <- 3
  #
  # Import SCC data
  SCC_Holiday_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted 
                 on Recent Holiday"), 
    sheet = 1, col_names = TRUE)
  SCC_Not_Weekday <- SCC_Holiday_Weekday
  SCC_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE)
  #
  # Import Sunquest data
  SQ_Holiday_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Recent Holiday"), 
    sheet = 1, col_names = TRUE))
  SQ_Not_Weekday <- SQ_Holiday_Weekday
  SQ_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE))
  #
  # # Import Powerpath data
  # PP_Holiday_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Recent Holiday"), 
  #   skip = 1, 1)
  # PP_Holiday_Weekday <- PP_Holiday_Weekday[-nrow(PP_Holiday_Weekday), ]
  # PP_Not_Weekday <- data.frame(PP_Holiday_Weekday, stringsAsFactors = FALSE)
  # PP_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   skip = 1, 1)
  # PP_Weekday <- data.frame(PP_Weekday[-nrow(PP_Weekday), ], 
  #                          stringsAsFactors = FALSE)
  # #
  # # Import Powerpath data
  # Epic_Holiday_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Recent Holiday"), 
  #   1)
  # Epic_Not_Weekday <- data.frame(Epic_Holiday_Weekday, stringsAsFactors = FALSE)
  # Epic_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   1)
} else { #Scenario 4: Tue-Fri without holidays (Need to select 1 file)
  # Save scenario
  scenario <- 4
  #
  # Import SCC data
  SCC_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE)
  SCC_Not_Weekday <- NULL
  #
  # Import Sunquest data
  SQ_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select SunQuest Report for Labs Resulted 
                 n Most Recent Weekday"), 
    sheet = 1, col_names = TRUE))
  SQ_Not_Weekday <- NULL
  #
  # # Import Powerpath data
  # PP_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   skip = 1, 1)
  # PP_Weekday <- data.frame(PP_Weekday[-nrow(PP_Weekday), ], 
  #                          stringsAsFactors = FALSE)
  # PP_Not_Weekday <- NULL
  # #
  # # Import Epic Cytology data
  # Epic_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   1)
  # Epic_Not_Weekday <- NULL
}

# #-----------Cytology Backlog Excel Files-----------#
# #For the backlog files the read excel is starting from the second row and remove last row
# Cytology_Backlog_Raw <- read_excel(
#   choose.files(default = paste0(user_directory, 
#                                 "/Cytology Backlog Reports/*.*"), 
#                caption = "Select Cytology Backlog Report"), 
#   skip =1, 1)
# Cytology_Backlog_Raw <- data.frame(
#   Cytology_Backlog_Raw[-nrow(Cytology_Backlog_Raw), ], stringsAsFactors = FALSE)
```

```{r Reference Data, warning = FALSE, message = FALSE, echo = FALSE}
# CP and Micro --------------------------------
# Import analysis reference data starting with test codes for SCC and Sunquest
reference_file <- choose.files(
  default = paste0(user_directory, "/Code Reference/*.*"), 
  caption = "Select analysis reference file")

test_code <- read_excel(reference_file, sheet = "TestNames")

tat_targets <- read_excel(reference_file, sheet = "Turnaround Targets")
tat_targets$Concate <- ifelse(tat_targets$Priority == "All" & 
                                tat_targets$`Pt Setting` == "All", 
                              tat_targets$Test,
                              ifelse(tat_targets$Priority != "All" & 
                                       tat_targets$`Pt Setting` == "All", 
                                     paste(tat_targets$Test, 
                                           tat_targets$Priority),
                                     paste(tat_targets$Test, 
                                           tat_targets$Priority, 
                                           tat_targets$`Pt Setting`)))

scc_icu <- read_excel(reference_file, sheet = "SCC_ICU")
scc_setting <- read_excel(reference_file, sheet = "SCC_ClinicType")
sun_icu <- read_excel(reference_file, sheet = "SUN_ICU")
sun_setting <- read_excel(reference_file, sheet = "SUN_LocType")

mshs_site <- read_excel(reference_file, sheet = "SiteNames")

scc_wday <- SCC_Weekday
sun_wday <- SQ_Weekday

cp_micro_lab_order <- c("Troponin", "Lactate WB", "BUN", "HGB", "PT", "Rapid Flu", "C. diff")

site_order <- c("MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM", "MSSN")
city_sites <- c("MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")

pt_setting_order <- c("ED", "ICU", "IP Non-ICU", "Amb", "Other")
pt_setting_order2 <- c("ED & ICU", "IP Non-ICU", "Amb", "Other")
dashboard_pt_setting <- c("ED & ICU", "IP Non-ICU", "Amb")

dashboard_priority_order <- c("All", "Stat", "Routine")

# # To Be Updated in Analysis reference file
# #-----------Patient Setting Excel File-----------#
# #Using Rev Center to determine patient setting
# Patient_Setting <- data.frame(read_excel(reference_file, 
#                                          sheet = "AP_Patient Setting"), 
#                               stringsAsFactors = FALSE)
# 
# #-----------Anatomic Pathology Targets Excel File-----------#
# TAT_Targets <- data.frame(read_excel(reference_file, 
#                                      sheet = "AP_TAT Targets"), 
#                           stringsAsFactors = FALSE)
# 
# #-----------GI Codes Excel File-----------#
# #Upload the exclusion vs inclusion criteria associated with the GI codes
# GI_Codes <- data.frame(read_excel(reference_file, sheet = "GI_Codes"), 
#                        stringsAsFactors = FALSE)
# 
# #-----------Create table template for Cyto/Path-----------#
# 
# #Cyto
# Table_Template_Cyto <- data.frame(matrix(ncol=19, nrow = 4))
# colnames(Table_Template_Cyto) <- c("spec_group", "Patient.Setting",
#                                    "No_Cases_Signed", 
#                                    "MSH.x", "BIMC.x", "MSQ.x","NYEE.x", 
#                                    "PACC.x", "R.x", "SL.x", "KH.x", "BIMC.y", 
#                                    "MSH.y", "MSQ.y", "NYEE.y", "PACC.y", "R.y", 
#                                    "SL.y", "KH.y")
# Table_Template_Cyto[1] <- c('CYTO GYN','CYTO GYN','CYTO NONGYN', 'CYTO NONGYN')
# Table_Template_Cyto[2] <- c('IP', 'Amb')
# 
# Table_Template_Cyto_V2 <- data.frame(matrix(ncol=12, nrow = 4))
# colnames(Table_Template_Cyto_V2) <- c("spec_group", "Patient.Setting",
#                                       "No_Cases_Signed", 
#                                       "Received_to_Signed_Out_within_target", 
#                                       "BIMC", "MSH", "MSQ", "NYEE", "PACC", 
#                                       "R", "SL", "KH")
# Table_Template_Cyto_V2[1] <- c('CYTO GYN', 'CYTO GYN', 
#                                'CYTO NONGYN', 'CYTO NONGYN')
# Table_Template_Cyto_V2[2] <- c('IP', 'Amb')
# 
# Table_Template_Cyto_Vol <- data.frame(matrix(ncol=10, nrow = 4))
# colnames(Table_Template_Cyto_Vol) <- c("spec_group", "Patient.Setting", 
#                                        "BIMC", "MSH", "MSQ", "NYEE", "PACC", 
#                                        "R", "SL", "KH")
# Table_Template_Cyto_Vol[1] <- c('CYTO GYN', 'CYTO GYN', 
#                                 'CYTO NONGYN', 'CYTO NONGYN')
# Table_Template_Cyto_Vol[2] <- c('IP', 'Amb')
# 
# #Patho
# Table_Template_Patho <- data.frame(matrix(ncol=17, nrow = 4))
# colnames(Table_Template_Patho) <- c("spec_group", "Patient.Setting", 
#                                     "No_Cases_Signed", 
#                                     "MSH.x", "BIMC.x", "MSQ.x", "PACC.x", 
#                                     "R.x", "SL.x", "KH.x", "BIMC.y", "MSH.y", 
#                                     "MSQ.y", "PACC.y", "R.y", "SL.y", "KH.y")
# Table_Template_Patho[1] <- c('Breast', 'Breast', 'GI', 'GI')
# Table_Template_Patho[2] <- c('IP', 'Amb')
# 
# Table_Template_Patho_Vol <- data.frame(matrix(ncol=9, nrow = 4))
# colnames(Table_Template_Patho_Vol) <- c("spec_group", "Patient.Setting", 
#                                         "BIMC", "MSH", "MSQ", "PACC", 
#                                         "R", "SL", "KH")
# Table_Template_Patho_Vol[1] <- c('Breast', 'Breast', 'GI', 'GI')
# Table_Template_Patho_Vol[2] <- c('IP', 'Amb')
```

```{r New concise function for preprocessing SCC and Sunquest data}
preprocessCP <- function(raw_scc, raw_sun)  {
  
  # Preprocess SCC data -------------------------------
  # Correct and format any timestamps that were not imported correctly
  raw_scc[c("ORDERING_DATE", 
            "COLLECTION_DATE", 
            "RECEIVE_DATE", 
            "VERIFIED_DATE")] <-
    lapply(raw_scc[c("ORDERING_DATE",
                     "COLLECTION_DATE",
                     "RECEIVE_DATE",
                     "VERIFIED_DATE")],
           function(x)
             ifelse(!is.na(x) & str_detect(x, "\\*.*\\*"),
                    str_replace(x, "\\*.*\\*", ""), x))
  
  raw_scc[c("ORDERING_DATE",
            "COLLECTION_DATE",
            "RECEIVE_DATE",
            "VERIFIED_DATE")] <-
    lapply(raw_scc[c("ORDERING_DATE",
                     "COLLECTION_DATE",
                     "RECEIVE_DATE",
                     "VERIFIED_DATE")],
           as.POSIXct, tz = "UTC",
           format = "%Y-%m-%d %H:%M:%OS",
           options(digits.sec = 1))
  
  # SCC lookup references ----------------------------------------------
  # Crosswalk in scope labs
  raw_scc <- left_join(raw_scc,
                       test_code[ , c("Test", "SCC_TestID", "Division")],
                       by = c("TEST_ID" = "SCC_TestID"))
  
  # Determine if test is included based on crosswalk results
  raw_scc <- raw_scc %>%
    mutate(TestIncl = !is.na(Test)) %>%
    filter(TestIncl)
  
  # Crosswalk unit type
  raw_scc <- left_join(raw_scc, scc_setting,
                       by = c("CLINIC_TYPE" = "Clinic_Type"))
  # Crosswalk site name
  raw_scc <- left_join(raw_scc, mshs_site,
                       by = c("SITE" = "DataSite"))
  
  # Crosswalk units and identify ICUs
  raw_scc <- raw_scc %>%
    mutate(WardandName = paste(Ward, WARD_NAME))
  
  raw_scc <- left_join(raw_scc, scc_icu[ , c("Concatenate", "ICU")], 
                       by = c("WardandName" = "Concatenate"))
  
  # Preprocess SCC data and add any necessary columns
  raw_scc <- raw_scc %>%
    mutate(
      # Determine if unit is an ICU based on crosswalk results
      ICU = ifelse(is.na(ICU), FALSE, ICU), 
      # Create a column for resulted date
      ResultedDate = date(VERIFIED_DATE),
      # Create master setting column to identify ICU and IP Non-ICU units
      MasterSetting = ifelse(SettingRollUp == "IP" & ICU, "ICU",
                             ifelse(SettingRollUp == "IP" & !ICU,
                                    "IP Non-ICU", SettingRollUp)),
      # Create dashboard setting column to roll up master settings based on
      # desired dashboard grouping (ie, group ED and ICU together)
      DashboardSetting = ifelse(MasterSetting %in% c("ED", "ICU"), 
                                "ED & ICU", MasterSetting),
      # Create column with adjusted priority based on assumption that all ED and
      # ICU labs are treated as stat per operational leadership
      AdjPriority = ifelse(MasterSetting %in% c("ED", "ICU") |
                             PRIORITY %in% "S", "Stat", "Routine"),
      # Create dashboard priority column 
      DashboardPriority = ifelse(
        tat_targets$Priority[match(Test, tat_targets$Test)] == "All", 
        "All", AdjPriority),
      # Calculate turnaround times
      CollectToReceive =
        as.numeric(RECEIVE_DATE - COLLECTION_DATE, units = "mins"),
      ReceiveToResult =
        as.numeric(VERIFIED_DATE - RECEIVE_DATE, units = "mins"),
      CollectToResult =
        as.numeric(VERIFIED_DATE - COLLECTION_DATE, units = "mins"),
      #
      # Determine if order was an add on or original order based on time between
      # order and receive times
      AddOnMaster = ifelse(as.numeric(ORDERING_DATE - RECEIVE_DATE,units = "mins")
                           > 5, "AddOn", "Original"),
      # Determine if collection time is missing
      MissingCollect = CollectToReceive == 0,
      #
      # Determine TAT based on test, priority, and patient setting
      # Create column concatenating test and priority to determine TAT targets
      Concate1 = paste(Test, DashboardPriority),
      # Create column concatenating test, priority, and setting to determine
      # TAT targets
      Concate2 = paste(Test, DashboardPriority, MasterSetting),
      # Determine Receive to Result TAT target using this logic:
      # 1. Try to match test, priority, and setting (applicable for labs with 
      # different TAT targets based on patient setting and order priority)
      # 2. Try to match test and priority (applicable for labs with different
      # TAT targets based on order priority)
      # 3. Try to match test - this is for tests with (applicable for labs with
      # TAT targets that are independent of patient setting or priority)
      #
      # Determine Receive to Result TAT target based on above logic/scenarios
      ReceiveResultTarget =
        # Match on scenario 1
        ifelse(!is.na(match(Concate2, tat_targets$Concate)),
               tat_targets$ReceiveToResultTarget[
                 match(Concate2, tat_targets$Concate)],
               # Match on scenario 2
               ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                      tat_targets$ReceiveToResultTarget[
                        match(Concate1, tat_targets$Concate)],
                      # Match on scenario 3
                      tat_targets$ReceiveToResultTarget[
                        match(Test, tat_targets$Concate)])),
      #
      # Determine Collect to Result TAT target based on above logic/scenarios
      CollectResultTarget =
        # Match on scenario 1
        ifelse(!is.na(match(Concate2, tat_targets$Concate)),
               tat_targets$CollectToResultTarget[
                 match(Concate2, tat_targets$Concate)],
               # Match on scenario 2
               ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                      tat_targets$CollectToResultTarget[
                        match(Concate1, tat_targets$Concate)],
                      # Match on scenario 3
                      tat_targets$CollectToResultTarget[
                        match(Test, tat_targets$Concate)])),
      #
      # Determine if Receive to Result and Collect to Result TAT meet targets
      ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget,
      CollectResultInTarget = CollectToResult <= CollectResultTarget,
      # Create column with patient name, order ID, test, collect, receive, and
      # result date and determine if there is a duplicate; order time excluded
      Concate3 = paste(LAST_NAME, FIRST_NAME,
                       ORDER_ID, TEST_NAME,
                       COLLECTION_DATE, RECEIVE_DATE, VERIFIED_DATE),
      DuplTest = duplicated(Concate3),
      # Determine whether or not to include this particular lab in TAT analysis
      # Exclusion criteria:
      # 1. Add on orders
      # 2. Orders from "Other" settings
      # 3. Orders with collect or receive times after result time
      # 4. Orders with missing collect, receive, or result timestamps
      TATInclude = ifelse(AddOnMaster == "AddOn" |
                            MasterSetting == "Other" |
                            CollectToResult < 0 |
                            ReceiveToResult < 0 |
                            is.na(CollectToResult) |
                            is.na(ReceiveToResult), FALSE, TRUE))
  
  # Remove duplicate tests
  raw_scc <- raw_scc %>%
    filter(!DuplTest)
  
  # Select columns
  scc_master_newfunc <- raw_scc[ , c("Ward", "WARD_NAME", "WardandName",
                              "ORDER_ID", "REQUESTING_DOC NAME",
                              "MPI", "WORK SHIFT",
                              "TEST_NAME", "Test", "Division", "PRIORITY",
                              "Site", "ICU", "CLINIC_TYPE",
                              "Setting", "SettingRollUp",
                              "MasterSetting", "DashboardSetting",
                              "AdjPriority", "DashboardPriority",
                              "ORDERING_DATE", "COLLECTION_DATE",
                              "RECEIVE_DATE", "VERIFIED_DATE",
                              "ResultedDate",
                              "CollectToReceive", "ReceiveToResult",
                              "CollectToResult",
                              "AddOnMaster", "MissingCollect",
                              "ReceiveResultTarget", "CollectResultTarget",
                              "ReceiveResultInTarget", "CollectResultInTarget",
                              "TATInclude")]
  # Rename columns
  colnames(scc_master_newfunc) <- c("LocCode", "LocName", "LocConcat",
                             "OrderID", "RequestMD",
                             "MSMRN", "WorkShift",
                             "TestName", "Test", "Division", "OrderPriority",
                             "Site", "ICU", "LocType",
                             "Setting", "SettingRollUp",
                             "MasterSetting", "DashboardSetting",
                             "AdjPriority", "DashboardPriority",
                             "OrderTime", "CollectTime",
                             "ReceiveTime", "ResultTime",
                             "ResultDate",
                             "CollectToReceiveTAT", "ReceiveToResultTAT",
                             "CollectToResultTAT",
                             "AddOnMaster", "MissingCollect",
                             "ReceiveResultTarget", "CollectResultTarget",
                             "ReceiveResultInTarget", "CollectResultInTarget",
                             "TATInclude")
  
  # Preprocess Sunquest data --------------------------------
  # Correct and format any timestamps that were not imported correctly
  # raw_sun <- SQ_Weekday
  raw_sun[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")], 
           function(x) ifelse(!is.na(x) & str_detect(x, "\\*.*\\*")  == TRUE, 
                              str_replace(x, "\\*.*\\*", ""), x))
  
  raw_sun[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")],
           as.POSIXct, tz = "UTC", format = "%m/%d/%Y %H:%M:%S")
  
  # Sunquest lookup references
  # Crosswalk labs included and remove out of scope labs
  raw_sun <- left_join(raw_sun, test_code[ , c("Test", 
                                               "SUN_TestCode",
                                               "Division")],
                       by = c("TestCode" = "SUN_TestCode"))
  
  # Determine if test is included based on crosswalk results
  raw_sun <- raw_sun %>%
    mutate(TestIncl = !is.na(Test)) %>%
    filter(TestIncl)
  
  
  # Crosswalk unit type
  raw_sun <- left_join(raw_sun, sun_setting, by = c("LocType" = "LocType"))
  
  # Crosswalk site name
  raw_sun <- left_join(raw_sun, mshs_site, by = c("HospCode" = "DataSite"))
  
  # Crosswalk units and identify ICUs
  raw_sun <- raw_sun %>%
    mutate(LocandName = paste(LocCode, LocName))
  
  raw_sun <- left_join(raw_sun, sun_icu[ , c("Concatenate", "ICU")], 
                       by = c("LocandName" = "Concatenate"))
  
  raw_sun[is.na(raw_sun$ICU), "ICU"] <- FALSE
  
  
  # # Sunquest data formatting-----------------------------
  # Preprocess Sunquest data and add any necessary columns
  raw_sun <- raw_sun %>%
    mutate(
      # Determine if unit is an ICU based on crosswalk results
      ICU = ifelse(is.na(ICU), FALSE, ICU),
      # Create a column for resulted date
      ResultedDate = as.Date(ResultDateTime, format = "%m/%d/%Y"),
      # Create master setting column to identify ICU and IP Non-ICU units
      MasterSetting = ifelse(SettingRollUp == "IP" & ICU, "ICU",
                             ifelse(SettingRollUp == "IP" & !ICU,
                                    "IP Non-ICU", SettingRollUp)),
      # Create dashboard setting column to roll up master settings based on
      # desired dashboard grouping(ie, group ED and ICU together)
      DashboardSetting = ifelse(MasterSetting %in% c("ED", "ICU"), "ED & ICU",
                                MasterSetting),
      #
      # Create column with adjusted priority based on operational assumption that
      # all ED and ICU labs are treated as stat
      AdjPriority = ifelse(MasterSetting %in% c("ED", "ICU") |
                             SpecimenPriority %in% "S", "Stat", "Routine"),
      #
      # Create dashboard priority column
      DashboardPriority = ifelse(
        tat_targets$Priority[match(Test, tat_targets$Test)] == "All", "All",
        AdjPriority),
      #
      # Calculate turnaround times
      CollectToReceive = 
        as.numeric(ReceiveDateTime - CollectDateTime, units = "mins"),
      ReceiveToResult = 
        as.numeric(ResultDateTime - ReceiveDateTime, units = "mins"),
      CollectToResult = 
        as.numeric(ResultDateTime - CollectDateTime, units = "mins"),
      #
      # Determine if order was an add on or original order based on time between
      # order and receive times
      AddOnMaster = ifelse(as.numeric(OrderDateTime - ReceiveDateTime,
                                      units = "mins") > 5, "AddOn", "Original"),
      #
      # Determine if collection time is missing
      MissingCollect = CollectDateTime == OrderDateTime,
      #
      # Determine TAT target based on test, priority, and patient setting
      # Create column concatenating test and priority to determine TAT targets
      Concate1 = paste(Test, DashboardPriority),
      # Create column concatenating test, priority, and setting to determine
      # TAT targets
      Concate2 = paste(Test, DashboardPriority, MasterSetting),
      # Determine Receive to Result TAT target using this logic:
      # 1. Try to match test, priority, and setting (applicable for labs with 
      # different TAT targets based on patient setting and order priority)
      # 2. Try to match test and priority (applicable for labs with different
      # TAT targets based on order priority)
      # 3. Try to match test - this is for tests with (applicable for labs with
      # TAT targets that are independent of patient setting or priority)
      #
      # Determine Receive to Result TAT target based on above logic/scenarios
      ReceiveResultTarget = 
        # Match on scenario 1
        ifelse(!is.na(match(Concate2, tat_targets$Concate)),
               tat_targets$ReceiveToResultTarget[
                 match(Concate2, tat_targets$Concate)],
               # Match on scenario 2
               ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                      tat_targets$ReceiveToResultTarget[
                        match(Concate1, tat_targets$Concate)],
                      # Match on scenario 3
                      tat_targets$ReceiveToResultTarget[
                        match(Test, tat_targets$Concate)])),
      #
      # Determine Collect to Result TAT target based on above logic/scenarios
      CollectResultTarget = 
        # Match on scenario 1
        ifelse(!is.na(match(Concate2, tat_targets$Concate)),
               tat_targets$CollectToResultTarget[
                 match(Concate2, tat_targets$Concate)],
               # Match on scenario 2
               ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                      tat_targets$CollectToResultTarget[
                        match(Concate1, tat_targets$Concate)],
                      # Match on scenario 3
                      tat_targets$CollectToResultTarget[
                        match(Test, tat_targets$Concate)])),
      #
      # Determine if Receive to Result and Collect to Result TAT meet targets
      ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget,
      CollectResultInTarget = CollectToResult <= CollectResultTarget,
      #
      # Create column with patient name, order ID, test, collect, receive, and
      # result date and determine if there is a duplicate; order time excluded
      Concate3 = paste(PtNumber, HISOrderNumber, TSTName, 
                       CollectDateTime, ReceiveDateTime, ResultDateTime),
      DuplTest = duplicated(Concate3),
      #
      # Determine whether or not to include this particular lab in TAT analysis
      # Exclusion criteria:
      # 1. Add on orders
      # 2. Orders from "Other" settings
      # 3. Orders with collect or receive times after result time
      # 4. Orders with missing collect, receive, or result timestamps
      TATInclude = ifelse(AddOnMaster == "AddOn" |
                            MasterSetting == "Other" |
                            CollectToResult < 0 |
                            ReceiveToResult < 0 |
                            is.na(CollectToResult) |
                            is.na(ReceiveToResult), FALSE, TRUE))
  
  # Remove duplicate tests
  raw_sun <- raw_sun %>%
    filter(!DuplTest)
  
  # Select columns
  sun_master_newfunc <- raw_sun[ ,c("LocCode", "LocName", "LocandName", 
                             "HISOrderNumber", "PhysName", 
                             "PtNumber", "SHIFT",            
                             "TSTName", "Test", "Division", "SpecimenPriority", 
                             "Site", "ICU", "LocType",               
                             "Setting", "SettingRollUp", 
                             "MasterSetting", "DashboardSetting", 
                             "AdjPriority", "DashboardPriority", 
                             "OrderDateTime", "CollectDateTime", 
                             "ReceiveDateTime", "ResultDateTime", 
                             "ResultedDate", 
                             "CollecttoReceive", "ReceivetoResult", 
                             "CollecttoResult", 
                             "AddOnMaster", "MissingCollect", 
                             "ReceiveResultTarget", "CollectResultTarget", 
                             "ReceiveResultInTarget", "CollectResultInTarget", 
                             "TATInclude")]
  
  colnames(sun_master_newfunc) <- c("LocCode", "LocName", "LocConcat", 
                             "OrderID", "RequestMD", 
                             "MSMRN", "WorkShift", 
                             "TestName", "Test", "Division", "OrderPriority", 
                             "Site", "ICU", "LocType", 
                             "Setting", "SettingRollUp", 
                             "MasterSetting", "DashboardSetting", 
                             "AdjPriority", "DashboardPriority",
                             "OrderTime", "CollectTime", 
                             "ReceiveTime", "ResultTime", 
                             "ResultDate", 
                             "CollectToReceiveTAT", "ReceiveToResultTAT", 
                             "CollectToResultTAT", 
                             "AddOnMaster", "MissingCollect", 
                             "ReceiveResultTarget", "CollectResultTarget", 
                             "ReceiveResultInTarget", "CollectResultInTarget", 
                             "TATInclude")

  
  scc_sun_master <- rbind(scc_master_newfunc, sun_master_newfunc)
  
  scc_sun_master$Site <- factor(scc_sun_master$Site, 
                                levels = site_order)
  scc_sun_master$Test <- factor(scc_sun_master$Test, 
                                levels = cp_micro_lab_order)
  scc_sun_master$MasterSetting <- factor(scc_sun_master$MasterSetting, 
                                         levels = pt_setting_order)
  scc_sun_master$DashboardSetting <- factor(scc_sun_master$DashboardSetting, 
                                            levels = pt_setting_order2)
  scc_sun_master$DashboardPriority <- factor(scc_sun_master$DashboardPriority, 
                                             levels = dashboard_priority_order)
  
  scc_sun_list_newfunc <- list(raw_scc, raw_sun, 
                       scc_master_newfunc, sun_master_newfunc,
                       scc_sun_master)
  
}
```

```{r}
# Preprocess data
scc_sun_wday_list <-preprocessCP(raw_scc = SCC_Weekday, raw_sun = SQ_Weekday)

scc_wday <- scc_sun_wday_list[[1]]
sun_wday <- scc_sun_wday_list[[2]]
scc_sun_wday_master <- scc_sun_wday_list[[5]]

if (is.null(SQ_Not_Weekday) & is.null(SCC_Not_Weekday)) {
  include_not_wday <- FALSE
  scc_sun_not_wday_list <- NULL
  scc_not_wday <- NULL
  sun_not_wday <- NULL
  scc_sun_not_wday_master <- NULL
} else {
  include_not_wday <- TRUE
  scc_sun_not_wday_list <- preprocessCP(
    raw_scc = SCC_Not_Weekday,
    raw_sun = SQ_Not_Weekday)
  scc_not_wday <- scc_sun_not_wday_list[[1]]
  sun_not_wday <- scc_sun_not_wday_list[[2]]
  scc_sun_not_wday_master <- scc_sun_not_wday_list[[5]]
}

# Remove labs from master data frame that were resulted at exactly midnight on 
# next morning or prior day
# Custom function to determine correct number of dates
correct_scc_result_dates <- function(data, number_days) {
  all_resulted_dates_vol <- data %>%
    group_by(ResultDate) %>%
    summarize(VolLabs = n()) %>%
    arrange(desc(VolLabs)) %>%
    ungroup()
  
  correct_dates <- all_resulted_dates_vol$ResultDate[1:number_days]
  
  new_data <- data %>%
    filter(ResultDate %in% correct_dates)
  
  return(new_data)
}

# Update preprocessed data to only include correct dates ----------------------
scc_sun_wday_master <- correct_scc_result_dates(scc_sun_wday_master, 1)

if (scenario == 1) {
  scc_sun_not_wday_master <- correct_scc_result_dates(scc_sun_not_wday_master, 
                                                      3)
} else if (scenario == 2) {
  scc_sun_not_wday_master <- correct_scc_result_dates(scc_sun_not_wday_master, 
                                                      2)
} else if (scenario == 3) {
  scc_sun_not_wday_master <- correct_scc_result_dates(scc_sun_not_wday_master, 
                                                      1)
}

# Determine resulted date for weekday labs
wday_result_date <- format(unique(scc_sun_wday_master$ResultDate), 
                           format = "%a %m/%d/%y")

```

```{r Template dataframe}
# Create template data frames for combinations of tests, priority and settings
# that will be used in TAT tables and volume lookback tables
test_name_division <- unique(test_code[, c("Division", "Test")])

test_names <- unique(test_code$Test)

# Create data frame of test and site combinations
rep_test_site <- sort(rep(test_names, length(city_sites)))

rep_sites <- rep(city_sites, length(test_names))

test_site_comb <- data.frame("Test" = rep_test_site,
                             "Site" = rep_sites,
                             stringsAsFactors = FALSE)

# Create data frame of test and priority combinations
rep_test_priority <- sort(rep(test_names, length(dashboard_priority_order)))

rep_priority <- rep(dashboard_priority_order, length(test_names))

test_priority_comb <- data.frame("Test" = rep_test_priority,
                                "DashboardPriority" = rep_priority,
                                stringsAsFactors = FALSE)

# Create data frame of test and setting combinations for TAT tables
rep_test_setting_tat <- sort(rep(test_names, length(dashboard_pt_setting)))

rep_setting_tat <- rep(dashboard_pt_setting, length(test_names))

test_setting_comb_tat <- data.frame("Test" = rep_test_setting_tat,
                                "DashboardSetting" = rep_setting_tat)

# Create data frame of test and setting combinations for volume lookback tables
rep_test_setting_vol <- sort(rep(test_names, length(pt_setting_order)))

rep_setting_vol <- rep(pt_setting_order, length(test_names))

test_setting_comb_vol <- data.frame("Test" = rep_test_setting_vol,
                                "PtSetting" = rep_setting_vol)

# Combine data frames to create data frame with all combinations of tests,
# sites, priority, and settings for both TAT tables and lookback tables
test_site_prty <- left_join(test_site_comb,
                            test_priority_comb,
                            by = c("Test" = "Test"))

test_site_prty_setting_tat <- left_join(test_site_prty,
                                   test_setting_comb_tat,
                                   by = c("Test" = "Test"))

test_site_prty_setting_tat <- left_join(test_site_prty_setting_tat,
                                    unique(test_code[, c("Test", "Division")]),
                                    by = c("Test" = "Test"))

test_site_prty_setting_vol <- left_join(test_site_prty,
                                   test_setting_comb_vol,
                                   by = c("Test" = "Test"))

test_site_prty_setting_vol <- left_join(test_site_prty_setting_vol,
                                    unique(test_code[, c("Test", "Division")]),
                                    by = c("Test" = "Test"))

# Select applicable test, priority, setting combinations based on lab operations
tat_dashboard_templ <- test_site_prty_setting_tat %>%
  mutate(
    # Create column for applicable combinations
    Incl = ifelse(
      # Remove ED & ICU labs with Routine priority since all labs in these
      # these settings are treated as stat
      (DashboardPriority %in% c("Routine") &
         DashboardSetting %in% c("ED & ICU")) |
        # Remove ambulatory troponin and lactate since these labs are collected
        # in ambulatory settings. Remove stat and routine stratification for
        # these labs since all are treated as stat.
        (Test %in% c("Troponin", "Lactate WB") &
           (DashboardPriority %in% c("Stat", "Routine") |
              DashboardSetting %in% c("Amb"))) |
        # Remove "all" priority for BUN, PT, and HGB labs
        (Test %in% c("BUN", "PT", "HGB") & DashboardPriority %in% c("All")) |
        # Remove priority stratification for rapid flu and c. diff since all
        # are treated as stat
        (Test %in% c("Rapid Flu", "C. diff") & 
           !(DashboardPriority %in% c("All"))), "Excl", "Incl")) %>%
  filter(Incl == "Incl")

vol_dashboard_templ <- test_site_prty_setting_vol %>%
  mutate(
    # Create column for applicable combinations
    Incl = ifelse(
      # Remove ED & ICU labs with Routine priority since all labs in these
      # these settings are treated as stat
      (DashboardPriority %in% c("Routine") &
         PtSetting %in% c("ED", "ICU")) |
        # Remove stat and routine stratification for troponin and lactate labs
        # these labs since all are treated as stat
        (Test %in% c("Troponin", "Lactate WB") &
           (DashboardPriority %in% c("Stat", "Routine"))) |
        # Remove "all" priority for BUN, PT, and HGB labs
        (Test %in% c("BUN", "PT", "HGB") & DashboardPriority %in% c("All")) |
        # Remove Microbiology RRL since resulted volume is included already in
        # TAT tables
        (Division %in% c("Microbiology RRL")), "Excl", "Incl")) %>%
  filter(Incl == "Incl")

```

```{r New function for subsetting lab data and creating kables}
summarizeLabDivTAT <- function(x, LabDivision) {
  # Subset data to be included based on lab division, whether or not TAT
  # meets inclusion criteria, and site location
  lab_div_df <- x %>%
    filter(Division == LabDivision & TATInclude & Site %in% city_sites)
  #
  # Summarize data based on test, site, priority, setting, and TAT targets.
  lab_summary <- lab_div_df %>%
    group_by(Test,
             Site,
             DashboardPriority,
             DashboardSetting,
             ReceiveResultTarget,
             CollectResultTarget) %>%
    summarize(ResultedVolume = n(),
              ReceiveResultInTarget = sum(ReceiveResultInTarget),
              CollectResultInTarget = sum(CollectResultInTarget),
              ReceiveResultPercent = round(
                ReceiveResultInTarget/ResultedVolume, digits = 3),
            CollectResultPercent = round(
              CollectResultInTarget/ResultedVolume, digits = 3),
            .groups = "keep") %>%
    ungroup()
  #
  # Subset template data frame for this division
  lab_div_df_templ <- tat_dashboard_templ %>%
    mutate(Incl = NULL) %>%
    filter(Division == LabDivision)
  #
  # Combine lab summary with template data frame for this division for
  # dashboard visualization
  lab_summary <- left_join(lab_div_df_templ, lab_summary,
                           by = c("Test" = "Test",
                                  "Site" = "Site",
                                  "DashboardPriority" = "DashboardPriority",
                                  "DashboardSetting" = "DashboardSetting"))
  #
  # Format relevant columns as factors, look up target TAT for labs with 0
  # resulted volume, add formatting for percent within targets
  lab_summary <- lab_summary %>%
    mutate(
      #
      # Set test, site, priority, and setting as factors
      Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
      Site = droplevels(factor(Site, levels = city_sites, ordered = TRUE)),
      DashboardPriority = droplevels(factor(DashboardPriority,
                                            levels = dashboard_priority_order,
                                            ordered = TRUE)),
      DashboardSetting = droplevels(factor(DashboardSetting,
                                           levels = dashboard_pt_setting,
                                           ordered = TRUE)),
      #
      # Determine TAT target for sites with 0 resulted labs
      # Create column concatenating test and priority to determine TAT targets
      Concate1 = paste(Test, DashboardPriority),
      # Create column concatenating test, priority, and setting to determine
      # TAT targets
      Concate2 = paste(Test, DashboardPriority, DashboardSetting),
      # Determine Receive to Result TAT target using this logic:
      # 1. Try to match test, priority, and setting (applicable for labs with
      # different TAT targets based on patient setting and order priority)
      # 2. Try to match test and priority (applicable for labs with different
      # TAT targets based on order priority)
      # 3. Try to match test - this is for tests with (applicable for labs with
      # TAT targets that are independent of patient setting or priority)
      #
      # Determine Receive to Result TAT target based on above logic/scenarios
      ReceiveResultTarget =
        # If TAT target is known, keep TAT target
        ifelse(!is.na(ReceiveResultTarget), ReceiveResultTarget,
               # Try to match on scenario 1
               ifelse(
                 !is.na(match(Concate2, tat_targets$Concate)),
                 tat_targets$ReceiveToResultTarget[
                   match(Concate2, tat_targets$Concate)],
                 # Try to match on scenario 2
                 ifelse(
                   !is.na(match(Concate1, tat_targets$Concate)),
                   tat_targets$ReceiveToResultTarget[
                     match(Concate1, tat_targets$Concate)],
                   # Try to match on scenario 3
                   tat_targets$ReceiveToResultTarget[
                     match(Test, tat_targets$Concate)]))),
      #
      # Determine Collect to Result TAT target based on above logic/scenarios
      # Determine Receive to Result TAT target based on above logic/scenarios
      CollectResultTarget =
        # If TAT target is known, keep TAT target
        ifelse(!is.na(CollectResultTarget), CollectResultTarget,
               # Try to match on scenario 1
               ifelse(
                 !is.na(match(Concate2, tat_targets$Concate)),
                 tat_targets$CollectToResultTarget[
                   match(Concate2, tat_targets$Concate)],
                 # Try to match on scenario 2
                 ifelse(
                   !is.na(match(Concate1, tat_targets$Concate)),
                   tat_targets$CollectToResultTarget[
                     match(Concate1, tat_targets$Concate)],
                   # Try to match on scenario 3
                   tat_targets$CollectToResultTarget[
                     match(Test, tat_targets$Concate)]))),
      #
      # Format target TAT for tables from numbers to "<=X min"
      ReceiveResultTarget = paste0("<=", ReceiveResultTarget, " min"),
      CollectResultTarget = paste0("<=", CollectResultTarget, " min"),
      #
      # Format percentage of labs in target
      ReceiveResultPercent = percent(ReceiveResultPercent, digits = 0),
      CollectResultPercent = percent(CollectResultPercent, digits = 0),
      #
      # Apply conditional color formatting to TAT percentages based on status
      # definitions for each lab division
      #
      # Chemistry & Hematology:
      # Green: >= 95%, Yellow: >= 80% & < 95%, Red: < 80%
      # Microbiology:
      # Green: 100%, Yellow: >= 90% & < 100%, Red: < 90%
      #
      ReceiveResultPercent = cell_spec(
        ReceiveResultPercent, "html",
        color = ifelse(is.na(ReceiveResultPercent), "lightgray",
                       ifelse(
                         (ReceiveResultPercent >= 0.95 &
                            LabDivision %in% c("Chemistry", "Hematology")) |
                           (ReceiveResultPercent == 1.00 &
                              LabDivision %in% c("Microbiology RRL")),
                         "green",
                         ifelse(
                           (ReceiveResultPercent >= 0.8 &
                              LabDivision %in% c("Chemistry", "Hematology")) |
                             (ReceiveResultPercent >= 0.9 &
                                LabDivision %in% c("Microbiology RRL")),
                           "orange", "red")))),
      CollectResultPercent = cell_spec(
        CollectResultPercent, "html",
        color = ifelse(is.na(CollectResultPercent), "lightgray",
                       ifelse(
                         (CollectResultPercent >= 0.95 &
                            LabDivision %in% c("Chemistry", "Hematology")) |
                           (CollectResultPercent == 1.00 &
                              LabDivision %in% c("Microbiology RRL")),
                         "green",
                         ifelse(
                           (CollectResultPercent >= 0.8 &
                              LabDivision %in% c("Chemistry", "Hematology")) |
                             (CollectResultPercent >= 0.9 &
                                LabDivision %in% c("Microbiology RRL")),
                           "orange", "red")))),
      #
      # Create a new column with test and priority to be used in tables later
      TestAndPriority = paste(Test, "-", DashboardPriority, "Labs"),
      #
      # Remove concatenated columns used for matching
      Concate1 = NULL,
      Concate2 = NULL) %>%
    arrange(Test, Site, DashboardPriority, DashboardSetting)
  #
  # Melt summarized data into a long dataframe
  lab_dashboard_melt <- melt(lab_summary,
                             id.var = c("Test",
                                        "Site",
                                        "DashboardPriority",
                                        "TestAndPriority",
                                        "DashboardSetting",
                                        "ReceiveResultTarget",
                                        "CollectResultTarget"),
                             measure.vars = c("ReceiveResultPercent",
                                              "CollectResultPercent"))
  #
  # Case dataframe into wide format for use in tables later
  lab_dashboard_cast <- dcast(lab_dashboard_melt,
                              Test +
                                DashboardPriority +
                                TestAndPriority +
                                DashboardSetting +
                                ReceiveResultTarget +
                                CollectResultTarget ~
                                variable +
                                Site,
                              value.var = "value")
  #
  # Rearrange columns based on desired dashboard aesthetics
  lab_dashboard_cast <- lab_dashboard_cast %>%
  mutate(DashboardSetting2 = DashboardSetting) %>%
  select(Test, DashboardPriority, TestAndPriority,
         ReceiveResultTarget, DashboardSetting,
         ReceiveResultPercent_MSH, ReceiveResultPercent_MSQ,
         ReceiveResultPercent_MSBI, ReceiveResultPercent_MSB,
         ReceiveResultPercent_MSW, ReceiveResultPercent_MSM,
         CollectResultTarget, DashboardSetting2,
         CollectResultPercent_MSH, CollectResultPercent_MSQ,
         CollectResultPercent_MSBI, CollectResultPercent_MSB,
         CollectResultPercent_MSW, CollectResultPercent_MSM)
  #
  # Save outputs in a list
  lab_sub_output <- list(lab_div_df,
                         lab_summary,
                         lab_dashboard_melt,
                         lab_dashboard_cast)
  #
  lab_sub_output
  
}

```

```{r Custom function for making TAT kables}

# Custom function for styling chemistry, hematology, and microbiology kables
kableChemHemMicroTAT <- function(x) {
  #
  # Select columns 3 and on
  data <- x[, c(3:ncol(x))]
  #
  # Format kable
  kable(data, format = "html", escape = FALSE, align = "c",
        col.names = c("Test & Priority",
                      "Target", "Setting",
                      "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM",
                      "Target", "Setting",
                      "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
    kable_styling(bootstrap_options = "hover", position = "center",
                  font_size = 11) %>%
    column_spec(column = c(1, 9, 17),
                border_right = "thin solid lightgray") %>%
    add_header_above(c(" " = 1,
                       "Receive to Result Within Target" =
                         (ncol(data)-1)/2,
                       "Collect to Result Within Target" =
                         (ncol(data)-1)/2),
                     background = c("white", "#00AEEF", "#221f72"),
                     color = "white", line = FALSE, font_size = 13) %>%
    column_spec(column = 2:9, background = "#E6F8FF", color = "black") %>%
    column_spec(column = 10:17, background = "#EBEBF9", color = "black") %>%
    #column_spec(column = 2:17, background = "inherit", color = "inherit") %>%
    column_spec(column = 1, width_min = "125px") %>%
    column_spec(column = c(3, 11), width_min = "100px") %>%
    row_spec(row = 0, font_size = 13) %>%
    collapse_rows(columns = c(1, 2, 10))
}

```

```{r Create TAT tables for each CP lab division}
chem_list_test <- summarizeLabDivTAT(x = scc_sun_wday_master,
                                     LabDivision = "Chemistry")

chem_subset_test <- chem_list_test[[1]]
chem_summary_test <- chem_list_test[[2]]
chem_melt_test <- chem_list_test[[3]]
chem_cast_test <- chem_list_test[[4]]

kableChemHemMicroTAT(x = chem_cast_test)

hem_list_test <- summarizeLabDivTAT(x = scc_sun_wday_master,
                                    LabDivision = "Hematology")

hem_subset_test <- hem_list_test[[1]]
hem_summary_test <- hem_list_test[[2]]
hem_melt_test <- hem_list_test[[3]]
hem_cast_test <- hem_list_test[[4]]

kableChemHemMicroTAT(x = hem_cast_test)

micro_list_test <- summarizeLabDivTAT(x = scc_sun_wday_master,
                                      LabDivision = "Microbiology RRL")

micro_subset_test <- micro_list_test[[1]]
micro_summary_test <- micro_list_test[[2]]
micro_melt_test <- micro_list_test[[3]]
micro_cast_test <- micro_list_test[[4]]

# Manually remove C. diff ambulatory TAT since TAT are not monitored for this
# lab/setting combination but volume is
micro_cast_test <- micro_cast_test %>%
  filter(!(Test == "C. diff" & DashboardSetting == "Amb"))
row.names(micro_cast_test) <- 1:nrow(micro_cast_test)

#
# Create volume table for Microbiology RRL that mimics TAT table layout
micro_volume_melt <- melt(micro_summary_test,
                               id.var = c("Test",
                                          "Site",
                                          "DashboardPriority",
                                          "TestAndPriority",
                                          "DashboardSetting",
                                          "ReceiveResultTarget",
                                          "CollectResultTarget"),
                               measure.vars = "ResultedVolume")

# Ensure all combinations of Microbiology RRL test-site-priorty are included
tat_micro_templ <- tat_dashboard_templ %>%
  filter(Division == "Microbiology RRL") %>%
  mutate(Incl = NULL,
         Division = NULL)

micro_volume_melt <- left_join(tat_micro_templ,
                               micro_volume_melt,
                               by = c("Test" = "Test",
                                      "Site" = "Site",
                                      "DashboardPriority" = "DashboardPriority",
                                      "DashboardSetting" = "DashboardSetting"))

# Replace NA with 0 and format site, tests, priority, and settings as factors
micro_volume_melt <- micro_volume_melt %>%
  mutate(
    #
    # Replace NA with 0
    value = ifelse(is.na(value), 0, value),
    #
    # Set test, site, priority, and setting as factors
    Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
    Site = droplevels(factor(Site, levels = city_sites, ordered = TRUE)),
    DashboardPriority = droplevels(factor(DashboardPriority,
                                          levels = dashboard_priority_order,
                                          ordered = TRUE)),
    DashboardSetting = droplevels(factor(DashboardSetting,
                                         levels = dashboard_pt_setting,
                                         ordered = TRUE)))

micro_volume_cast <- dcast(micro_volume_melt,
                           Test + DashboardPriority + TestAndPriority +
                             DashboardSetting + ReceiveResultTarget +
                             CollectResultTarget ~
                             variable + Site,
                           value.var = "value")

original_length <- ncol(micro_volume_cast)

micro_volume_cast <- micro_volume_cast %>%
  mutate(
    #
    # Replace TAT targets with "Resulted Volume"
    ReceiveResultTarget = "Resulted Volume",
    CollectResultTarget = "Resulted Volume",
    #
    # Duplicate dashboard setting column
    DashboardSetting2 = DashboardSetting,
    #
    # Duplicate resulted volume columns
    ResultedVolume_MSH2 = ResultedVolume_MSH,
    ResultedVolume_MSQ2 = ResultedVolume_MSQ,
    ResultedVolume_MSBI2 = ResultedVolume_MSBI,
    ResultedVolume_MSB2 = ResultedVolume_MSB,
    ResultedVolume_MSW2 = ResultedVolume_MSW,
    ResultedVolume_MSM2 = ResultedVolume_MSM) %>%
  select(Test,
         DashboardPriority,
         TestAndPriority,
         ReceiveResultTarget,
         DashboardSetting,
         ResultedVolume_MSH,
         ResultedVolume_MSQ,
         ResultedVolume_MSBI,
         ResultedVolume_MSB,
         ResultedVolume_MSW,
         ResultedVolume_MSM,
         CollectResultTarget,
         DashboardSetting2,
         ResultedVolume_MSH2,
         ResultedVolume_MSQ2,
         ResultedVolume_MSBI2,
         ResultedVolume_MSB2,
         ResultedVolume_MSW2,
         ResultedVolume_MSM2)

# Rename columns to match TAT table for binding
colnames(micro_volume_cast) <- colnames(micro_cast_test)

micro_volume_cast[, c(original_length:ncol(micro_volume_cast))] <- ""

micro_tat_vol_cast <- rbind(micro_cast_test, micro_volume_cast) 

micro_tat_vol_cast <- micro_tat_vol_cast %>%
  arrange(Test, ReceiveResultTarget)

kableChemHemMicroTAT(x = micro_tat_vol_cast)

```

```{r Missing Collection Times and Add On Order Tables, warning = FALSE, message = FALSE, echo = FALSE}
# Determine percentage of labs with missing collection times--------------------
missing_collect <- scc_sun_wday_master %>%
  filter(TATInclude & Site %in% city_sites) %>%
  group_by(Site) %>%
  summarize(ResultedVolume = n(),
            MissingCollection = sum(MissingCollect, na.rm = TRUE),
            Percent = percent(MissingCollection / ResultedVolume,
                              digits = 0)) %>%
  mutate(
    # Apply conditional formatting based on percentage of labs with missing
    # collections
    Percent = cell_spec(
      Percent, "html",
      color = ifelse(is.na(Percent), "grey",
                     ifelse(Percent <= 0.05, "green",
                            ifelse(Percent <= 0.15, "orange", "red")))))
#
# Cast missing collections into table format
missing_collect_table <- dcast(missing_collect,
                               "Percentage of Specimens" ~ Site,
                               value.var = "Percent")
#
# Create a kable of missing collection percentages
missing_collect_table %>%
  kable(format = "html", escape = FALSE, align = "c",  
        col.names = c("Site", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
  kable_styling(
    bootstrap = "hover",
    position = "float_left",
    font_size = 11,
    full_width = FALSE) %>%
  add_header_above(
    c(" " = 1,
      "Percentage of Labs Missing Collect Times" =
        ncol(missing_collect_table)-1),
    background = c("white", "#00AEEF"),
    color = "white",
    line = FALSE,
    font_size = 13) %>%
  column_spec(column = c(1, ncol(missing_collect_table)),
              border_right = "thin solid lightgray") %>%
  column_spec(column = c(2:ncol(missing_collect_table)),
              background = "#E6F8FF",
              color = "black") %>%
 # column_spec(column = c(2:ncol(missing_collect_table)), background = "inherit", color = "inherit", width_max = 0.15) %>%
  row_spec(row = 0, font_size =13)

# Determine add on order volume
add_on_volume <- scc_sun_wday_master %>%
  group_by(Test, Site, .drop = FALSE) %>%
  summarize(AddOnVolume = sum(AddOnMaster == "AddOn", na.rm = TRUE))

add_on_table <- dcast(add_on_volume, Test ~ Site, value.var = "AddOnVolume")

add_on_volume2 <- scc_sun_wday_master %>%
  filter(Site %in% city_sites) %>%
  group_by(Test, Site) %>%
  summarize(AddOnVolume = sum(AddOnMaster == "AddOn", na.rm = TRUE))

add_on_volume2 <- left_join(test_site_comb, add_on_volume2,
                            by =c("Site" = "Site",
                                  "Test" = "Test"))

add_on_volume2 <- add_on_volume2 %>%
  mutate(
    # Set test and site as factors
    Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
    Site = factor(Site, levels = city_sites, ordered = TRUE),
    AddOnVolume = ifelse(is.na(AddOnVolume), 0 , AddOnVolume))

add_on_table2 <- dcast(add_on_volume2, Test ~ Site, value.var = "AddOnVolume")  

add_on_table2 %>%
  kable(format = "html", escape = FALSE, align = "c", 
        col.names = c("Test", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM"),
        color = "gray") %>%
  kable_styling(
    bootstrap = "hover",
    position = "right",
    font_size = 11,
    full_width = FALSE) %>%
  add_header_above(
    c(" " = 1,
      "Volume of Add On Labs" = ncol(missing_collect_table)-1),
    background = c("white", "#00AEEF"),
    color = "white",
    line = FALSE,
    font_size = 13) %>%
  column_spec(
    column = c(1, ncol(missing_collect_table)),
    border_right = "thin solid lightgray") %>%
  column_spec(
    column = c(2:ncol(missing_collect_table)),
    background = "#E6F8FF", color = "black") %>%
  #column_spec(column = c(2:ncol(missing_collect_table)), background = "inherit", color = "inherit") %>%
  row_spec(row = 0, font_size =13)

```

```{r}

lab_vol_df2 <- scc_sun_wday_master %>%
  filter(Division == "Chemistry" & Site %in% city_sites) %>%
  group_by(Site, Test, DashboardPriority, MasterSetting) %>%
  summarize(ResultedLabs = n(), .groups = "keep")

# Create a template data frame for combinations of tests, priority and settings
# for volume look back tables



lab_div_vol_templ_df <- vol_dashboard_templ %>%
  filter(Division == "Chemistry") %>%
  mutate(Incl = NULL)

lab_vol_df2 <- left_join(lab_div_vol_templ_df, lab_vol_df2,
                         by = c("Test" = "Test",
                                "Site" = "Site",
                                "DashboardPriority" = "DashboardPriority",
                                "PtSetting" = "MasterSetting"))

lab_vol_df2 <- lab_vol_df2 %>%
  mutate(
    # Set test, site, priority, and setting as factors
    Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
    Site = droplevels(factor(Site, levels = city_sites, ordered = TRUE)),
    DashboardPriority = droplevels(factor(DashboardPriority,
                                          levels = dashboard_priority_order,
                                          ordered = TRUE)),
    PtSetting = droplevels(factor(PtSetting,
                                         levels = pt_setting_order,
                                         ordered = TRUE)),
    #
    ResultedLabs = ifelse(is.na(ResultedLabs), 0, ResultedLabs),
    TestAndPriority = paste(Test, "-", DashboardPriority, "Labs"))

lab_vol_df_cast <- dcast(lab_vol_df2, 
                         Test +
                           DashboardPriority +
                           TestAndPriority +
                           PtSetting ~
                           Site,
                         value.var = "ResultedLabs")

lab_vol_df_cast <- lab_vol_df_cast[, c(3:ncol(lab_vol_df_cast))]


summarizeLabDivVol <- function(x, LabDivision) {
  # Subset data to be included based on lab division and site location
  lab_div_vol_df <- x %>%
    filter(Division == LabDivision & Site %in% city_sites) %>%
    group_by(Site, Test, DashboardPriority, MasterSetting) %>%
    summarize(ResultedLabs = n(), .groups = "keep")
  #
  # Subset volume dataframe template for this division
  lab_div_vol_templ <- vol_dashboard_templ %>%
    filter(Division == LabDivision) %>%
    mutate(Incl = NULL)
  #
  # Combine two dataframes to ensure all combinations are accounts for
  lab_div_vol_df <- left_join(lab_div_vol_templ, lab_div_vol_df,
                              by = c("Test" = "Test",
                                     "Site" = "Site",
                                     "DashboardPriority" = "DashboardPriority",
                                     "PtSetting" = "MasterSetting"))
  #
  lab_div_vol_df <- lab_div_vol_df %>%
    mutate(
    # Set test, site, priority, and setting as factors
    Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
    Site = droplevels(factor(Site, levels = city_sites, ordered = TRUE)),
    DashboardPriority = droplevels(factor(DashboardPriority,
                                          levels = dashboard_priority_order,
                                          ordered = TRUE)),
    PtSetting = droplevels(factor(PtSetting,
                                         levels = pt_setting_order,
                                         ordered = TRUE)),
    #
    # Replace NA with 0
    ResultedLabs = ifelse(is.na(ResultedLabs), 0, ResultedLabs),
    #
    # Create column with test name and priority
    TestAndPriority = paste(Test, "-", DashboardPriority, "Labs"))
  #
  # Cast dataframe
  lab_div_vol_cast <- dcast(lab_div_vol_df,
                            Test +
                              DashboardPriority +
                              TestAndPriority +
                              PtSetting ~
                              Site,
                            value.var = "ResultedLabs")
  # Remove test and priority columns
  lab_div_vol_cast <- lab_div_vol_cast[, c(3:ncol(lab_div_vol_cast))]
  #
  return(lab_div_vol_cast)
}


kableChemHemVol <- function(x) {
  kable(x, format = "html", escape = FALSE, align = "c", 
        col.names = c("Test & Priority", "Setting", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11) %>%
  column_spec(column = c(1, 8), border_right = "thin solid lightgray") %>%
  add_header_above(c(" " = 1, "Resulted Lab Volume" = (ncol(x)-1)), background = c("white", "#00AEEF"), color = "white", line = FALSE, font_size = 13) %>%
  column_spec(column = 2:8, background = "#E6F8FF", color = "black") %>%
  #column_spec(column = 2:8, background = "inherit", color = "inherit") %>%
  # column_spec(column = 1, width_min = "125px", include_thead = TRUE) %>%
  # column_spec(column = c(3, 11), width_min = "100px", include_thead = TRUE) %>%
  row_spec(row = 0, font_size = 13) %>%
  collapse_rows(columns = c(1, 2))
}

kableChemHemVol(summarizeLabDivVol(x = scc_sun_wday_master,
                   LabDivision = "Chemistry"))

kableChemHemVol(summarizeLabDivVol(x = scc_sun_wday_master,
                   LabDivision = "Hematology"))

```

```{r Summarize data for repository}

if (!is.null(scc_sun_not_wday_master)) {
  scc_sun_all_days <- rbind(scc_sun_wday_master, scc_sun_not_wday_master)
} else {
  scc_sun_all_days <- scc_sun_wday_master
}

# Summarize data for export to historical repo
scc_sun_all_days_subset <- scc_sun_all_days %>%
  group_by(Site, ResultDate, Test, Division, 
           Setting, SettingRollUp, MasterSetting, DashboardSetting,
           OrderPriority, AdjPriority, DashboardPriority,
           ReceiveResultTarget, CollectResultTarget) %>%
  summarize(TotalResulted = n(),
            TotalResultedTAT = sum(TATInclude),
            TotalReceiveResultInTarget =
              sum(ReceiveResultInTarget[TATInclude == TRUE]),
            TotalCollectResultInTarget =
              sum(CollectResultInTarget[TATInclude == TRUE]),
            TotalAddOnOrder = sum(AddOnMaster == "AddOn"),
            TotalMissingCollections = sum(MissingCollect)) %>%
  arrange(Site, ResultDate) %>%
  ungroup()

cp_wday_summary <- scc_sun_wday_master %>%
  group_by(Site,
           ResultDate,
           Test,
           Division,
           Setting,
           SettingRollUp,
           MasterSetting,
           DashboardSetting,
           OrderPriority,
           AdjPriority,
           DashboardPriority,
           ReceiveResultTarget,
           CollectResultTarget) %>%
  summarize(TotalResulted = n(),
            TotalResultedTAT = sum(TATInclude),
            TotalReceiveResultInTarget =
              sum(ReceiveResultInTarget[TATInclude]),
            TotalCollectResultInTarget =
              sum(CollectResultInTarget[TATInclude]),
            TotalAddOnOrder = sum(AddOnMaster == "AddOn"),
            TotalMissingCollections = sum(MissingCollect[TATInclude]),
            .groups = "keep") %>%
  arrange(Site, ResultDate) %>%
  ungroup()



lab_div_wday_df <- cp_wday_summary %>%
  filter(Division == "Hematology" & Site %in% city_sites)

lab_div_wday_summary <- lab_div_wday_df %>%
  group_by(Test,
           Site,
           DashboardPriority,
           DashboardSetting,
           ReceiveResultTarget,
           CollectResultTarget) %>%
  summarize(ResultedVolume = sum(TotalResultedTAT),
            ReceiveResultInTarget = sum(TotalReceiveResultInTarget),
            CollectResultInTarget = sum(TotalCollectResultInTarget),
            ReceiveResultPercent = round(
                ReceiveResultInTarget/ResultedVolume, digits = 3),
              CollectResultPercent = round(
                CollectResultInTarget/ResultedVolume, digits = 3),
              .groups = "keep")

#
# Subset template data frame for this division
lab_div_df_templ <- tat_dashboard_templ %>%
  mutate(Incl = NULL) %>%
  filter(Division == "Hematology")

lab_div_wday_summary <- left_join(lab_div_df_templ, lab_div_wday_summary,
                           by = c("Test" = "Test",
                                  "Site" = "Site",
                                  "DashboardPriority" = "DashboardPriority",
                                  "DashboardSetting" = "DashboardSetting"))


  lab_div_wday_summary <- lab_div_wday_summary %>%
    mutate(
      #
      # Set test, site, priority, and setting as factors
      Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
      Site = droplevels(factor(Site, levels = city_sites, ordered = TRUE)),
      DashboardPriority = droplevels(factor(DashboardPriority,
                                            levels = dashboard_priority_order,
                                            ordered = TRUE)),
      DashboardSetting = droplevels(factor(DashboardSetting,
                                           levels = dashboard_pt_setting,
                                           ordered = TRUE)),
      #
      # Determine TAT target for sites with 0 resulted labs
      # Create column concatenating test and priority to determine TAT targets
      Concate1 = paste(Test, DashboardPriority),
      # Create column concatenating test, priority, and setting to determine
      # TAT targets
      Concate2 = paste(Test, DashboardPriority, DashboardSetting),
      # Determine Receive to Result TAT target using this logic:
      # 1. Try to match test, priority, and setting (applicable for labs with
      # different TAT targets based on patient setting and order priority)
      # 2. Try to match test and priority (applicable for labs with different
      # TAT targets based on order priority)
      # 3. Try to match test - this is for tests with (applicable for labs with
      # TAT targets that are independent of patient setting or priority)
      #
      # Determine Receive to Result TAT target based on above logic/scenarios
      ReceiveResultTarget =
        # If TAT target is known, keep TAT target
        ifelse(!is.na(ReceiveResultTarget), ReceiveResultTarget,
               # Try to match on scenario 1
               ifelse(
                 !is.na(match(Concate2, tat_targets$Concate)),
                 tat_targets$ReceiveToResultTarget[
                   match(Concate2, tat_targets$Concate)],
                 # Try to match on scenario 2
                 ifelse(
                   !is.na(match(Concate1, tat_targets$Concate)),
                   tat_targets$ReceiveToResultTarget[
                     match(Concate1, tat_targets$Concate)],
                   # Try to match on scenario 3
                   tat_targets$ReceiveToResultTarget[
                     match(Test, tat_targets$Concate)]))),
      #
      # Determine Collect to Result TAT target based on above logic/scenarios
      # Determine Receive to Result TAT target based on above logic/scenarios
      CollectResultTarget =
        # If TAT target is known, keep TAT target
        ifelse(!is.na(CollectResultTarget), CollectResultTarget,
               # Try to match on scenario 1
               ifelse(
                 !is.na(match(Concate2, tat_targets$Concate)),
                 tat_targets$CollectToResultTarget[
                   match(Concate2, tat_targets$Concate)],
                 # Try to match on scenario 2
                 ifelse(
                   !is.na(match(Concate1, tat_targets$Concate)),
                   tat_targets$CollectToResultTarget[
                     match(Concate1, tat_targets$Concate)],
                   # Try to match on scenario 3
                   tat_targets$CollectToResultTarget[
                     match(Test, tat_targets$Concate)]))),
      #
      # Format target TAT for tables from numbers to "<=X min"
      ReceiveResultTarget = paste0("<=", ReceiveResultTarget, " min"),
      CollectResultTarget = paste0("<=", CollectResultTarget, " min"),
      #
      # Format percentage of labs in target
      ReceiveResultPercent = percent(ReceiveResultPercent, digits = 0),
      CollectResultPercent = percent(CollectResultPercent, digits = 0),
      #
      # Apply conditional color formatting to TAT percentages based on status
      # definitions for each lab division
      #
      # Chemistry & Hematology:
      # Green: >= 95%, Yellow: >= 80% & < 95%, Red: < 80%
      # Microbiology:
      # Green: 100%, Yellow: >= 90% & < 100%, Red: < 90%
      #
      ReceiveResultPercent = cell_spec(
        ReceiveResultPercent, "html",
        color = ifelse(is.na(ReceiveResultPercent), "lightgray",
                       ifelse(
                         (ReceiveResultPercent >= 0.95 &
                            "Hematology" %in% c("Chemistry", "Hematology")) |
                           (ReceiveResultPercent == 1.00 &
                              "Hematology" %in% c("Microbiology RRL")),
                         "green",
                         ifelse(
                           (ReceiveResultPercent >= 0.8 &
                              "Hematology" %in% c("Chemistry", "Hematology")) |
                             (ReceiveResultPercent >= 0.9 &
                                "Hematology" %in% c("Microbiology RRL")),
                           "orange", "red")))),
      CollectResultPercent = cell_spec(
        CollectResultPercent, "html",
        color = ifelse(is.na(CollectResultPercent), "lightgray",
                       ifelse(
                         (CollectResultPercent >= 0.95 &
                            "Hematology" %in% c("Chemistry", "Hematology")) |
                           (CollectResultPercent == 1.00 &
                              "Hematology" %in% c("Microbiology RRL")),
                         "green",
                         ifelse(
                           (CollectResultPercent >= 0.8 &
                              "Hematology" %in% c("Chemistry", "Hematology")) |
                             (CollectResultPercent >= 0.9 &
                                "Hematology" %in% c("Microbiology RRL")),
                           "orange", "red")))),
      #
      # Create a new column with test and priority to be used in tables later
      TestAndPriority = paste(Test, "-", DashboardPriority, "Labs"),
      #
      # Remove concatenated columns used for matching
      Concate1 = NULL,
      Concate2 = NULL) %>%
    arrange(Test, Site, DashboardPriority, DashboardSetting) 
  
  # Melt summarized data into a long dataframe
  lab_dashboard_melt <- melt(lab_div_wday_summary,
                             id.var = c("Test",
                                        "Site",
                                        "DashboardPriority",
                                        "TestAndPriority",
                                        "DashboardSetting",
                                        "ReceiveResultTarget",
                                        "CollectResultTarget"),
                             measure.vars = c("ReceiveResultPercent",
                                              "CollectResultPercent"))
  #
  # Case dataframe into wide format for use in tables later
  lab_dashboard_cast <- dcast(lab_dashboard_melt,
                              Test +
                                DashboardPriority +
                                TestAndPriority +
                                DashboardSetting +
                                ReceiveResultTarget +
                                CollectResultTarget ~
                                variable +
                                Site,
                              value.var = "value")
  #
  # Rearrange columns based on desired dashboard aesthetics
  lab_dashboard_cast <- lab_dashboard_cast %>%
    mutate(DashboardSetting2 = DashboardSetting) %>%
    select(Test, DashboardPriority, TestAndPriority,
           ReceiveResultTarget, DashboardSetting,
           ReceiveResultPercent_MSH, ReceiveResultPercent_MSQ,
           ReceiveResultPercent_MSBI, ReceiveResultPercent_MSB,
           ReceiveResultPercent_MSW, ReceiveResultPercent_MSM,
           CollectResultTarget, DashboardSetting2,
           CollectResultPercent_MSH, CollectResultPercent_MSQ,
           CollectResultPercent_MSBI, CollectResultPercent_MSB,
           CollectResultPercent_MSW, CollectResultPercent_MSM)  
  
  
  # Select columns 3 and on
  data <- lab_dashboard_cast[, c(3:ncol(lab_dashboard_cast))]
  #
  # Format kable
  kable(data, format = "html", escape = FALSE, align = "c",
        col.names = c("Test & Priority",
                      "Target", "Setting",
                      "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM",
                      "Target", "Setting",
                      "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
    kable_styling(bootstrap_options = "hover", position = "center",
                  font_size = 11) %>%
    column_spec(column = c(1, 9, 17),
                border_right = "thin solid lightgray") %>%
    add_header_above(c(" " = 1,
                       "Receive to Result Within Target" =
                         (ncol(data)-1)/2,
                       "Collect to Result Within Target" =
                         (ncol(data)-1)/2),
                     background = c("white", "#00AEEF", "#221f72"),
                     color = "white", line = FALSE, font_size = 13) %>%
    column_spec(column = 2:9, background = "#E6F8FF", color = "black") %>%
    column_spec(column = 10:17, background = "#EBEBF9", color = "black") %>%
    #column_spec(column = 2:17, background = "inherit", color = "inherit") %>%
    column_spec(column = 1, width_min = "125px") %>%
    column_spec(column = c(3, 11), width_min = "100px") %>%
    row_spec(row = 0, font_size = 13) %>%
    collapse_rows(columns = c(1, 2, 10))

```

```{r Test micro}

lab_div_wday_df <- cp_wday_summary %>%
  filter(Division == "Microbiology RRL" & Site %in% city_sites)

lab_div_wday_summary <- lab_div_wday_df %>%
  group_by(Test,
           Site,
           DashboardPriority,
           DashboardSetting,
           ReceiveResultTarget,
           CollectResultTarget) %>%
  summarize(ResultedVolume = sum(TotalResultedTAT),
            ReceiveResultInTarget = sum(TotalReceiveResultInTarget),
            CollectResultInTarget = sum(TotalCollectResultInTarget),
            ReceiveResultPercent = round(
                ReceiveResultInTarget/ResultedVolume, digits = 3),
              CollectResultPercent = round(
                CollectResultInTarget/ResultedVolume, digits = 3),
              .groups = "keep")

#
# Subset template data frame for this division
lab_div_df_templ <- tat_dashboard_templ %>%
  mutate(Incl = NULL) %>%
  filter(Division == "Microbiology RRL")

lab_div_wday_summary <- left_join(lab_div_df_templ, lab_div_wday_summary,
                           by = c("Test" = "Test",
                                  "Site" = "Site",
                                  "DashboardPriority" = "DashboardPriority",
                                  "DashboardSetting" = "DashboardSetting"))


  lab_div_wday_summary <- lab_div_wday_summary %>%
    mutate(
      #
      # Set test, site, priority, and setting as factors
      Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
      Site = droplevels(factor(Site, levels = city_sites, ordered = TRUE)),
      DashboardPriority = droplevels(factor(DashboardPriority,
                                            levels = dashboard_priority_order,
                                            ordered = TRUE)),
      DashboardSetting = droplevels(factor(DashboardSetting,
                                           levels = dashboard_pt_setting,
                                           ordered = TRUE)),
      #
      # Determine TAT target for sites with 0 resulted labs
      # Create column concatenating test and priority to determine TAT targets
      Concate1 = paste(Test, DashboardPriority),
      # Create column concatenating test, priority, and setting to determine
      # TAT targets
      Concate2 = paste(Test, DashboardPriority, DashboardSetting),
      # Determine Receive to Result TAT target using this logic:
      # 1. Try to match test, priority, and setting (applicable for labs with
      # different TAT targets based on patient setting and order priority)
      # 2. Try to match test and priority (applicable for labs with different
      # TAT targets based on order priority)
      # 3. Try to match test - this is for tests with (applicable for labs with
      # TAT targets that are independent of patient setting or priority)
      #
      # Determine Receive to Result TAT target based on above logic/scenarios
      ReceiveResultTarget =
        # If TAT target is known, keep TAT target
        ifelse(!is.na(ReceiveResultTarget), ReceiveResultTarget,
               # Try to match on scenario 1
               ifelse(
                 !is.na(match(Concate2, tat_targets$Concate)),
                 tat_targets$ReceiveToResultTarget[
                   match(Concate2, tat_targets$Concate)],
                 # Try to match on scenario 2
                 ifelse(
                   !is.na(match(Concate1, tat_targets$Concate)),
                   tat_targets$ReceiveToResultTarget[
                     match(Concate1, tat_targets$Concate)],
                   # Try to match on scenario 3
                   tat_targets$ReceiveToResultTarget[
                     match(Test, tat_targets$Concate)]))),
      #
      # Determine Collect to Result TAT target based on above logic/scenarios
      # Determine Receive to Result TAT target based on above logic/scenarios
      CollectResultTarget =
        # If TAT target is known, keep TAT target
        ifelse(!is.na(CollectResultTarget), CollectResultTarget,
               # Try to match on scenario 1
               ifelse(
                 !is.na(match(Concate2, tat_targets$Concate)),
                 tat_targets$CollectToResultTarget[
                   match(Concate2, tat_targets$Concate)],
                 # Try to match on scenario 2
                 ifelse(
                   !is.na(match(Concate1, tat_targets$Concate)),
                   tat_targets$CollectToResultTarget[
                     match(Concate1, tat_targets$Concate)],
                   # Try to match on scenario 3
                   tat_targets$CollectToResultTarget[
                     match(Test, tat_targets$Concate)]))),
      #
      # Format target TAT for tables from numbers to "<=X min"
      ReceiveResultTarget = paste0("<=", ReceiveResultTarget, " min"),
      CollectResultTarget = paste0("<=", CollectResultTarget, " min"),
      #
      # Format percentage of labs in target
      ReceiveResultPercent = percent(ReceiveResultPercent, digits = 0),
      CollectResultPercent = percent(CollectResultPercent, digits = 0),
      #
      # Apply conditional color formatting to TAT percentages based on status
      # definitions for each lab division
      #
      # Chemistry & Hematology:
      # Green: >= 95%, Yellow: >= 80% & < 95%, Red: < 80%
      # Microbiology:
      # Green: 100%, Yellow: >= 90% & < 100%, Red: < 90%
      #
      ReceiveResultPercent = cell_spec(
        ReceiveResultPercent, "html",
        color = ifelse(is.na(ReceiveResultPercent), "lightgray",
                       ifelse(
                         (ReceiveResultPercent >= 0.95 &
                            "Microbiology RRL" %in% c("Chemistry", "Hematology")) |
                           (ReceiveResultPercent == 1.00 &
                              "Microbiology RRL" %in% c("Microbiology RRL")),
                         "green",
                         ifelse(
                           (ReceiveResultPercent >= 0.8 &
                              "Microbiology RRL" %in% c("Chemistry", "Hematology")) |
                             (ReceiveResultPercent >= 0.9 &
                                "Microbiology RRL" %in% c("Microbiology RRL")),
                           "orange", "red")))),
      CollectResultPercent = cell_spec(
        CollectResultPercent, "html",
        color = ifelse(is.na(CollectResultPercent), "lightgray",
                       ifelse(
                         (CollectResultPercent >= 0.95 &
                            "Microbiology RRL" %in% c("Chemistry", "Hematology")) |
                           (CollectResultPercent == 1.00 &
                              "Microbiology RRL" %in% c("Microbiology RRL")),
                         "green",
                         ifelse(
                           (CollectResultPercent >= 0.8 &
                              "Microbiology RRL" %in% c("Chemistry", "Hematology")) |
                             (CollectResultPercent >= 0.9 &
                                "Microbiology RRL" %in% c("Microbiology RRL")),
                           "orange", "red")))),
      #
      # Create a new column with test and priority to be used in tables later
      TestAndPriority = paste(Test, "-", DashboardPriority, "Labs"),
      #
      # Remove concatenated columns used for matching
      Concate1 = NULL,
      Concate2 = NULL) %>%
    arrange(Test, Site, DashboardPriority, DashboardSetting) 
  
  # Melt summarized data into a long dataframe
  lab_dashboard_melt <- melt(lab_div_wday_summary,
                             id.var = c("Test",
                                        "Site",
                                        "DashboardPriority",
                                        "TestAndPriority",
                                        "DashboardSetting",
                                        "ReceiveResultTarget",
                                        "CollectResultTarget"),
                             measure.vars = c("ReceiveResultPercent",
                                              "CollectResultPercent"))
  #
  # Case dataframe into wide format for use in tables later
  lab_dashboard_cast <- dcast(lab_dashboard_melt,
                              Test +
                                DashboardPriority +
                                TestAndPriority +
                                DashboardSetting +
                                ReceiveResultTarget +
                                CollectResultTarget ~
                                variable +
                                Site,
                              value.var = "value")
  #
  # Rearrange columns based on desired dashboard aesthetics
  lab_dashboard_cast <- lab_dashboard_cast %>%
    mutate(DashboardSetting2 = DashboardSetting) %>%
    select(Test, DashboardPriority, TestAndPriority,
           ReceiveResultTarget, DashboardSetting,
           ReceiveResultPercent_MSH, ReceiveResultPercent_MSQ,
           ReceiveResultPercent_MSBI, ReceiveResultPercent_MSB,
           ReceiveResultPercent_MSW, ReceiveResultPercent_MSM,
           CollectResultTarget, DashboardSetting2,
           CollectResultPercent_MSH, CollectResultPercent_MSQ,
           CollectResultPercent_MSBI, CollectResultPercent_MSB,
           CollectResultPercent_MSW, CollectResultPercent_MSM)  

# Create volume table for Microbiology RRL that mimics TAT table layout
micro_volume_melt <- melt(lab_div_wday_summary,
                          id.var = c("Test",
                                     "Site",
                                     "DashboardPriority",
                                     "TestAndPriority",
                                     "DashboardSetting",
                                     "ReceiveResultTarget",
                                     "CollectResultTarget"),
                          measure.vars = "ResultedVolume")

# Ensure all combinations of Microbiology RRL test-site-priorty are included
tat_micro_templ <- tat_dashboard_templ %>%
  filter(Division == "Microbiology RRL") %>%
  mutate(Incl = NULL,
         Division = NULL)

micro_volume_melt <- left_join(tat_micro_templ,
                               micro_volume_melt,
                               by = c("Test" = "Test",
                                      "Site" = "Site",
                                      "DashboardPriority" = "DashboardPriority",
                                      "DashboardSetting" = "DashboardSetting"))

# Replace NA with 0 and format site, tests, priority, and settings as factors
micro_volume_melt <- micro_volume_melt %>%
  mutate(
    #
    # Replace NA with 0
    value = ifelse(is.na(value), 0, value),
    #
    # Set test, site, priority, and setting as factors
    Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
    Site = droplevels(factor(Site, levels = city_sites, ordered = TRUE)),
    DashboardPriority = droplevels(factor(DashboardPriority,
                                          levels = dashboard_priority_order,
                                          ordered = TRUE)),
    DashboardSetting = droplevels(factor(DashboardSetting,
                                         levels = dashboard_pt_setting,
                                         ordered = TRUE)))

micro_volume_cast <- dcast(micro_volume_melt,
                           Test + DashboardPriority + TestAndPriority +
                             DashboardSetting + ReceiveResultTarget +
                             CollectResultTarget ~
                             variable + Site,
                           value.var = "value")

original_length <- ncol(micro_volume_cast)

micro_volume_cast <- micro_volume_cast %>%
  mutate(
    #
    # Replace TAT targets with "Resulted Volume"
    ReceiveResultTarget = "Resulted Volume",
    CollectResultTarget = "Resulted Volume",
    #
    # Duplicate dashboard setting column
    DashboardSetting2 = DashboardSetting,
    #
    # Duplicate resulted volume columns
    ResultedVolume_MSH2 = ResultedVolume_MSH,
    ResultedVolume_MSQ2 = ResultedVolume_MSQ,
    ResultedVolume_MSBI2 = ResultedVolume_MSBI,
    ResultedVolume_MSB2 = ResultedVolume_MSB,
    ResultedVolume_MSW2 = ResultedVolume_MSW,
    ResultedVolume_MSM2 = ResultedVolume_MSM) %>%
  select(Test,
         DashboardPriority,
         TestAndPriority,
         ReceiveResultTarget,
         DashboardSetting,
         ResultedVolume_MSH,
         ResultedVolume_MSQ,
         ResultedVolume_MSBI,
         ResultedVolume_MSB,
         ResultedVolume_MSW,
         ResultedVolume_MSM,
         CollectResultTarget,
         DashboardSetting2,
         ResultedVolume_MSH2,
         ResultedVolume_MSQ2,
         ResultedVolume_MSBI2,
         ResultedVolume_MSB2,
         ResultedVolume_MSW2,
         ResultedVolume_MSM2)

# Rename columns to match TAT table for binding
colnames(micro_volume_cast) <- colnames(micro_cast_test)

micro_volume_cast[, c(original_length:ncol(micro_volume_cast))] <- ""

micro_tat_vol_cast <- rbind(micro_cast_test, micro_volume_cast) 

micro_tat_vol_cast <- micro_tat_vol_cast %>%
  arrange(Test, ReceiveResultTarget)

kableChemHemMicroTAT(x = micro_tat_vol_cast)


# Manually remove C. diff ambulatory TAT since TAT are not monitored for this
# lab/setting combination but volume is
micro_cast_test <- lab_dashboard_cast %>%
  filter(!(Test == "C. diff" & DashboardSetting == "Amb"))
row.names(micro_cast_test) <- 1:nrow(micro_cast_test)










```

```{r Missing collections and add ons}

# Determine percentage of labs with missing collection times--------------------
missing_collect <- cp_wday_summary %>%
  filter(TotalResultedTAT & Site %in% city_sites) %>%
  group_by(Site) %>%
  summarize(ResultedVolume = sum(TotalResultedTAT),
            MissingCollection = sum(TotalMissingCollections, na.rm = TRUE),
            Percent = percent(MissingCollection / ResultedVolume,
                              digits = 0)) %>%
  mutate(
    # Apply conditional formatting based on percentage of labs with missing
    # collections
    Percent = cell_spec(
      Percent, "html",
      color = ifelse(is.na(Percent), "grey",
                     ifelse(Percent <= 0.05, "green",
                            ifelse(Percent <= 0.15, "orange", "red")))))
#
# Cast missing collections into table format
missing_collect_table <- dcast(missing_collect,
                               "Percentage of Specimens" ~ Site,
                               value.var = "Percent")
#
# Create a kable of missing collection percentages
missing_collect_table %>%
  kable(format = "html", escape = FALSE, align = "c",  
        col.names = c("Site", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
  kable_styling(
    bootstrap = "hover",
    position = "float_left",
    font_size = 11,
    full_width = FALSE) %>%
  add_header_above(
    c(" " = 1,
      "Percentage of Labs Missing Collect Times" =
        ncol(missing_collect_table)-1),
    background = c("white", "#00AEEF"),
    color = "white",
    line = FALSE,
    font_size = 13) %>%
  column_spec(column = c(1, ncol(missing_collect_table)),
              border_right = "thin solid lightgray") %>%
  column_spec(column = c(2:ncol(missing_collect_table)),
              background = "#E6F8FF",
              color = "black") %>%
 # column_spec(column = c(2:ncol(missing_collect_table)), background = "inherit", color = "inherit", width_max = 0.15) %>%
  row_spec(row = 0, font_size =13)

# Determine add on order volume
add_on_volume <- cp_wday_summary %>%
  group_by(Test, Site) %>%
  summarize(AddOnVolume = sum(TotalAddOnOrder, na.rm = TRUE),
            .groups = "keep")

add_on_table <- dcast(add_on_volume, Test ~ Site, value.var = "AddOnVolume")

add_on_volume2 <- cp_wday_summary %>%
  filter(Site %in% city_sites) %>%
  group_by(Test, Site) %>%
  summarize(AddOnVolume = sum(TotalAddOnOrder, na.rm = TRUE))

add_on_volume2 <- left_join(test_site_comb, add_on_volume2,
                            by =c("Site" = "Site",
                                  "Test" = "Test"))

add_on_volume2 <- add_on_volume2 %>%
  mutate(
    # Set test and site as factors
    Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
    Site = factor(Site, levels = city_sites, ordered = TRUE),
    AddOnVolume = ifelse(is.na(AddOnVolume), 0 , AddOnVolume))

add_on_table2 <- dcast(add_on_volume2, Test ~ Site, value.var = "AddOnVolume")  

add_on_table2 %>%
  kable(format = "html", escape = FALSE, align = "c", 
        col.names = c("Test", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM"),
        color = "gray") %>%
  kable_styling(
    bootstrap = "hover",
    position = "right",
    font_size = 11,
    full_width = FALSE) %>%
  add_header_above(
    c(" " = 1,
      "Volume of Add On Labs" = ncol(missing_collect_table)-1),
    background = c("white", "#00AEEF"),
    color = "white",
    line = FALSE,
    font_size = 13) %>%
  column_spec(
    column = c(1, ncol(missing_collect_table)),
    border_right = "thin solid lightgray") %>%
  column_spec(
    column = c(2:ncol(missing_collect_table)),
    background = "#E6F8FF", color = "black") %>%
  #column_spec(column = c(2:ncol(missing_collect_table)), background = "inherit", color = "inherit") %>%
  row_spec(row = 0, font_size =13)
```

```{r}

lab_vol_df2 <- cp_wday_summary %>%
  filter(Division == "Chemistry" & Site %in% city_sites) %>%
  group_by(Site, Test, DashboardPriority, MasterSetting) %>%
  summarize(ResultedLabs = sum(TotalResultedTAT), .groups = "keep")

# Create a template data frame for combinations of tests, priority and settings
# for volume look back tables



lab_div_vol_templ_df <- vol_dashboard_templ %>%
  filter(Division == "Chemistry") %>%
  mutate(Incl = NULL)

lab_vol_df2 <- left_join(lab_div_vol_templ_df, lab_vol_df2,
                         by = c("Test" = "Test",
                                "Site" = "Site",
                                "DashboardPriority" = "DashboardPriority",
                                "PtSetting" = "MasterSetting"))

lab_vol_df2 <- lab_vol_df2 %>%
  mutate(
    # Set test, site, priority, and setting as factors
    Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
    Site = droplevels(factor(Site, levels = city_sites, ordered = TRUE)),
    DashboardPriority = droplevels(factor(DashboardPriority,
                                          levels = dashboard_priority_order,
                                          ordered = TRUE)),
    PtSetting = droplevels(factor(PtSetting,
                                         levels = pt_setting_order,
                                         ordered = TRUE)),
    #
    ResultedLabs = ifelse(is.na(ResultedLabs), 0, ResultedLabs),
    TestAndPriority = paste(Test, "-", DashboardPriority, "Labs"))

lab_vol_df_cast <- dcast(lab_vol_df2, 
                         Test +
                           DashboardPriority +
                           TestAndPriority +
                           PtSetting ~
                           Site,
                         value.var = "ResultedLabs")

lab_vol_df_cast <- lab_vol_df_cast[, c(3:ncol(lab_vol_df_cast))]


summarizeLabDivVol <- function(x, LabDivision) {
  # Subset data to be included based on lab division and site location
  lab_div_vol_df <- x %>%
    filter(Division == LabDivision & Site %in% city_sites) %>%
    group_by(Site, Test, DashboardPriority, MasterSetting) %>%
    summarize(ResultedLabs = sum(TotalResulted), .groups = "keep")
  #
  # Subset volume dataframe template for this division
  lab_div_vol_templ <- vol_dashboard_templ %>%
    filter(Division == LabDivision) %>%
    mutate(Incl = NULL)
  #
  # Combine two dataframes to ensure all combinations are accounts for
  lab_div_vol_df <- left_join(lab_div_vol_templ, lab_div_vol_df,
                              by = c("Test" = "Test",
                                     "Site" = "Site",
                                     "DashboardPriority" = "DashboardPriority",
                                     "PtSetting" = "MasterSetting"))
  #
  lab_div_vol_df <- lab_div_vol_df %>%
    mutate(
    # Set test, site, priority, and setting as factors
    Test = droplevels(factor(Test, levels = test_names, ordered = TRUE)),
    Site = droplevels(factor(Site, levels = city_sites, ordered = TRUE)),
    DashboardPriority = droplevels(factor(DashboardPriority,
                                          levels = dashboard_priority_order,
                                          ordered = TRUE)),
    PtSetting = droplevels(factor(PtSetting,
                                         levels = pt_setting_order,
                                         ordered = TRUE)),
    #
    # Replace NA with 0
    ResultedLabs = ifelse(is.na(ResultedLabs), 0, ResultedLabs),
    #
    # Create column with test name and priority
    TestAndPriority = paste(Test, "-", DashboardPriority, "Labs"))
  #
  # Cast dataframe
  lab_div_vol_cast <- dcast(lab_div_vol_df,
                            Test +
                              DashboardPriority +
                              TestAndPriority +
                              PtSetting ~
                              Site,
                            value.var = "ResultedLabs")
  # Remove test and priority columns
  lab_div_vol_cast <- lab_div_vol_cast[, c(3:ncol(lab_div_vol_cast))]
  #
  return(lab_div_vol_cast)
}


kableChemHemVol <- function(x) {
  kable(x, format = "html", escape = FALSE, align = "c", 
        col.names = c("Test & Priority", "Setting", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11) %>%
  column_spec(column = c(1, 8), border_right = "thin solid lightgray") %>%
  add_header_above(c(" " = 1, "Resulted Lab Volume" = (ncol(x)-1)), background = c("white", "#00AEEF"), color = "white", line = FALSE, font_size = 13) %>%
  column_spec(column = 2:8, background = "#E6F8FF", color = "black") %>%
  #column_spec(column = 2:8, background = "inherit", color = "inherit") %>%
  # column_spec(column = 1, width_min = "125px", include_thead = TRUE) %>%
  # column_spec(column = c(3, 11), width_min = "100px", include_thead = TRUE) %>%
  row_spec(row = 0, font_size = 13) %>%
  collapse_rows(columns = c(1, 2))
}

kableChemHemVol(summarizeLabDivVol(x = cp_wday_summary,
                   LabDivision = "Chemistry"))

kableChemHemVol(summarizeLabDivVol(x = cp_wday_summary,
                   LabDivision = "Hematology"))

```









