---
title: "MSHS Laboratory KPI Dashboard"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---


```{r include = FALSE}
#Install packages only the first time you run the code
# install.packages("timeDate")
# install.packages("lubridate")
# install.packages("readxl")
# install.packages("dplyr")
# install.packages("reshape2")
# install.packages("knitr")
# install.packages("gdtools")
# install.packages("kableExtra")
# install.packages("formattable")
# install.packages("bizdays")
# install.packages("rmarkdown")
# install.packages("stringr")
# install.packages("writexl")

#-------------------------------Required packages------------------------------#

#Required packages: run these every time you run the code
library(timeDate)
library(readxl)
library(bizdays)
library(dplyr)
library(lubridate)
library(reshape2)
library(knitr)
# library(gdtools)
library(kableExtra)
library(formattable)
library(rmarkdown)
library(stringr)
library(writexl)


```


<h4><span style = "color:red">Draft - Not For Distribution</h4></span style = "color:red">


```{r global_options, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r Determine date, warning = FALSE, message = FALSE, echo = FALSE}
#Clear existing history
rm(list = ls())
#-------------------------------holiday/weekend-------------------------------#
# Get today and yesterday's date

Today <- as.timeDate(format(Sys.Date(), "%m/%d/%Y"))
# Today <- as.timeDate(as.Date("12/10/2020", format = "%m/%d/%Y"))


#Determine if yesterday was a holiday/weekend
#get yesterday's DOW
Yesterday <- as.timeDate(format(Sys.Date() - 1, "%m/%d/%Y"))
# Yesterday <- as.timeDate(as.Date("12/9/2020", format = "%m/%d/%Y"))

#Get yesterday's DOW
Yesterday_Day <- dayOfWeek(Yesterday)

#Remove Good Friday from MSHS Holidays
NYSE_Holidays <- as.Date(holidayNYSE(year = 1990:2100))
GoodFriday <- as.Date(GoodFriday())
MSHS_Holiday <- NYSE_Holidays[GoodFriday != NYSE_Holidays]

#Determine whether yesterday was a holiday/weekend
Holiday_Det <- isHoliday(Yesterday, holidays = MSHS_Holiday)

#Set up a calendar for collect to received TAT calculations for Path & Cyto
create.calendar("MSHS_working_days", MSHS_Holiday,
                weekdays = c("saturday", "sunday"))
bizdays.options$set(default.calendar = "MSHS_working_days")
```

#### *Dashboard Creation Date: `r format(Today, "%m/%d/%Y")`*

```{r Import all data, warning = FALSE, message = FALSE, echo = FALSE}
# Select file/folder path for easier file selection and navigation
# user_wd <- choose.dir(caption = "Select your working directory")
#user_wd <- "J:\\deans\\Presidents\\HSPI-PM\\Operations Analytics and Optimization\\Projects\\Service Lines\\Lab KPI\\Data"
#user_path <- paste0(user_wd, "\\*.*")

if (list.files("J://") == "Presidents") {
  user_directory <- paste0("J:/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "Service Lines/Lab Kpi/Data")
} else {
  user_directory <- paste0("J:/deans/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/", 
                           "Service Lines/Lab Kpi/Data")
}
user_path <- paste0(user_directory, "/*.*")


#------------------------------Read Excel sheets------------------------------#

# The if-statement below determines the number of raw data files to import
# based on the day of week and holidays. The user is then prompted to select
# each file from the relevant folder.

if (((Holiday_Det) & (Yesterday_Day == "Mon")) |
   ((Yesterday_Day == "Sun") & (isHoliday(Yesterday - (86400*2))))) { 
  # Scenario 1: Mon Holiday or Friday Holiday (Need to select 4 files)
  # Save scenario
  scenario <- 1
  # Import SCC data
  SCC_Holiday_Monday_or_Friday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on 
                 Recent Holiday"), 
    sheet = 1, col_names = TRUE)
  SCC_Sunday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on Sunday"), 
    sheet = 1, col_names = TRUE)
  SCC_Saturday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on Saturday"), 
    sheet = 1, col_names = TRUE)
  #Merge the weekend data with the holiday data in one data frame
  SCC_Not_Weekday <- rbind(SCC_Holiday_Monday_or_Friday, 
                           SCC_Sunday, 
                           SCC_Saturday)
  SCC_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on 
                 Most Recent Weekday"), 
    sheet = 1, col_names = TRUE)
  # 
  # Import Sunquest data
  SQ_Holiday_Monday_or_Friday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Recent Holiday"), 
    sheet = 1, col_names = TRUE))
  SQ_Sunday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Sunday"), 
    sheet = 1, col_names = TRUE))
  SQ_Saturday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Saturday"), 
    sheet = 1, col_names = TRUE))
  #Merge the weekend data with the holiday data in one data frame
  SQ_Not_Weekday <- rbind(SQ_Holiday_Monday_or_Friday, SQ_Sunday, SQ_Saturday)
  SQ_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE))
  # #
  # # Import Powerpath data
  # PP_Holiday_Monday_or_Friday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Recent Holiday"), 
  #   skip = 1, 1)
  # PP_Holiday_Monday_or_Friday  <- PP_Holiday_Monday_or_Friday[
  #   -nrow(PP_Holiday_Monday_or_Friday), ]
  # PP_Sunday <- read_excel(
  #   choose.files(default = paste0(user_directory,
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Sunday"), 
  #   skip = 1, 1)
  # PP_Sunday <- PP_Sunday[-nrow(PP_Sunday), ]
  # PP_Saturday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Saturday"), 
  #   skip = 1, 1)
  # PP_Saturday <- PP_Saturday[-nrow(PP_Saturday), ]
  # #Merge the weekend data with the holiday data in one data frame
  # PP_Not_Weekday <- data.frame(rbind(PP_Holiday_Monday_or_Friday, 
  #                                    PP_Sunday, 
  #                                    PP_Saturday), stringsAsFactors = FALSE)
  # PP_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"),
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Most Recent Weekday"),
  #   skip = 1, 1)
  # PP_Weekday <- data.frame(PP_Weekday[-nrow(PP_Weekday), ], 
  #                          stringsAsFactors = FALSE)
  # #
  # # Import EPIC Cytology data
  # Epic_Holiday_Monday_or_Friday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Recent Holiday"), 1)
  # Epic_Sunday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Sunday"), 1)
  # Epic_Saturday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Saturday"), 1)
  # #Merge the weekend data with the holiday data in one data frame
  # Epic_Not_Weekday <- data.frame(rbind(Epic_Holiday_Monday_or_Friday, 
  #                                      Epic_Sunday, 
  #                                      Epic_Saturday),stringsAsFactors = FALSE)
  # Epic_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 1)
} else if ((Holiday_Det) & (Yesterday_Day == "Sun")){
  # Scenario 2: Regular Monday (Need to select 3 files)
  # Save scenario
  scenario <- 2
  #
  # Import SCC data
  SCC_Sunday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on Sunday"), 
    sheet = 1, col_names = TRUE)
  SCC_Saturday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted on Saturday"), 
    sheet = 1, col_names = TRUE)
  #Merge the weekend data with the holiday data in one data frame
  SCC_Not_Weekday <- rbind(SCC_Sunday, SCC_Saturday)
  SCC_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE)
  #
  # Import Sunquest data
  SQ_Sunday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Sunday"), 
    sheet = 1, col_names = TRUE))
  SQ_Saturday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Saturday"), 
    sheet = 1, col_names = TRUE))
  #Merge the weekend data with the holiday data in one data frame
  SQ_Not_Weekday <- rbind(SQ_Sunday,SQ_Saturday)
  SQ_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE))
  #
  # # Import Powerpath data
  # PP_Sunday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Sunday"), 
  #   skip = 1, 1)
  # PP_Sunday <- PP_Sunday[-nrow(PP_Sunday), ]
  # PP_Saturday <- read_excel(
  #   choose.files(default = paste0(user_directory,
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Saturday"),
  #   skip = 1, 1)
  # PP_Saturday <- PP_Saturday[-nrow(PP_Saturday), ]
  # #Merge the weekend data with the holiday data in one data frame
  # PP_Not_Weekday <- data.frame(rbind(PP_Sunday, 
  #                                    PP_Saturday), stringsAsFactors = FALSE)
  # PP_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   skip = 1, 1)
  # PP_Weekday <- data.frame(PP_Weekday[-nrow(PP_Weekday), ], 
  #                          stringsAsFactors = FALSE)
  # #
  # # Import Epic Cytology data
  # Epic_Sunday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Sunday"), 
  #   1)
  # Epic_Saturday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Saturday"), 
  #   1)
  # #Merge the weekend data with the holiday data in one data frame
  # Epic_Not_Weekday <- data.frame(rbind(Epic_Sunday, 
  #                                      Epic_Saturday), 
  #                                stringsAsFactors = FALSE)
  # Epic_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   1)
} else if ((Holiday_Det) & ((Yesterday_Day != "Mon") | 
                            (Yesterday_Day != "Sun"))){ 
  #Scenario 3: Midweek holiday (Need to select 2 files)
  # Save scenario
  scenario <- 3
  #
  # Import SCC data
  SCC_Holiday_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted 
                 on Recent Holiday"), 
    sheet = 1, col_names = TRUE)
  SCC_Not_Weekday <- SCC_Holiday_Weekday
  SCC_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE)
  #
  # Import Sunquest data
  SQ_Holiday_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Recent Holiday"), 
    sheet = 1, col_names = TRUE))
  SQ_Not_Weekday <- SQ_Holiday_Weekday
  SQ_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select Sunquest Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE))
  #
  # # Import Powerpath data
  # PP_Holiday_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Recent Holiday"), 
  #   skip = 1, 1)
  # PP_Holiday_Weekday <- PP_Holiday_Weekday[-nrow(PP_Holiday_Weekday), ]
  # PP_Not_Weekday <- data.frame(PP_Holiday_Weekday, stringsAsFactors = FALSE)
  # PP_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   skip = 1, 1)
  # PP_Weekday <- data.frame(PP_Weekday[-nrow(PP_Weekday), ], 
  #                          stringsAsFactors = FALSE)
  # #
  # # Import Powerpath data
  # Epic_Holiday_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Recent Holiday"), 
  #   1)
  # Epic_Not_Weekday <- data.frame(Epic_Holiday_Weekday, stringsAsFactors = FALSE)
  # Epic_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   1)
} else { #Scenario 4: Tue-Fri without holidays (Need to select 1 file)
  # Save scenario
  scenario <- 4
  #
  # Import SCC data
  SCC_Weekday <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"), 
                 caption = "Select SCC Report for Labs Resulted 
                 on Most Recent Weekday"), 
    sheet = 1, col_names = TRUE)
  SCC_Not_Weekday <- NULL
  #
  # Import Sunquest data
  SQ_Weekday <- suppressWarnings(read_excel(
    choose.files(default = paste0(user_directory, "/SUN CP Reports/*.*"), 
                 caption = "Select SunQuest Report for Labs Resulted 
                 n Most Recent Weekday"), 
    sheet = 1, col_names = TRUE))
  SQ_Not_Weekday <- NULL
  #
  # # Import Powerpath data
  # PP_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, 
  #                                 "/AP & Cytology Signed Cases Reports/*.*"), 
  #                caption = "Select PowerPath Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   skip = 1, 1)
  # PP_Weekday <- data.frame(PP_Weekday[-nrow(PP_Weekday), ], 
  #                          stringsAsFactors = FALSE)
  # PP_Not_Weekday <- NULL
  # #
  # # Import Epic Cytology data
  # Epic_Weekday <- read_excel(
  #   choose.files(default = paste0(user_directory, "/EPIC Cytology/*.*"), 
  #                caption = "Select Epic Report for Specimens Signed Out 
  #                on Most Recent Weekday"), 
  #   1)
  # Epic_Not_Weekday <- NULL
}

# #-----------Cytology Backlog Excel Files-----------#
# #For the backlog files the read excel is starting from the second row and remove last row
# Cytology_Backlog_Raw <- read_excel(
#   choose.files(default = paste0(user_directory, 
#                                 "/Cytology Backlog Reports/*.*"), 
#                caption = "Select Cytology Backlog Report"), 
#   skip =1, 1)
# Cytology_Backlog_Raw <- data.frame(
#   Cytology_Backlog_Raw[-nrow(Cytology_Backlog_Raw), ], stringsAsFactors = FALSE)
```

```{r Reference Data, warning = FALSE, message = FALSE, echo = FALSE}
# CP and Micro --------------------------------
# Import analysis reference data starting with test codes for SCC and Sunquest
reference_file <- choose.files(
  default = paste0(user_directory, "/Code Reference/*.*"), 
  caption = "Select analysis reference file")

test_code <- read_excel(reference_file, sheet = "TestNames")

tat_targets <- read_excel(reference_file, sheet = "Turnaround Targets")
tat_targets$Concate <- ifelse(tat_targets$Priority == "All" & 
                                tat_targets$`Pt Setting` == "All", 
                              tat_targets$Test,
                              ifelse(tat_targets$Priority != "All" & 
                                       tat_targets$`Pt Setting` == "All", 
                                     paste(tat_targets$Test, 
                                           tat_targets$Priority),
                                     paste(tat_targets$Test, 
                                           tat_targets$Priority, 
                                           tat_targets$`Pt Setting`)))

scc_icu <- read_excel(reference_file, sheet = "SCC_ICU")
scc_setting <- read_excel(reference_file, sheet = "SCC_ClinicType")
sun_icu <- read_excel(reference_file, sheet = "SUN_ICU")
sun_setting <- read_excel(reference_file, sheet = "SUN_LocType")

mshs_site <- read_excel(reference_file, sheet = "SiteNames")

scc_wday <- SCC_Weekday
sun_wday <- SQ_Weekday

cp_micro_lab_order <- c("Troponin", "Lactate WB", "BUN", "HGB", "PT", "Rapid Flu", "C. diff")

site_order <- c("MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM", "MSSN")

pt_setting_order <- c("ED", "ICU", "IP Non-ICU", "Amb", "Other")
pt_setting_order2 <- c("ED & ICU", "IP Non-ICU", "Amb", "Other")
dashboard_pt_setting <- c("ED & ICU", "IP Non-ICU", "Amb")

dashboard_priority_order <- c("All", "Stat", "Routine")

# # To Be Updated in Analysis reference file
# #-----------Patient Setting Excel File-----------#
# #Using Rev Center to determine patient setting
# Patient_Setting <- data.frame(read_excel(reference_file, 
#                                          sheet = "AP_Patient Setting"), 
#                               stringsAsFactors = FALSE)
# 
# #-----------Anatomic Pathology Targets Excel File-----------#
# TAT_Targets <- data.frame(read_excel(reference_file, 
#                                      sheet = "AP_TAT Targets"), 
#                           stringsAsFactors = FALSE)
# 
# #-----------GI Codes Excel File-----------#
# #Upload the exclusion vs inclusion criteria associated with the GI codes
# GI_Codes <- data.frame(read_excel(reference_file, sheet = "GI_Codes"), 
#                        stringsAsFactors = FALSE)
# 
# #-----------Create table template for Cyto/Path-----------#
# 
# #Cyto
# Table_Template_Cyto <- data.frame(matrix(ncol=19, nrow = 4))
# colnames(Table_Template_Cyto) <- c("spec_group", "Patient.Setting",
#                                    "No_Cases_Signed", 
#                                    "MSH.x", "BIMC.x", "MSQ.x","NYEE.x", 
#                                    "PACC.x", "R.x", "SL.x", "KH.x", "BIMC.y", 
#                                    "MSH.y", "MSQ.y", "NYEE.y", "PACC.y", "R.y", 
#                                    "SL.y", "KH.y")
# Table_Template_Cyto[1] <- c('CYTO GYN','CYTO GYN','CYTO NONGYN', 'CYTO NONGYN')
# Table_Template_Cyto[2] <- c('IP', 'Amb')
# 
# Table_Template_Cyto_V2 <- data.frame(matrix(ncol=12, nrow = 4))
# colnames(Table_Template_Cyto_V2) <- c("spec_group", "Patient.Setting",
#                                       "No_Cases_Signed", 
#                                       "Received_to_Signed_Out_within_target", 
#                                       "BIMC", "MSH", "MSQ", "NYEE", "PACC", 
#                                       "R", "SL", "KH")
# Table_Template_Cyto_V2[1] <- c('CYTO GYN', 'CYTO GYN', 
#                                'CYTO NONGYN', 'CYTO NONGYN')
# Table_Template_Cyto_V2[2] <- c('IP', 'Amb')
# 
# Table_Template_Cyto_Vol <- data.frame(matrix(ncol=10, nrow = 4))
# colnames(Table_Template_Cyto_Vol) <- c("spec_group", "Patient.Setting", 
#                                        "BIMC", "MSH", "MSQ", "NYEE", "PACC", 
#                                        "R", "SL", "KH")
# Table_Template_Cyto_Vol[1] <- c('CYTO GYN', 'CYTO GYN', 
#                                 'CYTO NONGYN', 'CYTO NONGYN')
# Table_Template_Cyto_Vol[2] <- c('IP', 'Amb')
# 
# #Patho
# Table_Template_Patho <- data.frame(matrix(ncol=17, nrow = 4))
# colnames(Table_Template_Patho) <- c("spec_group", "Patient.Setting", 
#                                     "No_Cases_Signed", 
#                                     "MSH.x", "BIMC.x", "MSQ.x", "PACC.x", 
#                                     "R.x", "SL.x", "KH.x", "BIMC.y", "MSH.y", 
#                                     "MSQ.y", "PACC.y", "R.y", "SL.y", "KH.y")
# Table_Template_Patho[1] <- c('Breast', 'Breast', 'GI', 'GI')
# Table_Template_Patho[2] <- c('IP', 'Amb')
# 
# Table_Template_Patho_Vol <- data.frame(matrix(ncol=9, nrow = 4))
# colnames(Table_Template_Patho_Vol) <- c("spec_group", "Patient.Setting", 
#                                         "BIMC", "MSH", "MSQ", "PACC", 
#                                         "R", "SL", "KH")
# Table_Template_Patho_Vol[1] <- c('Breast', 'Breast', 'GI', 'GI')
# Table_Template_Patho_Vol[2] <- c('IP', 'Amb')
```


```{r Original Custom Function for preprocessing raw SCC and Sunquest data, warning = FALSE, message = FALSE, echo = FALSE}
preprocess_scc_sun <- function(raw_scc, raw_sun)  {
 
# SCC DATA PROCESSING --------------------------
  # SCC lookup references ----------------------------------------------
  # Crosswalk labs included and remove out of scope labs
  raw_scc <- left_join(raw_scc, 
                       test_code[ , c("Test", "SCC_TestID", "Division")], 
                       by = c("TEST_ID" = "SCC_TestID"))
  raw_scc$TEST_ID <- as.factor(raw_scc$TEST_ID)
  raw_scc$Division <- as.factor(raw_scc$Division)

  raw_scc <- raw_scc %>%
    mutate(TestIncl = ifelse(is.na(raw_scc$Test), FALSE, TRUE))
  
  raw_scc <- raw_scc %>%
    filter(TestIncl)
  
  # Crosswalk units and identify ICUs
  raw_scc <- raw_scc %>%
    mutate(WardandName = paste(Ward, WARD_NAME))
  
  raw_scc <- left_join(raw_scc, scc_icu[ , c("Concatenate", "ICU")], 
                       by = c("WardandName" = "Concatenate"))
  raw_scc[is.na(raw_scc$ICU), "ICU"] <- FALSE
  
  # Crosswalk unit type
  raw_scc <- left_join(raw_scc, scc_setting, 
                       by = c("CLINIC_TYPE" = "Clinic_Type"))
  # Crosswalk site name
  raw_scc <- left_join(raw_scc, mshs_site, 
                       by = c("SITE" = "DataSite"))
  
  # SCC data formatting ----------------------------------------------
  raw_scc[c("Ward", 
            "WARD_NAME", 
            "REQUESTING_DOC",
            "GROUP_TEST_ID",
            "TEST_ID",
            "TEST_NAME",
            "Test",
            "COLLECT_CENTER_ID",
            "SITE",
            "Site",
            "CLINIC_TYPE",
            "Setting",
            "SettingRollUp")] <- lapply(raw_scc[c("Ward",
                                                  "WARD_NAME",
                                                  "REQUESTING_DOC", 
                                                  "GROUP_TEST_ID",
                                                  "TEST_ID", 
                                                  "TEST_NAME", 
                                                  "Test",
                                                  "COLLECT_CENTER_ID",
                                                  "SITE",
                                                  "Site",
                                                  "CLINIC_TYPE",
                                                  "Setting",
                                                  "SettingRollUp")], 
                                        as.factor)
  
  # Fix any timestamps that weren't imported correctly and then format as date/time
  raw_scc[c("ORDERING_DATE", 
            "COLLECTION_DATE", 
            "RECEIVE_DATE", 
            "VERIFIED_DATE")] <- lapply(raw_scc[c("ORDERING_DATE", 
                                                  "COLLECTION_DATE", 
                                                  "RECEIVE_DATE", 
                                                  "VERIFIED_DATE")], 
           function(x) ifelse(!is.na(x) & str_detect(x, "\\*.*\\*")  == TRUE, 
                              str_replace(x, "\\*.*\\*", ""), x))
  
  raw_scc[c("ORDERING_DATE",
            "COLLECTION_DATE",
            "RECEIVE_DATE",
            "VERIFIED_DATE")] <- lapply(raw_scc[c("ORDERING_DATE",
                                                  "COLLECTION_DATE",
                                                  "RECEIVE_DATE",
                                                  "VERIFIED_DATE")], 
           as.POSIXct, tz = "UTC", format = "%Y-%m-%d %H:%M:%OS", 
           options(digits.sec = 1))
  
  # Add a column for Resulted date for later use in repository
  raw_scc <- raw_scc %>%
    mutate(ResultedDate = as.Date(VERIFIED_DATE, format = "%m/%d/%Y"))
  
  # Update patient setting to reflect ICU/Non-ICU and 
  # update priorities for ED and ICU labs
  raw_scc <- raw_scc %>%
    mutate(MasterSetting = ifelse(CLINIC_TYPE == "E", "ED", 
                                  ifelse(CLINIC_TYPE == "O", "Amb", 
                                         ifelse(CLINIC_TYPE == "I" & 
                                                  ICU == TRUE, "ICU",
                                                ifelse(CLINIC_TYPE == "I" & 
                                                         ICU != TRUE, 
                                                       "IP Non-ICU", 
                                                       "Other")))),
           DashboardSetting = ifelse(MasterSetting == "ED" | 
                                       MasterSetting == "ICU", "ED & ICU", 
                                     MasterSetting))
  
  # Update priority to reflect ED/ICU as stat and create Master Priority 
  # for labs where all specimens are treated as stat
  raw_scc <- raw_scc %>%
    mutate(AdjPriority = ifelse(MasterSetting == "ED" | 
                                  MasterSetting == "ICU" | PRIORITY == "S", 
                                "Stat", "Routine"),
           DashboardPriority = ifelse(
             tat_targets$Priority[match(Test, tat_targets$Test)] == "All", 
                                      "All", AdjPriority))

  # Calculate turnaround times
  raw_scc <- raw_scc %>%
    mutate(CollectToReceive = RECEIVE_DATE - COLLECTION_DATE,
           ReceiveToResult = VERIFIED_DATE - RECEIVE_DATE,
           CollectToResult = VERIFIED_DATE - COLLECTION_DATE)
  
  raw_scc[c("CollectToReceive", "ReceiveToResult", "CollectToResult")] <- 
    lapply(raw_scc[c("CollectToReceive", "ReceiveToResult", "CollectToResult")], 
           as.numeric, units = "mins")
  
  # Identify add on orders as orders placed more than 5 min 
  # after specimen received
  # Identify specimens with missing collections times as those with 
  # collection time defaulted to receive time
  raw_scc <- raw_scc %>%
    mutate(AddOnMaster = ifelse(difftime(ORDERING_DATE, 
                                         RECEIVE_DATE, units = "mins") > 5, 
                                "AddOn", "Original"),
           MissingCollect = ifelse(CollectToReceive == 0, TRUE, FALSE))
  
  # Determine target TAT based on test, priority, and patient setting
  raw_scc <- raw_scc %>%
    mutate(Concate1 = paste(Test, DashboardPriority),
           Concate2 = paste(Test, DashboardPriority, MasterSetting),
           ReceiveResultTarget = ifelse(
             !is.na(match(Concate2, tat_targets$Concate)),
             tat_targets$ReceiveToResultTarget[match(Concate2, 
                                                     tat_targets$Concate)],
             ifelse(!is.na(match(Concate1, tat_targets$Concate)), 
                    tat_targets$ReceiveToResultTarget[match(Concate1, 
                                                            tat_targets$Concate)],
                    tat_targets$ReceiveToResultTarget[match(Test, 
                                                            tat_targets$Concate)])),
           CollectResultTarget = ifelse(
             !is.na(match(Concate2, tat_targets$Concate)),
             tat_targets$CollectToResultTarget[match(Concate2, 
                                                     tat_targets$Concate)], 
             ifelse(!is.na(match(Concate1, tat_targets$Concate)), 
                    tat_targets$CollectToResultTarget[match(Concate1, 
                                                            tat_targets$Concate)], 
                    tat_targets$CollectToResultTarget[match(Test, 
                                                            tat_targets$Concate)])),
           ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget, 
           CollectResultInTarget = CollectToResult <= CollectResultTarget)
  
  # Identify and remove duplicate tests
  raw_scc <- raw_scc %>%
    mutate(Concate3 = paste(LAST_NAME, FIRST_NAME,
                            ORDER_ID, TEST_NAME, 
                            COLLECTION_DATE, RECEIVE_DATE, VERIFIED_DATE))
  
  raw_scc <- raw_scc[!duplicated(raw_scc$Concate3), ]
  
  # Identify which labs to include in TAT analysis
  # Exclude add on orders, orders from "other" settings, orders with collect or 
  # receive times after result, or orders with missing collect, receive, or 
  # result timestamps
  raw_scc <- raw_scc %>% 
    mutate(TATInclude = ifelse(AddOnMaster != "Original" | 
                                 MasterSetting == "Other" | 
                                 CollectToResult < 0 | 
                                 ReceiveToResult < 0 | 
                                 is.na(CollectToResult) | 
                                 is.na(ReceiveToResult), FALSE, TRUE))

  scc_master <- raw_scc[ , c("Ward", "WARD_NAME", "WardandName",
                             "ORDER_ID", "REQUESTING_DOC NAME", 
                             "MPI", "WORK SHIFT",
                             "TEST_NAME", "Test", "Division", "PRIORITY", 
                             "Site", "ICU", "CLINIC_TYPE", 
                             "Setting", "SettingRollUp", 
                             "MasterSetting", "DashboardSetting",
                             "AdjPriority", "DashboardPriority",
                             "ORDERING_DATE", "COLLECTION_DATE", 
                             "RECEIVE_DATE", "VERIFIED_DATE",
                             "ResultedDate", 
                             "CollectToReceive", "ReceiveToResult", 
                             "CollectToResult", 
                             "AddOnMaster", "MissingCollect", 
                             "ReceiveResultTarget", "CollectResultTarget", 
                             "ReceiveResultInTarget", "CollectResultInTarget", 
                             "TATInclude")]
  
  colnames(scc_master) <- c("LocCode", "LocName", "LocConcat",
                            "OrderID", "RequestMD", 
                            "MSMRN", "WorkShift", 
                            "TestName", "Test", "Division", "OrderPriority", 
                            "Site", "ICU", "LocType", 
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting",
                            "AdjPriority", "DashboardPriority",
                            "OrderTime", "CollectTime", 
                            "ReceiveTime", "ResultTime", 
                            "ResultDate", 
                            "CollectToReceiveTAT", "ReceiveToResultTAT", 
                            "CollectToResultTAT", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")

  
  ## SUNQUEST DATA PROCESSING ----------
  # Sunquest lookup references ----------------------------------------------
  # Crosswalk labs included and remove out of scope labs
  raw_sun <- left_join(raw_sun, test_code[ , c("Test", 
                                               "SUN_TestCode", 
                                               "Division")], 
                       by = c("TestCode" = "SUN_TestCode"))
  raw_sun$TestCode <- as.factor(raw_sun$TestCode)
  raw_sun$Division <- as.factor(raw_sun$Division)
  raw_sun <- raw_sun %>%
    mutate(TestIncl = ifelse(is.na(Test), FALSE, TRUE))
  
  raw_sun <- raw_sun[raw_sun$TestIncl == TRUE, ]
  
  # Crosswalk units and identify ICUs
  raw_sun <- raw_sun %>%
    mutate(LocandName = paste(LocCode, LocName))
  
  raw_sun <- left_join(raw_sun, sun_icu[ , c("Concatenate", "ICU")], 
                       by = c("LocandName" = "Concatenate"))
  raw_sun[is.na(raw_sun$ICU), "ICU"] <- FALSE
  
  # Crosswalk unit type
  raw_sun <- left_join(raw_sun, sun_setting, by = c("LocType" = "LocType"))
  
  # Crosswalk site name
  raw_sun <- left_join(raw_sun, mshs_site, by = c("HospCode" = "DataSite"))
  #Asala Added this to tackle the issue of the other site temporarly until Kate comes back
  # raw_sun <- inner_join(raw_sun, mshs_site, by = c("HospCode" = "DataSite"))

  # Sunquest data formatting --------------------------------------------
  raw_sun[c("HospCode", "BatTstCode", "BATName", "TestCode", "TSTName",
             "LocType", "LocCode", "LocName", 
             "PhysName", "SHIFT",
             "ReceiveTech", "ResultTech", "PerformingLabCode",
             "Test", "LocandName", "Setting", "SettingRollUp", "Site")] <- 
    lapply(raw_sun[c("HospCode", "BatTstCode", "BATName", "TestCode", "TSTName",
                     "LocType", "LocCode", "LocName", 
                     "PhysName", "SHIFT", 
                     "ReceiveTech", "ResultTech", "PerformingLabCode", 
                     "Test", "LocandName", "Setting", "SettingRollUp", "Site")],
           as.factor)
  
  # Fix any timestamps that weren't imported correctly and then format as date/time
  raw_sun[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")], 
           function(x) ifelse(!is.na(x) & str_detect(x, "\\*.*\\*")  == TRUE, 
                              str_replace(x, "\\*.*\\*", ""), x))

  raw_sun[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")], 
           as.POSIXct, tz = "UTC", format = "%m/%d/%Y %H:%M:%S")
  
  # Add a column for Resulted date for later use in repository
  raw_sun <- raw_sun %>%
    mutate(ResultedDate = as.Date(ResultDateTime, format = "%m/%d/%Y"))

  # Sunquest data preprocessing -----------------------------------------------
  # Update patient setting to reflect ICU/Non-ICU and update priorities for 
  # ED and ICU labs
  raw_sun <- raw_sun %>%
    mutate(MasterSetting = ifelse(SettingRollUp == "ED", "ED", 
                                  ifelse(SettingRollUp == "Amb", "Amb", 
                                         ifelse(SettingRollUp == "IP" & 
                                                  ICU == TRUE, "ICU",
                                                ifelse(SettingRollUp == "IP" & 
                                                         ICU == FALSE, 
                                                       "IP Non-ICU", "Other")))), 
           DashboardSetting = ifelse(MasterSetting == "ED" | 
                                       MasterSetting == "ICU", "ED & ICU", 
                                     MasterSetting))
  
  # Update priority to reflect ED/ICU as stat and create Master Priority for 
  # labs where all specimens are treated as stat
  raw_sun <- raw_sun %>%
    mutate(AdjPriority = ifelse(MasterSetting != "ED" & MasterSetting != "ICU" &
                                  is.na(SpecimenPriority), "Routine",
                                ifelse(MasterSetting == "ED" | 
                                         MasterSetting == "ICU" | 
                                         SpecimenPriority == "S", "Stat", 
                                       "Routine")),
           DashboardPriority = ifelse(tat_targets$Priority[match(
             Test, tat_targets$Test)] == "All", "All", AdjPriority))

  # Calculate turnaround times
  raw_sun <- raw_sun %>%
    mutate(CollectToReceive = ReceiveDateTime - CollectDateTime,
           ReceiveToResult = ResultDateTime - ReceiveDateTime,
           CollectToResult = ResultDateTime - CollectDateTime)
  
  raw_sun[c("CollectToReceive", "ReceiveToResult", "CollectToResult")] <- 
    lapply(raw_sun[c("CollectToReceive", "ReceiveToResult", "CollectToResult")], 
           as.numeric, units = "mins")
  
  # Identify add on orders as orders placed more than 5 min after 
  # specimen received. 
  # Identify specimens with missing collections times as those with collection 
  # time defaulted to order time
  raw_sun <- raw_sun %>%
    mutate(AddOnMaster = ifelse(difftime(OrderDateTime, ReceiveDateTime, 
                                         units = "mins") > 5, "AddOn", 
                                "Original"),
           MissingCollect = ifelse(CollectDateTime == OrderDateTime, TRUE, 
                                   FALSE))
  
  # Determine target TAT based on test, priority, and patient setting
  raw_sun <- raw_sun %>%
    mutate(Concate1 = paste(Test, DashboardPriority), 
           Concate2 = paste(Test, DashboardPriority, MasterSetting),
           ReceiveResultTarget = ifelse(!is.na(match(Concate2, 
                                                     tat_targets$Concate)), 
                                        tat_targets$ReceiveToResultTarget[
                                          match(Concate2, tat_targets$Concate)], 
                                        ifelse(!is.na(match(Concate1,
                                                            tat_targets$Concate)),
                                               tat_targets$ReceiveToResultTarget[
                                                 match(Concate1, 
                                                       tat_targets$Concate)],
                                               tat_targets$ReceiveToResultTarget[
                                                 match(Test, 
                                                       tat_targets$Concate)])),
           CollectResultTarget = ifelse(!is.na(match(Concate2, 
                                                     tat_targets$Concate)), 
                                        tat_targets$CollectToResultTarget[
                                          match(Concate2, tat_targets$Concate)], 
                                        ifelse(!is.na(match(Concate1, 
                                                            tat_targets$Concate)), 
                                               tat_targets$CollectToResultTarget[
                                                 match(Concate1, 
                                                       tat_targets$Concate)], 
                                               tat_targets$CollectToResultTarget[
                                                 match(Test, 
                                                       tat_targets$Concate)])),
           ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget,
           CollectResultInTarget = CollectToResult <= CollectResultTarget)
  
  # Identify and remove duplicate tests
  raw_sun <- raw_sun %>%
    mutate(Concate3 = paste(PtNumber, HISOrderNumber, TSTName, 
                            CollectDateTime, ReceiveDateTime, ResultDateTime))
  
  raw_sun <- raw_sun[!duplicated(raw_sun$Concate3), ]
  
  # Identify which labs to include in TAT analysis
  # Exclude add on orders, orders from "other" settings, orders with collect or 
  # receive times after result, or orders with missing collect, receive, or 
  # result timestamps
  raw_sun <- raw_sun %>%
    mutate(TATInclude = ifelse(AddOnMaster != "Original" | 
                                 MasterSetting == "Other" | 
                                 CollectToResult < 0 | 
                                 ReceiveToResult < 0 | 
                                 is.na(CollectToResult) | 
                                 is.na(ReceiveToResult), FALSE, TRUE))
  
  sun_master <- raw_sun[ ,c("LocCode", "LocName", "LocandName", 
                            "HISOrderNumber", "PhysName", 
                            "PtNumber", "SHIFT",            
                            "TSTName", "Test", "Division", "SpecimenPriority", 
                            "Site", "ICU", "LocType",               
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting", 
                            "AdjPriority", "DashboardPriority", 
                            "OrderDateTime", "CollectDateTime", 
                            "ReceiveDateTime", "ResultDateTime", 
                            "ResultedDate", 
                            "CollecttoReceive", "ReceivetoResult", 
                            "CollecttoResult", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")]
  
  colnames(sun_master) <- c("LocCode", "LocName", "LocConcat", 
                            "OrderID", "RequestMD", 
                            "MSMRN", "WorkShift", 
                            "TestName", "Test", "Division", "OrderPriority", 
                            "Site", "ICU", "LocType", 
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting", 
                            "AdjPriority", "DashboardPriority",
                            "OrderTime", "CollectTime", 
                            "ReceiveTime", "ResultTime", 
                            "ResultDate", 
                            "CollectToReceiveTAT", "ReceiveToResultTAT", 
                            "CollectToResultTAT", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")
  
  
  scc_sun_master <- rbind(scc_master, sun_master)
  
  scc_sun_master[c("LocConcat", "RequestMD", "WorkShift", 
                   "AdjPriority", "AddOnMaster")] <-
    lapply(scc_sun_master[c("LocConcat", "RequestMD", "WorkShift",
                            "AdjPriority", "AddOnMaster")], as.factor)
  
  scc_sun_master$Site <- factor(scc_sun_master$Site, 
                                levels = site_order)
  scc_sun_master$Test <- factor(scc_sun_master$Test, 
                                levels = cp_micro_lab_order)
  scc_sun_master$MasterSetting <- factor(scc_sun_master$MasterSetting, 
                                         levels = pt_setting_order)
  scc_sun_master$DashboardSetting <- factor(scc_sun_master$DashboardSetting, 
                                            levels = pt_setting_order2)
  scc_sun_master$DashboardPriority <- factor(scc_sun_master$DashboardPriority, 
                                             levels = dashboard_priority_order)
  
  scc_sun_list <- list(raw_scc, raw_sun, scc_sun_master)
  
}
```

```{r Analysis without custom function}
raw_scc_test <- scc_wday

# Correct and format any timestamps that were not imported correctly
raw_scc_test[c("ORDERING_DATE", 
            "COLLECTION_DATE", 
            "RECEIVE_DATE", 
            "VERIFIED_DATE")] <-
  lapply(raw_scc_test[c("ORDERING_DATE",
                   "COLLECTION_DATE",
                   "RECEIVE_DATE",
                   "VERIFIED_DATE")],
         function(x)
           ifelse(!is.na(x) & str_detect(x, "\\*.*\\*"),
                  str_replace(x, "\\*.*\\*", ""), x))
                   
raw_scc_test[c("ORDERING_DATE",
          "COLLECTION_DATE",
          "RECEIVE_DATE",
          "VERIFIED_DATE")] <-
  lapply(raw_scc_test[c("ORDERING_DATE",
                   "COLLECTION_DATE",
                   "RECEIVE_DATE",
                   "VERIFIED_DATE")],
         as.POSIXct, tz = "UTC",
         format = "%Y-%m-%d %H:%M:%OS",
         options(digits.sec = 1))

# SCC lookup references ----------------------------------------------
# Crosswalk in scope labs
raw_scc_test <- left_join(raw_scc_test,
                     test_code[ , c("Test", "SCC_TestID", "Division")],
                     by = c("TEST_ID" = "SCC_TestID"))

# Determine if test is included based on crosswalk results
raw_scc_test <- raw_scc_test %>%
  mutate(TestIncl = !is.na(Test)) %>%
  filter(TestIncl)

# Crosswalk unit type
raw_scc_test <- left_join(raw_scc_test, scc_setting,
                     by = c("CLINIC_TYPE" = "Clinic_Type"))
# Crosswalk site name
raw_scc_test <- left_join(raw_scc_test, mshs_site,
                     by = c("SITE" = "DataSite"))

# Crosswalk units and identify ICUs
raw_scc_test <- raw_scc_test %>%
  mutate(WardandName = paste(Ward, WARD_NAME))
  
raw_scc_test <- left_join(raw_scc_test, scc_icu[ , c("Concatenate", "ICU")], 
                       by = c("WardandName" = "Concatenate"))

# Preprocess SCC data and add any necessary columns
raw_scc_test <- raw_scc_test %>%
  mutate(
    # Determine if unit is an ICU based on crosswalk results
    ICU = ifelse(is.na(ICU), FALSE, ICU), 
    # Create a column for resulted date
    ResultedDate = date(VERIFIED_DATE),
    # Create master setting column to identify ICU and IP Non-ICU units
    MasterSetting = ifelse(SettingRollUp == "IP" & ICU, "ICU",
                                 ifelse(SettingRollUp == "IP" & !ICU,
                                        "IP Non-ICU", SettingRollUp)),
    # Create dashboard setting column to roll up master settings based on
    # desired dashboard grouping (ie, group ED and ICU together)
    DashboardSetting = ifelse(MasterSetting %in% c("ED", "ICU"), 
                                    "ED & ICU", MasterSetting),
    # Create column with adjusted priority based on assumption that all ED and
    # ICU labs are treated as stat per operational leadership
    AdjPriority = ifelse(MasterSetting %in% c("ED", "ICU") |
                                   PRIORITY %in% "S", "Stat", "Routine"),
    # Create dashboard priority column 
    DashboardPriority = ifelse(
             tat_targets$Priority[match(Test, tat_targets$Test)] == "All", 
                                      "All", AdjPriority),
    # Calculate turnaround times
    CollectToReceive =
      as.numeric(RECEIVE_DATE - COLLECTION_DATE, units = "mins"),
    ReceiveToResult =
      as.numeric(VERIFIED_DATE - RECEIVE_DATE, units = "mins"),
    CollectToResult =
      as.numeric(VERIFIED_DATE - COLLECTION_DATE, units = "mins"),
    #
    # Determine if order was an add on or original order based on time between
    # order and receive times
    AddOnMaster = ifelse(as.numeric(ORDERING_DATE - RECEIVE_DATE,units = "mins")
                         > 5, "AddOn", "Original"),
    # Determine if collection time is missing
    MissingCollect = CollectToReceive == 0,
    #
    # Determine TAT based on test, priority, and patient setting
    # Create column concatenating test and priority to determine TAT targets
    Concate1 = paste(Test, DashboardPriority),
    # Create column concatenating test, priority, and setting to determine
    # TAT targets
    Concate2 = paste(Test, DashboardPriority, MasterSetting),
    # Determine Receive to Result TAT target using this logic:
    # 1. Try to match test, priority, and setting (applicable for labs with 
    # different TAT targets based on patient setting and order priority)
    # 2. Try to match test and priority (applicable for labs with different
    # TAT targets based on order priority)
    # 3. Try to match test - this is for tests with (applicable for labs with
    # TAT targets that are independent of patient setting or priority)
    #
    # Determine Receive to Result TAT target based on above logic/scenarios
    ReceiveResultTarget =
      # Match on scenario 1
      ifelse(!is.na(match(Concate2, tat_targets$Concate)),
             tat_targets$ReceiveToResultTarget[
               match(Concate2, tat_targets$Concate)],
             # Match on scenario 2
             ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                    tat_targets$ReceiveToResultTarget[
                      match(Concate1, tat_targets$Concate)],
                    # Match on scenario 3
                    tat_targets$ReceiveToResultTarget[
                      match(Test, tat_targets$Concate)])),
    #
    # Determine Collect to Result TAT target based on above logic/scenarios
    CollectResultTarget =
      # Match on scenario 1
      ifelse(!is.na(match(Concate2, tat_targets$Concate)),
             tat_targets$CollectToResultTarget[
               match(Concate2, tat_targets$Concate)],
             # Match on scenario 2
             ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                    tat_targets$CollectToResultTarget[
                      match(Concate1, tat_targets$Concate)],
                    # Match on scenario 3
                    tat_targets$CollectToResultTarget[
                      match(Test, tat_targets$Concate)])),
    #
    # Determine if Receive to Result and Collect to Result TAT meet targets
    ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget,
    CollectResultInTarget = CollectToResult <= CollectResultTarget,
    # Create column with patient name, order ID, test, collect, receive, and
    # result date and determine if there is a duplicate; order time excluded
    Concate3 = paste(LAST_NAME, FIRST_NAME,
                     ORDER_ID, TEST_NAME,
                     COLLECTION_DATE, RECEIVE_DATE, VERIFIED_DATE),
    DuplTest = duplicated(Concate3),
    # Determine whether or not to include this particular lab in TAT analysis
    # Exclusion criteria:
    # 1. Add on orders
    # 2. Orders from "Other" settings
    # 3. Orders with collect or receive times after result time
    # 4. Orders with missing collect, receive, or result timestamps
    TATInclude = ifelse(AddOnMaster == "AddOn" |
                          MasterSetting == "Other" |
                          CollectToResult < 0 |
                          ReceiveToResult < 0 |
                          is.na(CollectToResult) |
                          is.na(ReceiveToResult), FALSE, TRUE))

# Remove duplicate tests
raw_scc_test <- raw_scc_test %>%
  filter(!DuplTest)

# Select columns
scc_master_test <- raw_scc_test[ , c("Ward", "WARD_NAME", "WardandName",
                           "ORDER_ID", "REQUESTING_DOC NAME",
                           "MPI", "WORK SHIFT",
                           "TEST_NAME", "Test", "Division", "PRIORITY",
                           "Site", "ICU", "CLINIC_TYPE",
                           "Setting", "SettingRollUp",
                           "MasterSetting", "DashboardSetting",
                           "AdjPriority", "DashboardPriority",
                           "ORDERING_DATE", "COLLECTION_DATE",
                           "RECEIVE_DATE", "VERIFIED_DATE",
                           "ResultedDate",
                           "CollectToReceive", "ReceiveToResult",
                           "CollectToResult",
                           "AddOnMaster", "MissingCollect",
                           "ReceiveResultTarget", "CollectResultTarget",
                           "ReceiveResultInTarget", "CollectResultInTarget",
                           "TATInclude")]
# Rename columns
colnames(scc_master_test) <- c("LocCode", "LocName", "LocConcat",
                          "OrderID", "RequestMD",
                          "MSMRN", "WorkShift",
                          "TestName", "Test", "Division", "OrderPriority",
                          "Site", "ICU", "LocType",
                          "Setting", "SettingRollUp",
                          "MasterSetting", "DashboardSetting",
                          "AdjPriority", "DashboardPriority",
                          "OrderTime", "CollectTime",
                          "ReceiveTime", "ResultTime",
                          "ResultDate",
                          "CollectToReceiveTAT", "ReceiveToResultTAT",
                          "CollectToResultTAT",
                          "AddOnMaster", "MissingCollect",
                          "ReceiveResultTarget", "CollectResultTarget",
                          "ReceiveResultInTarget", "CollectResultInTarget",
                          "TATInclude")

  
## SUNQUEST DATA PROCESSING ----------
# Correct and format any timestamps that were not imported correctly
raw_sun_test <- SQ_Weekday
raw_sun_test[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun_test[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")], 
           function(x) ifelse(!is.na(x) & str_detect(x, "\\*.*\\*")  == TRUE, 
                              str_replace(x, "\\*.*\\*", ""), x))

  raw_sun_test[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun_test[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")],
           as.POSIXct, tz = "UTC", format = "%m/%d/%Y %H:%M:%S")

# Sunquest lookup references
# Crosswalk labs included and remove out of scope labs
raw_sun_test <- left_join(raw_sun_test, test_code[ , c("Test", 
                                             "SUN_TestCode",
                                             "Division")],
                     by = c("TestCode" = "SUN_TestCode"))

# Determine if test is included based on crosswalk results
raw_sun_test <- raw_sun_test %>%
  mutate(TestIncl = !is.na(Test)) %>%
  filter(TestIncl)

  
# Crosswalk unit type
raw_sun_test <- left_join(raw_sun_test, sun_setting, by = c("LocType" = "LocType"))
  
# Crosswalk site name
raw_sun_test <- left_join(raw_sun_test, mshs_site, by = c("HospCode" = "DataSite"))

# Crosswalk units and identify ICUs
raw_sun_test <- raw_sun_test %>%
  mutate(LocandName = paste(LocCode, LocName))
  
raw_sun_test <- left_join(raw_sun_test, sun_icu[ , c("Concatenate", "ICU")], 
                       by = c("LocandName" = "Concatenate"))

raw_sun_test[is.na(raw_sun_test$ICU), "ICU"] <- FALSE


# # Sunquest data formatting-----------------------------
# Preprocess Sunquest data and add any necessary columns
raw_sun_test <- raw_sun_test %>%
  mutate(
    # Determine if unit is an ICU based on crosswalk results
    ICU = ifelse(is.na(ICU), FALSE, ICU),
    # Create a column for resulted date
    ResultedDate = as.Date(ResultDateTime, format = "%m/%d/%Y"),
    # Create master setting column to identify ICU and IP Non-ICU units
    MasterSetting = ifelse(SettingRollUp == "IP" & ICU, "ICU",
                           ifelse(SettingRollUp == "IP" & !ICU,
                                  "IP Non-ICU", SettingRollUp)),
    # Create dashboard setting column to roll up master settings based on
    # desired dashboard grouping(ie, group ED and ICU together)
    DashboardSetting = ifelse(MasterSetting %in% c("ED", "ICU"), "ED & ICU",
                              MasterSetting),
    #
    # Create column with adjusted priority based on operational assumption that
    # all ED and ICU labs are treated as stat
    AdjPriority = ifelse(MasterSetting %in% c("ED", "ICU") |
                           SpecimenPriority %in% "S", "Stat", "Routine"),
    #
    # Create dashboard priority column
    DashboardPriority = ifelse(
      tat_targets$Priority[match(Test, tat_targets$Test)] == "All", "All",
      AdjPriority),
    #
    # Calculate turnaround times
    CollectToReceive = 
      as.numeric(ReceiveDateTime - CollectDateTime, units = "mins"),
    ReceiveToResult = 
      as.numeric(ResultDateTime - ReceiveDateTime, units = "mins"),
    CollectToResult = 
      as.numeric(ResultDateTime - CollectDateTime, units = "mins"),
    #
    # Determine if order was an add on or original order based on time between
    # order and receive times
    AddOnMaster = ifelse(as.numeric(OrderDateTime - ReceiveDateTime,
                                    units = "mins") > 5, "AddOn", "Original"),
    #
    # Determine if collection time is missing
    MissingCollect = CollectDateTime == OrderDateTime,
    #
    # Determine TAT target based on test, priority, and patient setting
    # Create column concatenating test and priority to determine TAT targets
    Concate1 = paste(Test, DashboardPriority),
    # Create column concatenating test, priority, and setting to determine
    # TAT targets
    Concate2 = paste(Test, DashboardPriority, MasterSetting),
    # Determine Receive to Result TAT target using this logic:
    # 1. Try to match test, priority, and setting (applicable for labs with 
    # different TAT targets based on patient setting and order priority)
    # 2. Try to match test and priority (applicable for labs with different
    # TAT targets based on order priority)
    # 3. Try to match test - this is for tests with (applicable for labs with
    # TAT targets that are independent of patient setting or priority)
    #
    # Determine Receive to Result TAT target based on above logic/scenarios
    ReceiveResultTarget = 
      # Match on scenario 1
      ifelse(!is.na(match(Concate2, tat_targets$Concate)),
             tat_targets$ReceiveToResultTarget[
               match(Concate2, tat_targets$Concate)],
             # Match on scenario 2
             ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                    tat_targets$ReceiveToResultTarget[
                      match(Concate1, tat_targets$Concate)],
                    # Match on scenario 3
                    tat_targets$ReceiveToResultTarget[
                      match(Test, tat_targets$Concate)])),
    #
    # Determine Collect to Result TAT target based on above logic/scenarios
    CollectResultTarget = 
      # Match on scenario 1
      ifelse(!is.na(match(Concate2, tat_targets$Concate)),
             tat_targets$CollectToResultTarget[
               match(Concate2, tat_targets$Concate)],
             # Match on scenario 2
             ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                    tat_targets$CollectToResultTarget[
                      match(Concate1, tat_targets$Concate)],
                    # Match on scenario 3
                    tat_targets$CollectToResultTarget[
                      match(Test, tat_targets$Concate)])),
    #
    # Determine if Receive to Result and Collect to Result TAT meet targets
    ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget,
    CollectResultInTarget = CollectToResult <= CollectResultTarget,
    #
    # Create column with patient name, order ID, test, collect, receive, and
    # result date and determine if there is a duplicate; order time excluded
    Concate3 = paste(PtNumber, HISOrderNumber, TSTName, 
                            CollectDateTime, ReceiveDateTime, ResultDateTime),
    DuplTest = duplicated(Concate3),
    #
    # Determine whether or not to include this particular lab in TAT analysis
    # Exclusion criteria:
    # 1. Add on orders
    # 2. Orders from "Other" settings
    # 3. Orders with collect or receive times after result time
    # 4. Orders with missing collect, receive, or result timestamps
    TATInclude = ifelse(AddOnMaster == "AddOn" |
                          MasterSetting == "Other" |
                          CollectToResult < 0 |
                          ReceiveToResult < 0 |
                          is.na(CollectToResult) |
                          is.na(ReceiveToResult), FALSE, TRUE))

# Remove duplicate tests
raw_sun_test <- raw_sun_test %>%
  filter(!DuplTest)

# Select columns
sun_master_test <- raw_sun_test[ ,c("LocCode", "LocName", "LocandName", 
                            "HISOrderNumber", "PhysName", 
                            "PtNumber", "SHIFT",            
                            "TSTName", "Test", "Division", "SpecimenPriority", 
                            "Site", "ICU", "LocType",               
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting", 
                            "AdjPriority", "DashboardPriority", 
                            "OrderDateTime", "CollectDateTime", 
                            "ReceiveDateTime", "ResultDateTime", 
                            "ResultedDate", 
                            "CollecttoReceive", "ReceivetoResult", 
                            "CollecttoResult", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")]
  
colnames(sun_master_test) <- c("LocCode", "LocName", "LocConcat", 
                            "OrderID", "RequestMD", 
                            "MSMRN", "WorkShift", 
                            "TestName", "Test", "Division", "OrderPriority", 
                            "Site", "ICU", "LocType", 
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting", 
                            "AdjPriority", "DashboardPriority",
                            "OrderTime", "CollectTime", 
                            "ReceiveTime", "ResultTime", 
                            "ResultDate", 
                            "CollectToReceiveTAT", "ReceiveToResultTAT", 
                            "CollectToResultTAT", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")
  
  
scc_sun_master_test <- rbind(scc_master_test, sun_master_test)

  # scc_sun_master[c("LocConcat", "RequestMD", "WorkShift",
  #                  "AdjPriority", "AddOnMaster")] <-
  #   lapply(scc_sun_master[c("LocConcat", "RequestMD", "WorkShift",
  #                           "AdjPriority", "AddOnMaster")], as.factor)

  scc_sun_master_test$Site <- factor(scc_sun_master_test$Site,
                                levels = site_order)
  scc_sun_master_test$Test <- factor(scc_sun_master_test$Test,
                                levels = cp_micro_lab_order)
  scc_sun_master_test$MasterSetting <- factor(scc_sun_master_test$MasterSetting,
                                         levels = pt_setting_order)
  scc_sun_master_test$DashboardSetting <- factor(scc_sun_master_test$DashboardSetting,
                                            levels = pt_setting_order2)
  scc_sun_master_test$DashboardPriority <- factor(scc_sun_master_test$DashboardPriority,
                                             levels = dashboard_priority_order)

  scc_sun_list <- list(raw_scc_test, raw_sun_test, scc_sun_master_test)
```


```{r scratchpad}
# Create dataframe to compare
scc_master_function <- scc_wday[ , c("Ward", "WARD_NAME", "WardandName",
                           "ORDER_ID", "REQUESTING_DOC NAME",
                           "MPI", "WORK SHIFT",
                           "TEST_NAME", "Test", "Division", "PRIORITY",
                           "Site", "ICU", "CLINIC_TYPE",
                           "Setting", "SettingRollUp",
                           "MasterSetting", "DashboardSetting",
                           "AdjPriority", "DashboardPriority",
                           "ORDERING_DATE", "COLLECTION_DATE",
                           "RECEIVE_DATE", "VERIFIED_DATE",
                           "ResultedDate",
                           "CollectToReceive", "ReceiveToResult",
                           "CollectToResult",
                           "AddOnMaster", "MissingCollect",
                           "ReceiveResultTarget", "CollectResultTarget",
                           "ReceiveResultInTarget", "CollectResultInTarget",
                           "TATInclude")]
# Rename columns
colnames(scc_master_function) <- c("LocCode", "LocName", "LocConcat",
                          "OrderID", "RequestMD",
                          "MSMRN", "WorkShift",
                          "TestName", "Test", "Division", "OrderPriority",
                          "Site", "ICU", "LocType",
                          "Setting", "SettingRollUp",
                          "MasterSetting", "DashboardSetting",
                          "AdjPriority", "DashboardPriority",
                          "OrderTime", "CollectTime",
                          "ReceiveTime", "ResultTime",
                          "ResultDate",
                          "CollectToReceiveTAT", "ReceiveToResultTAT",
                          "CollectToResultTAT",
                          "AddOnMaster", "MissingCollect",
                          "ReceiveResultTarget", "CollectResultTarget",
                          "ReceiveResultInTarget", "CollectResultInTarget",
                          "TATInclude")

scc_master_function <- scc_master_function %>%
  mutate(LocCode = as.character(LocCode),
         LocName = as.character(LocName),
         TestName = as.character(TestName),
         Test = as.character(Test),
         LocType = as.character(LocType),
         Setting = as.character(Setting),
         SettingRollUp = as.character(SettingRollUp),
         Division = as.character(Division),
         Site = as.character(Site))


# Select columns
sun_master_function <- sun_wday[ ,c("LocCode", "LocName", "LocandName", 
                            "HISOrderNumber", "PhysName", 
                            "PtNumber", "SHIFT",            
                            "TSTName", "Test", "Division", "SpecimenPriority", 
                            "Site", "ICU", "LocType",               
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting", 
                            "AdjPriority", "DashboardPriority", 
                            "OrderDateTime", "CollectDateTime", 
                            "ReceiveDateTime", "ResultDateTime", 
                            "ResultedDate", 
                            "CollecttoReceive", "ReceivetoResult", 
                            "CollecttoResult", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")]
  
colnames(sun_master_function) <- c("LocCode", "LocName", "LocConcat", 
                            "OrderID", "RequestMD", 
                            "MSMRN", "WorkShift", 
                            "TestName", "Test", "Division", "OrderPriority", 
                            "Site", "ICU", "LocType", 
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting", 
                            "AdjPriority", "DashboardPriority",
                            "OrderTime", "CollectTime", 
                            "ReceiveTime", "ResultTime", 
                            "ResultDate", 
                            "CollectToReceiveTAT", "ReceiveToResultTAT", 
                            "CollectToResultTAT", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")

sun_master_function <- sun_master_function %>%
  mutate(LocCode = as.character(LocCode),
         LocName = as.character(LocName),
         LocConcat = as.character(LocConcat),
         RequestMD = as.character(RequestMD),
         WorkShift = as.character(WorkShift),
         TestName = as.character(TestName),
         Test = as.character(Test),
         Division = as.character(Division),
         Site = as.character(Site),
         LocType = as.character(LocType),
         Setting = as.character(Setting),
         SettingRollUp = as.character(SettingRollUp))


```

```{r New concise function for preprocessing SCC and Sunquest data}
preprocess_scc_sun_newfunc <- function(raw_scc, raw_sun)  {
  
  # Preprocess SCC data -------------------------------
  # Correct and format any timestamps that were not imported correctly
  raw_scc[c("ORDERING_DATE", 
            "COLLECTION_DATE", 
            "RECEIVE_DATE", 
            "VERIFIED_DATE")] <-
    lapply(raw_scc[c("ORDERING_DATE",
                     "COLLECTION_DATE",
                     "RECEIVE_DATE",
                     "VERIFIED_DATE")],
           function(x)
             ifelse(!is.na(x) & str_detect(x, "\\*.*\\*"),
                    str_replace(x, "\\*.*\\*", ""), x))
  
  raw_scc[c("ORDERING_DATE",
            "COLLECTION_DATE",
            "RECEIVE_DATE",
            "VERIFIED_DATE")] <-
    lapply(raw_scc[c("ORDERING_DATE",
                     "COLLECTION_DATE",
                     "RECEIVE_DATE",
                     "VERIFIED_DATE")],
           as.POSIXct, tz = "UTC",
           format = "%Y-%m-%d %H:%M:%OS",
           options(digits.sec = 1))
  
  # SCC lookup references ----------------------------------------------
  # Crosswalk in scope labs
  raw_scc <- left_join(raw_scc,
                       test_code[ , c("Test", "SCC_TestID", "Division")],
                       by = c("TEST_ID" = "SCC_TestID"))
  
  # Determine if test is included based on crosswalk results
  raw_scc <- raw_scc %>%
    mutate(TestIncl = !is.na(Test)) %>%
    filter(TestIncl)
  
  # Crosswalk unit type
  raw_scc <- left_join(raw_scc, scc_setting,
                       by = c("CLINIC_TYPE" = "Clinic_Type"))
  # Crosswalk site name
  raw_scc <- left_join(raw_scc, mshs_site,
                       by = c("SITE" = "DataSite"))
  
  # Crosswalk units and identify ICUs
  raw_scc <- raw_scc %>%
    mutate(WardandName = paste(Ward, WARD_NAME))
  
  raw_scc <- left_join(raw_scc, scc_icu[ , c("Concatenate", "ICU")], 
                       by = c("WardandName" = "Concatenate"))
  
  # Preprocess SCC data and add any necessary columns
  raw_scc <- raw_scc %>%
    mutate(
      # Determine if unit is an ICU based on crosswalk results
      ICU = ifelse(is.na(ICU), FALSE, ICU), 
      # Create a column for resulted date
      ResultedDate = date(VERIFIED_DATE),
      # Create master setting column to identify ICU and IP Non-ICU units
      MasterSetting = ifelse(SettingRollUp == "IP" & ICU, "ICU",
                             ifelse(SettingRollUp == "IP" & !ICU,
                                    "IP Non-ICU", SettingRollUp)),
      # Create dashboard setting column to roll up master settings based on
      # desired dashboard grouping (ie, group ED and ICU together)
      DashboardSetting = ifelse(MasterSetting %in% c("ED", "ICU"), 
                                "ED & ICU", MasterSetting),
      # Create column with adjusted priority based on assumption that all ED and
      # ICU labs are treated as stat per operational leadership
      AdjPriority = ifelse(MasterSetting %in% c("ED", "ICU") |
                             PRIORITY %in% "S", "Stat", "Routine"),
      # Create dashboard priority column 
      DashboardPriority = ifelse(
        tat_targets$Priority[match(Test, tat_targets$Test)] == "All", 
        "All", AdjPriority),
      # Calculate turnaround times
      CollectToReceive =
        as.numeric(RECEIVE_DATE - COLLECTION_DATE, units = "mins"),
      ReceiveToResult =
        as.numeric(VERIFIED_DATE - RECEIVE_DATE, units = "mins"),
      CollectToResult =
        as.numeric(VERIFIED_DATE - COLLECTION_DATE, units = "mins"),
      #
      # Determine if order was an add on or original order based on time between
      # order and receive times
      AddOnMaster = ifelse(as.numeric(ORDERING_DATE - RECEIVE_DATE,units = "mins")
                           > 5, "AddOn", "Original"),
      # Determine if collection time is missing
      MissingCollect = CollectToReceive == 0,
      #
      # Determine TAT based on test, priority, and patient setting
      # Create column concatenating test and priority to determine TAT targets
      Concate1 = paste(Test, DashboardPriority),
      # Create column concatenating test, priority, and setting to determine
      # TAT targets
      Concate2 = paste(Test, DashboardPriority, MasterSetting),
      # Determine Receive to Result TAT target using this logic:
      # 1. Try to match test, priority, and setting (applicable for labs with 
      # different TAT targets based on patient setting and order priority)
      # 2. Try to match test and priority (applicable for labs with different
      # TAT targets based on order priority)
      # 3. Try to match test - this is for tests with (applicable for labs with
      # TAT targets that are independent of patient setting or priority)
      #
      # Determine Receive to Result TAT target based on above logic/scenarios
      ReceiveResultTarget =
        # Match on scenario 1
        ifelse(!is.na(match(Concate2, tat_targets$Concate)),
               tat_targets$ReceiveToResultTarget[
                 match(Concate2, tat_targets$Concate)],
               # Match on scenario 2
               ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                      tat_targets$ReceiveToResultTarget[
                        match(Concate1, tat_targets$Concate)],
                      # Match on scenario 3
                      tat_targets$ReceiveToResultTarget[
                        match(Test, tat_targets$Concate)])),
      #
      # Determine Collect to Result TAT target based on above logic/scenarios
      CollectResultTarget =
        # Match on scenario 1
        ifelse(!is.na(match(Concate2, tat_targets$Concate)),
               tat_targets$CollectToResultTarget[
                 match(Concate2, tat_targets$Concate)],
               # Match on scenario 2
               ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                      tat_targets$CollectToResultTarget[
                        match(Concate1, tat_targets$Concate)],
                      # Match on scenario 3
                      tat_targets$CollectToResultTarget[
                        match(Test, tat_targets$Concate)])),
      #
      # Determine if Receive to Result and Collect to Result TAT meet targets
      ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget,
      CollectResultInTarget = CollectToResult <= CollectResultTarget,
      # Create column with patient name, order ID, test, collect, receive, and
      # result date and determine if there is a duplicate; order time excluded
      Concate3 = paste(LAST_NAME, FIRST_NAME,
                       ORDER_ID, TEST_NAME,
                       COLLECTION_DATE, RECEIVE_DATE, VERIFIED_DATE),
      DuplTest = duplicated(Concate3),
      # Determine whether or not to include this particular lab in TAT analysis
      # Exclusion criteria:
      # 1. Add on orders
      # 2. Orders from "Other" settings
      # 3. Orders with collect or receive times after result time
      # 4. Orders with missing collect, receive, or result timestamps
      TATInclude = ifelse(AddOnMaster == "AddOn" |
                            MasterSetting == "Other" |
                            CollectToResult < 0 |
                            ReceiveToResult < 0 |
                            is.na(CollectToResult) |
                            is.na(ReceiveToResult), FALSE, TRUE))
  
  # Remove duplicate tests
  raw_scc <- raw_scc %>%
    filter(!DuplTest)
  
  # Select columns
  scc_master_newfunc <- raw_scc[ , c("Ward", "WARD_NAME", "WardandName",
                              "ORDER_ID", "REQUESTING_DOC NAME",
                              "MPI", "WORK SHIFT",
                              "TEST_NAME", "Test", "Division", "PRIORITY",
                              "Site", "ICU", "CLINIC_TYPE",
                              "Setting", "SettingRollUp",
                              "MasterSetting", "DashboardSetting",
                              "AdjPriority", "DashboardPriority",
                              "ORDERING_DATE", "COLLECTION_DATE",
                              "RECEIVE_DATE", "VERIFIED_DATE",
                              "ResultedDate",
                              "CollectToReceive", "ReceiveToResult",
                              "CollectToResult",
                              "AddOnMaster", "MissingCollect",
                              "ReceiveResultTarget", "CollectResultTarget",
                              "ReceiveResultInTarget", "CollectResultInTarget",
                              "TATInclude")]
  # Rename columns
  colnames(scc_master_newfunc) <- c("LocCode", "LocName", "LocConcat",
                             "OrderID", "RequestMD",
                             "MSMRN", "WorkShift",
                             "TestName", "Test", "Division", "OrderPriority",
                             "Site", "ICU", "LocType",
                             "Setting", "SettingRollUp",
                             "MasterSetting", "DashboardSetting",
                             "AdjPriority", "DashboardPriority",
                             "OrderTime", "CollectTime",
                             "ReceiveTime", "ResultTime",
                             "ResultDate",
                             "CollectToReceiveTAT", "ReceiveToResultTAT",
                             "CollectToResultTAT",
                             "AddOnMaster", "MissingCollect",
                             "ReceiveResultTarget", "CollectResultTarget",
                             "ReceiveResultInTarget", "CollectResultInTarget",
                             "TATInclude")
  
  # Preprocess Sunquest data --------------------------------
  # Correct and format any timestamps that were not imported correctly
  raw_sun <- SQ_Weekday
  raw_sun[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")], 
           function(x) ifelse(!is.na(x) & str_detect(x, "\\*.*\\*")  == TRUE, 
                              str_replace(x, "\\*.*\\*", ""), x))
  
  raw_sun[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")],
           as.POSIXct, tz = "UTC", format = "%m/%d/%Y %H:%M:%S")
  
  # Sunquest lookup references
  # Crosswalk labs included and remove out of scope labs
  raw_sun <- left_join(raw_sun, test_code[ , c("Test", 
                                               "SUN_TestCode",
                                               "Division")],
                       by = c("TestCode" = "SUN_TestCode"))
  
  # Determine if test is included based on crosswalk results
  raw_sun <- raw_sun %>%
    mutate(TestIncl = !is.na(Test)) %>%
    filter(TestIncl)
  
  
  # Crosswalk unit type
  raw_sun <- left_join(raw_sun, sun_setting, by = c("LocType" = "LocType"))
  
  # Crosswalk site name
  raw_sun <- left_join(raw_sun, mshs_site, by = c("HospCode" = "DataSite"))
  
  # Crosswalk units and identify ICUs
  raw_sun <- raw_sun %>%
    mutate(LocandName = paste(LocCode, LocName))
  
  raw_sun <- left_join(raw_sun, sun_icu[ , c("Concatenate", "ICU")], 
                       by = c("LocandName" = "Concatenate"))
  
  raw_sun[is.na(raw_sun$ICU), "ICU"] <- FALSE
  
  
  # # Sunquest data formatting-----------------------------
  # Preprocess Sunquest data and add any necessary columns
  raw_sun <- raw_sun %>%
    mutate(
      # Determine if unit is an ICU based on crosswalk results
      ICU = ifelse(is.na(ICU), FALSE, ICU),
      # Create a column for resulted date
      ResultedDate = as.Date(ResultDateTime, format = "%m/%d/%Y"),
      # Create master setting column to identify ICU and IP Non-ICU units
      MasterSetting = ifelse(SettingRollUp == "IP" & ICU, "ICU",
                             ifelse(SettingRollUp == "IP" & !ICU,
                                    "IP Non-ICU", SettingRollUp)),
      # Create dashboard setting column to roll up master settings based on
      # desired dashboard grouping(ie, group ED and ICU together)
      DashboardSetting = ifelse(MasterSetting %in% c("ED", "ICU"), "ED & ICU",
                                MasterSetting),
      #
      # Create column with adjusted priority based on operational assumption that
      # all ED and ICU labs are treated as stat
      AdjPriority = ifelse(MasterSetting %in% c("ED", "ICU") |
                             SpecimenPriority %in% "S", "Stat", "Routine"),
      #
      # Create dashboard priority column
      DashboardPriority = ifelse(
        tat_targets$Priority[match(Test, tat_targets$Test)] == "All", "All",
        AdjPriority),
      #
      # Calculate turnaround times
      CollectToReceive = 
        as.numeric(ReceiveDateTime - CollectDateTime, units = "mins"),
      ReceiveToResult = 
        as.numeric(ResultDateTime - ReceiveDateTime, units = "mins"),
      CollectToResult = 
        as.numeric(ResultDateTime - CollectDateTime, units = "mins"),
      #
      # Determine if order was an add on or original order based on time between
      # order and receive times
      AddOnMaster = ifelse(as.numeric(OrderDateTime - ReceiveDateTime,
                                      units = "mins") > 5, "AddOn", "Original"),
      #
      # Determine if collection time is missing
      MissingCollect = CollectDateTime == OrderDateTime,
      #
      # Determine TAT target based on test, priority, and patient setting
      # Create column concatenating test and priority to determine TAT targets
      Concate1 = paste(Test, DashboardPriority),
      # Create column concatenating test, priority, and setting to determine
      # TAT targets
      Concate2 = paste(Test, DashboardPriority, MasterSetting),
      # Determine Receive to Result TAT target using this logic:
      # 1. Try to match test, priority, and setting (applicable for labs with 
      # different TAT targets based on patient setting and order priority)
      # 2. Try to match test and priority (applicable for labs with different
      # TAT targets based on order priority)
      # 3. Try to match test - this is for tests with (applicable for labs with
      # TAT targets that are independent of patient setting or priority)
      #
      # Determine Receive to Result TAT target based on above logic/scenarios
      ReceiveResultTarget = 
        # Match on scenario 1
        ifelse(!is.na(match(Concate2, tat_targets$Concate)),
               tat_targets$ReceiveToResultTarget[
                 match(Concate2, tat_targets$Concate)],
               # Match on scenario 2
               ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                      tat_targets$ReceiveToResultTarget[
                        match(Concate1, tat_targets$Concate)],
                      # Match on scenario 3
                      tat_targets$ReceiveToResultTarget[
                        match(Test, tat_targets$Concate)])),
      #
      # Determine Collect to Result TAT target based on above logic/scenarios
      CollectResultTarget = 
        # Match on scenario 1
        ifelse(!is.na(match(Concate2, tat_targets$Concate)),
               tat_targets$CollectToResultTarget[
                 match(Concate2, tat_targets$Concate)],
               # Match on scenario 2
               ifelse(!is.na(match(Concate1, tat_targets$Concate)),
                      tat_targets$CollectToResultTarget[
                        match(Concate1, tat_targets$Concate)],
                      # Match on scenario 3
                      tat_targets$CollectToResultTarget[
                        match(Test, tat_targets$Concate)])),
      #
      # Determine if Receive to Result and Collect to Result TAT meet targets
      ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget,
      CollectResultInTarget = CollectToResult <= CollectResultTarget,
      #
      # Create column with patient name, order ID, test, collect, receive, and
      # result date and determine if there is a duplicate; order time excluded
      Concate3 = paste(PtNumber, HISOrderNumber, TSTName, 
                       CollectDateTime, ReceiveDateTime, ResultDateTime),
      DuplTest = duplicated(Concate3),
      #
      # Determine whether or not to include this particular lab in TAT analysis
      # Exclusion criteria:
      # 1. Add on orders
      # 2. Orders from "Other" settings
      # 3. Orders with collect or receive times after result time
      # 4. Orders with missing collect, receive, or result timestamps
      TATInclude = ifelse(AddOnMaster == "AddOn" |
                            MasterSetting == "Other" |
                            CollectToResult < 0 |
                            ReceiveToResult < 0 |
                            is.na(CollectToResult) |
                            is.na(ReceiveToResult), FALSE, TRUE))
  
  # Remove duplicate tests
  raw_sun <- raw_sun %>%
    filter(!DuplTest)
  
  # Select columns
  sun_master_newfunc <- raw_sun[ ,c("LocCode", "LocName", "LocandName", 
                             "HISOrderNumber", "PhysName", 
                             "PtNumber", "SHIFT",            
                             "TSTName", "Test", "Division", "SpecimenPriority", 
                             "Site", "ICU", "LocType",               
                             "Setting", "SettingRollUp", 
                             "MasterSetting", "DashboardSetting", 
                             "AdjPriority", "DashboardPriority", 
                             "OrderDateTime", "CollectDateTime", 
                             "ReceiveDateTime", "ResultDateTime", 
                             "ResultedDate", 
                             "CollecttoReceive", "ReceivetoResult", 
                             "CollecttoResult", 
                             "AddOnMaster", "MissingCollect", 
                             "ReceiveResultTarget", "CollectResultTarget", 
                             "ReceiveResultInTarget", "CollectResultInTarget", 
                             "TATInclude")]
  
  colnames(sun_master_newfunc) <- c("LocCode", "LocName", "LocConcat", 
                             "OrderID", "RequestMD", 
                             "MSMRN", "WorkShift", 
                             "TestName", "Test", "Division", "OrderPriority", 
                             "Site", "ICU", "LocType", 
                             "Setting", "SettingRollUp", 
                             "MasterSetting", "DashboardSetting", 
                             "AdjPriority", "DashboardPriority",
                             "OrderTime", "CollectTime", 
                             "ReceiveTime", "ResultTime", 
                             "ResultDate", 
                             "CollectToReceiveTAT", "ReceiveToResultTAT", 
                             "CollectToResultTAT", 
                             "AddOnMaster", "MissingCollect", 
                             "ReceiveResultTarget", "CollectResultTarget", 
                             "ReceiveResultInTarget", "CollectResultInTarget", 
                             "TATInclude")

  
  scc_sun_master <- rbind(scc_master_newfunc, sun_master_newfunc)
  
  # scc_sun_master[c("LocConcat", "RequestMD", "WorkShift", 
  #                  "AdjPriority", "AddOnMaster")] <-
  #   lapply(scc_sun_master[c("LocConcat", "RequestMD", "WorkShift",
  #                           "AdjPriority", "AddOnMaster")], as.factor)
  
  scc_sun_master$Site <- factor(scc_sun_master$Site, 
                                levels = site_order)
  scc_sun_master$Test <- factor(scc_sun_master$Test, 
                                levels = cp_micro_lab_order)
  scc_sun_master$MasterSetting <- factor(scc_sun_master$MasterSetting, 
                                         levels = pt_setting_order)
  scc_sun_master$DashboardSetting <- factor(scc_sun_master$DashboardSetting, 
                                            levels = pt_setting_order2)
  scc_sun_master$DashboardPriority <- factor(scc_sun_master$DashboardPriority, 
                                             levels = dashboard_priority_order)
  
  scc_sun_list_newfunc <- list(raw_scc, raw_sun, 
                       scc_master_newfunc, sun_master_newfunc,
                       scc_sun_master)
  
}
```

```{r}
# Preprocess data
scc_sun_wday_list <-preprocess_scc_sun_newfunc(raw_scc = SCC_Weekday, raw_sun = SQ_Weekday)

scc_wday <- scc_sun_wday_list[[1]]
sun_wday <- scc_sun_wday_list[[2]]
scc_sun_wday_master <- scc_sun_wday_list[[5]]

if (is.null(SQ_Not_Weekday) & is.null(SCC_Not_Weekday)) {
  include_not_wday <- FALSE
  scc_sun_not_wday_list <- NULL
  scc_not_wday <- NULL
  sun_not_wday <- NULL
  scc_sun_not_wday_master <- NULL
} else {
  include_not_wday <- TRUE
  scc_sun_not_wday_list <- preprocess_scc_sun(SCC_Not_Weekday, 
                                              SQ_Not_Weekday)
  scc_not_wday <- scc_sun_not_wday_list[[1]]
  sun_not_wday <- scc_sun_not_wday_list[[2]]
  scc_sun_not_wday_master <- scc_sun_not_wday_list[[3]]
}

# Remove labs from master data frame that were resulted at exactly midnight on 
# next morning or prior day
# Custom function to determine correct number of dates
correct_scc_result_dates <- function(data, number_days) {
  all_resulted_dates_vol <- data %>%
    group_by(ResultDate) %>%
    summarize(VolLabs = n()) %>%
    arrange(desc(VolLabs)) %>%
    ungroup()
  
  correct_dates <- all_resulted_dates_vol$ResultDate[1:number_days]
  
  new_data <- data[data$ResultDate %in% correct_dates, ]
  
  return(new_data)
}

# Update preprocessed data to only include correct dates ----------------------
scc_sun_wday_master <- correct_scc_result_dates(scc_sun_wday_master, 1)

if (scenario == 1) {
  scc_sun_not_wday_master <- correct_scc_result_dates(scc_sun_not_wday_master, 
                                                      3)
} else if (scenario == 2) {
  scc_sun_not_wday_master <- correct_scc_result_dates(scc_sun_not_wday_master, 
                                                      2)
} else if (scenario == 3) {
  scc_sun_not_wday_master <- correct_scc_result_dates(scc_sun_not_wday_master, 
                                                      1)
}

test1 <- scc_sun_wday_master %>%
    select(MSMRN, ResultDate) %>%
    group_by(ResultDate) %>%
    summarize(VolLabs = n()) %>%
    arrange(desc(VolLabs)) %>%
    ungroup()

test2 <- scc_sun_wday_master %>%
    group_by(ResultDate) %>%
    summarize(VolLabs = n()) %>%
    arrange(desc(VolLabs)) %>%
    ungroup()

```

