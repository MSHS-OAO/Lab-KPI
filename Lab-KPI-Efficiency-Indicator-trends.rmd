---
title: "Laboratory Efficiency Indicators: 30 Day Lookback"
date: "7/24/2020"
output: html_document
---

<h2><span style="color: red;">Draft - Not for Distribution</span></h2>


```{r Install and load packages, echo = FALSE, warning = FALSE, message = FALSE}
#Install packages only the first time you run the code
#install.packages("timeDate")
#install.packages("lubridate")
#install.packages("readxl")
#install.packages("writexl")
#install.packages("dplyr")
#install.packages("reshape2")
#install.packages("knitr")
#install.packages("kableExtra")
#install.packages("formattable")
#install.packages("bizdays")
#install.packages("rmarkdown")
#install.packages("stringr")
#install.packages("tinytex")
#install.packages("scales")
#install.packages("gridExtra")
#install.packages("ggQC")


#-------------------------------Required packages-------------------------------#

#Required packages: run these everytime you run the code
library(timeDate)
library(readxl)
library(bizdays)
library(dplyr)
library(lubridate)
library(reshape2)
library(knitr)
library(kableExtra)
library(formattable)
library(rmarkdown)
library(stringr)
library(writexl)
library(ggplot2)
library(gridExtra)
library(scales)
library(ggQC)
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r Clear history and import relevant data, echo = FALSE, warning = FALSE, message = FALSE}
rm(list = ls())

user_wd <- "J:\\Presidents\\HSPI-PM\\Operations Analytics and Optimization\\Projects\\Service Lines\\Lab KPI\\Data\\SCC Sunquest Script Repo"
user_path <- paste0(user_wd, "\\*.*")
setwd(user_wd)

scc_sun_hist <- read_excel(choose.files(default = user_path, caption = "Select Historical Repository"), sheet = 1, col_names = TRUE)

scc_sun_hist$ResultDate <- as.Date(scc_sun_hist$ResultDate, format = "%m/%d/%y")
lookback_period <- 30
start_date <- max(scc_sun_hist$ResultDate) - (lookback_period - 1)

# Orders for labs, sites, patient setting, and priority
cp_micro_lab_order <- c("Troponin", "Lactate WB", "BUN", "HGB", "PT", "Rapid Flu", "C. diff")
site_order <- c("MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")
dashboard_pt_setting <- c("ED & ICU", "IP Non-ICU", "Amb")
dashboard_priority_order <- c("All", "Stat", "Routine")

#user_wd <- "J:\\deans\\Presidents\\HSPI-PM\\Operations Analytics and Optimization\\Projects\\Service Lines\\Lab KPI\\Data\\AP & Cytology Historical Repo"
#user_path <- paste0(user_wd, "\\*.*")

AP_historical_repo <- read_excel(choose.files(default = user_path, caption = "Select Anatomic Pathology Historical Repository"), sheet=1,  col_names = TRUE)


mshs_colors = c("#221f72", "#00AEFF", "#D80B8C", "#7f7f7f")
```

```{r Format historical repository for Clinical Pathology plotting, echo = FALSE, warning = FALSE, message = FALSE}
dashboard_tat_summary <- scc_sun_hist %>%
  group_by(Site, ResultDate, Division, Test, 
           DashboardPriority, DashboardSetting, 
           ReceiveResultTarget, CollectResultTarget) %>%
  summarize(ResultedVolume = sum(TotalResulted), 
            ResultedVolumeWithTAT = sum(TotalResultedTAT), 
            ReceiveResultInTarget = sum(TotalReceiveResultInTarget), 
            CollectResultInTarget = sum(TotalCollectResultInTarget)) %>%
  mutate(ReceiveResultDefects = ResultedVolumeWithTAT - ReceiveResultInTarget,
         CollectResultDefects = ResultedVolumeWithTAT - CollectResultInTarget,
         ReceiveResultPercent = ReceiveResultInTarget / ResultedVolumeWithTAT,
         CollectResultPercent = CollectResultInTarget / ResultedVolumeWithTAT,
         SafeThreshold = ifelse(Test == "Rapid Flu" | Test == "C. diff", 1.0, 0.95),
         NotSafeThreshold = ifelse(Test == "Rapid Flu" | Test == "C. diff", 0.9, 0.8))


# Summarize volume data
# dashboard_vol_summary <- scc_sun_hist %>%
#   group_by(Site, ResultDate, Test) %>%
#   summarize(ResultedVolume = sum(TotalResulted))

dashboard_vol_summary <- scc_sun_hist %>%
  group_by(Site, ResultDate, Test, DashboardPriority) %>%
  summarize(ResultedVolume = sum(TotalResulted))

```

```{r Filter unused TAT combinations for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}
# Manually remove patient settings or combinations not represented in efficiency indicator dashboards
dashboard_tat_filter <- dashboard_tat_summary %>%
  filter(!(DashboardPriority == "Other" | DashboardSetting == "Other" | 
             ((Test == "Troponin" | Test == "Lactate WB") & DashboardSetting == "Amb") |
             (Test == "C. diff" & DashboardSetting == "Amb")))

# Convert characters to factors
dashboard_tat_filter$Site <- factor(dashboard_tat_filter$Site, levels = site_order)
dashboard_tat_filter$Test <- factor(dashboard_tat_filter$Test, levels = cp_micro_lab_order)
dashboard_tat_filter$DashboardPriority <- factor(dashboard_tat_filter$DashboardPriority, levels = dashboard_priority_order)
dashboard_tat_filter$DashboardSetting <- factor(dashboard_tat_filter$DashboardSetting, levels = dashboard_pt_setting)

# Sort data frame
dashboard_tat_filter <- dashboard_tat_filter %>%
  arrange(Test, Site, DashboardPriority, DashboardSetting, ResultDate)

```

```{r Custom function for graphing TAT percentage for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}
tat_percentage_graph <- function(data, test_name, site_name, lab_priority, metric) {
  metric_name <- ifelse(metric == "ReceiveResultPercent", "Receive to Result TAT", ifelse(metric == "CollectResultPercent", "Collect to Result TAT", "Error"))
  # df <- data[data$ResultDate >= start_date & data$Test == test & data$Site == site & data$DashboardPriority == lab_priority, ]
  # 
  ggplot() +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data$ResultDate) + 1, ymin = -Inf, ymax = min(data$NotSafeThreshold), fill = "Not Safe", alpha = "Not Safe")) +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data$ResultDate) + 1, ymin = min(data$NotSafeThreshold), ymax = min(data$SafeThreshold), fill = "At Risk", alpha = "At Risk")) +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data$ResultDate) + 1, ymin = min(data$SafeThreshold), ymax = Inf, fill = "Safe", alpha = "Safe")) +
    geom_point(data = data[data$ResultDate >= start_date & data$Test == test_name & data$Site == site_name & data$DashboardPriority == lab_priority, ], aes_string(x = "ResultDate", y = metric, color = "DashboardSetting", shape = "DashboardSetting"), size = 3) +
    geom_line(data = data[data$ResultDate >= start_date & data$Test == test_name & data$Site == site_name & data$DashboardPriority == lab_priority, ], aes_string(x = "ResultDate", y = metric, color = "DashboardSetting"), linetype = "dashed") +
    labs(title = paste0(test_name, " ", metric_name, ":\n", site_name, " Percentage of ", lab_priority, " Labs within Target"), x = "Date",  y = "Percentage of Labs", color = "Setting", shape = "Setting") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "right", legend.box = "vertical", legend.title = element_text(size = 10), legend.text = element_text(size = 8),axis.text.x = element_text(angle = 30, hjust = 1)) +
    scale_x_date(limits = c(start_date -1, max(data$ResultDate)+1), breaks = seq(start_date, max(data$ResultDate), by = 3), date_minor_breaks = "1 day", date_labels = "%m/%d/%y", expand = c(0, 0, 0, 0)) +
    scale_fill_manual(name = "Status", values = c("Not Safe" = "red", "At Risk" = "orange", "Safe" = "green"), breaks=c("Not Safe","At Risk","Safe")) +
    scale_alpha_manual(name = "Status", values = c("Not Safe" = 0.15, "At Risk" = 0.15, "Safe" = 0.15), breaks=c("Not Safe","At Risk","Safe")) +
    scale_color_manual(name = "Setting", values = mshs_colors)
}
```

```{r Custom function for graphing resulted lab volume stratified by order priority for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}

# Function for plotting total resulted lab volume stratified by order priority
resulted_volume_graph <- function(data, test_name, site_name) {
  ggplot() +
    geom_point(data = data[data$ResultDate >= start_date & data$Test == test_name & data$Site == site_name, ], aes(x = ResultDate, y = ResultedVolume, color = DashboardPriority, shape = DashboardPriority), size = 3) +
    geom_line(data = data[data$ResultDate >= start_date & data$Test == test_name & data$Site == site_name, ], aes(x = ResultDate, y = ResultedVolume, color = DashboardPriority), linetype = "dashed") +
    labs(title = paste0(site_name, " ", test_name, " Resulted Lab Volume"), x = "Date",  y = "Volume of Labs", color = "Priority", shape = "Priority") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),axis.text.x = element_text(angle = 30, hjust = 1)) +
    scale_x_date(limits = c(start_date -1, max(data$ResultDate)+1), breaks = seq(start_date, max(data$ResultDate), by = 3), date_minor_breaks = "1 day", date_labels = "%m/%d/%y", expand = c(0, 0, 0, 0)) +
    # scale_y_continuous(sec.axis = sec_axis(~.*1, name = " ", breaks = NULL, label = NULL)) +
    scale_color_manual(name = "Priority", values = mshs_colors)
}
```

```{r Custom function for plotting TAT percentages and resulted volume on single graph for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}

tat_and_volume_plot <- function(data_tat, test_name, site_name, lab_priority, metric) {
  # 
  # Subset turnaround time and volume data based on test, site, and priority
  data_tat_plot <- data_tat %>%
    filter(ResultDate >= start_date & 
             Test == test_name & 
             Site == site_name & 
             DashboardPriority == lab_priority)

  data_vol_plot <- dashboard_vol_summary %>%
    filter(ResultDate >= start_date & 
             Test == test_name & 
             Site == site_name & 
             DashboardPriority == lab_priority)
  # 
  # Create printable metric name based on selected metric
  metric_name <- ifelse(metric == "ReceiveResultPercent", "Receive to Result", ifelse(metric == "CollectResultPercent", "Collect to Result", "Error"))
  #
  # Determine scale factor for secondary axis based on maximum resulted volume
  base10 <- floor(log10(max(data_vol_plot$ResultedVolume)))
  scale <- ceiling(max(data_vol_plot$ResultedVolume)/(10^(base10-1)))*10^(base10-1)
  #
  # Create plot and standard settings
  ggplot() +
    # Plot safe, at risk, not safe thresholds
    geom_rect(aes(xmin = start_date - 1, xmax = max(data_tat_plot$ResultDate) + 1, 
                  ymin = -Inf, ymax = min(data_tat_plot$NotSafeThreshold), 
                  fill = "Not Safe", alpha = "Not Safe")) +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data_tat_plot$ResultDate) + 1, 
                  ymin = min(data_tat_plot$NotSafeThreshold), ymax = min(data_tat_plot$SafeThreshold), 
                  fill = "At Risk", alpha = "At Risk"), show.legend = FALSE) +
    geom_rect(aes(xmin = start_date - 1, xmax = max(data_tat_plot$ResultDate) + 1, 
                  ymin = min(data_tat_plot$SafeThreshold), ymax = 1, 
                  fill = "Safe", alpha = "Safe"), show.legend = FALSE) + 
    geom_rect(aes(xmin = start_date - 1, xmax = max(data_tat_plot$ResultDate) + 1, 
                  ymin = 1, ymax = Inf, fill = "N/A", 
                  alpha = "N/A"), show.legend = FALSE) +
    # Plot percentage of labs within turnaround time target
    geom_point(data = data_tat_plot, aes_string(x = "ResultDate", y = metric, color = "DashboardSetting", shape = "DashboardSetting"), size = 3) +
    geom_line(data = data_tat_plot, aes_string(x = "ResultDate", y = metric, color = "DashboardSetting"), linetype = "dashed") +
    # Plot resulted volume on secondary axis
    geom_point(data = data_vol_plot, aes(x = ResultDate, y = ResultedVolume/scale, size = "Volume"), color = "#959595", shape = 18) +
    geom_line(data = data_vol_plot, aes(x = ResultDate, y = ResultedVolume/scale, linetype = "Volume"), color = "#959595") +
    # Specify graph labels and themes
    labs(title = paste0(site_name, " ", test_name, " ", metric_name, ":\n", "Percentage of ", lab_priority, " Labs within Target TAT"), 
         x = "Date",  y = "Percentage of Labs", color = "Setting", shape = "Setting", fill = "Status", alpha = "Status", linetype = "Resulted Volume", size = "Resulted Volume") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", 
          legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),
          axis.text.x = element_text(angle = 30, hjust = 1)) +
    # Specify fills, shapes, and lines mappings and legends
    scale_fill_manual(name = "Status", values = c("Not Safe" = "red", "At Risk" = "orange", "Safe" = "green", "N/A" = "grey"), 
                      breaks=c("Not Safe","At Risk","Safe")) +
    scale_alpha_manual(name = "Status", values = c("Not Safe" = 0.25, "At Risk" = 0.25, "Safe" = 0.25, "N/A" = 0.5), 
                       breaks=c("Not Safe","At Risk","Safe")) +
    scale_color_manual(name = "Setting", values = mshs_colors) +
    scale_size_manual(name = "Resulted Volume", values = 2, labels = paste(lab_priority, "Labs, \n All Settings")) + 
    scale_linetype_manual(name = "Resulted Volume", values = "dotted", labels = paste(lab_priority, "Labs, \n All Settings")) +
    # Reorder legends
    guides(color = guide_legend(order = 1, nrow = length(unique(data_tat_plot$DashboardSetting)), title.vjust = 1), shape = guide_legend(order = 1, nrow = length(unique(data_tat_plot$DashboardSetting)), title.vjust = 1), fill = guide_legend(order = 3, nrow = 3, title.vjust = 1), alpha = guide_legend(order = 3, nrow = 3, title.vjust = 1), 
           size = guide_legend(order = 2, title.vjust = 1), linetype = guide_legend(order = 2, title.vjust = 1)) +
    # Specify axis properties
    scale_x_date(limits = c(start_date -1, max(data_tat_plot$ResultDate)+1), 
                 breaks = seq(start_date, max(data_tat_plot$ResultDate), by = 3), date_minor_breaks = "1 day", 
                 date_labels = "%m/%d/%y", expand = c(0, 0, 0, 0)) +
    scale_y_continuous(limits = c(0, 1), breaks = seq(from = 0, to = 1, length.out = 5), expand = c(0, 0, 0.05, 0), labels = percent_format(accuracy = 1), 
                       sec.axis = sec_axis(~.*scale, name = "Volume of Labs"))
}
```


```{r Custom function for stepping through stratified TAT data for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}
stratified_data_for_plots <- function(tat_data, test) {
  test_df <- tat_data %>% 
    filter(Test == test,
           ResultDate >= start_date)
  sites <- unique(test_df$Site)
  for (site in sites) {
    site_df <- test_df %>%
      filter(Site == site)
    priorities <- unique(site_df$DashboardPriority)
    for (priority in priorities) {
      priority_df <- site_df %>%
        filter(DashboardPriority == priority)
      # print(tat_percentage_graph(data = priority_df, test_name = test, site_name = site, lab_priority = priority, metric = "ReceiveResultPercent"))
      # print(tat_percentage_graph(data = priority_df, test_name = test, site_name = site, lab_priority = priority, metric = "CollectResultPercent"))
      print(tat_and_volume_plot(data_tat = priority_df, test_name = test, site_name = site, lab_priority = priority, metric = "ReceiveResultPercent"))
      print(tat_and_volume_plot(data_tat = priority_df, test_name = test, site_name = site, lab_priority = priority, metric = "CollectResultPercent"))
      }
    print(resulted_volume_graph(data = dashboard_vol_summary, test_name = test, site_name = site))
  }
}
```


```{r Summarize data to calculate defects and defect rates for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}

# Summarize data based on site and priority
dashboard_defect_summary <- dashboard_tat_filter %>%
  group_by(Site, ResultDate, Division, Test, DashboardPriority) %>%
  summarize(ResultedVolume = sum(ResultedVolume), 
            ResultedVolumeWithTAT = sum(ResultedVolumeWithTAT),
            ReceiveResultInTarget = sum(ReceiveResultInTarget), 
            CollectResultInTarget = sum(CollectResultInTarget),
            ReceiveResultDefects = ResultedVolumeWithTAT - ReceiveResultInTarget, 
            ReceiveResultDefectRate = ReceiveResultDefects / ResultedVolumeWithTAT)

dashboard_defect_summary <- dashboard_defect_summary[!is.na(dashboard_defect_summary$ReceiveResultDefectRate), ]
```

```{r Custom function for p-charts for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE}

receive_result_pchart <- function(data_defect, test_name, site_name, lab_priority) {
  # 
  # Subset turnaround time and volume data based on test, site, and priority
  data_defect_plot <- data_defect %>%
    filter(ResultDate >= start_date & 
             Test == test_name & 
             Site == site_name & 
             DashboardPriority == lab_priority)
  # Calculate center line
  center_line <- mean(QC_Lines(data = data_defect_plot$ReceiveResultDefectRate, n = data_defect_plot$ResultedVolumeWithTAT, method = "p")$pBar)
  # 
  # Create plot and standard settings
  ggplot(data = data_defect_plot, aes(x = ResultDate, y = ReceiveResultDefectRate, n = ResultedVolumeWithTAT)) +
  # Create point and connecting lines for defect rate data
  geom_point(color = mshs_colors[1], shape = 16, size = 3) +
  geom_line(color = mshs_colors[1], linetype = "dashed") +
  # Add centerline, upper, and lower control limit lines
  stat_QC(method = "p", auto.label = T, color.qc_center = "black") +
  geom_label(x = max(data_defect_plot$ResultDate)+1, y = center_line, vjust = 1.2, hjust = 1, label = paste("CL:", percent(center_line, accuracy = 0.1))) +
  # Specify graph labels and themes
  labs(title = paste(site_name, test_name, lab_priority, "Labs:\n", "Control Chart of Non-Compliant Receive to Result TAT"), x = "Date",  y = "Percent Non-Compliant") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", 
          legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),
          axis.text.x = element_text(angle = 30, hjust = 1)) +
  # Specify axis properties
  scale_x_date(limits = c(start_date -1, max(data_defect_plot$ResultDate)+1), breaks = seq(start_date, max(data_defect_plot$ResultDate), by = 3), date_minor_breaks = "1 day", date_labels = "%m/%d/%y", expand = c(0, 0, 0, 0)) +
  scale_y_continuous(labels = percent_format(accuracy = 1))
}


```

```{r Iterate through defect rate data and plot p-charts for Clinical Pathology, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}

stratified_data_for_pcharts <- function(defect_data, test) {
  test_df <- defect_data %>%
    filter(Test == test & 
             ResultDate >= start_date)
  sites <- unique(test_df$Site)

  for (site in sites) {
    # print(site)
    # print(test)
    site_df <- test_df %>%
      filter(Site == site)
    priorities <- unique(site_df$DashboardPriority)
    for (priority in priorities) {
      # print(priority)
      priority_df <- site_df %>%
        filter(DashboardPriority == priority)
      # Determine average resulted volume over last 30 days to see if p-chart is valid
      avg_resulted_volume <- mean(priority_df$ResultedVolumeWithTAT[priority_df$ResultDate >= start_date])
      # print(avg_resulted_volume)
      if (avg_resulted_volume >= 50) {
        print(receive_result_pchart(data_defect = priority_df, test_name = test, site_name = site, lab_priority = priority))
      } else {
        cat(paste('\n<center><h3><i>', site, test, priority, "Labs: Insufficient volume for this analysis (n<50).</h3> \n <h4>(Average resulted volume over last 30 days:", round(avg_resulted_volume, digits = 0), "specimens.)", '</i></h4></center>\n\n<br><br>'))
      }
    }
  }
}

```


```{r Format Anatomic Pathology historical repository for plotting, warning = FALSE, message = FALSE, echo = FALSE}
#Exclude weekends
AP_historical_repo_weekdays <- AP_historical_repo[which(AP_historical_repo$Signed_out_day_only != "Sunday" & AP_historical_repo$Signed_out_day_only != "Saturday" & AP_historical_repo$Patient_setting != "NA"),]

AP_historical_repo_weekdays$Signed_out_date_only <- as.Date(AP_historical_repo_weekdays$Signed_out_date_only)
AP_historical_repo_weekdays$Lab_metric_within_target <- as.numeric(AP_historical_repo_weekdays$Lab_metric_within_target)
AP_historical_repo_weekdays$Patient_metric_avg <- as.numeric(AP_historical_repo_weekdays$Patient_metric_avg)
AP_historical_repo_weekdays$Lab_metric_avg <- as.numeric(AP_historical_repo_weekdays$Lab_metric_avg)

#Calculate the total none defects
AP_historical_repo_weekdays$total_none_defects <- round(AP_historical_repo_weekdays$Lab_metric_within_target * AP_historical_repo_weekdays$No_cases_signed_out)

#Calculate the total defects
AP_historical_repo_weekdays$total_defects <- AP_historical_repo_weekdays$No_cases_signed_out - AP_historical_repo_weekdays$total_none_defects 

#Standardize Facility name 
AP_historical_repo_weekdays$Facility_Old <- AP_historical_repo_weekdays$Facility

AP_historical_repo_weekdays$Facility[AP_historical_repo_weekdays$Facility == "BIMC"] <- "MSBI"
AP_historical_repo_weekdays$Facility[AP_historical_repo_weekdays$Facility == "R"] <- "MSW"
AP_historical_repo_weekdays$Facility[AP_historical_repo_weekdays$Facility == "SL"] <- "MSSL"
AP_historical_repo_weekdays$Facility[AP_historical_repo_weekdays$Facility == "KH"] <- "MSB"

#Add an extra column to change the facilities for GYN and CYTO GYN for receive to result to Centralized Lab
AP_historical_repo_weekdays$New_Facility_RTR_CYTO <- AP_historical_repo_weekdays$Facility

AP_historical_repo_weekdays[(AP_historical_repo_weekdays$Spec_group == "CYTO GYN" | AP_historical_repo_weekdays$Spec_group == "CYTO NONGYN"),]$New_Facility_RTR_CYTO <- "Centralized Lab"
  
#determine the 30 business that will be reported
unique_dates <- unique(AP_historical_repo_weekdays$Signed_out_date_only)

ordered_dates <- unique_dates[rev(order(unique_dates))]

reporting_30_day_period <- ordered_dates[1:30]
first_day_in_reporting_period <- ordered_dates[30] 
last_day_in_reporting_period <- ordered_dates[1]

historical_30_day_period <- AP_historical_repo_weekdays[which(AP_historical_repo_weekdays$Signed_out_date_only>=first_day_in_reporting_period),]

#summarized the data to plot it correctly
historical_30_day_period_sum_RTR <-summarise(group_by(historical_30_day_period, Signed_out_date_only,Spec_group, New_Facility_RTR_CYTO,Patient_setting), Lab_metric_within_target = format(round(mean(as.numeric(Lab_metric_within_target), na.rm = TRUE), 2)), Patient_metric_avg = format(round(mean(as.numeric(Patient_metric_avg), na.rm = TRUE),0)),No_cases_signed_out = sum(No_cases_signed_out))

historical_30_day_period_sum_RTR[c("Lab_metric_within_target", "Patient_metric_avg", "No_cases_signed_out")] <- lapply(historical_30_day_period_sum_RTR[c("Lab_metric_within_target", "Patient_metric_avg", "No_cases_signed_out")], as.numeric)

historical_30_day_period_sum_CTR <-summarise(group_by(historical_30_day_period, Signed_out_date_only,Spec_group, Facility, Patient_setting), Lab_metric_within_target = format(round(mean(as.numeric(Lab_metric_within_target), na.rm = TRUE), 2)), Patient_metric_avg = format(round(mean(as.numeric(Patient_metric_avg), na.rm = TRUE),0)),No_cases_signed_out = sum(No_cases_signed_out))

historical_30_day_period_sum_CTR[c("Lab_metric_within_target", "Patient_metric_avg", "No_cases_signed_out")] <- lapply(historical_30_day_period_sum_CTR[c("Lab_metric_within_target", "Patient_metric_avg", "No_cases_signed_out")], as.numeric)

historical_30_day_period_sum_vol <-summarise(group_by(historical_30_day_period, Signed_out_date_only,Spec_group, New_Facility_RTR_CYTO),No_cases_signed_out = sum(No_cases_signed_out))

historical_30_day_period_sum_vol_CTR <-summarise(group_by(historical_30_day_period, Signed_out_date_only,Spec_group, Facility),No_cases_signed_out = sum(No_cases_signed_out))

```


```{r Anatomic Pathology: plot volume and % TAT within target, warning = FALSE, message = FALSE, echo = FALSE}

#we need to create a percent within target graph for cyto and patho
#the graph will have the split between IP and AMB

lab_TAT_volume_AP_plot <- function(historical_30_day_period_sum_RTR, historical_30_day_period_sum_vol, test_name, site_name, metric) {
  
  data_tat <- historical_30_day_period_sum_RTR[historical_30_day_period_sum_RTR$Spec_group == test_name & historical_30_day_period_sum_RTR$New_Facility_RTR_CYTO == site_name,]
  
  data_vol <- historical_30_day_period_sum_vol[historical_30_day_period_sum_vol$Spec_group == test_name & historical_30_day_period_sum_vol$New_Facility_RTR_CYTO == site_name,]
 
  # Create printable metric name based on selected metric
  metric_name <- ifelse(metric == "Lab_metric_within_target", "Receive to Result", ifelse(metric == "Patient_metric_avg", "Collect to Result", "Error"))
  # Create printable test name based on selected test
  test_name <- ifelse(test_name == "Breast", "All Breast Specimen", ifelse(metric == "GI", "GI Biopsies", test_name))
  
ggplot() +
  # Plot safe, at risk, not safe thresholds
  geom_rect(aes(xmin = first_day_in_reporting_period - 1, xmax = last_day_in_reporting_period + 1, ymin = -Inf, ymax = 0.8, fill = "Not Safe", alpha = "Not Safe"))+
  geom_rect(aes(xmin = first_day_in_reporting_period - 1, xmax = last_day_in_reporting_period + 1, ymin = 0.8, ymax = 0.9, fill = "At Risk",  alpha = "At Risk"))+
  geom_rect(aes(xmin = first_day_in_reporting_period - 1, xmax = last_day_in_reporting_period + 1, ymin = 0.9, ymax = Inf, fill = "Safe", alpha = "Safe"))+  
  geom_rect(aes(xmin = first_day_in_reporting_period - 1, xmax = last_day_in_reporting_period + 1, ymin = 0.9, ymax = Inf, fill = "N/A", alpha = "N/A"), show.legend = FALSE)+ 

  # Plot resulted volume on secondary axis
  geom_point(data = data_vol, aes(x = Signed_out_date_only, y = No_cases_signed_out/max(No_cases_signed_out), size = "Spec_group"), shape = 18, color = "#959595")+
  geom_line(data = data_vol, aes(x = Signed_out_date_only, y = No_cases_signed_out/max(No_cases_signed_out),linetype = "Spec_group"), color = "#959595")+
  
  # Plot percentage of labs within turnaround time target
  geom_point(data = data_tat, aes_string(x = "Signed_out_date_only", y = metric, shape = "Patient_setting", color = "Patient_setting"), size = 3)+
  geom_line(data = data_tat, aes_string(x = "Signed_out_date_only", y = metric, shape = "Patient_setting", color = "Patient_setting"), linetype = "dashed")+
  
  # Specify graph labels and themes
  labs(title = paste0(site_name, " ", test_name, " ", metric_name, ":\n", "Percentage of Labs within Target TAT"), 
       x = "Date",  y = "Percentage of Labs", color = "Setting", shape = "Setting", fill = "Status", alpha = "Status", linetype = "Resulted Volume", size = "Resulted Volume") +
  
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", 
        legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 30, hjust = 1)) +
 
  # Specify fills, shapes, and lines mappings and legends
  scale_fill_manual(name = "Status", values = c("Not Safe" = "red", "At Risk" = "orange", "Safe" = "green", "N/A" = "grey"), breaks=c("Not Safe","At Risk","Safe")) +
  scale_alpha_manual(name = "Status", values = c("Not Safe" = 0.25, "At Risk" = 0.25, "Safe" = 0.25, "N/A" = 0.5), breaks=c("Not Safe","At Risk","Safe")) +
  
  scale_color_manual(name = "Setting", values = mshs_colors) +
  scale_size_manual(name = "Resulted Volume", values = 2, labels = paste("All Labs, \n All Settings")) + 
  scale_linetype_manual(name = "Resulted Volume", values = "dotted", labels = paste("All Labs, \n All Settings"))+
  
  # Reorder legends
  guides(color = guide_legend(order = 1, nrow = length(unique(data_tat$Patient_setting)), title.vjust = 1), shape = guide_legend(order = 1, nrow = length(unique(data_tat$Patient_setting)), title.vjust = 1), fill = guide_legend(order = 3, nrow = 3, title.vjust = 1), alpha = guide_legend(order = 3, nrow = 3, title.vjust = 1), size = guide_legend(order = 2, title.vjust = 1), linetype = guide_legend(order = 2, title.vjust = 1)) +
  
  # Specify axis properties
  scale_x_date(name = "Date", labels = date_format("%m/%d/%Y"), limits = c(first_day_in_reporting_period - 1,last_day_in_reporting_period + 1), date_breaks = "3 days", date_minor_breaks = "1 day", expand = c(0, 0, 0, 0))+
  scale_y_continuous(name = "Percentage of Labs",limits = c(0,1), labels = percent, sec.axis = sec_axis(~.*max(data_vol$No_cases_signed_out), name = "Volume of Labs"))

}



#lab_TAT_volume_AP_plot(historical_30_day_period_sum, historical_30_day_period_sum_vol, "CYTO GYN", "Centralized Lab", "Lab_metric_within_target")

```


```{r Anatomic Pathology: Avg TAT for patient metric, warning = FALSE, message = FALSE, echo = FALSE}

#we need to create a percent within target graph for cyto and patho
#the graph will have the split between IP and AMB

patient_TAT_AP_plot <- function(historical_30_day_period_sum_CTR, historical_30_day_period_sum_vol_CTR, test_name, site_name, metric) {
  
  data_tat <- historical_30_day_period_sum_CTR[historical_30_day_period_sum_CTR$Spec_group == test_name & historical_30_day_period_sum_CTR$Facility == site_name,]
  
  data_vol <- historical_30_day_period_sum_vol_CTR[historical_30_day_period_sum_vol_CTR$Spec_group == test_name & historical_30_day_period_sum_vol_CTR$Facility == site_name,]
  
  # Create printable metric name based on selected metric
  metric_name <- ifelse(metric == "Lab_metric_within_target", "Receive to Result", ifelse(metric == "Patient_metric_avg", "Collect to Result", "Error"))
  # Create printable test name based on selected test
  test_name <- ifelse(test_name == "Breast", "All Breast Specimen", ifelse(test_name == "GI", "GI Biopsies", test_name))

  ggplot() +

  # Plot resulted volume on secondary axis
  geom_point(data = data_vol, aes(x = Signed_out_date_only, y = No_cases_signed_out/mean(No_cases_signed_out) , size = "Spec_group"), shape = 18, color = "#959595")+
  geom_line(data = data_vol, aes(x = Signed_out_date_only, y = No_cases_signed_out/mean(No_cases_signed_out),linetype = "Spec_group"), color = "#959595")+
    
  # Plot Average lab metric TAT
  geom_point(data = data_tat, aes_string(x = "Signed_out_date_only", y = metric, shape = "Patient_setting", color = "Patient_setting"), size = 3)+
  geom_line(data = data_tat, aes_string(x = "Signed_out_date_only", y = metric, shape = "Patient_setting", color = "Patient_setting"), linetype = "dashed")+
  
  # Specify graph labels and themes
  labs(title = paste0(site_name, " ", test_name, " ", metric_name,":\n","Average TAT (Days)"), 
       x = "Date",  y = "Percentage of Labs", color = "Setting", shape = "Setting", linetype = "Resulted Volume", size = "Resulted Volume") +
  
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", 
        legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),
        axis.text.x = element_text(angle = 30, hjust = 1)) +
 
  # Specify fills, shapes, and lines mappings and legends
  scale_color_manual(name = "Setting", values = mshs_colors) +
  scale_size_manual(name = "Resulted Volume", values = 2, labels = paste("All Labs, \n All Settings")) + 
  scale_linetype_manual(name = "Resulted Volume", values = "dotted", labels = paste("All Labs, \n All Settings"))+
  
  # Reorder legends
  guides(color = guide_legend(order = 1, nrow = length(unique(data_tat$Patient_setting)), title.vjust = 1), shape = guide_legend(order = 1, nrow = length(unique(data_tat$Patient_setting)), title.vjust = 1), size = guide_legend(order = 2, title.vjust = 1), linetype = guide_legend(order = 2, title.vjust = 1)) +
  
  # Specify axis properties
  scale_x_date(name = "Date", labels = date_format("%m/%d/%Y"), limits = c(first_day_in_reporting_period - 1,last_day_in_reporting_period + 1), date_breaks = "3 days", date_minor_breaks = "1 day", expand = c(0, 0, 0, 0))+
  
  scale_y_continuous(name = "Average TAT (Days)",limits = c(0,max(data_tat$Patient_metric_avg+1)), sec.axis = sec_axis(~.*mean(data_vol$No_cases_signed_out), name = "Volume of Labs"))

}



#patient_TAT_AP_plot(historical_30_day_period_sum,"CYTO GYN", "MSH", "Patient_metric_avg")

```




```{r Custom function for graphing resulted lab volume, echo = FALSE, warning = FALSE, message = FALSE}
# Function for plotting total resulted lab volume

resulted_volume_graph <- function(historical_30_day_period_sum_vol, test_name, site_name) {
  
  data_vol <- historical_30_day_period_sum_vol[historical_30_day_period_sum_vol$Spec_group == test_name & historical_30_day_period_sum_vol$New_Facility_RTR_CYTO == site_name,]

  # Create printable test name based on selected test
  test_name <- ifelse(test_name == "Breast", "All Breast Specimen", ifelse(test_name == "GI", "GI Biopsies", test_name))

  ggplot() +
    geom_point(data = data_vol, aes(x = Signed_out_date_only, y = No_cases_signed_out, size = "Spec_group"), shape = 16, color = mshs_colors[1]) +
    geom_line(data = data_vol, aes(x = Signed_out_date_only, y = No_cases_signed_out, linetype = "Spec_group"), color = mshs_colors[1]) +
    labs(title = paste0(site_name, " ", test_name, " Resulted Lab Volume"), x = "Date",  y = "Volume of Labs", color = "Setting", shape = "Setting") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),axis.text.x = element_text(angle = 30, hjust = 1)) +
    scale_x_date(name = "Date", labels = date_format("%m/%d/%Y"), limits = c(first_day_in_reporting_period - 1,last_day_in_reporting_period + 1), date_breaks = "3 days", date_minor_breaks = "1 day", expand = c(0, 0, 0, 0))+
    scale_size_manual(name = "Resulted Volume", values = 2, labels = paste("All Labs, \n All Settings")) + 
    scale_linetype_manual(name = "Resulted Volume", values = "dotted", labels = paste("All Labs, \n All Settings"))+
    scale_y_continuous(limits = c(min(data_vol$No_cases_signed_out-1),max(data_vol$No_cases_signed_out+1)))
}

#resulted_volume_graph(historical_30_day_period_sum_vol, "CYTO NONGYN", "Centralized Lab")

```

```{r function to go through all the facilities for each test, warning = FALSE, message = FALSE, echo = FALSE}

stratified_data_for_AP_charts <- function(historical_30_day_period_sum_RTR, historical_30_day_period_sum_CTR, historical_30_day_period_sum_vol, test_name){
  
  sites_RTR <- unique(historical_30_day_period_sum_RTR[historical_30_day_period_sum_RTR$Spec_group == test_name,]$New_Facility_RTR_CYTO)
  
  sites_CTR <- unique(historical_30_day_period_sum_CTR[historical_30_day_period_sum_CTR$Spec_group == test_name,]$Facility)

  for (site_RTR in sites_RTR){
    
    print(lab_TAT_volume_AP_plot(historical_30_day_period_sum_RTR = historical_30_day_period_sum_RTR, historical_30_day_period_sum_vol = historical_30_day_period_sum_vol, test_name = test_name, site_name = site_RTR, metric = "Lab_metric_within_target"))
  }
  
  for (site_CTR in sites_CTR){
    print(patient_TAT_AP_plot(historical_30_day_period_sum_CTR = historical_30_day_period_sum_CTR, historical_30_day_period_sum_vol_CTR = historical_30_day_period_sum_vol_CTR, test_name = test_name, site_name = site_CTR, metric = "Patient_metric_avg"))
  }
  
  for (site_RTR in sites_RTR){
    print(resulted_volume_graph(historical_30_day_period_sum_vol = historical_30_day_period_sum_vol, test_name = test_name, site_name = site_RTR))
  }
}
  
#stratified_data_for_AP_charts(historical_30_day_period_sum_RTR, historical_30_day_period_sum_CTR, historical_30_day_period_sum_vol, "CYTO GYN")


```



```{r summarize data to calculate defects and defect rates for anatomic pathology, warning = FALSE, message = FALSE, echo = FALSE}

historical_30_day_period_defects <-summarise(group_by(historical_30_day_period, Signed_out_date_only,Spec_group, New_Facility_RTR_CYTO), No_cases_signed_out = sum(No_cases_signed_out),total_none_defects = sum(total_none_defects), total_defects = sum(total_defects), defective_rate = total_defects/No_cases_signed_out)

```

```{r function for defective rate p-charts for anatomic pathology, echo = FALSE, warning = FALSE, message = FALSE}
defective_rate_pchart <- function(historical_30_day_period_defects, test_name, site_name) {
  
  data_defc <- historical_30_day_period_defects[historical_30_day_period_defects$Spec_group == test_name & historical_30_day_period_defects$New_Facility_RTR_CYTO == site_name,]
  
  # Create printable test name based on selected test
  test_name <- ifelse(test_name == "Breast", "All Breast Specimen", ifelse(test_name == "GI", "GI Biopsies", test_name))
   
  # Find the center line for the p-chart using QC_lines 
  center_line <- mean(QC_Lines(data = data_defc$defective_rate, n = data_defc$No_cases_signed_out, method = "p")$pBar)
  
  # Create plot and standard settings
  ggplot(data = data_defc, aes(x = Signed_out_date_only, y = defective_rate, n = No_cases_signed_out)) +
  # Create point and connecting lines for defect rate data
  geom_point(color = mshs_colors[1], shape = 16, size = 3) +
  geom_line(color = mshs_colors[1], linetype = "dashed") +
  
  # Add centerline, upper, and lower control limit lines
  stat_QC(method = "p", auto.label = TRUE, color.qc_center = "black", limit.txt.label = c("LCL", "UCL")) +
  geom_label(x = max(data_defc$Signed_out_date_only)+1, y = center_line, vjust = 1.2, hjust = 1, label = paste("CL:", percent(center_line, accuracy = 0.1))) +
  # Specify graph labels and themes
  labs(title = paste(site_name, test_name, "All Labs:\n", "Control Chart of Non-Compliant Receive to Result TAT"), x = "Date",  y = "Percent Non-Compliant") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom", legend.box = "horizontal", 
          legend.title = element_text(size = 8, face = "bold"), legend.text = element_text(size = 8),
          axis.text.x = element_text(angle = 30, hjust = 1)) +
  # Specify axis properties
  scale_x_date(limits = c(first_day_in_reporting_period -1, max(data_defc$Signed_out_date_only)+1), breaks = seq(first_day_in_reporting_period, max(data_defc$Signed_out_date_only), by = 3), date_minor_breaks = "1 day", date_labels = "%m/%d/%y", expand = c(0, 0, 0, 0)) +
  scale_y_continuous(labels = percent_format(accuracy = 1))
}

#defective_rate_pchart(historical_30_day_period_defects, "CYTO GYN", "Centralized Lab")

```

```{r function to go through all the facilities for each test for the p-chart, warning = FALSE, message = FALSE, echo = FALSE, results = 'asis'}

stratified_data_for_AP_p_charts <- function(historical_30_day_period_defects, test_name){
  
  sites <- unique(historical_30_day_period_defects[historical_30_day_period_defects$Spec_group == test_name,]$New_Facility_RTR_CYTO)
    
  for (site in sites){
    
    avg_resulted_volume_AP <- mean(historical_30_day_period_defects[(historical_30_day_period_defects$New_Facility_RTR_CYTO==site & historical_30_day_period_defects$Spec_group==test_name),]$No_cases_signed_out)
    
    if (avg_resulted_volume_AP >= 50){
      print(defective_rate_pchart(historical_30_day_period_defects = historical_30_day_period_defects, test_name = test_name, site_name = site))
    }
    else{
      # Create printable test name based on selected test
      test_name_new <- ifelse(test_name == "Breast", "All Breast Specimen", ifelse(test_name == "GI", "GI Biopsies", test_name))
      cat(paste('\n<center><h3><i>', site, test_name_new, "Labs: Insufficient volume for this analysis (n<50).</h3> \n <h4>(Average resulted volume over last 30 days:", round(avg_resulted_volume_AP, digits = 0), "specimens.)", '</i></h4></center>\n\n<br><br>'))
    }
  }
}

  
#stratified_data_for_AP_p_charts(historical_30_day_period_defects, "CYTO NONGYN")

```
# {.tabset}

## Efficiency Indicator Historical Performance {.tabset}

### Troponin
```{r Troponin historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
stratified_data_for_plots(tat_data = dashboard_tat_filter, test = "Troponin")
```
<h6> TAT percentages include ED, ICU, and IP Non-ICU labs with valid turnaround times. Resulted volumes include all resulted labs from all settings, including Ambulatory. </h6>

### Lactate WB
```{r Lactate WB historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
stratified_data_for_plots(tat_data = dashboard_tat_filter, test = "Lactate WB")
```
<h6> TAT percentages include ED, ICU, and IP Non-ICU labs with valid turnaround times. Resulted volumes include all resulted labs from all settings, including Ambulatory. </h6>

### BUN
```{r BUN historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
stratified_data_for_plots(tat_data = dashboard_tat_filter, test = "BUN")
```
<h6> TAT percentages include ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Resulted volumes include all resulted labs from all settings. </h6>

### HGB
```{r HGB historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
stratified_data_for_plots(tat_data = dashboard_tat_filter, test = "HGB")
```
<h6> TAT percentages include ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Resulted volumes include all resulted labs from all settings. </h6>

### PT
```{r PT historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
stratified_data_for_plots(tat_data = dashboard_tat_filter, test = "PT")
```
<h6> TAT percentages include ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Resulted volumes include all resulted labs from all settings. </h6>

### Rapid Flu
```{r Rapid Flu historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
stratified_data_for_plots(tat_data = dashboard_tat_filter, test = "Rapid Flu")
```
<h6> TAT percentages include ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Resulted volumes include all resulted labs from all settings. </h6>

### C. diff
```{r C. diff historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}
stratified_data_for_plots(tat_data = dashboard_tat_filter, test = "C. diff")
```
<h6> TAT percentages include ED, ICU, and IP Non-ICU labs with valid turnaround times. Resulted volumes include all resulted labs from all settings. </h6>

### All Breast Specimens
```{r All Breast Specimens historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}

stratified_data_for_AP_charts(historical_30_day_period_sum_RTR, historical_30_day_period_sum_CTR, historical_30_day_period_sum_vol, "Breast")

```

### GI Biopsies
```{r GI Biopsies historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}

stratified_data_for_AP_charts(historical_30_day_period_sum_RTR, historical_30_day_period_sum_CTR, historical_30_day_period_sum_vol, "GI")

```

### Cyto Gyn Specimens
<h1><span style = "color:red">Cyto Gyn Pending - Resolution of Data Issues</h1>
```{r Cyto Gyn Specimens historical data, eval = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}

stratified_data_for_AP_charts(historical_30_day_period_sum_RTR, historical_30_day_period_sum_CTR, historical_30_day_period_sum_vol, "CYTO GYN")

```

### Cyto Non-Gyn Specimens
```{r Cyto Non-Gyn Specimens historical data, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center"}

stratified_data_for_AP_charts(historical_30_day_period_sum_RTR, historical_30_day_period_sum_CTR, historical_30_day_period_sum_vol, "CYTO NONGYN")

```

## Control Charts of Non-Compliant Labs {.tabset}
### Troponin
```{r Troponin p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
stratified_data_for_pcharts(defect_data = dashboard_defect_summary, test = "Troponin")
```
<h6> Control charts includes ED, ICU, and IP Non-ICU labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.


### Lactate WB
```{r Lactate WB p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
stratified_data_for_pcharts(defect_data = dashboard_defect_summary, test = "Lactate WB")
```
<h6> Control charts includes ED, ICU, and IP Non-ICU labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### BUN
```{r BUN p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
stratified_data_for_pcharts(defect_data = dashboard_defect_summary, test = "BUN")
```
<h6> Control charts includes ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### HGB
```{r HGB p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
stratified_data_for_pcharts(defect_data = dashboard_defect_summary, test = "HGB")
```
<h6> Control charts includes ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### PT
```{r PT p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
stratified_data_for_pcharts(defect_data = dashboard_defect_summary, test = "PT")
```
<h6> Control charts includes ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### Rapid Flu
```{r Rapid Flu p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
stratified_data_for_pcharts(defect_data = dashboard_defect_summary, test = "Rapid Flu")
# asis_output('<span style = "color: red">test text</span>')
```
<h6> Control charts includes ED, ICU, IP Non-ICU, and Ambulatory labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### C. diff
```{r C. diff p-charts, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", eval = TRUE, results = 'asis'}
stratified_data_for_pcharts(defect_data = dashboard_defect_summary, test = "C. diff")
```
<h6> Control charts includes ED, ICU, and IP Non-ICU labs with valid turnaround times. Percent non-compliant represents fraction of labs outside target turnaround time and is calculated as $\frac{Volume Of Resulted Labs Exceeding Target}{Total Volume Of Resulted Labs}$. Center line represents process mean and is calculated as $\overline{p} =  \frac{\sum_{} np}{n}$. Control limits calculated as $\overline{p} \pm 3\sqrt{\frac{\overline{p}(1-\overline{p})}{n}}$.

### All Breast Specimens
```{r All Breast Specimens pchart, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", results='asis'}

stratified_data_for_AP_p_charts(historical_30_day_period_defects, "Breast")

```

### GI Biopsies
```{r GI Biopsies  pchart, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", results='asis'}

stratified_data_for_AP_p_charts(historical_30_day_period_defects, "GI")

```

### Cyto Gyn Specimens
<h1><span style = "color:red">Cyto Gyn Pending - Resolution of Data Issues</h1>
```{r Cyto Gyn Specimens  pchart, eval = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", results='asis'}

stratified_data_for_AP_p_charts(historical_30_day_period_defects, "CYTO GYN")


```

### Cyto Non-Gyn Specimens
```{r Cyto Non-Gyn Specimens  pchart, echo = FALSE, warning = FALSE, message = FALSE, fig.height = 5, fig.width = 8, fig.align="center", results='asis'}

stratified_data_for_AP_p_charts(historical_30_day_period_defects, "CYTO NONGYN")

```














