---
title: "MSHS Laboratory KPI Dashboard (Preliminary)"
knit: (function(input, ...) {
      rmarkdown::render(input,
            output_file = paste0("/Pathology/Prelim Dashboard Output Tests KN/",
            "Lab KPI Prelim Dashboard ",
                    Sys.Date()),
      envir = globalenv()
    )
  })
output:
  html_document
    # toc: true
    # toc_depth: 2
    # toc_float: true
---
  
<!-- <h4><span style = "color:red">Draft - Not For Distribution</h4></span style = "color:red"> -->


```{r global_options, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
rm(list = ls())
```

```{r package_ref file, warning = FALSE, message = FALSE, echo = FALSE}
#######
# Source code for importing the needed packages, constants, reference files, and
# data templates for the lab KPI dashboard pre-processing -----
#######
source(here::here("Automated Daily Dashboard/Packages_Ref_Info.R"))
```

```{r raw_data_import file, warning = FALSE, message = FALSE, echo = FALSE}
#######
# Source Code for importing the raw data needed for the first run of the 
# daily dashboard.
# Imported data includes:
# 1. SCC data for clinical pathology
# 2. SunQuest data for clinical pathology
# 3. PowerPath data for anatomic pathology (surgical pathology & cytology)
# 4. Epic data for anatomic pathology including cytology
# 5. Backlog data for anatomic pathology including cytology-----
#######

source(here::here("Automated Daily Dashboard/Daily_Run_Raw_Data_Import.R"))
```

```{r Import CP custom functions, warning = FALSE, message = FALSE, echo = FALSE}
# Code with custom functions for preprocessing, analyzing, and displaying
# Clinical Pathology KPI -----
# CP includes Chemistry, Hematology, and Microbiology RRL divisions
source(here::here("Automation Standard Files/SCC_Sunquest_Preprocessing_Functions.R"))

source(here::here("Automated Daily Dashboard/CP_Summary_Kable_Functions.R"))
```

```{r Preprocess CP data, warning = FALSE, message = FALSE, echo = FALSE}
# Code for calling custom functions to preprocess and summarize CP data 
source(here::here("Automated Daily Dashboard/CP_Preprocessing_Analysis.R"))
```

```{r Subset and format CP data for each lab division for daily dashboard, warning = FALSE, message = FALSE, echo = FALSE}
# Custom function to subset and summarize data for each lab division ----------
# Chemistry
chem_tat_output <- summarize_cp_tat(x = cp_summary,
                                    lab_division = "Chemistry")

# Hematology
hematology_tat_output <- summarize_cp_tat(x = cp_summary,
                                          lab_division = "Hematology")

# Microbiology RRL
micro_tat_output <- summarize_cp_tat(x = cp_summary,
                                     lab_division = "Microbiology RRL")
    
micro_summary <- micro_tat_output[[1]]
micro_dashboard_cast <- micro_tat_output[[2]]

# # Microbiology RRL: Manually remove C. diff ambulatory TAT since only volume
# # is monitored for this lab/setting combination
# micro_dashboard_cast <- micro_dashboard_cast %>%
#   filter(!(Test == "C. diff" & DashboardSetting == "Amb"))
# row.names(micro_dashboard_cast) <- seq_len(nrow(micro_dashboard_cast))

# Infusion
infusion_tat_output <- summarize_cp_tat(x = cp_summary,
                                        lab_division = "Infusion")

```

```{r Import AP custom functions, warning = FALSE, message = FALSE, echo = FALSE}
#######
# Source Code for preprocessing, analyzing, and displaying Anatomic Pathology
# Anatomic Pathology (AP) includes Cytology and Surgical Pathology divisions
#######
#import source code
source(here::here("Automated Daily Dashboard/AP_functions_data_preprocessing.R"))
source(here::here("Automated Daily Dashboard/AP_processing_functions_for_output.R"))
source(here::here("Automated Daily Dashboard/AP_kable_outputs.R"))


```

```{r Preprocess AP data, warning = FALSE, message = FALSE, echo = FALSE}
processed_cytology_data <-  cyto_prep(epic_data_raw ,pp_data_raw,yesterday)

processed_surgical_pathology_data <- patho_prep(pp_data_raw,yesterday)

processed_backlog_data <- pre_processing_backlog(cyto_backlog_data_raw,yesterday)


```


```{r Calling the Custom functions for processing to output formats data, warning = FALSE, message = FALSE, echo = FALSE}
stratified_volume_cytology_24 <- get_stratified_volume(processed_cytology_data, "CYTOLOGY")
stratified_volume_surgical_pathology_24 <- get_stratified_volume(processed_surgical_pathology_data, "SURGICAL PATHOLOGY")

backlog_cytlogy <- analyze_backlog(processed_backlog_data,processed_cytology_data)

ei_cytlogy <- get_efficiency_indicators_cytology(processed_cytology_data)
ei_surgical_pathology <- get_efficiency_indicators_surgical_pathology(processed_surgical_pathology_data)

```



# {.tabset .tabset-fade .tabset-pills}

## **Efficiency Indicators** {.tabset .tabset-fade .tabset-pills}

<br>

### Chemistry       
#### *Chemistry KPI (Labs Resulted on `r result_date_text`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <95%,
<span style = "color:green">Green:</span> >=95%</h5>
```{r Chemistry dashboard table, warning = FALSE, message = FALSE, echo = FALSE}
kable_cp_tat(x = chem_tat_output[[2]])
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings. Labs with missing collection times excluded from collect-to-result analysis. MSH BUN excludes labs collected and processed at RTC; see "Infusion" tab.*</h6>
  
  
### Hematology
#### *Hematology KPI (Labs Resulted on `r result_date_text`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <95%,
<span style = "color:green">Green:</span> >=95%</h5>
```{r Hematology dashboard table, warning = FALSE, message = FALSE, echo = FALSE}
kable_cp_tat(x = hematology_tat_output[[2]])
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings. Labs with missing collection times excluded from collect-to-result analysis. MSH HGB excludes labs collected and processed at RTC; see "Infusion" tab.*</h6>
  

### Microbiology RRL
#### *Microbiology RRL KPI (Labs Resulted on `r result_date_text`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <90%, 
<span style = "color:orange">Yellow:</span> >=90% & <100%,
<span style = "color:green">Green:</span> =100%</h5>
```{r Create Micro RRL TAT and Volume Table, warning = FALSE, message = FALSE, echo = FALSE}
# Create volume table for Microbiology RRL that mimics TAT table layout
if (is.null(micro_summary)) {
  micro_tat_vol_cast <- NULL
} else {
  # Ensure all Microbiology RRL test, site, and priority combinations are included
  micro_vol_templ <- tat_dashboard_templ %>%
    filter(Division == "Microbiology RRL") %>%
    mutate(Incl = NULL,
           Division = NULL)
  
  micro_vol_df <- micro_summary %>%
    mutate(Metric = "ResultedVolume") %>%
    rename(Value = ResultedVolume) %>%
    select(-Division, -ResultedVol_ReceiveTAT, -ResultedVol_CollectTAT,
           -ReceiveResultInTarget, -CollectResultInTarget,
           -ReceiveResultPercent, -CollectResultPercent) %>%
    left_join(micro_vol_templ,
              by = c("Test" = "Test",
                     "Site" = "Site",
                     "DashboardPriority" = "DashboardPriority",
                     "DashboardSetting" = "DashboardSetting")) %>%
    mutate(Value = replace_na(Value, 0),
           ReceiveResultTarget = "ResultedVolume",
           CollectResultTarget = "",
           #
           # Set test, site, priority, and setting as factors
           Test = droplevels(factor(Test, levels = test_names,
                                    ordered = TRUE)),
           Site = droplevels(factor(Site, levels = all_sites,
                                    ordered = TRUE)),
           DashboardPriority = droplevels(
             factor(DashboardPriority,
                    levels = dashboard_priority_order,
                    ordered = TRUE)),
           DashboardSetting = droplevels(
             factor(DashboardSetting,
                    levels = dashboard_pt_setting,
                    ordered = TRUE))) %>%
    arrange(Test, DashboardPriority, DashboardSetting, Site) %>%
    pivot_wider(names_from = c(Metric, Site),
                names_sep = "_",
                values_from = Value) %>%
    relocate(TestAndPriority, .after = DashboardPriority) %>%
    relocate(ReceiveResultTarget, .after = TestAndPriority) %>%
    relocate(CollectResultTarget, .after = last_col())
  
  original_length <- ncol(micro_vol_df)
  
  missing_cols <- colnames(micro_dashboard_cast)[
    seq(original_length + 1, ncol(micro_dashboard_cast))]
  
  micro_vol_df[missing_cols] <- ""
  
  colnames(micro_vol_df) <- colnames(micro_dashboard_cast)
  
  micro_tat_vol_cast <- rbind(micro_dashboard_cast, micro_vol_df)
  
  micro_tat_vol_cast <- micro_tat_vol_cast %>%
    arrange(Test, ReceiveResultTarget)
}

kable_cp_tat(x = micro_tat_vol_cast)
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings. Labs with missing collection times excluded from collect-to-result analysis.*</h6>
  
### Infusion       
#### *Infusion KPI (Labs Resulted on `r result_date_text`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <90%,
<span style = "color:green">Green:</span> >=90%</h5>
```{r Create Infusion TAT and Volume Table, warning = FALSE, message = FALSE, echo = FALSE}
kable_cp_tat(x = infusion_tat_output[[2]])
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings. Labs with missing collection times excluded from collect-to-result analysis.*</h6>
  
### Missing Collections & Add Ons
#### *Missing Collection Times and Add On Order Volume (Labs Resulted on `r result_date_text`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> >15%, 
<span style = "color:orange">Yellow:</span> <=15% & >5%,
<span style = "color:green">Green:</span> <=5%</h5>
```{r Missing Collection Times Tables, warning = FALSE, message = FALSE, echo = FALSE}
# # Labs with missing collection times -----------------------
# Custom function for percentage of labs with missing collection times
# Call custom functions for missing collections and add-on order volume --------
kable_missing_collections(x = cp_summary)

kable_add_on_volume(x = cp_summary)

```
<h6>*Missing collection time analysis includes analytes represented in Chemistry, Hematology, and Microbiology RRL dashboard TAT analysis from ED, ICU, IP Non-ICU, and ambulatory settings.*</h6>
  
### Surgical Pathology
#### *Surgical Pathology KPI (Specimens Signed Out on `r result_date_text`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <90%,
<span style = "color:green">Green:</span> >=90%</h5>
```{r Surgical Pathology Efficiency Indicators, echo=FALSE, warning=FALSE, message=FALSE}

ei_surgical_pathology <- ap_ei_kable_surgical_pathology(ei_surgical_pathology)

ei_surgical_pathology
```
<h6>*TAT analysis includes all breast specimens and GI biopsies and excludes those with missing timestamps, negative TAT, and not from above settings.*</h6>
  
  
### Cytology
#### *Cytology KPI (Specimens Signed Out on `r result_date_text`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <90%,
<span style = "color:green">Green:</span> >=90%</h5>
```{r Cytology Efficiency Indicators, echo=FALSE, warning=FALSE, message=FALSE}
ei_cytlogy <- ap_ei_kable_cytology(ei_cytlogy)
ei_cytlogy
```

<br />
  
## **24-Hour Volume Lookback** {.tabset .tabset-fade .tabset-pills}

### Chemistry
#### *Chemistry Resulted Lab Volume (Labs Resulted on `r result_date_text`)*
```{r Chemistry: 24 hour volume lookback, echo = FALSE, warning = FALSE, message = FALSE}
chem_vol_table <- summarize_cp_vol(x = cp_summary,
                                        lab_division = "Chemistry")

kable_cp_vol(chem_vol_table)
```

### Hematology
#### *Hematology Resulted Lab Volume (Labs Resulted on `r result_date_text`)*
```{r Hematology: 24 hour volume lookback, echo = FALSE, warning = FALSE, message = FALSE}
hem_vol_table <- summarize_cp_vol(x = cp_summary,
                                       lab_division = "Hematology")

kable_cp_vol(hem_vol_table)
```

### Infusion
#### *Infusion Resulted Lab Volume (Labs Resulted on `r result_date_text`)*
```{r Infusion: 24 hour volume lookback, echo = FALSE, warning = FALSE, message = FALSE}
inf_vol_table <- summarize_cp_vol(x = cp_summary,
                                       lab_division = "Infusion")

kable_cp_vol(inf_vol_table)
```

### Surgical Pathology
#### *Surgical Pathology Signed Out Case Volume (Signed Out on `r result_date_text`)*
```{r Surgical Pathology: Volume of signed out cases, echo=FALSE, warning=FALSE, message=FALSE}

stratified_volume_surgical_pathology_24 <- table_formatting_volume(stratified_volume_surgical_pathology_24, "SURGICAL PATHOLOGY")

stratified_volume_surgical_pathology_24
```

### Cytology
#### *Cytology Accessioned Cases and Backlog Volume (As of `r result_date_text`)*
```{r Cytology Backlog and Accessioned case volume, echo=FALSE, warning=FALSE, message=FALSE}
backlog_cytlogy <- table_formatting_volume_backlog(backlog_cytlogy)

backlog_cytlogy
```

#### *Cytology Signed Out Cases Volume (As of `r result_date_text`)*
```{r Cytology Signed Out Cases, echo=FALSE, warning=FALSE, message=FALSE}

stratified_volume_cytology_24 <- table_formatting_volume(stratified_volume_cytology_24, "CYTOLOGY")
stratified_volume_cytology_24

```

## **Assumptions and Methodology** {.tabset .tabset-fade .tabset-pills}
### Definitions
<h4><b>Definition table</b></h4>
The table below summarizes the definitions for some of the terminology used in this dashboard for clarification purposes. 

```{r format table for definitions}

definition_table <-
  data.frame(read_excel(reference_file, sheet = "Definitions"),
             stringsAsFactors = FALSE)

definition_table  %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Terminology Used", "Terminology Definition")) %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white")

```

### Clinical Pathology

<h4><b>Data Sources</b></h4>
MSH and MSQ: Based on daily SCC report. Report name changes daily but follows structure of "DocMM-DD_xxxxxx.xlsx"</br>
MSBI, MSB, MSW, MSM: Based on daily Sunquest report titled "KPI_Daily_TAT_Report_Updated.xls"</br>
The table below summarizes the test codes and IDs used from these daily reports.

```{r Create and format a table for test codes}

test_codes_kable <- full_join(cp_scc_test_codes, cp_sun_test_codes,
                              by = c("TEST" = "TEST",
                                     "DIVISION" = "DIVISION"))

test_codes_kable <- test_codes_kable %>%
  select(DIVISION, TEST, SCC_TEST_ID, SUN_TEST_CODE) %>%
  mutate(TEST = factor(TEST, levels = cp_micro_lab_order, ordered = TRUE)) %>%
  arrange(TEST)

test_codes_kable %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Lab Division", "Test", "SCC Test ID",
                      "Sunquest Test Code")) %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2, 3, 4), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white") %>%
  collapse_rows()

```

<h4><b>Target Turnaround Times</b></h4>
The table below summarizes target turnaround times as agreed upon by clinical and operational leadership. 
```{r Create and format tables for TAT targets }

tat_targets_kable <- cp_tat_targets %>%
  select(DIVISION, TEST,
         PRIORITY, PT_SETTING,
         RECEIVE_TO_RESULT_TARGET, COLLECT_TO_RESULT_TARGET) %>%
  mutate(DIVISION = factor(DIVISION, levels = cp_division_order, ordered = TRUE),
         TEST = factor(TEST, levels = cp_micro_lab_order, ordered = TRUE),
         PRIORITY = factor(PRIORITY, levels = dashboard_priority_order,
                           ordered = TRUE)) %>%
  arrange(DIVISION, TEST, PRIORITY)

tat_targets_kable <- tat_targets_kable %>%
  mutate(Concate = NULL)

tat_targets_kable %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Division", "Test", "Priority", "Patient Setting",
                      "Receive to Result TAT Target (min)",
                      "Collect to Result TAT Target (min)"),
        caption = "Target Turnaround Times") %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1:ncol(tat_targets_kable)), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white")

```

<h4><b>Additional notes on target turnaround times:</b></h4>
  
* Troponin and Lactate WB:
    + All labs are treated as stat regardless of documented priority and patient setting.
    + Ambulatory labs excluded from turnaround time analysis
* Rapid Flu:
    + All labs are treated as stat regardless of documented priority and patient setting.
* C. diff:
    + All labs are treated as stat regardless of documented priority and patient setting.
    + Turnaround time for ambulatory C. diff tests are not tracked but rather volume of these labs is monitored.

<h4><b>Turnaround Time Exclusions</b></h4>
  
Turnaround time analysis excludes labs with out of order steps (ie, collect after receive), missing timestamps, add-on orders, and labs not originating in IP, ED, or ambulatory settings (ie, Outreach).

MSH turnaround times exclude BUN and HGB labs collected at RTC.

<br>
  
<h4><b>Add On Orders</b></h4>
Add on orders are defined as labs with an order time more than 5 minutes after receive time. These labs are excluded from turnaround time analysis but the volume of these labs is monitored.

<br>
  
<h4><b>Missing Collections</b></h4>
Labs are classified as missing collections based on the following criteria:
  
* SCC: Collection time equal to receive time
* Sunquest: Collection time equal to order time

### Anatomic Pathology
<h4><b>Target Turnaround Times</b></h4>
The table below summarizes target turnaround times for Anatomic Pathology as agreed upon by clinical and operational leadership. 

```{r Target Turnaround Times Table}

# tat_targets_ap  %>%
#   kable(format = "html", escape = FALSE, align = "c",
#         col.names = c("Test", "Patient Setting",
#                       "Receive to Result TAT Target (days)",
#                       "Collect to Result TAT Target (days)")) %>%
#   kable_styling(bootstrap_options = "hover", position = "center",
#                 font_size = 11, full_width = FALSE) %>%
#   column_spec(column = c(1, 2, 3, 4), border_right = "thin solid lightgray") %>%
#   row_spec(row = 0, font_size = 13, background = "#221f72", color = "white") %>%
#   collapse_rows(columns = 1)

```


<h4><b>Inclusion and Exclusion Criteria for GI Specimens</b></h4>
The table below summarizes the GI codes that were included vs. excluded during the TAT and volume calculations as agreed upon by clinical and operational leadership.
<br>
Only the codes for GI biopsies are included in the analysis.

```{r GI Codes Table}
# gi_codes_updated <-
#   gi_codes[, c("GI_Code_InclExcl",
#                "Spec_code")]
# 
# gi_codes_updated  %>%
#   kable(format = "html", escape = FALSE, align = "c",
#         col.names = c("Specimen Code", "Included vs. Excluded Codes")) %>%
#   kable_styling(bootstrap_options = "hover", position = "center",
#                 font_size = 11, full_width = FALSE) %>%
#   column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
#   row_spec(row = 0, font_size = 13, background = "#221f72",
#            color = "white") %>%
#   collapse_rows(columns = 1)
```

<h4><b>Additional notes on target turnaround times:</b></h4>
  
* Receive to Result TAT: for anatomic pathology this metric only includes MSHS business days and is a measure of internal laboratory performance.

* Collect to Result TAT: for anatomic pathology this metric includes all calendar days and is a patient-centric measure of performance.

* At this phase, target turnaround times for collect to result have not been established. This metric will be tracked in order to understand current performance and establish future targets.

* Primary Specimens: When a specimen has multiple slides, only the first slide is included. The primary slide is identified as those with spec_sort_order = A.

* All Breast Specimens:
    + Included all the primary breast specimens only. 
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume

* GI Biopsies:
    + Included only the samples that are consisted of GI biopsies
    + Only primary specimen GI biopsies included
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume

* Cyto Gyn:
    + TAT and volume analysis were only calculated for Cyto Gyn specimens that were finalized and closed out in EPIC
    + Included all primary Cyto Gyn specimens
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume

* Cyto Non-Gyn:
    + TAT and volume analysis were only calculated for Cyto non-Gyn specimens that were finalized and closed out in EPIC
    + Included all primary Cyto non-Gyn specimens
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume

* Backlog Cases:
    + Backlog cases are defined as all the cases that are open by cytology and microbiology.

<h6> *End of report.* </h6>
  