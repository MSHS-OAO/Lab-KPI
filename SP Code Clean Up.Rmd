---
title: "MSHS Laboratory KPI Dashboard"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---


```{r include = FALSE}
#Install packages only the first time you run the code
# install.packages("timeDate")
# install.packages("lubridate")
# install.packages("readxl")
# install.packages("dplyr")
# install.packages("reshape2")
# install.packages("knitr")
# install.packages("gdtools")
# install.packages("kableExtra")
# install.packages("formattable")
# install.packages("bizdays")
# install.packages("rmarkdown")
# install.packages("stringr")
# install.packages("writexl")

#-------------------------------Required packages------------------------------#

#Required packages: run these every time you run the code
library(timeDate)
library(readxl)
library(bizdays)
library(dplyr)
library(lubridate)
library(reshape2)
library(knitr)
# library(gdtools)
library(kableExtra)
library(formattable)
library(rmarkdown)
library(stringr)
library(writexl)


```


<h4><span style = "color:red">Draft - Not For Distribution</h4></span style = "color:red">


```{r global_options, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r Determine date, warning = FALSE, message = FALSE, echo = FALSE}
#Clear existing history
rm(list = ls())
#-------------------------------holiday/weekend-------------------------------#
# Get today and yesterday's date

#today <- as.timeDate(format(Sys.Date(), "%m/%d/%Y"))
today <- as.timeDate(as.Date("03/04/2021", format = "%m/%d/%Y"))


#Determine if yesterday was a holiday/weekend
#get yesterday's DOW
#yesterday <- as.timeDate(format(Sys.Date() - 1, "%m/%d/%Y"))
yesterday <- as.timeDate(as.Date("03/03/2021", format = "%m/%d/%Y"))

#Get yesterday's DOW
yesterday_day <- dayOfWeek(yesterday)

#Remove Good Friday from MSHS Holidays
nyse_holidays <- as.Date(holidayNYSE(year = 1990:2100))
good_friday <- as.Date(GoodFriday())
mshs_holiday <- nyse_holidays[good_friday != nyse_holidays]

#Determine whether yesterday was a holiday/weekend
holiday_det <- isHoliday(yesterday, holidays = mshs_holiday)

#Set up a calendar for collect to received TAT calculations for Path & Cyto
create.calendar("MSHS_working_days", mshs_holiday,
                weekdays = c("saturday", "sunday"))
bizdays.options$set(default.calendar = "MSHS_working_days")

```

#### *Dashboard Creation Date: `r format(today, "%m/%d/%Y")`*

```{r Import all data, warning = FALSE, message = FALSE, echo = FALSE}
# Select file/folder path for easier file selection and navigation

if (list.files("J://") == "Presidents") {
  user_directory <- paste0("J:/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "Service Lines/Lab Kpi/Data")
} else {
  user_directory <- paste0("J:/deans/Presidents/HSPI-PM/",
                           "Operations Analytics and Optimization/Projects/",
                           "Service Lines/Lab Kpi/Data")
}

#------------------------------Read Excel sheets------------------------------#

#Import weekday files
scc_weekday <- read_excel(
  choose.files(
    default = paste0(user_directory, "/SCC CP Reports/*.*"),
    caption = "Select SCC Report for Labs Resulted on Most Recent Weekday"),
    sheet = 1, col_names = TRUE)

sq_weekday <- suppressWarnings(read_excel(
  choose.files(
    default = paste0(user_directory, "/SUN CP Reports/*.*"),
    caption =
      "Select Sunquest Report for Labs Resulted on Most Recent Weekday"),
    sheet = 1, col_names = TRUE))
  
pp_weekday <- read_excel(
  choose.files(
    default = paste0(user_directory, "/AP & Cytology Signed Cases Reports/*.*"),
    caption =
      "Select PowerPath Report for Spec Signed Out on Most Recent Weekday"),
    skip = 1, 1)

pp_weekday <- data.frame(pp_weekday[-nrow(pp_weekday), ],
                         stringsAsFactors = FALSE)

epic_weekday <- read_excel(
  choose.files(
    default = paste0(user_directory, "/EPIC Cytology/*.*"),
    caption = "Select Epic Report for Spec Signed Out on Most Recent Weekday"),
  1)
  
# The if-statement below determines the number of raw data files to import
# based on the day of week and holidays. The user is then prompted to select
# each file from the relevant folder.

if (((holiday_det) & (yesterday_day == "Mon")) |
   ((yesterday_day == "Sun") & (isHoliday(yesterday - (86400 * 2))))) {
  # Scenario 1: Mon Holiday or Friday Holiday (Need to select 4 files)
  # Save scenario
  scenario <- 1
  # Import SCC data
  scc_hol_mon_fri <- read_excel(
    choose.files(
      default = paste0(user_directory, "/SCC CP Reports/*.*"),
      caption = "Select SCC Report for Labs Resulted on Recent Holiday"),
    sheet = 1, col_names = TRUE)
  scc_sun <- read_excel(
    choose.files(
      default = paste0(user_directory, "/SCC CP Reports/*.*"),
      caption = "Select SCC Report for Labs Resulted on Sunday"),
    sheet = 1, col_names = TRUE)
  scc_sat <- read_excel(
    choose.files(
      default = paste0(user_directory, "/SCC CP Reports/*.*"),
      caption = "Select SCC Report for Labs Resulted on Saturday"),
    sheet = 1, col_names = TRUE)
  #Merge the weekend data with the holiday data in one data frame
  scc_not_weekday <- rbind(scc_hol_mon_fri,
                           scc_sun,
                           scc_sat)
  #
  # Import Sunquest data
  sq_hol_mon_fri <- suppressWarnings(read_excel(
    choose.files(
      default = paste0(user_directory, "/SUN CP Reports/*.*"),
      caption = "Select Sunquest Report for Labs Resulted on Recent Holiday"),
    sheet = 1, col_names = TRUE))
  sq_sun <- suppressWarnings(read_excel(
    choose.files(
      default = paste0(user_directory, "/SUN CP Reports/*.*"),
      caption = "Select Sunquest Report for Labs Resulted on Sunday"),
    sheet = 1, col_names = TRUE))
  sq_sat <- suppressWarnings(read_excel(
    choose.files(
      default = paste0(user_directory, "/SUN CP Reports/*.*"),
      caption = "Select Sunquest Report for Labs Resulted on Saturday"),
    sheet = 1, col_names = TRUE))
  #Merge the weekend data with the holiday data in one data frame
  sq_not_weekday <- rbind(sq_hol_mon_fri, sq_sun, sq_sat)
  #
  # Import Powerpath data
  pp_hol_mon_fri <- read_excel(
    choose.files(
      default =
        paste0(user_directory, "/AP & Cytology Signed Cases Reports/*.*"),
      caption =
        "Select PowerPath Report for Spec Signed Out on Recent Holiday"),
    skip = 1, 1)
  pp_hol_mon_fri  <- pp_hol_mon_fri[
    -nrow(pp_hol_mon_fri), ]
  pp_sun <- read_excel(
    choose.files(
      default =
        paste0(user_directory, "/AP & Cytology Signed Cases Reports/*.*"),
      caption =
        "Select PowerPath Report for Spec Signed Out on Sunday"),
    skip = 1, 1)
  pp_sun <- pp_sun[-nrow(pp_sun), ]
  pp_sat <- read_excel(
    choose.files(
      default =
        paste0(user_directory, "/AP & Cytology Signed Cases Reports/*.*"),
      caption =
        "Select PowerPath Report for Spec Signed Out on Saturday"),
    skip = 1, 1)
  pp_sat <- pp_sat[-nrow(pp_sat), ]
  #Merge the weekend data with the holiday data in one data frame
  pp_not_weekday <- data.frame(rbind(pp_hol_mon_fri,
                                     pp_sun,
                                     pp_sat), stringsAsFactors = FALSE)
  #
  # Import EPIC Cytology data
  epic_hol_mon_fri <- read_excel(
    choose.files(
      default = paste0(user_directory, "/EPIC Cytology/*.*"),
      caption = "Select Epic Report for Spec Signed Out on Recent Holiday"),
    1)
  epic_sun <- read_excel(
    choose.files(
      default = paste0(user_directory, "/EPIC Cytology/*.*"),
      caption = "Select Epic Report for Spec Signed Out on Sunday"), 1)
  epic_sat <- read_excel(
    choose.files(
      default = paste0(user_directory, "/EPIC Cytology/*.*"),
      caption = "Select PowerPath Report for Spec Signed Out on Saturday"), 1)
  #Merge the weekend data with the holiday data in one data frame
  epic_not_weekday <- data.frame(rbind(epic_hol_mon_fri,
                                       epic_sun,
                                       epic_sat), stringsAsFactors = FALSE)

} else if ((holiday_det) & (yesterday_day == "Sun")) {
  # Scenario 2: Regular Monday (Need to select 3 files)
  # Save scenario
  scenario <- 2
  #
  # Import SCC data
  scc_sun <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"),
                 caption = "Select SCC Report for Labs Resulted on Sunday"),
    sheet = 1, col_names = TRUE)
  scc_sat <- read_excel(
    choose.files(default = paste0(user_directory, "/SCC CP Reports/*.*"),
                 caption = "Select SCC Report for Labs Resulted on Saturday"),
    sheet = 1, col_names = TRUE)
  #Merge the weekend data with the holiday data in one data frame
  scc_not_weekday <- rbind(scc_sun, scc_sat)
  #
  # Import Sunquest data
  sq_sun <- suppressWarnings(read_excel(
    choose.files(
      default = paste0(user_directory, "/SUN CP Reports/*.*"),
      caption = "Select Sunquest Report for Labs Resulted on Sunday"),
    sheet = 1, col_names = TRUE))
  sq_sat <- suppressWarnings(read_excel(
    choose.files(
      default = paste0(user_directory, "/SUN CP Reports/*.*"),
      caption = "Select Sunquest Report for Labs Resulted on Saturday"),
    sheet = 1, col_names = TRUE))
  #Merge the weekend data with the holiday data in one data frame
  sq_not_weekday <- rbind(sq_sun, sq_sat)
  #
  # Import Powerpath data
  pp_sun <- read_excel(
    choose.files(
      default =
        paste0(user_directory, "/AP & Cytology Signed Cases Reports/*.*"),
      caption =
        "Select PowerPath Report for Spec Signed Out on Sunday"),
    skip = 1, 1)
  pp_sun <- pp_sun[-nrow(pp_sun), ]
  pp_sat <- read_excel(
    choose.files(
      default =
        paste0(user_directory, "/AP & Cytology Signed Cases Reports/*.*"),
      caption =
        "Select PowerPath Report for Spec Signed Out on Saturday"),
    skip = 1, 1)
  pp_sat <- pp_sat[-nrow(pp_sat), ]
  #Merge the weekend data with the holiday data in one data frame
  pp_not_weekday <- data.frame(rbind(pp_sun,
                                     pp_sat), stringsAsFactors = FALSE)
  #
  # Import Epic Cytology data
  epic_sun <- read_excel(
    choose.files(
      default = paste0(user_directory, "/EPIC Cytology/*.*"),
      caption = "Select Epic Report for Spec Signed Out on Sunday"), 1)
  epic_sat <- read_excel(
    choose.files(
      default = paste0(user_directory, "/EPIC Cytology/*.*"),
      caption = "Select Epic Report for Spec Signed Out on Saturday"), 1)
  #Merge the weekend data with the holiday data in one data frame
  epic_not_weekday <- data.frame(rbind(epic_sun,
                                       epic_sat),
                                 stringsAsFactors = FALSE)

} else if ((holiday_det) & ((yesterday_day != "Mon") |
                            (yesterday_day != "Sun"))) {
  #Scenario 3: Midweek holiday (Need to select 2 files)
  # Save scenario
  scenario <- 3
  #
  # Import SCC data
  scc_hol_weekday <- read_excel(
    choose.files(
      default = paste0(user_directory, "/SCC CP Reports/*.*"),
      caption = "Select SCC Report for Labs Resulted on Recent Holiday"),
    sheet = 1, col_names = TRUE)
  scc_not_weekday <- scc_hol_weekday
  #
  # Import Sunquest data
  sq_hol_weekday <- suppressWarnings(read_excel(
    choose.files(
      default = paste0(user_directory, "/SUN CP Reports/*.*"),
      caption = "Select Sunquest Report for Labs Resulted on Recent Holiday"),
    sheet = 1, col_names = TRUE))
  sq_not_weekday <- sq_hol_weekday
  #
  # Import Powerpath data
  pp_hol_weekday <- read_excel(
    choose.files(
      default =
        paste0(user_directory, "/AP & Cytology Signed Cases Reports/*.*"),
      caption =
        "Select PowerPath Report for Spec Signed Out on Recent Holiday"),
    skip = 1, 1)
  pp_hol_weekday <- pp_hol_weekday[-nrow(pp_hol_weekday), ]
  pp_not_weekday <- data.frame(pp_hol_weekday, stringsAsFactors = FALSE)
  #
  # Import Epic Cytology data
  epic_hol_weekday <- read_excel(
    choose.files(
      default = paste0(user_directory, "/EPIC Cytology/*.*"),
      caption = "Select Epic Report for Spec Signed Out on Recent Holiday"), 1)
  epic_not_weekday <- data.frame(epic_hol_weekday, stringsAsFactors = FALSE)

} else {#Scenario 4: Tue-Fri without holidays (Need to select 1 file)
  # Save scenario
  scenario <- 4
  #
  scc_not_weekday <- NULL
  #
  sq_not_weekday <- NULL
  #
  pp_not_weekday <- NULL
  #
  epic_not_weekday <- NULL
}

#-----------Cytology Backlog Excel Files-----------#
#For the backlog files the read excel is starting from the second row and
#remove last row
cyto_backlog_raw <- read_excel(
  choose.files(default = paste0(user_directory,
                                "/Cytology Backlog Reports/*.*"),
               caption = "Select Cytology Backlog Report"),
  skip = 1, 1)
cyto_backlog_raw <- data.frame(
  cyto_backlog_raw[-nrow(cyto_backlog_raw), ], stringsAsFactors = FALSE)

```

```{r Reference Data, warning = FALSE, message = FALSE, echo = FALSE}
# Import analysis reference data
reference_file <- choose.files(
  default = paste0(user_directory, "/Code Reference/*.*"),
  caption = "Select analysis reference file")

# CP and Micro --------------------------------
test_code <- read_excel(reference_file, sheet = "TestNames")

tat_targets <- read_excel(reference_file, sheet = "Turnaround Targets")
tat_targets$Concate <- ifelse(tat_targets$Priority == "All" &
                                tat_targets$`Pt Setting` == "All",
                              tat_targets$Test,
                              ifelse(tat_targets$Priority != "All" &
                                       tat_targets$`Pt Setting` == "All",
                                     paste(tat_targets$Test,
                                           tat_targets$Priority),
                                     paste(tat_targets$Test,
                                           tat_targets$Priority,
                                           tat_targets$`Pt Setting`)))

scc_icu <- read_excel(reference_file, sheet = "SCC_ICU")
scc_setting <- read_excel(reference_file, sheet = "SCC_ClinicType")
sun_icu <- read_excel(reference_file, sheet = "SUN_ICU")
sun_setting <- read_excel(reference_file, sheet = "SUN_LocType")

mshs_site <- read_excel(reference_file, sheet = "SiteNames")

scc_wday <- scc_weekday
sun_wday <- sq_weekday

cp_micro_lab_order <- c("Troponin", "Lactate WB", "BUN", "HGB", "PT",
                        "Rapid Flu", "C. diff")

site_order <- c("MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM", "MSSN")

pt_setting_order <- c("ED", "ICU", "IP Non-ICU", "Amb", "Other")
pt_setting_order2 <- c("ED & ICU", "IP Non-ICU", "Amb", "Other")
dashboard_pt_setting <- c("ED & ICU", "IP Non-ICU", "Amb")

dashboard_priority_order <- c("All", "Stat", "Routine")

#-----------Patient Setting Excel File-----------#
#Using Rev Center to determine patient setting
patient_setting <- data.frame(read_excel(reference_file,
                                         sheet = "AP_Patient Setting"),
                              stringsAsFactors = FALSE)

#-----------Anatomic Pathology Targets Excel File-----------#
tat_targets_ap <- data.frame(read_excel(reference_file,
                                     sheet = "AP_TAT Targets"),
                          stringsAsFactors = FALSE)

#-----------GI Codes Excel File-----------#
#Upload the exclusion vs inclusion criteria associated with the GI codes
gi_codes <- data.frame(read_excel(reference_file, sheet = "GI_Codes"),
                       stringsAsFactors = FALSE)

#-----------Create table template for Cyto/Path-----------#
#The reason behind the table templates is to make sure all the variables and
#patient settings are included

#Cyto
#this template for cyto is with an assumption that received to result is not
#centralized
table_temp_cyto <- data.frame(matrix(ncol = 19, nrow = 4))

colnames(table_temp_cyto) <- c("spec_group", "Patient.Setting",
                                   "no_cases_signed",
                                   "MSH.x", "BIMC.x", "MSQ.x", "NYEE.x",
                                   "PACC.x", "R.x", "SL.x", "KH.x", "BIMC.y",
                                   "MSH.y", "MSQ.y", "NYEE.y", "PACC.y", "R.y",
                                   "SL.y", "KH.y")

table_temp_cyto[1] <- c("CYTO GYN", "CYTO GYN", "CYTO NONGYN", "CYTO NONGYN")
table_temp_cyto[2] <- c("IP", "Amb")

#this template for cyto is with an assumption that received to result is
#centralized
table_temp_cyto_v2 <- data.frame(matrix(ncol = 12, nrow = 4))

colnames(table_temp_cyto_v2) <- c("spec_group", "Patient.Setting",
                                      "no_cases_signed",
                                      "received_to_signed_out_within_target",
                                      "BIMC", "MSH", "MSQ", "NYEE", "PACC",
                                      "R", "SL", "KH")

table_temp_cyto_v2[1] <- c("CYTO GYN", "CYTO GYN", "CYTO NONGYN", "CYTO NONGYN")
table_temp_cyto_v2[2] <- c("IP", "Amb")

#this table template is for cytology volume
table_temp_cyto_vol <- data.frame(matrix(ncol = 10, nrow = 4))

colnames(table_temp_cyto_vol) <- c("spec_group", "Patient.Setting",
                                       "BIMC", "MSH", "MSQ", "NYEE", "PACC",
                                       "R", "SL", "KH")

table_temp_cyto_vol[1] <- c("CYTO GYN", "CYTO GYN",
                            "CYTO NONGYN", "CYTO NONGYN")
table_temp_cyto_vol[2] <- c("IP", "Amb")

#Patho
#this template for patho (sp) is with an assumption that received to result is
#not centralized
table_temp_patho <- data.frame(matrix(ncol = 17, nrow = 4))
colnames(table_temp_patho) <- c("spec_group", "Patient.Setting",
                                    "no_cases_signed",
                                    "MSH.x", "BIMC.x", "MSQ.x", "PACC.x",
                                    "R.x", "SL.x", "KH.x", "BIMC.y", "MSH.y",
                                    "MSQ.y", "PACC.y", "R.y", "SL.y", "KH.y")

table_temp_patho[1] <- c("Breast", "Breast", "GI", "GI")
table_temp_patho[2] <- c("IP", "Amb")

#this table template is for surgical pathology volume
table_temp_patho_vol <- data.frame(matrix(ncol = 9, nrow = 4))
colnames(table_temp_patho_vol) <- c("spec_group", "Patient.Setting",
                                        "BIMC", "MSH", "MSQ", "PACC",
                                        "R", "SL", "KH")

table_temp_patho_vol[1] <- c("Breast", "Breast", "GI", "GI")
table_temp_patho_vol[2] <- c("IP", "Amb")

```


```{r Custom Function for preprocessing raw SCC and Sunquest data, warning = FALSE, message = FALSE, echo = FALSE}
preprocess_scc_sun <- function(raw_scc, raw_sun)  {

# SCC DATA PROCESSING --------------------------
  # SCC lookup references ----------------------------------------------
  # Crosswalk labs included and remove out of scope labs
  raw_scc <- left_join(raw_scc,
                       test_code[ , c("Test", "SCC_TestID", "Division")], 
                       by = c("TEST_ID" = "SCC_TestID"))
  raw_scc$TEST_ID <- as.factor(raw_scc$TEST_ID)
  raw_scc$Division <- as.factor(raw_scc$Division)

  raw_scc <- raw_scc %>%
    mutate(TestIncl = ifelse(is.na(raw_scc$Test), FALSE, TRUE))
  
  raw_scc <- raw_scc %>%
    filter(TestIncl)
  
  # Crosswalk units and identify ICUs
  raw_scc <- raw_scc %>%
    mutate(WardandName = paste(Ward, WARD_NAME))
  
  raw_scc <- left_join(raw_scc, scc_icu[ , c("Concatenate", "ICU")], 
                       by = c("WardandName" = "Concatenate"))
  raw_scc[is.na(raw_scc$ICU), "ICU"] <- FALSE
  
  # Crosswalk unit type
  raw_scc <- left_join(raw_scc, scc_setting, 
                       by = c("CLINIC_TYPE" = "Clinic_Type"))
  # Crosswalk site name
  raw_scc <- left_join(raw_scc, mshs_site, 
                       by = c("SITE" = "DataSite"))
  
  # SCC data formatting ----------------------------------------------
  raw_scc[c("Ward", 
            "WARD_NAME", 
            "REQUESTING_DOC",
            "GROUP_TEST_ID",
            "TEST_ID",
            "TEST_NAME",
            "Test",
            "COLLECT_CENTER_ID",
            "SITE",
            "Site",
            "CLINIC_TYPE",
            "Setting",
            "SettingRollUp")] <- lapply(raw_scc[c("Ward",
                                                  "WARD_NAME",
                                                  "REQUESTING_DOC", 
                                                  "GROUP_TEST_ID",
                                                  "TEST_ID", 
                                                  "TEST_NAME", 
                                                  "Test",
                                                  "COLLECT_CENTER_ID",
                                                  "SITE",
                                                  "Site",
                                                  "CLINIC_TYPE",
                                                  "Setting",
                                                  "SettingRollUp")], 
                                        as.factor)
  
  # Fix any timestamps that weren't imported correctly and then format as date/time
  raw_scc[c("ORDERING_DATE", 
            "COLLECTION_DATE", 
            "RECEIVE_DATE", 
            "VERIFIED_DATE")] <- lapply(raw_scc[c("ORDERING_DATE", 
                                                  "COLLECTION_DATE", 
                                                  "RECEIVE_DATE", 
                                                  "VERIFIED_DATE")], 
           function(x) ifelse(!is.na(x) & str_detect(x, "\\*.*\\*")  == TRUE, 
                              str_replace(x, "\\*.*\\*", ""), x))
  
  raw_scc[c("ORDERING_DATE",
            "COLLECTION_DATE",
            "RECEIVE_DATE",
            "VERIFIED_DATE")] <- lapply(raw_scc[c("ORDERING_DATE",
                                                  "COLLECTION_DATE",
                                                  "RECEIVE_DATE",
                                                  "VERIFIED_DATE")], 
           as.POSIXct, tz = "UTC", format = "%Y-%m-%d %H:%M:%OS", 
           options(digits.sec = 1))
  
  # Add a column for Resulted date for later use in repository
  raw_scc <- raw_scc %>%
    mutate(ResultedDate = as.Date(VERIFIED_DATE, format = "%m/%d/%Y"))
  
  # Update patient setting to reflect ICU/Non-ICU and 
  # update priorities for ED and ICU labs
  raw_scc <- raw_scc %>%
    mutate(MasterSetting = ifelse(CLINIC_TYPE == "E", "ED", 
                                  ifelse(CLINIC_TYPE == "O", "Amb", 
                                         ifelse(CLINIC_TYPE == "I" & 
                                                  ICU == TRUE, "ICU",
                                                ifelse(CLINIC_TYPE == "I" & 
                                                         ICU != TRUE, 
                                                       "IP Non-ICU", 
                                                       "Other")))),
           DashboardSetting = ifelse(MasterSetting == "ED" | 
                                       MasterSetting == "ICU", "ED & ICU", 
                                     MasterSetting))
  
  # Update priority to reflect ED/ICU as stat and create Master Priority 
  # for labs where all specimens are treated as stat
  raw_scc <- raw_scc %>%
    mutate(AdjPriority = ifelse(MasterSetting == "ED" | 
                                  MasterSetting == "ICU" | PRIORITY == "S", 
                                "Stat", "Routine"),
           DashboardPriority = ifelse(
             tat_targets$Priority[match(Test, tat_targets$Test)] == "All", 
                                      "All", AdjPriority))

  # Calculate turnaround times
  raw_scc <- raw_scc %>%
    mutate(CollectToReceive = RECEIVE_DATE - COLLECTION_DATE,
           ReceiveToResult = VERIFIED_DATE - RECEIVE_DATE,
           CollectToResult = VERIFIED_DATE - COLLECTION_DATE)
  
  raw_scc[c("CollectToReceive", "ReceiveToResult", "CollectToResult")] <- 
    lapply(raw_scc[c("CollectToReceive", "ReceiveToResult", "CollectToResult")], 
           as.numeric, units = "mins")
  
  # Identify add on orders as orders placed more than 5 min 
  # after specimen received
  # Identify specimens with missing collections times as those with 
  # collection time defaulted to receive time
  raw_scc <- raw_scc %>%
    mutate(AddOnMaster = ifelse(difftime(ORDERING_DATE, 
                                         RECEIVE_DATE, units = "mins") > 5, 
                                "AddOn", "Original"),
           MissingCollect = ifelse(CollectToReceive == 0, TRUE, FALSE))
  
  # Determine target TAT based on test, priority, and patient setting
  raw_scc <- raw_scc %>%
    mutate(Concate1 = paste(Test, DashboardPriority),
           Concate2 = paste(Test, DashboardPriority, MasterSetting),
           ReceiveResultTarget = ifelse(
             !is.na(match(Concate2, tat_targets$Concate)),
             tat_targets$ReceiveToResultTarget[match(Concate2, 
                                                     tat_targets$Concate)],
             ifelse(!is.na(match(Concate1, tat_targets$Concate)), 
                    tat_targets$ReceiveToResultTarget[match(Concate1, 
                                                            tat_targets$Concate)],
                    tat_targets$ReceiveToResultTarget[match(Test, 
                                                            tat_targets$Concate)])),
           CollectResultTarget = ifelse(
             !is.na(match(Concate2, tat_targets$Concate)),
             tat_targets$CollectToResultTarget[match(Concate2, 
                                                     tat_targets$Concate)], 
             ifelse(!is.na(match(Concate1, tat_targets$Concate)), 
                    tat_targets$CollectToResultTarget[match(Concate1, 
                                                            tat_targets$Concate)], 
                    tat_targets$CollectToResultTarget[match(Test, 
                                                            tat_targets$Concate)])),
           ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget, 
           CollectResultInTarget = CollectToResult <= CollectResultTarget)
  
  # Identify and remove duplicate tests
  raw_scc <- raw_scc %>%
    mutate(Concate3 = paste(LAST_NAME, FIRST_NAME,
                            ORDER_ID, TEST_NAME, 
                            COLLECTION_DATE, RECEIVE_DATE, VERIFIED_DATE))
  
  raw_scc <- raw_scc[!duplicated(raw_scc$Concate3), ]
  
  # Identify which labs to include in TAT analysis
  # Exclude add on orders, orders from "other" settings, orders with collect or 
  # receive times after result, or orders with missing collect, receive, or 
  # result timestamps
  raw_scc <- raw_scc %>% 
    mutate(TATInclude = ifelse(AddOnMaster != "Original" | 
                                 MasterSetting == "Other" | 
                                 CollectToResult < 0 | 
                                 ReceiveToResult < 0 | 
                                 is.na(CollectToResult) | 
                                 is.na(ReceiveToResult), FALSE, TRUE))

  scc_master <- raw_scc[ , c("Ward", "WARD_NAME", "WardandName",
                             "ORDER_ID", "REQUESTING_DOC NAME", 
                             "MPI", "WORK SHIFT",
                             "TEST_NAME", "Test", "Division", "PRIORITY", 
                             "Site", "ICU", "CLINIC_TYPE", 
                             "Setting", "SettingRollUp", 
                             "MasterSetting", "DashboardSetting",
                             "AdjPriority", "DashboardPriority",
                             "ORDERING_DATE", "COLLECTION_DATE", 
                             "RECEIVE_DATE", "VERIFIED_DATE",
                             "ResultedDate", 
                             "CollectToReceive", "ReceiveToResult", 
                             "CollectToResult", 
                             "AddOnMaster", "MissingCollect", 
                             "ReceiveResultTarget", "CollectResultTarget", 
                             "ReceiveResultInTarget", "CollectResultInTarget", 
                             "TATInclude")]
  
  colnames(scc_master) <- c("LocCode", "LocName", "LocConcat",
                            "OrderID", "RequestMD", 
                            "MSMRN", "WorkShift", 
                            "TestName", "Test", "Division", "OrderPriority", 
                            "Site", "ICU", "LocType", 
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting",
                            "AdjPriority", "DashboardPriority",
                            "OrderTime", "CollectTime", 
                            "ReceiveTime", "ResultTime", 
                            "ResultDate", 
                            "CollectToReceiveTAT", "ReceiveToResultTAT", 
                            "CollectToResultTAT", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")

  
  ## SUNQUEST DATA PROCESSING ----------
  # Sunquest lookup references ----------------------------------------------
  # Crosswalk labs included and remove out of scope labs
  raw_sun <- left_join(raw_sun, test_code[ , c("Test", 
                                               "SUN_TestCode", 
                                               "Division")], 
                       by = c("TestCode" = "SUN_TestCode"))
  raw_sun$TestCode <- as.factor(raw_sun$TestCode)
  raw_sun$Division <- as.factor(raw_sun$Division)
  raw_sun <- raw_sun %>%
    mutate(TestIncl = ifelse(is.na(Test), FALSE, TRUE))
  
  raw_sun <- raw_sun[raw_sun$TestIncl == TRUE, ]
  
  # Crosswalk units and identify ICUs
  raw_sun <- raw_sun %>%
    mutate(LocandName = paste(LocCode, LocName))
  
  raw_sun <- left_join(raw_sun, sun_icu[ , c("Concatenate", "ICU")], 
                       by = c("LocandName" = "Concatenate"))
  raw_sun[is.na(raw_sun$ICU), "ICU"] <- FALSE
  
  # Crosswalk unit type
  raw_sun <- left_join(raw_sun, sun_setting, by = c("LocType" = "LocType"))
  
  # Crosswalk site name
  raw_sun <- left_join(raw_sun, mshs_site, by = c("HospCode" = "DataSite"))

  # Sunquest data formatting --------------------------------------------
  raw_sun[c("HospCode", "BatTstCode", "BATName", "TestCode", "TSTName",
             "LocType", "LocCode", "LocName", 
             "PhysName", "SHIFT",
             "ReceiveTech", "ResultTech", "PerformingLabCode",
             "Test", "LocandName", "Setting", "SettingRollUp", "Site")] <- 
    lapply(raw_sun[c("HospCode", "BatTstCode", "BATName", "TestCode", "TSTName",
                     "LocType", "LocCode", "LocName", 
                     "PhysName", "SHIFT", 
                     "ReceiveTech", "ResultTech", "PerformingLabCode", 
                     "Test", "LocandName", "Setting", "SettingRollUp", "Site")],
           as.factor)
  
  # Fix any timestamps that weren't imported correctly and then format as date/time
  raw_sun[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")], 
           function(x) ifelse(!is.na(x) & str_detect(x, "\\*.*\\*")  == TRUE, 
                              str_replace(x, "\\*.*\\*", ""), x))

  raw_sun[c("OrderDateTime", 
            "CollectDateTime", 
            "ReceiveDateTime", 
            "ResultDateTime")] <- 
    lapply(raw_sun[c("OrderDateTime", 
                     "CollectDateTime", 
                     "ReceiveDateTime", 
                     "ResultDateTime")], 
           as.POSIXct, tz = "UTC", format = "%m/%d/%Y %H:%M:%S")
  
  # Add a column for Resulted date for later use in repository
  raw_sun <- raw_sun %>%
    mutate(ResultedDate = as.Date(ResultDateTime, format = "%m/%d/%Y"))

  # Sunquest data preprocessing -----------------------------------------------
  # Update patient setting to reflect ICU/Non-ICU and update priorities for 
  # ED and ICU labs
  raw_sun <- raw_sun %>%
    mutate(MasterSetting = ifelse(SettingRollUp == "ED", "ED", 
                                  ifelse(SettingRollUp == "Amb", "Amb", 
                                         ifelse(SettingRollUp == "IP" & 
                                                  ICU == TRUE, "ICU",
                                                ifelse(SettingRollUp == "IP" & 
                                                         ICU == FALSE, 
                                                       "IP Non-ICU", "Other")))), 
           DashboardSetting = ifelse(MasterSetting == "ED" | 
                                       MasterSetting == "ICU", "ED & ICU", 
                                     MasterSetting))
  
  # Update priority to reflect ED/ICU as stat and create Master Priority for 
  # labs where all specimens are treated as stat
  raw_sun <- raw_sun %>%
    mutate(AdjPriority = ifelse(MasterSetting != "ED" & MasterSetting != "ICU" &
                                  is.na(SpecimenPriority), "Routine",
                                ifelse(MasterSetting == "ED" | 
                                         MasterSetting == "ICU" | 
                                         SpecimenPriority == "S", "Stat", 
                                       "Routine")),
           DashboardPriority = ifelse(tat_targets$Priority[match(
             Test, tat_targets$Test)] == "All", "All", AdjPriority))

  # Calculate turnaround times
  raw_sun <- raw_sun %>%
    mutate(CollectToReceive = ReceiveDateTime - CollectDateTime,
           ReceiveToResult = ResultDateTime - ReceiveDateTime,
           CollectToResult = ResultDateTime - CollectDateTime)
  
  raw_sun[c("CollectToReceive", "ReceiveToResult", "CollectToResult")] <- 
    lapply(raw_sun[c("CollectToReceive", "ReceiveToResult", "CollectToResult")], 
           as.numeric, units = "mins")
  
  # Identify add on orders as orders placed more than 5 min after 
  # specimen received. 
  # Identify specimens with missing collections times as those with collection 
  # time defaulted to order time
  raw_sun <- raw_sun %>%
    mutate(AddOnMaster = ifelse(difftime(OrderDateTime, ReceiveDateTime, 
                                         units = "mins") > 5, "AddOn", 
                                "Original"),
           MissingCollect = ifelse(CollectDateTime == OrderDateTime, TRUE, 
                                   FALSE))
  
  # Determine target TAT based on test, priority, and patient setting
  raw_sun <- raw_sun %>%
    mutate(Concate1 = paste(Test, DashboardPriority), 
           Concate2 = paste(Test, DashboardPriority, MasterSetting),
           ReceiveResultTarget = ifelse(!is.na(match(Concate2, 
                                                     tat_targets$Concate)), 
                                        tat_targets$ReceiveToResultTarget[
                                          match(Concate2, tat_targets$Concate)], 
                                        ifelse(!is.na(match(Concate1,
                                                            tat_targets$Concate)),
                                               tat_targets$ReceiveToResultTarget[
                                                 match(Concate1, 
                                                       tat_targets$Concate)],
                                               tat_targets$ReceiveToResultTarget[
                                                 match(Test, 
                                                       tat_targets$Concate)])),
           CollectResultTarget = ifelse(!is.na(match(Concate2, 
                                                     tat_targets$Concate)), 
                                        tat_targets$CollectToResultTarget[
                                          match(Concate2, tat_targets$Concate)], 
                                        ifelse(!is.na(match(Concate1, 
                                                            tat_targets$Concate)), 
                                               tat_targets$CollectToResultTarget[
                                                 match(Concate1, 
                                                       tat_targets$Concate)], 
                                               tat_targets$CollectToResultTarget[
                                                 match(Test, 
                                                       tat_targets$Concate)])),
           ReceiveResultInTarget = ReceiveToResult <= ReceiveResultTarget,
           CollectResultInTarget = CollectToResult <= CollectResultTarget)
  
  # Identify and remove duplicate tests
  raw_sun <- raw_sun %>%
    mutate(Concate3 = paste(PtNumber, HISOrderNumber, TSTName, 
                            CollectDateTime, ReceiveDateTime, ResultDateTime))
  
  raw_sun <- raw_sun[!duplicated(raw_sun$Concate3), ]
  
  # Identify which labs to include in TAT analysis
  # Exclude add on orders, orders from "other" settings, orders with collect or 
  # receive times after result, or orders with missing collect, receive, or 
  # result timestamps
  raw_sun <- raw_sun %>%
    mutate(TATInclude = ifelse(AddOnMaster != "Original" | 
                                 MasterSetting == "Other" | 
                                 CollectToResult < 0 | 
                                 ReceiveToResult < 0 | 
                                 is.na(CollectToResult) | 
                                 is.na(ReceiveToResult), FALSE, TRUE))
  
  sun_master <- raw_sun[ ,c("LocCode", "LocName", "LocandName", 
                            "HISOrderNumber", "PhysName", 
                            "PtNumber", "SHIFT",            
                            "TSTName", "Test", "Division", "SpecimenPriority", 
                            "Site", "ICU", "LocType",               
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting", 
                            "AdjPriority", "DashboardPriority", 
                            "OrderDateTime", "CollectDateTime", 
                            "ReceiveDateTime", "ResultDateTime", 
                            "ResultedDate", 
                            "CollecttoReceive", "ReceivetoResult", 
                            "CollecttoResult", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")]
  
  colnames(sun_master) <- c("LocCode", "LocName", "LocConcat", 
                            "OrderID", "RequestMD", 
                            "MSMRN", "WorkShift", 
                            "TestName", "Test", "Division", "OrderPriority", 
                            "Site", "ICU", "LocType", 
                            "Setting", "SettingRollUp", 
                            "MasterSetting", "DashboardSetting", 
                            "AdjPriority", "DashboardPriority",
                            "OrderTime", "CollectTime", 
                            "ReceiveTime", "ResultTime", 
                            "ResultDate", 
                            "CollectToReceiveTAT", "ReceiveToResultTAT", 
                            "CollectToResultTAT", 
                            "AddOnMaster", "MissingCollect", 
                            "ReceiveResultTarget", "CollectResultTarget", 
                            "ReceiveResultInTarget", "CollectResultInTarget", 
                            "TATInclude")
  
  
  scc_sun_master <- rbind(scc_master, sun_master)
  
  scc_sun_master[c("LocConcat", "RequestMD", "WorkShift", 
                   "AdjPriority", "AddOnMaster")] <-
    lapply(scc_sun_master[c("LocConcat", "RequestMD", "WorkShift",
                            "AdjPriority", "AddOnMaster")], as.factor)
  
  scc_sun_master$Site <- factor(scc_sun_master$Site, 
                                levels = site_order)
  scc_sun_master$Test <- factor(scc_sun_master$Test, 
                                levels = cp_micro_lab_order)
  scc_sun_master$MasterSetting <- factor(scc_sun_master$MasterSetting, 
                                         levels = pt_setting_order)
  scc_sun_master$DashboardSetting <- factor(scc_sun_master$DashboardSetting, 
                                            levels = pt_setting_order2)
  scc_sun_master$DashboardPriority <- factor(scc_sun_master$DashboardPriority, 
                                             levels = dashboard_priority_order)
  
  scc_sun_list <- list(raw_scc, raw_sun, scc_sun_master)
  
}
```

```{r Data Preprocessing and Merging for SCC and Sunquest data, message = FALSE, warning = FALSE, echo = FALSE}
scc_sun_wday_list <- preprocess_scc_sun(SCC_Weekday, SQ_Weekday)
scc_wday <- scc_sun_wday_list[[1]]
sun_wday <- scc_sun_wday_list[[2]]
scc_sun_wday_master <- scc_sun_wday_list[[3]]

if (is.null(SQ_Not_Weekday) & is.null(SCC_Not_Weekday)) {
  include_not_wday <- FALSE
  scc_sun_not_wday_list <- NULL
  scc_not_wday <- NULL
  sun_not_wday <- NULL
  scc_sun_not_wday_master <- NULL
} else {
  include_not_wday <- TRUE
  scc_sun_not_wday_list <- preprocess_scc_sun(SCC_Not_Weekday, 
                                              SQ_Not_Weekday)
  scc_not_wday <- scc_sun_not_wday_list[[1]]
  sun_not_wday <- scc_sun_not_wday_list[[2]]
  scc_sun_not_wday_master <- scc_sun_not_wday_list[[3]]
}

# Remove labs from master data frame that were resulted at exactly midnight on 
# next morning or prior day
# Custom function to determine correct number of dates
correct_scc_result_dates <- function(data, number_days) {
  all_resulted_dates_vol <- data %>%
    group_by(ResultDate) %>%
    summarize(VolLabs = n()) %>%
    arrange(desc(VolLabs)) %>%
    ungroup()
  
  correct_dates <- all_resulted_dates_vol$ResultDate[1:number_days]
  
  new_data <- data[data$ResultDate %in% correct_dates, ]
  
  return(new_data)
}

# Update preprocessed data to only include correct dates ----------------------
scc_sun_wday_master <- correct_scc_result_dates(scc_sun_wday_master, 1)

if (scenario == 1) {
  scc_sun_not_wday_master <- correct_scc_result_dates(scc_sun_not_wday_master, 
                                                      3)
} else if (scenario == 2) {
  scc_sun_not_wday_master <- correct_scc_result_dates(scc_sun_not_wday_master, 
                                                      2)
} else if (scenario == 3) {
  scc_sun_not_wday_master <- correct_scc_result_dates(scc_sun_not_wday_master, 
                                                      1)
}


# Determine resulted date for weekday labs
wday_result_date <- format(unique(scc_sun_wday_master$ResultDate), 
                           format = "%a %m/%d/%y")


if (!is.null(scc_sun_not_wday_master)) {
  not_wday_result_date <- sort(unique(not_wday_dates_df$ResultDate))
  wkend_holiday_result_date <- ifelse(
    length(not_wday_result_date) == 1,
    format(not_wday_result_date, format = "%a %m/%d/%y"),
    paste0(format(not_wday_result_date[1],
                  format = "%a %m/%d/%y"),
           "-",
           format(not_wday_result_date[length(not_wday_result_date)],
                  format = "%a %m/%d/%y")))
} else {
  wkend_holiday_result_date <- NULL
}
```

```{r Combine week day and weekend/holiday data and summarize for historical repository, eval = FALSE, echo = FALSE, warning = FALSE, message = FALSE}
# Bind weekday and non-weekday data, if any exists
if (!is.null(scc_sun_not_wday_master)) {
  scc_sun_all_days <- rbind(scc_sun_wday_master, scc_sun_not_wday_master)
} else {
  scc_sun_all_days <- scc_sun_wday_master
}

# Summarize data for export to historical repo
scc_sun_all_days_subset <- scc_sun_all_days %>%
  group_by(Site, ResultDate, Test, Division, 
           Setting, SettingRollUp, MasterSetting, DashboardSetting,
           OrderPriority, AdjPriority, DashboardPriority,
           ReceiveResultTarget, CollectResultTarget) %>%
  summarize(TotalResulted = n(),
            TotalResultedTAT = sum(TATInclude),
            TotalReceiveResultInTarget =
              sum(ReceiveResultInTarget[TATInclude == TRUE]),
            TotalCollectResultInTarget =
              sum(CollectResultInTarget[TATInclude == TRUE]),
            TotalAddOnOrder = sum(AddOnMaster == "AddOn"),
            TotalMissingCollections = sum(MissingCollect)) %>%
  arrange(Site, ResultDate) %>%
  ungroup()

# Open existing repository
# existing_repo <- read_excel(
#   choose.files(default = user_path, 
#                caption = "Select SCC and Sunquest Historical Repository"), 
#   sheet = 1, col_names = TRUE)
existing_repo <- readRDS(file = 
  choose.files(default = paste0(user_directory,
                                "/SCC Sunquest Historical Repo",
                                "/*.*"),
               caption = "Select SCC and Sunquest Historical Repository"))

# Convert ResultDate from date-time to date
existing_repo <- existing_repo %>%
   mutate(ResultDate  = date(ResultDate))
  
# Bind new data with existing repository
scc_sun_repo <- rbind(existing_repo, scc_sun_all_days_subset)
  
# Remove any duplicates
scc_sun_repo <- unique(scc_sun_repo)

# Determine earliest and latest date in repository for use in file name
start_date <- format(min(scc_sun_repo$ResultDate), "%m%d%y")
end_date <- format(max(scc_sun_repo$ResultDate), "%m%d%y")

# Save updated repository
# write_xlsx(scc_sun_repo, path = paste0(user_directory, 
#                                        "\\SCC Sunquest Historical Repo", 
#                                        "\\Hist Repo Test ", start_date, " to ", 
#                                        end_date, " Created ", Sys.Date(), 
#                                        ".xlsx"))
saveRDS(scc_sun_repo, file = paste0(user_directory, 
                                    "/SCC Sunquest Historical Repo", 
                                    "/Hist Repo ", start_date, " to ", 
                                    end_date, " Created ", 
                                    format(Sys.Date(), "%m%d%y"), ".RDS"))
```


```{r Custom function for preprocessing raw Powerpath and Epic data and calling function, warning = FALSE, message = FALSE, echo = FALSE}

##preprocessing for epic data

#we are only looking for the specimens that were finalized/final edited in epic
epic_weekday_final <-
  epic_weekday[which(epic_weekday$LAB_STATUS == "Final result" |
                       epic_weekday$LAB_STATUS == "Edited Result - FINAL"), ]

#get only the SPECIMEN_ID Column from Epic data
epic_final_spec <- NULL
epic_final_spec <- as.data.frame(epic_weekday_final$SPECIMEN_ID)
colnames(epic_final_spec) <- c("Case_no")

#keep only the unique spec IDs
epic_final_spec <- unique(epic_final_spec)

# create an extra column for old Fcaility
pp_weekday <- pp_weekday %>%
  mutate(Facility_Old = Facility)

pp_weekday$Facility[pp_weekday$Facility_Old == "MSS"] <- "MSH"
pp_weekday$Facility[pp_weekday$Facility_Old == "STL"] <- "SL"
pp_weekday$spec_group[pp_weekday$spec_group == "BREAST"] <- "Breast"

#---------------Extract the Cytology GYN and NON-GYN Data Only-----------------#
#Cytology
#Keep the cyto gyn and cyto non-gyn

cyto_weekday_raw <-
  pp_weekday[which((pp_weekday$spec_group == "CYTO NONGYN" |
                      pp_weekday$spec_group == "CYTO GYN") &
                     pp_weekday$spec_sort_order == "A"), ]

cyto_not_weekday_raw <-
  pp_not_weekday[which((pp_not_weekday$spec_group == "CYTO NONGYN" |
                          pp_not_weekday$spec_group == "CYTO GYN") &
                         pp_not_weekday$spec_sort_order == "A"), ]

cyto_weekday_final <- merge(x = cyto_weekday_raw,
                                    y = epic_final_spec)

#--------------Extract the All Breast and GI specs Data Only-------------------#

#Merge the exclusion/inclusion cloumn into the modified powerpath Dataset
#for weekdays and not weekdays

pp_weekday <- merge(x = pp_weekday, y = gi_codes, all.x = TRUE)

#find case numbers with GI_Code = exclude
exclude_gi_codes_df <-
  pp_weekday[
    which
    ((
      pp_weekday$spec_group == "GI") &
        (pp_weekday$GI.Codes.Must.Include.in.Analysis..All.GI.Biopsies. ==
           "Exclude")), ]

must_exclude_cnum <- unique(exclude_gi_codes_df$Case_no)

#this dataframe has all the GI specs and biopsies that should be excluded
#it includes any biopsy that came with another excluded code
#this DF is only for our reference
must_exclude_cnum_df <-
  pp_weekday[which(pp_weekday$Case_no %in% must_exclude_cnum), ]

sp_weekday <-
  pp_weekday[which((((pp_weekday$spec_group == "GI") &
                       (!(pp_weekday$Case_no %in% must_exclude_cnum))) |
                      (pp_weekday$spec_group == "Breast")) &
                     pp_weekday$spec_sort_order == "A"), ]

sp_weekday <-
  sp_weekday[which(
    sp_weekday$Facility != "NYEE"), ]


#-----------Reporting Dates-----------#
#1. Weekday Date
report_date_weekday <- unique(as.timeDate(format(pp_weekday$signed_out_date,
                                                 "%m/%d/%Y")))

report_date_weekday_day <- unique(dayOfWeek(report_date_weekday))

#2. Weekend/Holiday Dates
if (is.null(pp_not_weekday)) {
  report_date_weekend <- NULL
  report_date_weekend_day <- NULL
}else {
  report_date_weekend <-
    unique(as.timeDate(format(pp_not_weekday$signed_out_date,
                              "%m/%d/%Y")))
  report_date_weekend_day <- unique(dayOfWeek(report_date_weekend))
}

#------------------------------Data Pre-Processing-----------------------------#
############Create a function for Data pre-processing############

pre_processing_pp <- function(raw_data) {
  if (is.null(raw_data) || nrow(raw_data) == 0) {
    raw_data_ps <- NULL
    raw_data_new <- NULL
    vol_cases_signed <- NULL
    vol_cases_signed_strat <- NULL
    patient_metric <- NULL
    lab_metric <- NULL
    lab_metric_v2 <- NULL
    processed_data_table_v2 <- NULL
    processed_data_table <- NULL
    summarized_table <- NULL
    return_tables <- NULL
    } else {
    #vlookup the Rev_Center and its corresponding patient setting for the
      #PowerPath Data
    raw_data_ps <- merge(x = raw_data, y = patient_setting, all.x = TRUE)

    #make sure to fix the MSBK patient type based on the extra column in the
    #new report

    raw_data_ps$Patient.Setting[raw_data_ps$Rev_ctr == "MSBK" &
                                  (raw_data_ps$patient_type == "A" |
                                     raw_data_ps$patient_type == "O")] <- "Amb"

    raw_data_ps$Patient.Setting[raw_data_ps$Rev_ctr == "MSBK" &
                                  raw_data_ps$patient_type == "IN"] <- "IP"

    #vlookup targets based on spec_group and patient setting
    raw_data_new <- merge(x = raw_data_ps, y = tat_targets_ap,
                          all.x = TRUE, by = c("spec_group", "Patient.Setting"))

    #check if any of the dates was imported as char
    if (is.character(raw_data_new$Collection_Date)) {
      raw_data_new <- raw_data_new %>%
        mutate(Collection_Date = as.numeric(Collection_Date)) %>%
        mutate(Collection_Date = as.Date(Collection_Date,
                                         origin = "1899-12-30"))
      } else {
      raw_data_new <- raw_data_new %>%
        mutate(Collection_Date = Collection_Date)
      }
    #Change all Dates into POSIXct format to start the calculations
    raw_data_new[c("Case_created_date",
                   "Collection_Date",
                   "Received_Date",
                   "signed_out_date")] <-
      lapply(raw_data_new[c("Case_created_date",
                            "Collection_Date",
                            "Received_Date",
                            "signed_out_date")],
             as.POSIXct, tz = "", format = "%m/%d/%y %I:%M %p")

    #add columns for calculations:
    #collection to signed out and received to signed out
    #collection to signed out
    #All days in the calendar
    raw_data_new <- raw_data_new %>%
      mutate(Collection_to_signed_out =
               as.numeric(difftime(signed_out_date, Collection_Date,
                                   units = "days")))
    #recieve to signed out
    #without weekends and holidays
    raw_data_new <- raw_data_new %>%
      mutate(Received_to_signed_out = bizdays(Received_Date, signed_out_date))

    #Calculate Average for Collection to signed out and number of cases signed
    vol_cases_signed <- summarise(group_by(raw_data_new,
                                           spec_group,
                                           Patient.Setting),
                                  no_cases_signed = n())

    vol_cases_signed_strat <- summarise(group_by(raw_data_new,
                                                 spec_group,
                                                 Facility,
                                                 Patient.Setting),
                                        no_cases_signed = n())

    vol_cases_signed_strat <- dcast(
      vol_cases_signed_strat,
      spec_group + Patient.Setting ~ Facility, value.var = "no_cases_signed")

    vol_cases_signed_strat[is.na(vol_cases_signed_strat)] <- 0

    patient_metric <- summarise(group_by(raw_data_new,
                                         spec_group,
                                         Facility,
                                         Patient.Setting),
                          avg_collection_to_signed_out =
                            format(ceiling(mean(Collection_to_signed_out,
                                                na.rm = TRUE))))
    patient_metric <- dcast(patient_metric,
                            spec_group + Patient.Setting ~ Facility,
                            value.var = "avg_collection_to_signed_out")
    #Calculate % Receive to result TAT within target
    lab_metric <- summarise(
      group_by(raw_data_new,
               spec_group,
               Facility,
               Patient.Setting),
      received_to_signed_out_within_target =
        format(round(sum(Received_to_signed_out <=
                           Received.to.signed.out.target..Days.,
                         na.rm = TRUE) / sum(Received_to_signed_out >= 0,
                                           na.rm = TRUE), 2)))

    lab_metric <- dcast(lab_metric,
                        spec_group + Patient.Setting ~ Facility,
                        value.var = "received_to_signed_out_within_target")

    lab_metric_v2 <- summarise(
      group_by(raw_data_new,
               spec_group,
               Patient.Setting),
      received_to_signed_out_within_target =
        format(round(sum(Received_to_signed_out <=
                           Received.to.signed.out.target..Days.,
                         na.rm = TRUE) / sum(Received_to_signed_out >= 0,
                                           na.rm = TRUE), 2)))

    summarized_table <-
      summarise(
        group_by(raw_data_new,
                 Spec_code,
                 spec_group,
                 Facility,
                 Patient.Setting,
                 Rev_ctr,
                 as.Date(signed_out_date),
                 weekdays(as.Date(signed_out_date)),
                 Received.to.signed.out.target..Days.,
                 Collected.to.signed.out.target..Days.),
        no_cases_signed = n(),
        lab_metric_tat_avg = round(mean(Received_to_signed_out,
                                        na.rm = TRUE), 0),
        lab_metric_tat_med = round(median(Received_to_signed_out,
                                          na.rm = TRUE), 0),
        lab_metric_tat_sd = round(sd(Received_to_signed_out, na.rm = TRUE), 1),
        lab_metric_within_target = format(
          round(
            sum(Received_to_signed_out <= Received.to.signed.out.target..Days.,
                na.rm = TRUE) / sum(
                  Received_to_signed_out >= 0, na.rm = TRUE), 2)),
        patient_metric_tat_avg = format(ceiling(mean(Collection_to_signed_out,
                                                   na.rm = TRUE))),
        patient_metric_tat_med = round(median(Collection_to_signed_out,
                                              na.rm = TRUE), 0),
        patient_metric_tat_sd = round(sd(Collection_to_signed_out,
                                        na.rm = TRUE), 1))

  #here I will merge number of cases signed, received to result TAT,
  #and acollect to result TAT calcs into one table
    processed_data_table <-
      left_join(full_join(vol_cases_signed, lab_metric),
                patient_metric,
                by = c("spec_group", "Patient.Setting"))
    processed_data_table <-
      processed_data_table[!(processed_data_table$Patient.Setting == "Other"), ]

    processed_data_table_v2 <-
      left_join(full_join(vol_cases_signed, lab_metric_v2),
                patient_metric,
                by = c("spec_group", "Patient.Setting"))
    processed_data_table_v2 <-
      processed_data_table_v2[!(processed_data_table_v2$Patient.Setting ==
                                  "Other"), ]
    return_tables <- list(processed_data_table,
                          processed_data_table_v2,
                          vol_cases_signed_strat,
                          raw_data_new,
                          summarized_table)
  }
  return(return_tables)
}

#This table will give us the summarized TAT for cyto with an assumption that
#receive to result is not centralized.
cyto_table_weekday <-
  pre_processing_pp(cyto_weekday_final)[[1]]

cyto_table_not_weekday <-
  pre_processing_pp(cyto_not_weekday_raw)[[1]]

#This table will give us the summarized TAT for cyto with an assumption that
#receive to result is centralized.
cyto_table_weekday_v2 <-
  pre_processing_pp(cyto_weekday_final)[[2]]

cyto_table_not_weekday_v2 <-
  pre_processing_pp(cyto_not_weekday_raw)[[2]]

#this table summarizes the volume for cyto per hospital per patient setting
cyto_strat_vol_weekday <-
  pre_processing_pp(cyto_weekday_final)[[3]]

cyto_strat_vol_not_weekday <-
  pre_processing_pp(cyto_not_weekday_raw)[[3]]

#this table gives the processed and cleaned raw cyto data only
cyto_table_weekday_raw <-
  pre_processing_pp(cyto_weekday_final)[[4]]

#This table will give us the summarized TAT for surgical pathology
#with an assumption that receive to result is not centralized.
sp_table_weekday <-
  pre_processing_pp(sp_weekday)[[1]]

#this table summarizes the volume for surgical pathology per hospital per
#patient setting
sp_strat_vol_weekday <-
  pre_processing_pp(sp_weekday)[[3]]

#this table gives the processed and cleaned raw surgical pathology data only
sp_table_weekday_raw <-
  pre_processing_pp(sp_weekday)[[4]]

```

```{r cyto backlog preprocessing and analysis, echo=FALSE, warning = FALSE, message=FALSE}
#cyto backlog Calculation

#vlookup the Rev_Center and its corresponding patient setting for the
#PowerPath Data

cyto_backlog_ps <- merge(x = cyto_backlog_raw,
                             y = patient_setting,
                             all.x = TRUE)

#vlookup targets based on spec_group and patient setting
cyto_backlog_ps_target <- merge(x = cyto_backlog_ps,
                                    y = tat_targets_ap,
                                    all.x = TRUE,
                                    by = c("spec_group", "Patient.Setting"))

#Keep the cyto gyn and cyto non-gyn

cyto_backlog <-
  cyto_backlog_ps_target[which(
    cyto_backlog_ps_target$spec_group == "CYTO NONGYN" |
      cyto_backlog_ps_target$spec_group == "CYTO GYN"), ]

#Change all Dates into POSIXct format to start the calculations

cyto_backlog[c("Case_created_date",
                   "Collection_Date",
                   "Received_Date",
                   "signed_out_date")] <-
  lapply(cyto_backlog[c("Case_created_date",
                            "Collection_Date",
                            "Received_Date",
                            "signed_out_date")],
         as.POSIXct, tz = "", format = "%m/%d/%y %I:%M %p")

#Backlog Calculations: Date now - case created date
#without weekends and holidays, subtract one so we don't include today's date

cyto_backlog$backlog <-
  bizdays(cyto_backlog$Case_created_date, today) - 1

#Case Volume
cyto_backlog_vol <-
  summarise(group_by(cyto_backlog, spec_group),
            cyto_backlog = format(
              round(
                sum(
                  backlog > Received.to.signed.out.target..Days.,
                  na.rm = TRUE), 0)),

            percentile_25th =
              format(
                ceiling(
                  quantile(
                    backlog[backlog > Received.to.signed.out.target..Days.],
                    prob = 0.25, na.rm = TRUE))),

            percentile_50th =
              format(
                ceiling(
                  quantile(
                    backlog[backlog > Received.to.signed.out.target..Days.],
                    prob = 0.5, na.rm = TRUE))),

            maximum = format(
              ceiling(
                max(
                  backlog[backlog > Received.to.signed.out.target..Days.],
                  na.rm = TRUE))))

cyto_backlog_vol$spec_group <-
  factor(cyto_backlog_vol$spec_group,
         levels = c("CYTO GYN", "CYTO NONGYN"))

cyto_backlog_vol$maximum[cyto_backlog_vol$maximum == "-Inf"] <- "NA"

#Days of work
cyto_case_vol_dow <- as.numeric(cyto_backlog_vol$cyto_backlog[1]) / 80

#accessioned volume
#1. Find the date that we need to report --> the date of the last weekday

acc_date <- as.Date(cyto_weekday_final$signed_out_date[1])

#2. count the accessioned volume that was accessioned on that date
#from the cyto report

cyto_weekday_final$acc_date_only <- as.Date(cyto_weekday_final$Received_Date)

cyto_acc_vol1 <-
  summarise(group_by(
    cyto_weekday_final,
    spec_group),
    cyto_acc_vol1 = as.numeric(sum(acc_date == acc_date_only,
                                   na.rm = TRUE)))

cyto_acc_vol1$spec_group <-
  factor(cyto_acc_vol1$spec_group,
         levels = c("CYTO GYN", "CYTO NONGYN"))

#3. count the accessioned volume that was accessioned on that date
#from the backlog report

cyto_backlog$acc_date_only <-
  as.Date(cyto_backlog$Received_Date)

cyto_acc_vol2 <-
  summarise(
    group_by(
      cyto_backlog,
      spec_group),
    cyto_acc_vol2 = as.numeric(sum(acc_date == acc_date_only, na.rm = TRUE)))
#4. sum the two counts

cyto_acc_vol3 <- merge(x = cyto_acc_vol1, y = cyto_acc_vol2)

cyto_acc_vol3$total_acc_vol <-
  cyto_acc_vol3$cyto_acc_vol1 + cyto_acc_vol3$cyto_acc_vol2

cyto_acc_vol3$cyto_acc_vol1 <- NULL
cyto_acc_vol3$cyto_acc_vol2 <- NULL

backlog_acc_table <- merge(x = cyto_acc_vol3, y = cyto_backlog_vol, all = TRUE)

#as extra precaution

table_temp_backlog_acc <- data.frame(matrix(ncol = 6, nrow = 2))
colnames(table_temp_backlog_acc) <- c("spec_group",
                                      "total_accessioned_volume",
                                      "cyto_backlog",
                                      "percentile_25th",
                                      "percentile_50th",
                                      "maximum")

table_temp_backlog_acc[1] <- c("CYTO GYN", "CYTO NONGYN")

backlog_acc_table_new <- merge(x = table_temp_backlog_acc,
                               y = backlog_acc_table, all.y = TRUE)

backlog_acc_table_new2 <- merge(x = table_temp_backlog_acc[1],
                                y = backlog_acc_table,
                                all.x = TRUE, by = c("spec_group"))

backlog_acc_table_new2[is.na(backlog_acc_table_new2)] <- 0

#added this line to delete the cyto gyn from the table until we get correct data
#currently not in use
backlog_acc_table_new3 <- backlog_acc_table_new2[-c(1), ]

```

```{r Add the current summary to the historical repo for cyto/pathology, echo = FALSE, warning = FALSE, message = FALSE, eval = TRUE}

#1. import the historical repo
historical_repo <- read_excel(
  paste0(user_directory, "/AP & Cytology Historical Repo/",
         "Historical_Repo_Surgical_Pathology", "_", yesterday, ".xlsx"))

#2. append all the summary tables together

#this table gives the summarized cyto data for historical repo
cyto_table_weekday_summarized <- pre_processing_pp(cyto_weekday_final)[[5]]

#this table gives the summarized surgical pathology data for historical repo
sp_table_weekday_summarized <- pre_processing_pp(sp_weekday)[[5]]

#bind the cyto repo with the surgical pathology repo to prepare for the
#merge with the historical repo
current_summary <- rbind(cyto_table_weekday_summarized,
                         sp_table_weekday_summarized)

#make sure that the summarized data is a data frame
current_summary <- as.data.frame(current_summary)

#standardize the name for the current summary to match the historical repo
colnames(current_summary) <-
  c("Spec_code", "Spec_group", "Facility", "Patient_setting", "Rev_ctr",
    "Signed_out_date_only", "Signed_out_day_only", "Lab_metric_target",
    "Patient_metric_target", "No_cases_signed_out", "Lab_metric_avg",
    "Lab_metric_med", "Lab_metric_std", "Lab_metric_within_target",
    "Patient_metric_avg", "Patient_metric_med", "Patient_metric_std")

#make sure the data types for both dataframes are the same

common <-
  names(historical_repo)[names(historical_repo) %in% names(current_summary)]

historical_repo[common] <- lapply(common, function(x) {
  match.fun(paste0("as.", class(current_summary[[x]])))(historical_repo[[x]])
})

#3. combine the current summary with the historical repo and write them
#into a xlsx file

historical_repo_updated <- rbind(historical_repo, current_summary)

#4. to ensure that the selected rows are the unique ones only without
#any dupilacation

historical_repo_updated <- unique(historical_repo_updated)

xlsx_file_name <- paste0(user_directory, "/AP & Cytology Historical Repo/",
                       "Historical_Repo_Surgical_Pathology", "_",
                       today, ".xlsx")

write_xlsx(historical_repo_updated, xlsx_file_name)

```


```{r Custom Functions for subsetting and summarizing data for SCC and Sunquest dashboard tables, warning = FALSE, message = FALSE, echo = FALSE}
# # Custom function to clean and format summarized data (used in "subsetting and summarizing function"lab_sub_summarize" function beflore)
# clean_summarized_data <- function(x) {
#   # Replace NaN TAT percentages with NA
#   x[is.finite(x$ReceiveResultPercent) == FALSE, "ReceiveResultPercent"] <- NA
#   x[is.finite(x$CollectResultPercent) == FALSE, "CollectResultPercent"] <- NA
#   # Look up target TAT for sites with 0 resulted labs using tat_targets reference
#   x$Concate1 <- paste(x$Test, x$DashboardPriority)
#   x$Concate2 <- paste(x$Test, x$DashboardPriority, x$DashboardSetting)
#   
#   x$ReceiveResultTarget[is.na(x$ReceiveResultTarget)] <- ifelse(!is.na(match(x$Concate2[is.na(x$ReceiveResultTarget)], tat_targets$Concate)), 
#                                                             tat_targets$ReceiveToResultTarget[match(x$Concate2[is.na(x$ReceiveResultTarget)], tat_targets$Concate)], ifelse(!is.na(match(x$Concate1[is.na(x$ReceiveResultTarget)], tat_targets$Concate)), 
#                                                             tat_targets$ReceiveToResultTarget[match(x$Concate1[is.na(x$ReceiveResultTarget)], tat_targets$Concate)], tat_targets$ReceiveToResultTarget[match(x$Test[is.na(x$ReceiveResultTarget)], tat_targets$Concate)]))
#   x$CollectResultTarget[is.na(x$CollectResultTarget)] <- ifelse(!is.na(match(x$Concate2[is.na(x$CollectResultTarget)], tat_targets$Concate)), 
#                                                             tat_targets$CollectToResultTarget[match(x$Concate2[is.na(x$CollectResultTarget)], tat_targets$Concate)], ifelse(!is.na(match(x$Concate1[is.na(x$CollectResultTarget)], tat_targets$Concate)), 
#                                                             tat_targets$CollectToResultTarget[match(x$Concate1[is.na(x$CollectResultTarget)], tat_targets$Concate)], tat_targets$CollectToResultTarget[match(x$Test[is.na(x$CollectResultTarget)], tat_targets$Concate)]))
#   x$Concate1 <- NULL
#   x$Concate2 <- NULL
#   # # Look up target TAT for sites with 0 resulted labs
#   # dummy_df <- unique(x[is.na(x$ReceiveResultTarget) != TRUE | is.na(x$CollectResultTarget) != TRUE, c(1,3:6)])
#   # x$ReceiveResultTarget <- dummy_df$ReceiveResultTarget[match(paste(x$Test, x$DashboardPriority,  x$DashboardSetting), paste(dummy_df$Test, dummy_df$DashboardPriority, dummy_df$DashboardSetting))]
#   # x$CollectResultTarget <- dummy_df$CollectResultTarget[match(paste(x$Test, x$DashboardPriority,  x$DashboardSetting), paste(dummy_df$Test, dummy_df$DashboardPriority, dummy_df$DashboardSetting))]
#   # Format target TAT for tables
#     x[c("ReceiveResultTarget", "CollectResultTarget")] <- lapply(x[c("ReceiveResultTarget", "CollectResultTarget")], function(y) ifelse(is.na(y), y, paste0("<=", y, " min")))
#   x[c("ReceiveResultPercent", "CollectResultPercent")] <- lapply(x[c("ReceiveResultPercent", "CollectResultPercent")], percent, digits = 0)
#   # Create new column with test and priority
#   x$TestAndPriority <- paste(x$Test, "-", x$DashboardPriority, "Labs")
#   # Remove unused combinations like Routine ED & ICU labs
#   x <- x[!(x$DashboardPriority == "Routine" & x$DashboardSetting == "ED & ICU"), ]
#   # Format TAT percentages based on status definitions and lab division
# 
#   x <- x %>%  mutate(ReceiveResultPercent = cell_spec(ReceiveResultPercent, "html", color = ifelse(is.na(ReceiveResultPercent), "lightgray", ifelse(((ReceiveResultPercent >= 0.95 & (LabDivision == "Chemistry" | LabDivision == "Hematology")) | (ReceiveResultPercent == 1.00 & LabDivision == "Microbiology RRL")), "green", ifelse(((ReceiveResultPercent >=0.8 &  ReceiveResultPercent < 0.95 & (LabDivision == "Chemistry" | LabDivision == "Hematology")) | (ReceiveResultPercent >= 0.90 & ReceiveResultPercent < 1.0 & LabDivision == "Microbiology RRL")), "orange", "red")))))
#   x <- x %>%  mutate(CollectResultPercent = cell_spec(CollectResultPercent, "html", color = ifelse(is.na(CollectResultPercent), "lightgray", ifelse(CollectResultPercent >= 0.95, "green", ifelse(CollectResultPercent >=0.8 &  CollectResultPercent < 0.95, "orange", "red")))))
#   x
# }
# 
# # Custon function for subsetting and summarizing data for each lab division's TAT dashboard
# lab_sub_summarize <- function(x, LabDivision) {
#   lab_df <- x[x$Division == LabDivision & x$TATInclude == TRUE, ]
#   lab_df$Test <- factor(lab_df$Test, unique(test_code$Test[test_code$Division == LabDivision]))
#   lab_df$DashboardSetting <- factor(lab_df$DashboardSetting, dashboard_pt_setting)
#   lab_df$DashboardPriority <- droplevels(lab_df$DashboardPriority)
#   lab_summary <- lab_df %>%
#     group_by(Test, Site, DashboardPriority, DashboardSetting, ReceiveResultTarget, CollectResultTarget, .drop = FALSE) %>%
#   summarize(ResultedVolume = n(), ReceiveResultInTarget = sum(ReceiveResultInTarget), CollectResultInTarget = sum(CollectResultInTarget),
#             ReceiveResultPercent = round(ReceiveResultInTarget/ResultedVolume, digits = 3), CollectResultPercent = round(CollectResultInTarget/ResultedVolume, digits = 3))
#   lab_summary <- clean_summarized_data(lab_summary)
#   lab_dashboard1 <- melt(lab_summary, id.var = c("Test", "Site", "DashboardPriority", "TestAndPriority", "DashboardSetting", "ReceiveResultTarget", "CollectResultTarget"), measure.vars = c("ReceiveResultPercent", "CollectResultPercent"))
#   lab_dashboard2 <- dcast(lab_dashboard1, Test + DashboardPriority + TestAndPriority + DashboardSetting +ReceiveResultTarget + CollectResultTarget ~ variable + Site, value.var = "value")
#   lab_dashboard2 <- lab_dashboard2[ , c(1:3, 5, 4, 7:12, 6, 4, 13:18)]
#     lab_sub_output <- list(lab_df, lab_summary, lab_dashboard1, lab_dashboard2)
# }

# Custom function to subset, summarize, clean, and format data for dashboards for all lab divisions
lab_sub_summarize <- function(x, LabDivision) {
  # Subset data to be included based on lab division and whether or not TAT meets inclusion criteria
  lab_df <- x[x$Division == LabDivision & x$TATInclude == TRUE, ]
  # Update factors
  lab_df$Test <- factor(lab_df$Test, unique(test_code$Test[test_code$Division == LabDivision]))
  lab_df$DashboardSetting <- factor(lab_df$DashboardSetting, dashboard_pt_setting)
  lab_df$DashboardPriority <- droplevels(lab_df$DashboardPriority)
  # Summarize data based on test, site, priority, setting, and TAT targets. Keep levels so each site is maintained for melting/casting later.
  lab_summary <- lab_df %>%
    group_by(Test, Site, DashboardPriority, DashboardSetting, ReceiveResultTarget, CollectResultTarget, .drop = FALSE) %>%
  summarize(ResultedVolume = n(), ReceiveResultInTarget = sum(ReceiveResultInTarget), CollectResultInTarget = sum(CollectResultInTarget),
            ReceiveResultPercent = round(ReceiveResultInTarget/ResultedVolume, digits = 3), CollectResultPercent = round(CollectResultInTarget/ResultedVolume, digits = 3))
  
  # Clean up summarized data
  # Replace NaN TAT percentages with NA
  lab_summary[is.finite(lab_summary$ReceiveResultPercent) == FALSE, "ReceiveResultPercent"] <- NA
  lab_summary[is.finite(lab_summary$CollectResultPercent) == FALSE, "CollectResultPercent"] <- NA
  # Look up target TAT for sites with 0 resulted labs using tat_targets reference
  lab_summary$Concate1 <- paste(lab_summary$Test, lab_summary$DashboardPriority)
  lab_summary$Concate2 <- paste(lab_summary$Test, lab_summary$DashboardPriority, lab_summary$DashboardSetting)
  
  lab_summary$ReceiveResultTarget[is.na(lab_summary$ReceiveResultTarget)] <- ifelse(!is.na(match(lab_summary$Concate2[is.na(lab_summary$ReceiveResultTarget)], tat_targets$Concate)), 
                                                            tat_targets$ReceiveToResultTarget[match(lab_summary$Concate2[is.na(lab_summary$ReceiveResultTarget)], tat_targets$Concate)], ifelse(!is.na(match(lab_summary$Concate1[is.na(lab_summary$ReceiveResultTarget)], tat_targets$Concate)), 
                                                            tat_targets$ReceiveToResultTarget[match(lab_summary$Concate1[is.na(lab_summary$ReceiveResultTarget)], tat_targets$Concate)], tat_targets$ReceiveToResultTarget[match(lab_summary$Test[is.na(lab_summary$ReceiveResultTarget)], tat_targets$Concate)]))
  lab_summary$CollectResultTarget[is.na(lab_summary$CollectResultTarget)] <- ifelse(!is.na(match(lab_summary$Concate2[is.na(lab_summary$CollectResultTarget)], tat_targets$Concate)), 
                                                            tat_targets$CollectToResultTarget[match(lab_summary$Concate2[is.na(lab_summary$CollectResultTarget)], tat_targets$Concate)], ifelse(!is.na(match(lab_summary$Concate1[is.na(lab_summary$CollectResultTarget)], tat_targets$Concate)), 
                                                            tat_targets$CollectToResultTarget[match(lab_summary$Concate1[is.na(lab_summary$CollectResultTarget)], tat_targets$Concate)], tat_targets$CollectToResultTarget[match(lab_summary$Test[is.na(lab_summary$CollectResultTarget)], tat_targets$Concate)]))
  lab_summary$Concate1 <- NULL
  lab_summary$Concate2 <- NULL
  
  # Format target TAT for tables from numbers to "<=X min"
  lab_summary[c("ReceiveResultTarget", "CollectResultTarget")] <- lapply(lab_summary[c("ReceiveResultTarget", "CollectResultTarget")], function(y) ifelse(is.na(y), y, paste0("<=", y, " min")))
  lab_summary[c("ReceiveResultPercent", "CollectResultPercent")] <- lapply(lab_summary[c("ReceiveResultPercent", "CollectResultPercent")], percent, digits = 0)
  # Create new column with test and priority to be used in tables later
  lab_summary$TestAndPriority <- paste(lab_summary$Test, "-", lab_summary$DashboardPriority, "Labs")
  # Remove unused combinations, specifically Routine ED & ICU labs
  lab_summary <- lab_summary[!(lab_summary$DashboardPriority == "Routine" & lab_summary$DashboardSetting == "ED & ICU"), ]
  # Apply conditional color formatting to TAT percentages based on status definitions for each lab division
  lab_summary <- lab_summary %>%  mutate(ReceiveResultPercent = cell_spec(ReceiveResultPercent, "html", color = ifelse(is.na(ReceiveResultPercent), "lightgray", ifelse(((ReceiveResultPercent >= 0.95 & (LabDivision == "Chemistry" | LabDivision == "Hematology")) | (ReceiveResultPercent == 1.00 & LabDivision == "Microbiology RRL")), "green", ifelse(((ReceiveResultPercent >=0.8 &  ReceiveResultPercent < 0.95 & (LabDivision == "Chemistry" | LabDivision == "Hematology")) | (ReceiveResultPercent >= 0.90 & ReceiveResultPercent < 1.0 & LabDivision == "Microbiology RRL")), "orange", "red")))))
  lab_summary <- lab_summary %>%  mutate(CollectResultPercent = cell_spec(CollectResultPercent, "html", color = ifelse(is.na(CollectResultPercent), "lightgray", ifelse(((CollectResultPercent >= 0.95 & (LabDivision == "Chemistry" | LabDivision == "Hematology")) | (CollectResultPercent == 1.00 & LabDivision == "Microbiology RRL")), "green", ifelse(((CollectResultPercent >=0.8 &  CollectResultPercent < 0.95 & (LabDivision == "Chemistry" | LabDivision == "Hematology")) | (CollectResultPercent >= 0.90 & CollectResultPercent < 1.0 & LabDivision == "Microbiology RRL")), "orange", "red")))))

  # Melt summarized data into a "long" dataframe
  lab_dashboard1 <- melt(lab_summary, id.var = c("Test", "Site", "DashboardPriority", "TestAndPriority", "DashboardSetting", "ReceiveResultTarget", "CollectResultTarget"), measure.vars = c("ReceiveResultPercent", "CollectResultPercent"))
  # Cast dataframe into wide format for use in tables later
  lab_dashboard2 <- dcast(lab_dashboard1, Test + DashboardPriority + TestAndPriority + DashboardSetting +ReceiveResultTarget + CollectResultTarget ~ variable + Site, value.var = "value")
  # Rearrange casted dataframe columns based on desired table aesthetics
  lab_dashboard2 <- lab_dashboard2[ , c(1:3, 5, 4, 7:12, 6, 4, 13:18)]
  # Save outputs in a list
  lab_sub_output <- list(lab_df, lab_summary, lab_dashboard1, lab_dashboard2)
  lab_sub_output
}


# Custom function for styling kable tables
chem_hem_micro_kable <- function(data) {
  kable(data, format = "html", escape = FALSE, align = "c", 
        col.names = c("Test & Priority", "Target", "Setting", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM", "Target", "Setting", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11) %>%
  column_spec(column = c(1, 9, 17), border_right = "thin solid lightgray") %>%
  add_header_above(c(" ", "Receive to Result Within Target" = (ncol(data)-1)/2, "Collect to Result Within Target" = (ncol(data)-1)/2), background = c("white", "#00AEEF", "#221f72"), color = "white", line = FALSE, font_size = 13) %>%
  column_spec(column = 2:9, background = "#E6F8FF", color = "black") %>%
  column_spec(column = 10:17, background = "#EBEBF9", color = "black") %>%
  #column_spec(column = 2:17, background = "inherit", color = "inherit") %>%
  column_spec(column = 1, width_min = "125px") %>%
  column_spec(column = c(3, 11), width_min = "100px") %>%
  row_spec(row = 0, font_size = 13) %>%
  collapse_rows(columns = c(1, 2, 10))
}

```

```{r Subset and format SCC and Sunquest data for each lab division weekday dashboard, warning = FALSE, message = FALSE, echo = FALSE}

# Chemistry
chem_sub_output <-lab_sub_summarize(scc_sun_wday_master, LabDivision = "Chemistry")
chem_subset <- chem_sub_output[[1]]
chemistry_summary <- chem_sub_output[[2]]
chemistry_dashboard1 <- chem_sub_output[[3]]
chemistry_dashboard2 <- chem_sub_output[[4]]

# Chemistry: Manually remove unused combinations
chemistry_dashboard2 <- chemistry_dashboard2[!(((chemistry_dashboard2$Test == "Troponin" | chemistry_dashboard2$Test == "Lactate WB") & (chemistry_dashboard2$DashboardPriority != "All" | chemistry_dashboard2$DashboardSetting == "Amb")) | (chemistry_dashboard2$Test == "BUN" & chemistry_dashboard2$DashboardPriority == "All")), ]
row.names(chemistry_dashboard2) <- 1:nrow(chemistry_dashboard2)

chem_table <- chemistry_dashboard2[ , 3:ncol(chemistry_dashboard2)]

# Hematology
hem_sub_output <-lab_sub_summarize(scc_sun_wday_master, LabDivision = "Hematology")
hem_subset <- hem_sub_output[[1]]
hematology_summary <- hem_sub_output[[2]]
hematology_dashboard1 <- hem_sub_output[[3]]
hematology_dashboard2 <- hem_sub_output[[4]]

hem_table<- hematology_dashboard2[ , 3:ncol(hematology_dashboard2)]

# Microbiology RRL
micro_sub_output <-lab_sub_summarize(scc_sun_wday_master, LabDivision = "Microbiology RRL")
micro_subset <- micro_sub_output[[1]]
micro_summary <- micro_sub_output[[2]]
micro_dashboard1 <- micro_sub_output[[3]]
micro_dashboard2 <- micro_sub_output[[4]]

# Microbiology RRL: Manually remove unused combinations
micro_dashboard2 <- micro_dashboard2[!(micro_dashboard2$Test == "C. diff" & micro_dashboard2$DashboardSetting == "Amb"), ]
row.names(micro_dashboard2) <- 1:nrow(micro_dashboard2)

micro_table <- micro_dashboard2[ , 3:ncol(micro_dashboard2)]
```


```{r Custom functions for formatting cyto dashboard tables, echo = FALSE, warning = FALSE, message = FALSE}

######Create a function for Table standardization for cyto and patho########
#To add all the missing rows and columns

#cyto table
table_merging_cyto <- function(cyto_table) {
  if (is.null(cyto_table)) {
    cyto_table_new <- NULL
    cyto_table_new2 <- NULL
  } else {
    #first step is merging the table template with the cyto table and this
    #will include all of the missing columns.

    cyto_table_new <- merge(x = table_temp_cyto, y = cyto_table, all.y = TRUE)
    #second step is merging the table with all of the columns with only the
    #first two columns of the template to include all the missing rows
    cyto_table_new2 <- merge(x = table_temp_cyto[c(1, 2)],
                             y = cyto_table_new, all.x = TRUE,
                             by = c("spec_group", "Patient.Setting"))

    rows_order_cyto <- factor(rownames(cyto_table_new2), levels = c(2, 1, 4, 3))

    cyto_table_new2 <-
      cyto_table_new2[
        order(rows_order_cyto),
        c("spec_group",
          "Patient.Setting",
          "no_cases_signed",
          "MSH.x", "MSQ.x", "BIMC.x", "PACC.x", "KH.x", "R.x", "SL.x", "NYEE.x",
          "MSH.y", "MSQ.y", "BIMC.y", "PACC.y", "KH.y", "R.y", "SL.y",
          "NYEE.y")]
  }

  return(cyto_table_new2)

}

table_merging_cyto_v2 <- function(cyto_table_v2) {
  if (is.null(cyto_table_v2)) {
    cyto_table_new_v2 <- NULL
    cyto_table_new2_v2 <- NULL
  } else {
    #first step is merging the table template with the cyto table and this
    #will include all of the missing columns.

    cyto_table_new_v2 <- merge(x = table_temp_cyto_v2, y = cyto_table_v2,
                               all.y = TRUE)

    #second step is merging the table with all of the columns with only the
    #first two columns of the template to include all the missing rows

    cyto_table_new2_v2 <- merge(x = table_temp_cyto_v2[c(1, 2)],
                                y = cyto_table_new_v2,
                                all.x = TRUE,
                                by = c("spec_group", "Patient.Setting"))

    rows_order_cyto_v2 <- factor(rownames(cyto_table_new2_v2),
                                 levels = c(2, 1, 4, 3))

    cyto_table_new2_v2 <-
      cyto_table_new2_v2[order(rows_order_cyto_v2),
                             c("spec_group",
                               "Patient.Setting",
                               "no_cases_signed",
                               "received_to_signed_out_within_target",
                               "MSH", "MSQ", "BIMC", "PACC", "KH", "R",
                               "SL", "NYEE")]
    }

  return(cyto_table_new2_v2)
}

#final cyto summarized table with an assumption that
#received to result is not centralized
cyto_table_weekday_new2 <- table_merging_cyto(cyto_table_weekday)

cyto_table_not_weekday_new2 <- table_merging_cyto(cyto_table_not_weekday)

#final cyto summarized table with an assumption that
#received to result is centralized
cyto_table_weekday_new2_v2 <- table_merging_cyto_v2(cyto_table_weekday_v2)

cyto_table_not_weekday_new2_v2 <-
  table_merging_cyto_v2(cyto_table_not_weekday_v2)

#Pathology table
table_merging_patho <- function(sp_table) {
  if (is.null(sp_table)) {
    sp_table_new <- NULL
    sp_table_new2 <- NULL
  } else {
    #first step is merging the table template with the cyto table
    #and this will include all of the missing columns.

    sp_table_new <- merge(x = table_temp_patho, y = sp_table, all.y = TRUE)

    #second step is merging the table with all of the columns with
    #only the first two columns of the template to include all the missing rows
    sp_table_new2 <- merge(x = table_temp_patho[c(1, 2)], y = sp_table_new,
                           all.x = TRUE,
                           by = c("spec_group", "Patient.Setting"))

    rows_order_patho <- factor(rownames(sp_table_new2), levels = c(2, 1, 4, 3))

    sp_table_new2 <-
      sp_table_new2[
        order(rows_order_patho),
        c("spec_group",
          "Patient.Setting",
          "no_cases_signed",
          "MSH.x", "MSQ.x", "BIMC.x", "PACC.x", "KH.x", "R.x", "SL.x",
          "MSH.y", "MSQ.y", "BIMC.y", "PACC.y", "KH.y", "R.y", "SL.y")]

  }

  return(sp_table_new2)

}

#final surgical pathology summarized table with an assumption that
#received to result is not centralized
sp_table_weekday_new2 <- table_merging_patho(sp_table_weekday)

sp_vol_column_order <- c("spec_group", "Patient.Setting",
                         "MSH", "MSQ", "BIMC", "PACC", "KH", "R", "SL")

cyto_vol_column_order <- c("spec_group", "Patient.Setting",
                           "MSH", "MSQ", "BIMC", "PACC", "KH", "R", "SL",
                           "NYEE")

table_merging_volume <-
  function(table_temp_vol, vol_table, columns_order_v3) {
  if (is.null(vol_table)) {
    vol_table_new <- NULL
    vol_table_new2 <- NULL
    rows_order_vol <- NULL
  } else {
    vol_table_new <- merge(x = table_temp_vol, y = vol_table, all.y = TRUE)

    vol_table_new2 <- merge(x = table_temp_vol[c(1, 2)],
                            y = vol_table_new, all.x = TRUE,
                            by = c("spec_group", "Patient.Setting"))

    rows_order_vol <- factor(rownames(vol_table_new2), levels = c(2, 1, 4, 3))
    vol_table_new2 <- vol_table_new2[order(rows_order_vol), columns_order_v3]
    row.names(vol_table_new2) <- NULL
    vol_table_new2[is.na(vol_table_new2)] <- 0
  }
  return(vol_table_new2)
}


#final surgical pathology volume table per site per patient setting
sp_strat_vol_weekday_new2 <- table_merging_volume(
  table_temp_patho_vol,
  sp_strat_vol_weekday,
  sp_vol_column_order)

sp_strat_vol_weekday_new2$spec_group[
  sp_strat_vol_weekday_new2$spec_group == "GI"] <-
  "GI Biopsies"

sp_strat_vol_weekday_new2$spec_group[
  sp_strat_vol_weekday_new2$spec_group == "Breast"] <-
  "All Breast Specimens"

#final cyto volume table per site per patient setting
cyto_strat_vol_weekday_new2 <- table_merging_volume(
  table_temp_cyto_vol,
  cyto_strat_vol_weekday,
  cyto_vol_column_order)

#added this line to delete the cyto gyn from the table until we get correct data
#this line is not used anymore
cyto_strat_vol_weekday_new3 <-
  cyto_strat_vol_weekday_new2[-c(1, 2), ]

############Create a function for conditional formatting############
conditional_formatting_cyto <- function(table_new2) {
  if (is.null(table_new2)) {
    table_new3 <- NULL
    table_new4 <- NULL
    table_new5 <- NULL
  } else {

    table_new2[, 4:19] <- lapply(table_new2[, 4:19], as.numeric)

    table_new2[, 4:11] <- lapply(table_new2[, 4:11], percent)

    #steps for conditional formatting:

    table_new3 <-
      melt(
        table_new2,
        id = c("spec_group",
               "Patient.Setting",
               "no_cases_signed",
               "MSH.y", "MSQ.y", "BIMC.y", "PACC.y", "KH.y",
               "R.y", "SL.y", "NYEE.y"))

    table_new3 <- table_new3 %>%
      mutate(value = ifelse(is.na(value),
                            cell_spec(value, "html",
                                      color = "lightgray"),
                            ifelse(value > 0.9,
                                   cell_spec(value, "html",
                                             color = "green"),
                                   ifelse(value < 0.8,
                                          cell_spec(value, "html",
                                                    color = "red"),
                                          cell_spec(value, "html",
                                                    color = "orange")))))

    table_new3 <-
      dcast(table_new3,
            spec_group +
              Patient.Setting +
              no_cases_signed +
              BIMC.y + MSH.y + MSQ.y + NYEE.y + PACC.y + R.y + SL.y +
              KH.y ~ variable)

    table_new4 <-
      melt(
        table_new3,
        id = c("spec_group",
               "Patient.Setting",
               "no_cases_signed",
               "MSH.x", "MSQ.x", "BIMC.x", "PACC.x", "KH.x", "R.x", "SL.x",
               "NYEE.x"))

    table_new4 <-
      table_new4 %>%
      mutate(value = ifelse(is.na(value),
                            cell_spec(value, "html", color = "lightgray"),
                            cell_spec(value, "html", color = "black")))

    table_new4 <-
      dcast(table_new4,
            spec_group +
              Patient.Setting +
              no_cases_signed +
              BIMC.x + MSH.x + MSQ.x + NYEE.x + PACC.x + R.x + SL.x +
              KH.x ~ variable)

    table_new5 <- merge(x = table_new4, y = tat_targets_ap[1:3])

    rows_order <- factor(rownames(table_new5), levels = c(2, 1, 4, 3))

    table_new5 <-
      table_new5[
        order(rows_order),
        c("spec_group",
          "Received.to.signed.out.target..Days.",
          "Patient.Setting",
          "no_cases_signed",
          "MSH.x", "MSQ.x", "BIMC.x", "PACC.x", "KH.x", "R.x", "SL.x", "NYEE.x",
          "MSH.y", "MSQ.y", "BIMC.y", "PACC.y", "KH.y", "R.y", "SL.y",
          "NYEE.y")]


    table_new5 <-
      table_new5 %>%
      mutate(Received.to.signed.out.target..Days. =
      paste("<= ", Received.to.signed.out.target..Days., "days"))

    row.names(table_new5) <- NULL

    table_new5 <- table_new5 %>%
      mutate(no_cases_signed = coalesce(no_cases_signed, 0))

  }
  return(table_new5)
}

#final cyto summarized table with conditional formatting and receive to result
#targets with an assumption that received to result is not centralized

cyto_table_weekday_new3 <- conditional_formatting_cyto(cyto_table_weekday_new2)

#added this line to delete the cyto gyn from the table until we get correct data
#this line is not used anymore
cyto_table_weekday_new4 <- cyto_table_weekday_new3[-c(1, 2), ]

conditional_formatting_cyto2 <- function(table_new2_v2) {
  if (is.null(table_new2_v2)) {
    table_new3_v2 <- NULL
    table_new4_v2 <- NULL
  } else {

    table_new2_v2[4] <- lapply(table_new2_v2[4], as.numeric)
    table_new2_v2[4] <- lapply(table_new2_v2[4], percent, d = 0)

    #steps for conditional formatting:

    table_new3_v2 <-
      table_new2_v2 %>%
      mutate(
        received_to_signed_out_within_target =
          ifelse(
            is.na(received_to_signed_out_within_target),
            cell_spec(received_to_signed_out_within_target, "html",
                      color = "lightgray"),
            ifelse(
              received_to_signed_out_within_target > 0.9,
              cell_spec(received_to_signed_out_within_target, "html",
                        color  = "green"),
              ifelse(
                received_to_signed_out_within_target < 0.8,
                cell_spec(received_to_signed_out_within_target, "html",
                          color = "red"),
                cell_spec(received_to_signed_out_within_target, "html",
                          color = "orange")))))

    table_new4_v2 <-
      melt(table_new3_v2,
           id = c("spec_group",
                  "Patient.Setting",
                  "no_cases_signed",
                  "received_to_signed_out_within_target"))


    table_new4_v2 <-
      table_new4_v2 %>%
      mutate(value = ifelse(is.na(value),
                            cell_spec(value, "html", color = "lightgray"),
                            cell_spec(value, "html", color = "black")))

    table_new4_v2 <-
      dcast(table_new4_v2,
            spec_group +
              Patient.Setting +
              no_cases_signed +
              received_to_signed_out_within_target ~ variable)

    table_new4_v2 <- merge(x = table_new4_v2, y = tat_targets_ap[1:3])
    rows_order_v2 <- factor(rownames(table_new4_v2), levels = c(2, 1, 4, 3))

    table_new4_v2 <-
      table_new4_v2[order(rows_order_v2),
                    c("spec_group",
                      "Received.to.signed.out.target..Days.",
                      "Patient.Setting", "no_cases_signed",
                      "received_to_signed_out_within_target",
                      "MSH", "MSQ", "BIMC", "PACC", "KH", "R", "SL", "NYEE")]

    table_new4_v2 <- table_new4_v2 %>%
      mutate(Received.to.signed.out.target..Days. =
      paste("<= ", Received.to.signed.out.target..Days., "days"))

    row.names(table_new4_v2) <- NULL

    table_new4_v2 <- table_new4_v2 %>%
      mutate(no_cases_signed = coalesce(no_cases_signed, 0))
  }
  return(table_new4_v2)
}

#final cyto summarized table with conditional formatting and receive to
#result targets with an assumption that received to result is centralized

cyto_table_weekday_new3_v2 <-
  conditional_formatting_cyto2(cyto_table_weekday_new2_v2)

#added this line to delete the cyto gyn from the table until we get correct data
#this line is not in use anymore
cyto_table_weekday_new3_v3 <- cyto_table_weekday_new3_v2[-c(1, 2), ]

conditional_formatting_patho <- function(table_new2) {
  if (is.null(table_new2)) {
    table_new3 <- NULL
    table_new4 <- NULL
    table_new5 <- NULL
  } else {

    table_new2[, 4:17] <- lapply(table_new2[, 4:17], as.numeric)
    table_new2[, 4:10] <- lapply(table_new2[, 4:10], percent, d = 0)

    #steps for conditional formatting:

    table_new3 <-
      melt(table_new2,
           id = c("spec_group",
                  "Patient.Setting",
                  "no_cases_signed",
                  "MSH.y", "MSQ.y", "BIMC.y", "PACC.y", "KH.y", "R.y", "SL.y"))


    table_new3 <-
      table_new3 %>%
      mutate(value = ifelse(is.na(value),
                            cell_spec(value, "html",
                                      color = "lightgray"),
                            ifelse(value > 0.9,
                                   cell_spec(value, "html",
                                             color  = "green"),
                                   ifelse(value < 0.8,
                                          cell_spec(value, "html",
                                                    color = "red"),
                                          cell_spec(value, "html",
                                                    color = "orange")))))


    table_new3 <-
      dcast(table_new3,
            spec_group +
              Patient.Setting +
              no_cases_signed +
              BIMC.y + MSH.y + MSQ.y + PACC.y + R.y + SL.y + KH.y ~ variable)

    table_new4 <-
      melt(table_new3,
           id = c("spec_group",
                  "Patient.Setting",
                  "no_cases_signed",
                  "MSH.x", "MSQ.x", "BIMC.x", "PACC.x", "KH.x", "R.x", "SL.x"))


    table_new4 <-
      table_new4 %>%
      mutate(value =
               ifelse(is.na(value),
                      cell_spec(value, "html", color = "lightgray"),
                      cell_spec(value, "html", color = "black")))

    table_new4 <-
      dcast(table_new4,
            spec_group +
              Patient.Setting +
              no_cases_signed +
              BIMC.x + MSH.x + MSQ.x + PACC.x + R.x + SL.x + KH.x ~ variable)

    table_new5 <- merge(x = table_new4, y = tat_targets_ap[1:3])

    rows_order <- factor(rownames(table_new5), levels = c(2, 1, 4, 3))

    table_new5 <-
      table_new5[order(rows_order),
                 c("spec_group",
                   "Received.to.signed.out.target..Days.",
                   "Patient.Setting",
                   "no_cases_signed",
                   "MSH.x", "MSQ.x", "BIMC.x", "PACC.x", "KH.x", "R.x", "SL.x",
                   "MSH.y", "MSQ.y", "BIMC.y", "PACC.y", "KH.y", "R.y", "SL.y")]

    table_new5 <- table_new5 %>% mutate(Received.to.signed.out.target..Days. =
      paste("<= ", Received.to.signed.out.target..Days., "days"))

    row.names(table_new5) <- NULL

    table_new5 <- table_new5 %>%
      mutate(no_cases_signed = coalesce(no_cases_signed, 0))
  }
  return(table_new5)
}

#final surgical pathology summarized table with conditional formatting and
#receive to result targets with an assumption that received to result
#is centralized
sp_table_weekday_new3 <- conditional_formatting_patho(sp_table_weekday_new2)


sp_table_weekday_new3$spec_group[sp_table_weekday_new3$spec_group == "GI"] <-
  "GI Biopsies"

sp_table_weekday_new3$spec_group[
  sp_table_weekday_new3$spec_group == "Breast"] <-
  "All Breast Specimens"

```

```{r Custom function for Anatomic Pathology kable formatting, echo=FALSE, warning = FALSE, message = FALSE}

sp_standardized_column_names <-
  c("Case Type", "Target", "Setting", "No. Cases Signed Out",
    "MSH", "MSQ", "MSBI", "PACC", "MSB", "MSW", "MSSL",
    "MSH", "MSQ", "MSBI", "PACC", "MSB", "MSW", "MSSL")


table_formatting <- function(table_new3, column_names) {
  if (is.null(table_new3)) {
    table_new3 <- NULL
  } else {
    table_new3 %>%
    select(everything()) %>%
    kable(escape = F, align = "c", col.names = column_names) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE,
                  position = "center", row_label_position = "c",
                  font_size = 11) %>%
    add_header_above(c(" " = 1,
                       "Receive to Result within Target (Business Days)" = 10,
                       "Average Collection to Result TAT (Calendar Days)" = 7),
                     background = c("white", "#00B9F2", "#221F72"),
                     color = "white", font_size = 13) %>%
    column_spec(2:11, background = "#E6F8FF", color = "black") %>%
    column_spec(12:18, background = "#EBEBF9", color = "black") %>%
    row_spec(row = 0, font_size = 13) %>%
    collapse_rows(columns = c(1, 2))
  }
}


table_formatting2 <- function(table_new3_v2) {
  if (is.null(table_new3_v2)) {
    table_new3_v2 <- NULL
  } else {
    table_new3_v2 %>%
    select(everything()) %>%
    kable(escape = F, align = "c",
          col.names = c("Case Type", "Target", "Setting",
                        "No. Cases Signed Out", "Centralized Lab",
                        "MSH", "MSQ", "MSBI", "PACC", "MSB", "MSW", "MSSL",
                        "NYEE")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE,
                  position = "center", row_label_position = "c",
                  font_size = 11) %>%
    add_header_above(c(" " = 1,
                       "Receive to Result within Target (Business Days)" = 4,
                       "Average Collection to Result TAT (Calendar Days)" = 8),
                     background = c("white", "#00B9F2", "#221F72"),
                     color = "white", font_size = 13) %>%
    column_spec(2:5, background = "#E6F8FF", color = "black") %>%
    column_spec(6:13, background = "#EBEBF9", color = "black") %>%
    row_spec(row = 0, font_size = 13) %>%
    collapse_rows(columns = c(1, 2))
  }
}

sp_vol_column_names <- c("Case Type", "Setting",
                          "MSH", "MSQ", "MSBI", "PACC", "MSB", "MSW", "MSSL")

cyto_vol_column_names <- c("Case Type", "Setting",
                            "MSH", "MSQ", "MSBI", "PACC", "MSB", "MSW", "MSSL",
                            "NYEE")

#Volume table formatting
table_formatting_volume <- function(vol_table, column_names) {
  if (is.null(vol_table)) {
    vol_table <- NULL
  } else {
    vol_table %>%
    select(everything()) %>%
    kable(escape = F, align = "c", col.names = column_names) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE,
                  position = "center", row_label_position = "c",
                  font_size = 11) %>%
      add_header_above(c(" " = 2,
                         "Resulted Lab Volume" = length(column_names) - 2),
                       background = c("white", "#00B9F2"), color = "white",
                       font_size = 13) %>%
      column_spec(3:length(column_names), background = "#E6F8FF",
                  color = "black") %>%
    row_spec(row = 0, font_size = 13) %>%
    collapse_rows(columns = 1)

  }
}

```

<br />

## **Weekday Efficiency Indicators** {.tabset}
### Chemistry       
#### *Chemistry KPI (Labs Resulted on `r wday_result_date`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <95%,
<span style = "color:green">Green:</span> >=95%</h5>
```{r Chemistry dashboard table, warning = FALSE, message = FALSE, echo = FALSE}
chem_hem_micro_kable(chem_table)
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings.*</h6>


### Hematology
#### *Hematology KPI (Labs Resulted on `r wday_result_date`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <95%,
<span style = "color:green">Green:</span> >=95%</h5>
```{r Hematology dashboard table, warning = FALSE, message = FALSE, echo = FALSE}
chem_hem_micro_kable(hem_table)
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings.*</h6>

```{r Microbiology RRL volume and TAT table creation, warning = FALSE, message = FALSE, echo = FALSE}
# chem_hem_micro_kable(micro_table)

micro_volume_dashboard1 <- melt(micro_summary, id.var = c("Test", "Site", "DashboardPriority", "TestAndPriority", "DashboardSetting", "ReceiveResultTarget", "CollectResultTarget"), measure.vars = "ResultedVolume")

# Create a table with micro volume with similar formatting to TAT tables to later combine with TAT
micro_volume_dashboard2 <- dcast(micro_volume_dashboard1, Test + DashboardPriority + TestAndPriority + DashboardSetting +ReceiveResultTarget + CollectResultTarget ~ variable + Site, value.var = "value") 

micro_volume_dashboard2[c("ReceiveResultTarget", "CollectResultTarget")] <- "Resulted Volume"
original_length <- ncol(micro_volume_dashboard2)

micro_volume_dashboard2 <- micro_volume_dashboard2[ ,c(1:ncol(micro_volume_dashboard2), (ncol(micro_volume_dashboard2)-(6-1)):ncol(micro_volume_dashboard2))]

micro_volume_dashboard2 <- micro_volume_dashboard2[ , c(1:3, 5, 4, 7:12, 6, 4, 13:18)]
colnames(micro_volume_dashboard2) <- colnames(micro_dashboard2)

micro_volume_dashboard2[ , (original_length):ncol(micro_volume_dashboard2)] <- " "

# Combine TAT table and volume table
micro_tat_vol_comb <- rbind(micro_dashboard2, micro_volume_dashboard2)

micro_tat_vol_comb <- micro_tat_vol_comb[order(micro_tat_vol_comb$Test, micro_tat_vol_comb$ReceiveResultTarget), ]
row.names(micro_tat_vol_comb) <- 1:nrow(micro_tat_vol_comb)

micro_tat_vol_table <- micro_tat_vol_comb[ , 3:ncol(micro_tat_vol_comb)]
```

### Microbiology RRL
#### *Microbiology RRL KPI (Labs Resulted on `r wday_result_date`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <90%, 
<span style = "color:orange">Yellow:</span> >=90% & <100%,
<span style = "color:green">Green:</span> =100%</h5>
```{r Create Micro RRL TAT and Volume Table, warning = FALSE, message = FALSE, echo = FALSE}
chem_hem_micro_kable(micro_tat_vol_table)
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings.*</h6>

### Missing Collections & Add Ons
#### *Missing Collection Times and Add On Order Volume (Labs Resulted on `r wday_result_date`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> >15%, 
<span style = "color:orange">Yellow:</span> <=15% & >5%,
<span style = "color:green">Green:</span> <=5%</h5>
```{r Missing Collection Times Tables, warning = FALSE, message = FALSE, echo = FALSE}
# # Determine percentage of labs with missing collection times -------------------------------
missing_collect <- 
  scc_sun_wday_master[scc_sun_wday_master$TATInclude == TRUE, ] %>%
  group_by(Site, .drop = FALSE) %>%
  summarize(ResultedVolume = n(),
            MissingCollection = sum(MissingCollect, na.rm = TRUE),
            Percent = MissingCollection / ResultedVolume)

# Format percentage of labs with missing collection times as percentage
missing_collect$Percent <- percent(missing_collect$Percent, digits = 0)

# Apply conditional formatting to percentage of labs with missing collection times
missing_collect <- missing_collect %>%
  mutate(Percent = cell_spec(Percent, "html", color = ifelse(is.na(Percent), "grey",
                                                         ifelse(Percent <= 0.05, "green",
                                                                ifelse(Percent >0.05 &  Percent <= 0.15, "orange", "red")))))

missing_collect_table <- dcast(missing_collect, "Percentage of Specimens" ~ Site, value.var = "Percent")

missing_collect_table %>%
  kable(format = "html", escape = FALSE, align = "c",  
        col.names = c("Site", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
  kable_styling(bootstrap_options = "hover", position = "float_left", font_size = 11, full_width = FALSE) %>%
  add_header_above(c(" " = 1, "Percentage of Labs with Missing Collect Times" = ncol(missing_collect_table)-1), background = c("white", "#00AEEF"), color = "white", line = FALSE, font_size = 13) %>%
  column_spec(column = c(1, ncol(missing_collect_table)), border_right = "thin solid lightgray") %>%
  column_spec(column = c(2:ncol(missing_collect_table)), background = "#E6F8FF", color = "black") %>%
 # column_spec(column = c(2:ncol(missing_collect_table)), background = "inherit", color = "inherit", width_max = 0.15) %>%
  row_spec(row = 0, font_size =13)


add_on_volume <- scc_sun_wday_master %>%
  group_by(Test, Site, .drop = FALSE) %>%
  summarize(AddOnVolume = sum(AddOnMaster == "AddOn", na.rm = TRUE))

add_on_table <- dcast(add_on_volume, Test ~ Site, value.var = "AddOnVolume")

add_on_table %>%
  kable(format = "html", escape = FALSE, align = "c", 
        col.names = c("Test", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM"), color = "gray") %>%
  kable_styling(bootstrap_options = "hover", position = "right", font_size = 11, full_width = FALSE) %>%
  add_header_above(c(" " = 1, "Volume of Add On Labs" = ncol(missing_collect_table)-1), background = c("white", "#00AEEF"), color = "white", line = FALSE, font_size = 13) %>%
  column_spec(column = c(1, ncol(missing_collect_table)), border_right = "thin solid lightgray") %>%
  column_spec(column = c(2:ncol(missing_collect_table)), background = "#E6F8FF", color = "black") %>%
  #column_spec(column = c(2:ncol(missing_collect_table)), background = "inherit", color = "inherit") %>%
  row_spec(row = 0, font_size =13)
```
<h6>*Missing collection time analysis includes analytes represented in Chemistry, Hematology, and Microbiology RRL dashboard TAT analysis from ED, ICU, IP Non-ICU, and ambulatory settings.*</h6>

### Surgical Pathology
#### *Surgical Pathology KPI (Specimens Resulted on `r wday_result_date`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <90%,
<span style = "color:green">Green:</span> >=90%</h5>
```{r Surgical Pathology Efficiency Indicator Weekday, echo=FALSE, warning=FALSE, message=FALSE}

table_formatting(sp_table_weekday_new3, sp_standardized_column_names)
```
<h6>*TAT analysis includes all breast specimens and GI biopsies and excludes those with missing timestamps, negative TAT, and not from above settings.*</h6>


### Cytology

#### *Cytology KPI (Specimens Resulted on `r wday_result_date`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <90%,
<span style = "color:green">Green:</span> >=90%</h5>
```{r cyto Efficiency Indicators Weekday, echo=FALSE, warning=FALSE, message=FALSE}
table_formatting2(cyto_table_weekday_new3_v2)
```

<h6>*TAT analysis includes excludes specimens with missing timestamps, negative TAT, and not from above settings.*</h6>


```{r Lab KPI Form for Qualitative Indicators, echo=FALSE, message=FALSE, warning=FALSE, eval = TRUE}
#read the excel sheet that is generated from office form responses
kpi_form <- data.frame(read_excel(
  choose.files(default = paste0(user_directory, "/Lab KPI Form/*.*"),
               caption = "Select the KPI form generated today"), 1),
  stringsAsFactors = FALSE)


#Determine the dates within the KPI excel sheet and report only the latest date
kpi_form <- kpi_form %>%
  mutate(Completion_Date = as.Date(as.POSIXct(Completion.time, tz = "",
                                              format = '%m/%d/%y %I:%M %p')))

kpi_form <- kpi_form %>%
  mutate(Completion_Hour = format(Completion.time, format = "%H:%M:%S"))


kpi_form_today  <- 
  kpi_form[which(kpi_form$Completion_Date == as.Date(today) |
                   (kpi_form$Completion_Date == as.Date(yesterday) &
                      kpi_form$Completion_Hour >= "17:00:00")), ]

#Rename the columns of the kpi form data
colnames(kpi_form_today) <- c("ID", "Start_time", "Completion_time", "Email",
                              "Name", "Facility", "LabCorp", "Vendor_Services",
                              "Environment", "Equipment", "IT",
                              "Service_Changes", "Volume", "Staffing",
                              "Comments", "NEVER_EVENTS",
                              "NEVER_EVENTS_COMMENTS", "Good_Catch",
                              "LIS_Staffing", 
                              "LIS_Unplanned_Service",
                              "LIS_Preplanned_Downtime",
                              "Completion_Date", "Completion_Hour")

#keep only unique rows with the latest timestamp
#order data by facility and time by descending order
kpi_form_today <- kpi_form_today[with(kpi_form_today, order(Facility, -ID)), ]
#add a column to include the dupliacted values
kpi_form_today$duplicated_id <- duplicated(kpi_form_today$Facility)
#only keep the unique ids
kpi_form_today <-
  kpi_form_today[which(kpi_form_today$duplicated_id == "FALSE"), ]

#do not run now until test it - waiting for Daya to send the data for today's
#read historical repo
historical_repo_form <- read_excel(
  paste0(user_directory, "/Lab KPI Form/Lab KPI Hsitorical Repo/",
         "Lab_KPI_Form_Repo", "_", yesterday, ".xlsx"))


#2. combine the current summary with the historical repo and write them
#into a xlsx file
historical_repo_form2 <- rbind(historical_repo_form, kpi_form_today)

#3. to ensure that the selected rows are the unique ones only without
#any dupilacation

historical_repo_form2 <- unique(historical_repo_form2)

xlsx_form <- paste0(user_directory, "/Lab KPI Form/Lab KPI Hsitorical Repo/",
                    "Lab_KPI_Form_Repo", "_", today, ".xlsx")

write_xlsx(historical_repo_form2, xlsx_form)

#split the data into 3 datasets

# the first dataset representes the following: CP/AP/CPA/4LABS
clinical_labs_ops_ind <-
  kpi_form_today[
    which(kpi_form_today$Facility !=
            "Laboratory Information System (LIS)"), c(6:15)]

# the second dataset represents the LIS indicators
lis_ops_ind <-
  kpi_form_today[
    which(kpi_form_today$Facility ==
            "Laboratory Information System (LIS)"), c(6, 19:21)]

# the third and last dataset is the never events and good catches dataset
never_events <-
  kpi_form_today[
    which(kpi_form_today$Facility !=
            "Laboratory Information System (LIS)"), c(6, 16:18)]

####### Start creating and formatting the tables

#first melt the tables to get the values needed in one column:

#1. Clinical labs table
clinical_labs_melt <-
  melt(clinical_labs_ops_ind,
       id = c("Facility", "Comments"))

#2. LIS table
lis_melt <- melt(lis_ops_ind,
                 id = c("Facility",
                        "LIS_Unplanned_Service",
                        "LIS_Preplanned_Downtime"))

##### create a function to rename the status of the measures to a standard one
#( Safe, Under Stress, and Not Safe)

renaming <- function(melted_dataset) {
  if (is.null(melted_dataset) || nrow(melted_dataset) == 0) {
    melted_dataset <- NULL
  } else {

  melted_dataset[melted_dataset == "Green (No issues)"] <- "Safe"

  melted_dataset[
    melted_dataset == "Yellow (Safe/Under Stress)" |
      melted_dataset == "Yellow (Delays)" |
      melted_dataset == "Yellow (Delays in pickup/delivery)" |
      melted_dataset == "Yellow (Shortage with no/minimal significant impact)" |
      melted_dataset ==
      "Yellow (Minor issues/Coordinating with Reference Labs)"] <-
    "Under Stress"

  melted_dataset[
    melted_dataset == "Yellow (Safe/Under Stress)" |
      melted_dataset == "Yellow (Delays)" |
      melted_dataset == "Yellow (Delays in pickup/delivery)" |
      melted_dataset == "Yellow (Shortage with no/minimal significant impact)" |
      melted_dataset ==
      "Yellow (Minor issues/Coordinating with Reference Labs)"] <-
    "Under Stress"

  melted_dataset[
    melted_dataset == "Red (Severe shortage of consumables)" |
      melted_dataset == "Red (Missed pickups)" |
      melted_dataset == "Red (Not Safe/Risk)" |
      melted_dataset == "Red (Severe shortage that halts activity)" |
      melted_dataset == "Red (Major issues/Requires Immediate Attention)"] <-
    "Not Safe"
  }

return(melted_dataset)

}

clinical_labs_melt_new <- renaming(clinical_labs_melt)
lis_melt_new <- renaming(lis_melt)


### create a function to format the data table into the correct colors
conditional_format_form <- function(melted_data_new) {
  if (is.null(melted_data_new) || nrow(melted_data_new) == 0) {
    melted_data_new <- NULL
  } else {
  melted_data_new <-
    melted_data_new %>%
      mutate(
        value =
          ifelse(is.na(value),
                 cell_spec(value, "html", color = "lightgray"),
                 ifelse((value == "Safe" | value == "None"),
                        cell_spec(value, "html", color  = "green"),
                        ifelse((value == "Not Safe" | value == "Present"),
                               cell_spec(value, "html", color = "red"),
                               cell_spec(value, "html", color = "orange")))))

return(melted_data_new)

  }

}

formatted_clinical_labs <-
  conditional_format_form(clinical_labs_melt_new)

formatted_lis_new <- conditional_format_form(lis_melt_new)

###### ------------- Now decast the melted clinical table ------------- ######
formatted_clinical_labs1 <-
  dcast(formatted_clinical_labs,
        Facility + Comments ~ variable)

#Change the order of the columns in the table
columns_order_form_clinical <-
  c("Facility", "LabCorp", "Vendor_Services", "Environment", "Equipment", "IT",
    "Service_Changes", "Volume", "Staffing", "Comments")

formatted_clinical_labs1 <-
  formatted_clinical_labs1[, columns_order_form_clinical]

needed_rows <- data.frame(matrix(ncol = 1, nrow = 11))

colnames(needed_rows) <- c("Facility")

needed_rows[1] <-
  c("MSH (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSQ (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSBI (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSB (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSW (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSSL (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "NYEE (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSSN (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSH - Anatomic Pathology (Centralized)",
    "MSH - Central Processing & Accessioning",
    "4LABS - Client Services")

#i need all the columns from x and all the rows from x and y
trial <- right_join(formatted_clinical_labs1, needed_rows)
#
rownames(trial) <- trial$Facility

#Change the order of the rows in the table

formatted_clinical_labs2 <-
  trial[c(
    "MSH (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSQ (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSBI (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSB (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSW (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSSL (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "NYEE (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSSN (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSH - Anatomic Pathology (Centralized)",
    "MSH - Central Processing & Accessioning",
    "4LABS - Client Services"), ]

rownames(formatted_clinical_labs2) <- NULL

#Change the names in the Facility columns to be standardized

rownames(formatted_clinical_labs2) <-
  c("MSH", "MSQ", "MSBI", "MSB", "MSW", "MSSL", "NYEE", "MSSN",
    "Anatomic Pathology (Centralized)",
    "Central Processiong & Accessioning (CPA)",
    "Client Services - 4LABS")

formatted_clinical_labs2 <- formatted_clinical_labs2 %>%
  mutate(Facility = rownames(formatted_clinical_labs2))

rownames(formatted_clinical_labs2) <- NULL

formatted_clinical_labs3 <- formatted_clinical_labs2[, c(1:9)]

comments_clinical_labs <- formatted_clinical_labs2[, c(1, 10)]
comments_clinical_labs[is.na(comments_clinical_labs)] <-
  "No Issues Reported (Safe)"

comments_clinical_labs[comments_clinical_labs == "None" |
                         comments_clinical_labs == "NONE" |
                         comments_clinical_labs == "none" |
                         comments_clinical_labs == "N/A" |
                         comments_clinical_labs == "n/a" |
                         comments_clinical_labs == "na" |
                         comments_clinical_labs == "NA"] <-
  "No Issues Reported (Safe)"

###### --------------- now decast the LIS  table --------------- ######
if (is.null(formatted_lis_new) || nrow(formatted_lis_new) == 0) {
    formatted_lis_new2 <- NULL
} else{
  formatted_lis_new2 <-
    dcast(formatted_lis_new,
          Facility +
            LIS_Unplanned_Service +
            LIS_Preplanned_Downtime ~ variable)

  columns_order_form_lis <-
    c("Fcaility",
      "LIS_Staffing",
      "LIS_Unplanned_Service",
      "LIS_Preplanned_Downtime")

  formatted_lis_new2 <- formatted_lis_new2[, columns_order_form_lis]
  rownames(formatted_lis_new2) <- NULL
  formatted_lis_new2[is.na(formatted_lis_new2)] <- "None"
}
###### --------------- Formatting Never Events Table --------------- ######

# added 4 extra columns each one for different never event
never_events["Specimen(s) Lost"] <- NA
never_events["QNS - specimen that cannot be recollected"] <- NA
never_events["Treatment based on mislabeled/misidentified specimen"] <- NA
never_events["Treatment based on false positive/false negative results"] <- NA

#because we have multiple never events in one cell i created a
#list with these by:
splitting_ne_text <- sapply(never_events$NEVER_EVENTS, strsplit, "[;]")

#created a nested for loop with nested if to determine which of these
#never events are listed
for (i in 1:nrow(never_events)) {
  for (j in 1:length(splitting_ne_text[[i]])) {
    if (splitting_ne_text[[i]][j] == colnames(never_events)[5]) {
      never_events$`Specimen(s) Lost`[i] <- 1
      }
    else if (splitting_ne_text[[i]][j] == colnames(never_events)[6]) {
      never_events$`QNS - specimen that cannot be recollected`[i] <- 1
      }
    else if (splitting_ne_text[[i]][j] == colnames(never_events)[7]) {
      never_events$`Treatment based on mislabeled/misidentified specimen`[i] <- 1
      }
    else if (splitting_ne_text[[i]][j] == colnames(never_events)[8]) {
      never_events$`Treatment based on false positive/false negative results`[i] <- 1
      }
  }
}

never_events$NEVER_EVENTS <- NULL

never_events_melt <-
  melt(never_events,
       id = c(
         "Facility",
         "NEVER_EVENTS_COMMENTS",
         "Good_Catch"))

never_events_melt$value[is.na(never_events_melt$value)] <- "None"
never_events_melt$value[never_events_melt$value == 1] <- "Present"

never_events_melt[never_events_melt == "None" |
                    never_events_melt == "NONE" |
                    never_events_melt == "none" |
                    never_events_melt == "N/A" |
                    never_events_melt == "n/a" |
                    never_events_melt == "na" |
                    never_events_melt == "NA"] <- "None"

formatted_never_event_melt <- conditional_format_form(never_events_melt)

formatted_never_event_ <-
  dcast(formatted_never_event_melt,
        Facility +
        NEVER_EVENTS_COMMENTS +
        Good_Catch ~ variable)

never_events_column_order_1 <-
  c("Facility",
    "Specimen(s) Lost",
    "QNS - specimen that cannot be recollected",
    "Treatment based on mislabeled/misidentified specimen",
    "Treatment based on false positive/false negative results",
    "NEVER_EVENTS_COMMENTS", "Good_Catch")

formatted_never_event_ <- formatted_never_event_[, never_events_column_order_1]

#Change the order of the rows in the table
trial_neverevent <- right_join(formatted_never_event_, needed_rows)
rownames(trial_neverevent) <- trial_neverevent$Facility

#Change the order of the rows in the table

formatted_never_event <-
  trial_neverevent[c(
    "MSH (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSQ (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSBI (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSB (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSW (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSSL (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "NYEE (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSSN (Clinical Pathology, Blood Bank, Anatomic Pathology Front End, etc.)",
    "MSH - Anatomic Pathology (Centralized)",
    "MSH - Central Processing & Accessioning",
    "4LABS - Client Services"), ]

rownames(formatted_never_event) <- NULL

#Change the names in the Facility columns to be standardized

rownames(formatted_never_event) <-
  c("MSH", "MSQ", "MSBI", "MSB", "MSW", "MSSL", "NYEE", "MSSN",
    "Anatomic Pathology (Centralized)",
    "Central Processiong & Accessioning (CPA)",
    "Client Services - 4LABS")

formatted_never_event$Facility <-
  rownames(formatted_never_event)

rownames(formatted_never_event) <- NULL

#Split the table into three
#table one is the comments only while table two is the details

good_catch <- formatted_never_event[, c(1, 7)]
good_catch[is.na(good_catch)] <- "No Issues Reported"

good_catch[good_catch == "None" |
             good_catch == "NONE" |
             good_catch == "none" |
             good_catch == "N/A" |
             good_catch == "n/a" |
             good_catch == "na" |
             good_catch == "NA" |
             good_catch == 0] <- "No Issues Reported"


never_events_comments <- formatted_never_event[, c(1, 6)]
never_events_comments[is.na(never_events_comments)] <- "No Issues Reported"

never_events_comments[never_events_comments == "None" |
                        never_events_comments == "NONE" |
                        never_events_comments == "none" |
                        never_events_comments == "N/A" |
                        never_events_comments == "n/a" |
                        never_events_comments == "na" |
                        never_events_comments == "NA" |
                        never_events_comments == 0] <- "No Issues Reported"

never_events_only <- formatted_never_event[, c(1:5)]

```

<br />

## **Operational and Quality Indicators** {.tabset}
### Operational Indicators

#### *Operational Indicators for Labs at each Site & Centralized Anatomic Pathology (Submitted on `r wday_result_date`)*

```{r Qualitative Indicators for Clinical Labs, echo=FALSE, message=FALSE, warning=FALSE, eval = TRUE}

formatted_clinical_labs3 %>%
    select(everything()) %>%
    kable(escape = F, align = "c",
          col.names = c("Facility", "Lab Corp Consumable", "Vendor Services",
                        "Enviroment", "Equipment", "IT", "Service Change",
                        "Acute Volume Increase", "Staffing")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE,
                  position = "center", row_label_position = "c",
                  font_size = 11) %>%
    row_spec(row = 0, font_size = 13)

comments_clinical_labs %>%
    select(everything()) %>%
    kable(escape = F, align = "c",
          col.names = c("Facility", "Comments if At Risk or Not Safe")) %>%
    kable_styling(bootstrap_options = "hover", full_width = TRUE,
                  position = "center", row_label_position = "c",
                  font_size = 11) %>%
    row_spec(row = 0, font_size = 13)

```


### Laboratory Information System
#### *Operational Indicators for LIS (Submitted on `r wday_result_date`)*

```{r Qualitative Indicators for LIS, echo=FALSE, message=FALSE, warning=FALSE, eval = TRUE}
if (is.null(formatted_lis_new2) || nrow(formatted_lis_new2) == 0) {
    formatted_lis_new2 <- NULL
} else{
  formatted_lis_new2 %>%
      select(everything()) %>%
      kable(escape = F, align = "c",
            col.names = c("", "Staffing", "Service Change",
                          "Preplanned Downtime")) %>%
      kable_styling(bootstrap_options = "hover", full_width = FALSE,
                    position = "center", row_label_position = "c",
                    font_size = 11) %>%
      row_spec(row = 0, font_size = 13)
}
```


### Quality Indicators
#### Never Events 
##### *Reported Never Events for Each Division/Facility (Submitted on `r wday_result_date`)*
```{r Lab KPI Form for Never Events, echo=FALSE, message=FALSE, warning=FALSE, eval = TRUE}
never_events_only %>%
    select(everything()) %>%
    kable(escape = F, align = "c",
          col.names = c(
            "Facility", "Specimen(s) Lost",
            "QNS - specimen that cannot be recollected",
            "Treatment based on mislabeled/misidentified specimen",
            "Treatment based on false positive/false negative results")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE,
                  position = "center", row_label_position = "c",
                  font_size = 11) %>%
    row_spec(row = 0, font_size = 13)

never_events_comments %>%
    select(everything()) %>%
    kable(escape = F, align = "c",
          col.names = c("Facility", "Comments if There is a Never Event")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE,
                  position = "center", row_label_position = "c",
                  font_size = 11) %>%
    row_spec(row = 0, font_size = 13)

```

#### Good Catches
##### *Reported Good Catches for Each Division/Facility (Submitted on `r wday_result_date`)*
```{r Lab KPI Form for Good Catches, echo=FALSE, message=FALSE, warning=FALSE, eval = TRUE}
good_catch %>%
    select(everything()) %>%
    kable(escape = F, align = "c",
          col.names = c("Facility", "Good Catch Comment")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE,
                  position = "center", row_label_position = "c",
                  font_size = 11) %>%
    row_spec(row = 0, font_size = 13)

```

<br />

## **Weekday 24-Hour Volume Lookback** {.tabset}

```{r Custom function for 24 hour volume lookbacks for Chemistry and Hematology, echo = FALSE, warning = FALSE, message = FALSE}

lab_volume_summarize <- function(x, LabDivision) {
  # Subset data for relevant division
  lab_vol_df <- x[x$Division == LabDivision, ]
  # Update factors and format data
  lab_vol_df$Test <- factor(lab_vol_df$Test, unique(test_code$Test[test_code$Division == LabDivision]))
  lab_vol_df$MasterSetting <- factor(lab_vol_df$MasterSetting, pt_setting_order)
  lab_vol_df$DashboardPriority <- droplevels(lab_vol_df$DashboardPriority)
  
  # Summarize data
  lab_vol_summary <- lab_vol_df %>%
  group_by(Site, Test, DashboardPriority, MasterSetting, .drop = FALSE) %>%
  summarize(ResultedLabs = n())
  # Add column concatenating Test and Priority
  lab_vol_summary$TestPriority <- paste(lab_vol_summary$Test, "-", lab_vol_summary$DashboardPriority, "Labs")
  
  # Remove unused combinations (ie, Routine ED & ICU labs)
  lab_vol_summary <- lab_vol_summary[!((lab_vol_summary$MasterSetting == "ED" | lab_vol_summary$MasterSetting == "ICU")&(lab_vol_summary$DashboardPriority == "Routine")), ]
  
  # Cast summary table
  lab_vol_table <- dcast(lab_vol_summary, Test + DashboardPriority + TestPriority + MasterSetting ~ Site, value.var = "ResultedLabs")
  
  lab_vol_output <- list(lab_vol_df, lab_vol_summary, lab_vol_table)
  return(lab_vol_output)
}

lab_vol_kable_format <- function(table_data) {
  kable(table_data, format = "html", escape = FALSE, align = "c", 
        col.names = c("Test & Priority", "Setting", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
  kable_styling(bootstrap_options = "hover", position = "center", font_size = 11) %>%
  column_spec(column = c(1, 8), border_right = "thin solid lightgray") %>%
  add_header_above(c(" " = 1, "Resulted Lab Volume" = (ncol(table_data)-1)), background = c("white", "#00AEEF"), color = "white", line = FALSE, font_size = 13) %>%
  column_spec(column = 2:8, background = "#E6F8FF", color = "black") %>%
  #column_spec(column = 2:8, background = "inherit", color = "inherit") %>%
  # column_spec(column = 1, width_min = "125px", include_thead = TRUE) %>%
  # column_spec(column = c(3, 11), width_min = "100px", include_thead = TRUE) %>%
  row_spec(row = 0, font_size = 13) %>%
  collapse_rows(columns = c(1, 2))
}

```

### Chemistry
#### *Chemistry Resulted Lab Volume (Labs Resulted on `r wday_result_date`)*
```{r Chemistry: 24 hour volume lookback, echo = FALSE, warning = FALSE, message = FALSE}
chem_vol_wday_output <- lab_volume_summarize(scc_sun_wday_master, LabDivision = "Chemistry")
chem_vol_wday_df <- chem_vol_wday_output[[1]]
chem_vol_wday_summary <- chem_vol_wday_output[[2]]
chem_vol_wday_table <- chem_vol_wday_output[[3]]

# Manually remove unused combinations (ie. Troponin & Lactate w/o "All" as priority, BUN with "All" priority)
chem_vol_wday_table2 <- chem_vol_wday_table[!(((chem_vol_wday_table$Test == "Troponin" | chem_vol_wday_table$Test == "Lactate WB")&(chem_vol_wday_table$DashboardPriority != "All")) | (chem_vol_wday_table$Test == "BUN" & chem_vol_wday_table$DashboardPriority == "All")), ]

chem_vol_wday_table2 <- chem_vol_wday_table2[ , 3:ncol(chem_vol_wday_table2)]
rownames(chem_vol_wday_table2) <- 1:nrow(chem_vol_wday_table2)

lab_vol_kable_format(chem_vol_wday_table2)
```


### Hematology
#### *Hematology Resulted Lab Volume (Labs Resulted on `r wday_result_date`)*
```{r Hematology: 24 hour volume lookback, echo = FALSE, warning = FALSE, message = FALSE}
hem_vol_wday_output <- lab_volume_summarize(scc_sun_wday_master, LabDivision = "Hematology")
hem_vol_wday_df <- hem_vol_wday_output[[1]]
hem_vol_wday_summary <- hem_vol_wday_output[[2]]
hem_vol_wday_table <- hem_vol_wday_output[[3]]

hem_vol_wday_table <- hem_vol_wday_table[ , 3:ncol(hem_vol_wday_table)]
rownames(hem_vol_wday_table) <- 1:nrow(hem_vol_wday_table)

lab_vol_kable_format(hem_vol_wday_table)
```

### Surgical Pathology   
#### *Surgical Pathology Signed Out Cases Volume (As of `r wday_result_date`)*
```{r Surgical Pathology Signed Out Cases on a weekday, echo=FALSE, warning=FALSE, message=FALSE}
table_formatting_volume(sp_strat_vol_weekday_new2, 
                        sp_vol_column_names)
```

### Cytology   

#### *Cytology Accessioned Cases and Backlog Volume (As of `r wday_result_date`)*
```{r cyto Backlog and Accessioned, echo=FALSE, warning=FALSE, message=FALSE}

backlog_acc_table_new2 %>% 
  kable(escape = F, align = "c",
        col.names = c("Case Type","Cases Accessioned","Backlog Volume",
                      "25th Percentile", "50th Percentile", "Maximum")) %>%
  kable_styling(bootstrap_options = "hover", full_width = TRUE,
                position = "center", row_label_position = "c",
                font_size = 11) %>%
  column_spec(2, background = "#E6F8FF", color = "black") %>%
  column_spec(3:6, background = "#EBEBF9", color = "black") %>%
  row_spec(row = 0, font_size = 13) %>%
  add_header_above(c(
    " " = 2,
    "Elapsed Turn Around Time for Backlogged Cases From the Received Time" = 4),
    background = c("white", "#221F72"), color = "white", font_size = 13) %>%
  collapse_rows(columns = 1)

```



#### *Cytology Signed Out Cases Volume (As of `r wday_result_date`)*
```{r cyto Signed Out Cases on a weekday, echo=FALSE, warning=FALSE, message=FALSE}
table_formatting_volume(cyto_strat_vol_weekday_new2, cyto_vol_column_names)
```

`r if (include_not_wday != TRUE) {"<!--"}`

```{r Conditional Block for Weekends, eval = include_not_wday, warning = FALSE, message = FALSE, echo = FALSE}

# Chemistry
chem_sub_output_not_wday <-lab_sub_summarize(scc_sun_not_wday_master, LabDivision = "Chemistry")
chem_subset_not_wday <- chem_sub_output_not_wday[[1]]
chemistry_summary_not_wday <- chem_sub_output_not_wday[[2]]
chemistry_dashboard1_not_wday <- chem_sub_output_not_wday[[3]]
chemistry_dashboard2_not_wday <- chem_sub_output_not_wday[[4]]

# Chemistry: Manually remove unused combinations
chemistry_dashboard2_not_wday <- chemistry_dashboard2_not_wday[!(((chemistry_dashboard2_not_wday$Test == "Troponin" | chemistry_dashboard2_not_wday$Test == "Lactate WB") & (chemistry_dashboard2_not_wday$DashboardPriority != "All" | chemistry_dashboard2_not_wday$DashboardSetting == "Amb")) | (chemistry_dashboard2_not_wday$Test == "BUN" & chemistry_dashboard2_not_wday$DashboardPriority == "All")), ]
row.names(chemistry_dashboard2_not_wday) <- 1:nrow(chemistry_dashboard2_not_wday)

chem_table_not_wday <- chemistry_dashboard2_not_wday[ , 3:ncol(chemistry_dashboard2_not_wday)]

# Hematology
hem_sub_output_not_wday <-lab_sub_summarize(scc_sun_not_wday_master, LabDivision = "Hematology")
hem_subset_not_wday <- hem_sub_output_not_wday[[1]]
hematology_summary_not_wday <- hem_sub_output_not_wday[[2]]
hematology_dashboard1_not_wday <- hem_sub_output_not_wday[[3]]
hematology_dashboard2_not_wday <- hem_sub_output_not_wday[[4]]

hem_table_not_wday <- hematology_dashboard2_not_wday[ , 3:ncol(hematology_dashboard2_not_wday)]

# Microbiology RRL
micro_sub_output_not_wday <-lab_sub_summarize(scc_sun_not_wday_master, LabDivision = "Microbiology RRL")
micro_subset_not_wday <- micro_sub_output_not_wday[[1]]
micro_summary_not_wday <- micro_sub_output_not_wday[[2]]
micro_dashboard1_not_wday <- micro_sub_output_not_wday[[3]]
micro_dashboard2_not_wday <- micro_sub_output_not_wday[[4]]

# Microbiology RRL: Manually remove unused combinations
micro_dashboard2_not_wday <- micro_dashboard2_not_wday[!(micro_dashboard2_not_wday$Test == "C. diff" & micro_dashboard2_not_wday$DashboardSetting == "Amb"), ]
row.names(micro_dashboard2_not_wday) <- 1:nrow(micro_dashboard2_not_wday)

micro_table_not_wday <- micro_dashboard2_not_wday[ , 3:ncol(micro_dashboard2_not_wday)]
```

`r #Begin weekend/holiday dashboard visualizations`

<br />

## **Weekend/Holiday Efficiency Indicators** {.tabset}
### Chemistry
#### *Chemistry KPI (Labs Resulted on `r wkend_holiday_result_date`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <95%, 
<span style = "color:green">Green:</span> >=95%</h5>'
```{r Chemistry dashboard table for weekends and holidays, eval = include_not_wday, warning = FALSE, message = FALSE, echo = FALSE}
# asis_output(paste('<h4> *Chemistry KPI (Labs Resulted on', wkend_holiday_result_date, ')*</h4>'))
# asis_output('<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, <span style = "color:orange">Yellow:</span> >=80% & <95%, <span style = "color:green">Green:</span> >=95%</h5>')
chem_hem_micro_kable(chem_table_not_wday)
# asis_output('<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings.*</h6>')
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings.*</h6>'

### Hematology
#### *Hematology KPI (Labs Resulted on `r wkend_holiday_result_date`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, 
<span style = "color:orange">Yellow:</span> >=80% & <95%, 
<span style = "color:green">Green:</span> >=95%</h5>
```{r Hematology dashboard table for weekends/holidays, eval = include_not_wday, warning = FALSE, message = FALSE, echo = FALSE}
# asis_output('<h3> Hematology </h3>')
# asis_output(paste('<h4> *Hematology KPI (Labs Resulted on', wkend_holiday_result_date, ')*</h4>'))
# asis_output('<h5>Status Definitions: <span style = "color:red">Red:</span> <80%, <span style = "color:orange">Yellow:</span> >=80% & <95%, <span style = "color:green">Green:</span> >=95%</h5>')
chem_hem_micro_kable(hem_table_not_wday)
# asis_output('<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings.*</h6>')
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings.*</h6>

```{r Microbiology RRL volume and TAT table creation for weekends/holidays, eval = include_not_wday, warning = FALSE, message = FALSE, echo = FALSE}

micro_volume_dashboard1_not_wday <- melt(micro_summary_not_wday, id.var = c("Test", "Site", "DashboardPriority", "TestAndPriority", "DashboardSetting", "ReceiveResultTarget", "CollectResultTarget"), measure.vars = "ResultedVolume")

# Create a table with micro volume with similar formatting to TAT tables to later combine with TAT
micro_volume_dashboard2_not_wday <- dcast(micro_volume_dashboard1_not_wday, Test + DashboardPriority + TestAndPriority + DashboardSetting +ReceiveResultTarget + CollectResultTarget ~ variable + Site, value.var = "value") 

micro_volume_dashboard2_not_wday[c("ReceiveResultTarget", "CollectResultTarget")] <- "Resulted Volume"
original_length_not_wday <- ncol(micro_volume_dashboard2_not_wday)

micro_volume_dashboard2_not_wday <- micro_volume_dashboard2_not_wday[ ,c(1:ncol(micro_volume_dashboard2_not_wday), (ncol(micro_volume_dashboard2_not_wday)-(6-1)):ncol(micro_volume_dashboard2_not_wday))]

micro_volume_dashboard2_not_wday <- micro_volume_dashboard2_not_wday[ , c(1:3, 5, 4, 7:12, 6, 4, 13:18)]
colnames(micro_volume_dashboard2_not_wday) <- colnames(micro_dashboard2_not_wday)

micro_volume_dashboard2_not_wday[ , (original_length_not_wday):ncol(micro_volume_dashboard2_not_wday)] <- " "

# Combine TAT table and volume table
micro_tat_vol_comb_not_wday <- rbind(micro_dashboard2_not_wday, micro_volume_dashboard2_not_wday)

micro_tat_vol_comb_not_wday <- micro_tat_vol_comb_not_wday[order(micro_tat_vol_comb_not_wday$Test, micro_tat_vol_comb_not_wday$ReceiveResultTarget), ]
row.names(micro_tat_vol_comb_not_wday) <- 1:nrow(micro_tat_vol_comb_not_wday)

micro_tat_vol_table_not_wday <- micro_tat_vol_comb_not_wday[ , 3:ncol(micro_tat_vol_comb_not_wday)]
```

### Microbiology RRL
#### *Microbiology RRL (Labs Resulted on `r wkend_holiday_result_date`)*
<h5>Status Definitions: <span style = "color:red">Red:</span> <90%, 
<span style = "color:orange">Yellow:</span> >=90% & <100%, 
<span style = "color:green">Green:</span> =100%</h5>
```{r Microbiology RRL dashboard table for weekends/holidays, eval = include_not_wday, warning = FALSE, message = FALSE, echo = FALSE}
# asis_output('<h3> Microbiology RRL  </h3>')
# asis_output(paste('<h4> *Microbiology RRL KPI (Labs Resulted on ', wkend_holiday_result_date, ')*</h4>'))
# asis_output('<h5>Status Definitions: <span style = "color:red">Red:</span> <90%, <span style = "color:orange">Yellow:</span> >=90% & <100%, <span style = "color:green">Green:</span> =100%</h5>')
chem_hem_micro_kable(micro_tat_vol_table_not_wday) 
# asis_output('<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings.*</h6>')
```
<h6>*TAT Analysis excludes add on orders, labs with missing timestamps, labs with negative TAT, and labs not from above settings.*</h6>

### Missing Collections & Add Ons
    
#### *Missing Collection Times and Add On Order Volume (Labs Resulted on `r wkend_holiday_result_date`)*

<h5> Missing Collection Status Definitions: <span style = "color:red">Red:</span> >15%, 
<span style = "color:orange">Yellow:</span> <=15% & >5%, 
<span style = "color:green">Green:</span> <=5%</h5>
```{r Missing Collection Times Tables for weekends/holidays, eval = include_not_wday, warning = FALSE, message = FALSE, echo = FALSE}
# asis_output('<h3> Missing Collections & Add On Orders </h3>')
# asis_output(paste('<h4>*Missing Collection Times and Add On Order Volume (Labs Resulted on ', wkend_holiday_result_date, ')*</h4>'))
# asis_output('<h5>Status Definitions: <span style = "color:red">Red:</span> >15%, <span style = "color:orange">Yellow:</span> <=15% & >5%, <span style = "color:green">Green:</span> <=5%</h5>')

# Determine percentage of labs with missing collection times -------------------------------
missing_collect_not_wday <- scc_sun_not_wday_master[scc_sun_not_wday_master$TATInclude == TRUE, ] %>%
  group_by(Site, .drop = FALSE) %>%
  summarize(ResultedVolume = n(), MissingCollection = sum(MissingCollect, na.rm = TRUE), Percent = MissingCollection/ResultedVolume)

# Format percentage of labs with missing collection times as percentage
missing_collect_not_wday$Percent <- percent(missing_collect_not_wday$Percent, digits = 0)

# Apply conditional formatting to percentage of labs with missing collection times
missing_collect_not_wday <- missing_collect_not_wday %>%
  mutate(Percent = cell_spec(Percent, "html", color = ifelse(is.na(Percent), "grey",
                                                         ifelse(Percent <= 0.05, "green",
                                                                ifelse(Percent >0.05 &  Percent <= 0.15, "orange", "red")))))

missing_collect_table_not_wday <- dcast(missing_collect_not_wday, "Percentage of Specimens" ~ Site, value.var = "Percent")

missing_collect_table_not_wday %>%
  kable(format = "html", escape = FALSE, align = "c",  
        col.names = c("Site", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM")) %>%
  kable_styling(bootstrap = "hover", position = "float_left", font_size = 11, full_width = FALSE) %>%
  add_header_above(c(" " = 1, "Percentage of Labs with Missing Collect Times" = ncol(missing_collect_table)-1), background = c("white", "#00AEEF"), color = "white", line = FALSE, font_size = 13) %>%
  column_spec(column = c(1, ncol(missing_collect_table)), border_right = "thin solid lightgray") %>%
  column_spec(column = c(2:ncol(missing_collect_table)), background = "#E6F8FF", color = "black") %>%
  #column_spec(column = c(2:ncol(missing_collect_table)), background = "inherit", color = "inherit", width_max = 0.15) %>%
  row_spec(row = 0, font_size =13)

add_on_volume_not_wday <- scc_sun_not_wday_master %>%
  group_by(Test, Site, .drop = FALSE) %>%
  summarize(AddOnVolume = sum(AddOnMaster == "AddOn", na.rm = TRUE))

add_on_table_not_wday <- dcast(add_on_volume_not_wday, Test ~ Site, value.var = "AddOnVolume")

add_on_table_not_wday %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Test", "MSH", "MSQ", "MSBI", "MSB", "MSW", "MSM"), color = "gray") %>%
  kable_styling(bootstrap = "hover", position = "right", font_size = 11, full_width = FALSE) %>%
  add_header_above(c(" " = 1, "Volume of Add On Labs" = ncol(missing_collect_table)-1), background = c("white", "#00AEEF"), color = "white", line = FALSE, font_size = 13) %>%
  column_spec(column = c(1, ncol(missing_collect_table)), border_right = "thin solid lightgray") %>%
  column_spec(column = c(2:ncol(missing_collect_table)), background = "#E6F8FF", color = "black") %>%
  #column_spec(column = c(2:ncol(missing_collect_table)), background = "#E6F8FF", color = "black", include_thead = TRUE) %>%
  #column_spec(column = c(2:ncol(missing_collect_table)), background = "inherit", color = "inherit") %>%
  row_spec(row = 0, font_size =13)

# asis_output('<h6>*Missing collection time analysis only includes labs represented in dashboard included in TAT analysis*</h6>
# ')
```
<h6>*Missing collection time analysis only includes labs represented in dashboard included in TAT analysis*</h6>

`r #Start new tabset for weekend/holiday volume lookback`

<br />

## **Weekend/Holiday Volume Lookback** {.tabset}

### Chemistry
#### *Chemistry Resulted Lab Volume (Labs Resulted on `r wkend_holiday_result_date`)*
```{r Chemistry Weekend/Holiday: volume lookback, eval = include_not_wday, warning = FALSE, message = FALSE, echo = FALSE}
# asis_output('<h3> Chemistry </h3>')
# asis_output(paste('<h4> *Chemistry Resulted Lab Volume (Labs Resulted on ', wkend_holiday_result_date, ')*</h4>'))
chem_vol_not_wday_output <- lab_volume_summarize(scc_sun_not_wday_master, LabDivision = "Chemistry")
chem_vol_not_wday_df <- chem_vol_not_wday_output[[1]]
chem_vol_not_wday_summary <- chem_vol_not_wday_output[[2]]
chem_vol_not_wday_table <- chem_vol_not_wday_output[[3]]

# Manually remove unused combinations (ie. Troponin & Lactate w/o "All" as priority, BUN with "All" priority)
chem_vol_not_wday_table2 <- chem_vol_not_wday_table[!(((chem_vol_not_wday_table$Test == "Troponin" | chem_vol_not_wday_table$Test == "Lactate WB")&(chem_vol_not_wday_table$DashboardPriority != "All")) | (chem_vol_not_wday_table$Test == "BUN" & chem_vol_not_wday_table$DashboardPriority == "All")), ]

chem_vol_not_wday_table2 <- chem_vol_not_wday_table2[ , 3:ncol(chem_vol_not_wday_table2)]
rownames(chem_vol_not_wday_table2) <- 1:nrow(chem_vol_not_wday_table2)

lab_vol_kable_format(chem_vol_not_wday_table2)
```

### Hematology
#### *Hematology Resulted Lab Volume (Labs Resulted on `r wkend_holiday_result_date`)*
```{r Hematology Weekend/Holiday: volume lookback, eval = include_not_wday, warning = FALSE, message = FALSE, echo = FALSE}
# asis_output('<h3> Hematology </h3>')
# asis_output(paste('<h4> *Hematology Resulted Lab Volume (Labs Resulted on ', wkend_holiday_result_date, ')*</h4>'))

hem_vol_not_wday_output <- lab_volume_summarize(scc_sun_not_wday_master, LabDivision = "Hematology")
hem_vol_not_wday_df <- hem_vol_not_wday_output[[1]]
hem_vol_not_wday_summary <- hem_vol_not_wday_output[[2]]
hem_vol_not_wday_table <- hem_vol_not_wday_output[[3]]

hem_vol_not_wday_table <- hem_vol_not_wday_table[ , 3:ncol(hem_vol_not_wday_table)]
rownames(hem_vol_not_wday_table) <- 1:nrow(hem_vol_not_wday_table)

lab_vol_kable_format(hem_vol_not_wday_table)
```


`r if (include_not_wday != TRUE) {"-->"}`

## **Assumptions and Methodology** {.tabset}
### Definitions
<h4><b>Definition table</b></h4>
The table below summarizes the definitions for some of the terminology used in this dashboard for clarification purposes. 

```{r format table for definitions}

definition_table <-
  data.frame(read_excel(reference_file, sheet = "Definitions"),
             stringsAsFactors = FALSE)

definition_table  %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Terminology Used", "Terminology Definition")) %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white")

```

### Clinical Pathology

<h4><b>Data Sources</b></h4>
MSH and MSQ: Based on daily SCC report. Report name changes daily but follows structure of "DocMM-DD_xxxxxx.xlsx"</br>
MSBI, MSB, MSW, MSM: Based on daily Sunquest report titled "KPI_Daily_TAT_Report_Updated.xls"</br>
The table below summarizes the test codes and IDs used from these daily reports.

```{r Create and format a table for test codes}
test_codes_kable <- test_code %>%
  mutate(Test = factor(Test, levels = cp_micro_lab_order, ordered = TRUE)) %>%
  arrange(Test)

test_codes_kable <-
  test_codes_kable[, c("Division", "Test", "SCC_TestID", "SUN_TestCode")]

test_codes_kable %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Lab Division", "Test", "SCC Test ID",
                      "Sunquest Test Code")) %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2, 3, 4), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white") %>%
  collapse_rows()

```

<h4><b>Target Turnaround Times</b></h4>
The table below summarizes target turnaround times as agreed upon by clinical and operational leadership. 
```{r Create and format tables for TAT targets }
tat_targets_kable <- tat_targets %>%
  mutate(Test = factor(Test, levels = cp_micro_lab_order, ordered = TRUE),
         Priority = factor(Priority, levels = dashboard_priority_order,
                           ordered = TRUE)) %>%
  arrange(Test, Priority)

tat_targets_kable$Concate <- NULL

tat_targets_kable %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Test", "Priority", "Patient Setting",
                      "Receive to Result TAT Target (min)",
                      "Collect to Result TAT Target (min)"),
        caption = "Target Turnaround Times") %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2, 3, 5), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white")

```

<h4><b>Additional notes on target turnaround times:</b></h4>

* Troponin and Lactate WB:
    + All labs are treated as stat regardless of documented priority and patient setting.
    + Ambulatory labs excluded from turnaround time analysis
* Rapid Flu:
    + All labs are treated as stat regardless of documented priority and patient setting.
* C. diff:
    + All labs are treated as stat regardless of documented priority and patient setting.
    + Turnaround time for ambulatory C. diff tests are not tracked but rather volume of these labs is monitored.

<h4><b>Turnaround Time Exclusions</b></h4>

Turnaround time analysis excludes labs with out of order steps (ie, collect after receive), missing timestamps, add-on orders, and labs not originating in IP, ED, or ambulatory settings (ie, Outreach).

<br>
  
<h4><b>Add On Orders</b></h4>
Add on orders are defined as labs with an order time more than 5 minutes after receive time. These labs are excluded from turnaround time analysis but the volume of these labs is monitored.

<br>

<h4><b>Missing Collections</b></h4>
Labs are classified as missing collections based on the following criteria:

* SCC: Collection time equal to receive time
* Sunquest: Collection time equal to order time

### Anatomic Pathology
<h4><b>Target Turnaround Times</b></h4>
The table below summarizes target turnaround times for Anatomic Pathology as agreed upon by clinical and operational leadership. 

```{r Target Turnaround Times Table}

tat_targets_ap  %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Test", "Patient Setting",
                      "Receive to Result TAT Target (days)",
                      "Collect to Result TAT Target (days)")) %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2, 3, 4), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72", color = "white") %>%
  collapse_rows(columns = 1)

```


<h4><b>Inclusion and Exclusion Criteria for GI Specimens</b></h4>
The table below summarizes the GI codes that were included vs. excluded during the TAT and volume calculations as agreed upon by clinical and operational leadership.
<br>
Only the codes for GI biopsies are included in the analysis.

```{r GI Codes Table}
gi_codes_updated <-
  gi_codes[, c("GI.Codes.Must.Include.in.Analysis..All.GI.Biopsies.",
              "Spec_code")]

gi_codes_updated  %>%
  kable(format = "html", escape = FALSE, align = "c",
        col.names = c("Specimen Code", "Included vs. Excluded Codes")) %>%
  kable_styling(bootstrap_options = "hover", position = "center",
                font_size = 11, full_width = FALSE) %>%
  column_spec(column = c(1, 2), border_right = "thin solid lightgray") %>%
  row_spec(row = 0, font_size = 13, background = "#221f72",
           color = "white") %>%
  collapse_rows(columns = 1)

```

<h4><b>Additional notes on target turnaround times:</b></h4>

* Receive to Result TAT: for anatomic pathology this metric only includes MSHS business days and is a measure of internal laboratory performance.

* Collect to Result TAT: for anatomic pathology this metric includes all calendar days and is a patient-centric measure of performance.

* At this phase, target turnaround times for collect to result have not been established. This metric will be tracked in order to understand current performance and establish future targets.

* Primary Specimens: When a specimen has multiple slides, only the first slide is included. The primary slide is identified as those with spec_sort_order = A.

* All Breast Specimens:
    + Included all the primary breast specimens only. 
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume
    
* GI Biopsies:
    + Included only the samples that are consisted of GI biopsies
    + Only primary specimen GI biopsies included
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume

* Cyto Gyn:
    + TAT and volume analysis were only calculated for Cyto Gyn specimens that were finalized and closed out in EPIC
    + Included all primary Cyto Gyn specimens
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume

* Cyto Non-Gyn:
    + TAT and volume analysis were only calculated for Cyto non-Gyn specimens that were finalized and closed out in EPIC
    + Included all primary Cyto non-Gyn specimens
    + Only labs from ambulatory and inpatient services with valid time stamps included in TAT calculations.
    + TAT analysis excludes labs with missing timestamps
    + All settings included in the resulted volume

* Backlog Cases:
    + Backlog cases are defined as all the cases that are open by cytology and microbiology.
    
<h6> *End of report.* </h6>
