---
title: "Operational Indicators"
author: "Asala Erekat"
date: "2/4/2020"
output: html_document
---

```{r include = FALSE}
#Install packages only the first time you run the code
#install.packages("timeDate")
#install.packages("lubridate")
#install.packages("readxl")
#install.packages("dplyr")
#install.packages("reshape2")
#install.packages("knitr")
#install.packages("kableExtra")
#install.packages("formattable")
# install.packages("bizdays")
#install.packages("rmarkdown")
#install.packages("tinytex")
#install.packages("emojifont")


#-------------------------------Required packages-------------------------------#

#Required packages: run these everytime you run the code
library(timeDate)
library(readxl)
library(bizdays)
library(dplyr)
library(lubridate)
library(reshape2)
library(knitr)
library(kableExtra)
library(formattable)
library(rmarkdown)
library(emojifont)
# library(tinytex)


```

```{r global_options, echo=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=TRUE, message=FALSE)
```

```{r Lab KPI Form for Qualitative Indicators, echo=FALSE, message=FALSE, warning=FALSE}
#read the excel sheet that is generated from office form responses
KPI_Form <- data.frame(read_excel(choose.files(caption = "Select the KPI form generated today"), 1), stringsAsFactors = FALSE)

#Determine the dates within the KPI excel sheet and report only the latest date
KPI_Form$Completion_Date <- as.Date(as.POSIXct(KPI_Form$Completion.time,tz="",format='%m/%d/%y %I:%M %p'))
List_of_Dates <-unique(KPI_Form$Completion_Date)
Ordered_Dates <- List_of_Dates[rev(order(List_of_Dates))]
#pick only the newest responses
KPI_Form_Today <- KPI_Form[which(KPI_Form$Completion_Date == Ordered_Dates[1]),]

#split the data into 3 datasets

# the first dataset representes the following: CP/AP/CPA/4LABS

Clinical_Labs_Ops_Ind <- KPI_Form_Today[which(KPI_Form_Today$Select.your.branch.facility !="Laboratory Information System (LIS)"),c(6:14,16)]

# the second dataset represents the LIS indicators
LIS_Ops_Ind <- KPI_Form_Today[which(KPI_Form_Today$Select.your.branch.facility == "Laboratory Information System (LIS)"),c(6,19:21)]

# the third and last dataset is the never events and good catches dataset
Never_Events <- KPI_Form_Today[which(KPI_Form_Today$Select.your.branch.facility !="Laboratory Information System (LIS)"), c(6,15,17:18)]

####### Start creating and formatting the tables

#first melt the tables to get the values needed in one column:

#1. Clinical labs table
Clinical_Labs_Melt <- melt(Clinical_Labs_Ops_Ind, id =c( "Select.your.branch.facility", "IF.chosen..RED.or.YELLOW.for.any.of.the.items.listed.above..please.write.a.brief.note.on.each.event.including.source.of.specimen.and.location.of.incident"))

#2. LIS table
LIS_Melt <- melt(LIS_Ops_Ind, id =c("Select.your.branch.facility", "LIS...Unplanned.Service.Changes", "LIS.Preplanned.Downtime...If.Applicable."))
##### create a function to rename the status of the measures to a standard one ( Sfae, Under Stress, and Not Safe)

Renaming <- function(Melted_Dataset){
  Melted_Dataset[Melted_Dataset == "Green (No issues)"] <- "Safe"

  Melted_Dataset[Melted_Dataset == "Yellow (Safe/Under Stress)"| Melted_Dataset == "Yellow (Delays)" |  Melted_Dataset == "Yellow (Delays in pickup/delivery)" | Melted_Dataset == "Yellow (Shortage with no/minimal significant impact)" | Melted_Dataset == "Yellow (Minor issues/Coordinating with Reference Labs)"] <- "Under Stress"

  Melted_Dataset[Melted_Dataset == "Yellow (Safe/Under Stress)"| Melted_Dataset == "Yellow (Delays)" |  Melted_Dataset == "Yellow (Delays in pickup/delivery)" | Melted_Dataset == "Yellow (Shortage with no/minimal significant impact)" | Melted_Dataset == "Yellow (Minor issues/Coordinating with Reference Labs)"] <- "Under Stress"

  Melted_Dataset[Melted_Dataset== "Red (Severe shortage of consumables)" | Melted_Dataset == "Red (Missed pickups)" | Melted_Dataset == "Red (Not Safe/Risk)" | Melted_Dataset == "Red (Severe shortage that halts activity)"| Melted_Dataset =="Red (Major issues/Requires Immediate Attention)"] <- "Not Safe"

return(Melted_Dataset)
}

Clinical_Labs_Melt_New <- Renaming(Clinical_Labs_Melt)
LIS_Melt_New <- Renaming(LIS_Melt)

### create a function to format the data table into the correct colors

Conditional_Formatting_Kpi_Form <- function(Melted_Data_New){
  Melted_Data_New <- Melted_Data_New %>%
      mutate(value = ifelse(is.na(value), cell_spec(value, "html", color = "lightgray"), 
                            ifelse((value == "Safe"|value == "None"), cell_spec(value, "html", color  = "green"),
                                   ifelse((value == "Not Safe" |value == "Present") , cell_spec(value, "html", color = "red"), cell_spec(value, "html", color = "orange")))))

return(Melted_Data_New)  
  }

Formatted_Clinical_Labs_Melt_New <- Conditional_Formatting_Kpi_Form(Clinical_Labs_Melt_New)
Formatted_LIS_New <- Conditional_Formatting_Kpi_Form(LIS_Melt_New)

###### --------------- Now decast the melted clinical table --------------- ######

Formatted_Clinical_Labs_Melt_New2 <- dcast(Formatted_Clinical_Labs_Melt_New,  Select.your.branch.facility +IF.chosen..RED.or.YELLOW.for.any.of.the.items.listed.above..please.write.a.brief.note.on.each.event.including.source.of.specimen.and.location.of.incident ~ variable)

#Change the order of the columns in the table

Columns_Order_Form_Clinical <- c("Select.your.branch.facility", "LabCorp...Consumables", "Vendor.Services..LabLogistics..HealthEx..Reference.Labs..Other.Vendors.", "Environment", "Equipment.Issues..Lab.Equipment..Pneumatic.Tube.System..Others.", "IT.Issues", "Service.Changes", "Acute.Volume.Increase", "Staffing.Issues","IF.chosen..RED.or.YELLOW.for.any.of.the.items.listed.above..please.write.a.brief.note.on.each.event.including.source.of.specimen.and.location.of.incident")

Formatted_Clinical_Labs_Melt_New2 <- Formatted_Clinical_Labs_Melt_New2[,Columns_Order_Form_Clinical]

#Change the order of the rows in the table

Rows_Order_Form_Clinical <- factor(rownames(Formatted_Clinical_Labs_Melt_New2),levels = c(11, 4, 3, 9, 10, 1 , 2, 5, 8, 6, 7))
Formatted_Clinical_Labs_Melt_New2 <- Formatted_Clinical_Labs_Melt_New2[Rows_Order_Form_Clinical,]
rownames(Formatted_Clinical_Labs_Melt_New2) <- NULL

#Change the names in the Facility columns to be standardized

rownames(Formatted_Clinical_Labs_Melt_New2) <- c("MSH", "MSQ", "MSBI", "MSB", "MSSL", "MSW", "NYEE", "MSSN", "Anatomic Pathology (Centralized)", "Central Processiong & Accessioning (CPA)", "Client Services - 4LABS")

Formatted_Clinical_Labs_Melt_New2$Select.your.branch.facility <- rownames(Formatted_Clinical_Labs_Melt_New2)
rownames(Formatted_Clinical_Labs_Melt_New2) <- NULL

Formatted_Clinical_Labs_Melt_New3 <- Formatted_Clinical_Labs_Melt_New2[,c(1:9)]

Comments_Clinical_Labs <- Formatted_Clinical_Labs_Melt_New2[,c(1,10)]
Comments_Clinical_Labs[is.na(Comments_Clinical_Labs)] <- "No Issues Reported (Safe)"

###### --------------- now decast the LIS  table --------------- ######
Formatted_LIS_New2 <- dcast(Formatted_LIS_New, Select.your.branch.facility + LIS...Unplanned.Service.Changes + LIS.Preplanned.Downtime...If.Applicable. ~ variable)
Columns_Order_Form_LIS <- c("Select.your.branch.facility","LIS...Staffing.Issues", "LIS...Unplanned.Service.Changes", "LIS.Preplanned.Downtime...If.Applicable.")
Formatted_LIS_New2 <- Formatted_LIS_New2[,Columns_Order_Form_LIS]
rownames(Formatted_LIS_New2) <- NULL
Formatted_LIS_New2[is.na(Formatted_LIS_New2)] <- "None"

###### --------------- Formatting Never Events Table --------------- ######

# added 4 extra columns each one for different never event
Never_Events["Specimen(s) Lost"] <- NA
Never_Events["QNS - specimen that cannot be recollected"] <- NA
Never_Events["Treatment based on mislabeled/misidentified specimen"] <- NA
Never_Events["Treatment based on false positive/false negative results"] <- NA

#because we have multiple never events in one cell i created a list with these by:
Splitting_NE_Text <- sapply(Never_Events$NEVER.EVENTS, strsplit,'[;]')

#created a nested for loop with nested if to determine which of these never events are listed
for (i in 1:nrow(Never_Events)){
  for (j in 1:length(Splitting_NE_Text[[i]])){
    if (Splitting_NE_Text[[i]][j] == colnames(Never_Events)[5]){
      Never_Events$`Specimen(s) Lost`[i] = 1
    } else if (Splitting_NE_Text[[i]][j] == colnames(Never_Events)[6]){
      Never_Events$`QNS - specimen that cannot be recollected`[i] = 1
      } else if (Splitting_NE_Text[[i]][j] == colnames(Never_Events)[7]){
        Never_Events$`Treatment based on mislabeled/misidentified specimen`[i] = 1
        } else if (Splitting_NE_Text[[i]][j] == colnames(Never_Events)[8]){
          Never_Events$`Treatment based on false positive/false negative results`[i] = 1
        }
  }
}

Never_Events$NEVER.EVENTS <- NULL

Never_Events_Melt <- melt(Never_Events, id =c("Select.your.branch.facility", "NEVER.EVENTS..Please.provide.number.of.events.and.write.a.brief.note.on.each.one.including.source.of.specimen.and.location.of.incident..If.Applicable.","X.Good.Catch....Misidentified.mislabeled.specimen.s...Please.provide.number.of.events.that.occurred.in.the.last.24.hours...If.Applicable."))

Never_Events_Melt$value[is.na(Never_Events_Melt$value)] <- "None"
Never_Events_Melt$value[Never_Events_Melt$value == 1] <- "Present"

Formatted_Never_Event_Melt <- Conditional_Formatting_Kpi_Form(Never_Events_Melt)

Formatted_Never_Event <- dcast(Formatted_Never_Event_Melt,Select.your.branch.facility+NEVER.EVENTS..Please.provide.number.of.events.and.write.a.brief.note.on.each.one.including.source.of.specimen.and.location.of.incident..If.Applicable.+ X.Good.Catch....Misidentified.mislabeled.specimen.s...Please.provide.number.of.events.that.occurred.in.the.last.24.hours...If.Applicable. ~ variable)

Never_Events_Column_Order_1 <- c("Select.your.branch.facility", "Specimen(s) Lost", "QNS - specimen that cannot be recollected", "Treatment based on mislabeled/misidentified specimen", "Treatment based on false positive/false negative results", "NEVER.EVENTS..Please.provide.number.of.events.and.write.a.brief.note.on.each.one.including.source.of.specimen.and.location.of.incident..If.Applicable.", "X.Good.Catch....Misidentified.mislabeled.specimen.s...Please.provide.number.of.events.that.occurred.in.the.last.24.hours...If.Applicable.")

Formatted_Never_Event <- Formatted_Never_Event[,Never_Events_Column_Order_1]

#Change the order of the rows in the table

Rows_Order_Never_Events <- factor(rownames(Formatted_Never_Event),levels = c(11, 4, 3, 9, 10, 1 , 2, 5, 8, 6, 7))
Formatted_Never_Event <- Formatted_Never_Event[Rows_Order_Never_Events,]
rownames(Formatted_Never_Event) <- NULL

#Change the names in the Facility columns to be standardized

rownames(Formatted_Never_Event) <- c("MSH", "MSQ", "MSBI", "MSB", "MSSL", "MSW", "NYEE", "MSSN", "Anatomic Pathology (Centralized)", "Central Processiong & Accessioning (CPA)", "Client Services - 4LABS")

Formatted_Never_Event$Select.your.branch.facility <- rownames(Formatted_Never_Event)
rownames(Formatted_Never_Event) <- NULL

#Split the table into three
#table one is the comments only while table two is the details

Good_Catch <- Formatted_Never_Event[,c(1,7)]
Good_Catch[is.na(Good_Catch)] <- 0

#Good_Catch_New <- Good_Catch[which(!(is.na(Good_Catch$X.Good.Catch....Misidentified.mislabeled.specimen.s...Please.provide.number.of.events.that.occurred.in.the.last.24.hours...If.Applicable.))),]

Never_Events_Comments <- Formatted_Never_Event[,c(1,6)]
Never_Events_Comments[is.na(Never_Events_Comments)] <- "No Issues Reported"

Never_Events_Only <- Formatted_Never_Event[,c(1:5)]

```

## **Operational and Quality Indicators** {.tabset}
### Operational Indicators
#### *Operational Indicators for Labs at each Site & Centralized Anatomic Pathology*
```{r Qualitative Indicators for Clinical Labs, echo=FALSE, message=FALSE, warning=FALSE}

Formatted_Clinical_Labs_Melt_New3%>%
    select(everything()) %>%
    kable(escape = F, align = "c", col.names = c("Facility","Lab Corp Consumable", "Vendor Services", "Enviroment", "Equipment", "IT", "Service Change", "Acute Volume Increase", "Staffing")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE, position = "center", row_label_position = "c", font_size = 11) %>%
    row_spec(row = 0, font_size = 13)

Comments_Clinical_Labs %>%
    select(everything()) %>%
    kable(escape = F, align = "c", col.names = c("Facility","Comments if At Risk or Not Safe")) %>%
    kable_styling(bootstrap_options = "hover", full_width = TRUE, position = "center", row_label_position = "c", font_size = 11) %>%
    row_spec(row = 0, font_size = 13)

```


### Laboratory Information System
#### *Operational Indicators for LIS*
```{r Qualitative Indicators for LIS, echo=FALSE, message=FALSE, warning=FALSE}
Formatted_LIS_New2%>%
    select(everything()) %>%
    kable(escape = F, align = "c", col.names = c("","Staffing","Service Change", "Preplanned Downtime")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE, position = "center", row_label_position = "c", font_size = 11) %>%
    row_spec(row = 0, font_size = 13)
```


### Quality Indicators
#### Never Events 
##### *Reported Never Events for Each Division/Facility*
```{r Lab KPI Form for Never Events, echo=FALSE, message=FALSE, warning=FALSE}
Never_Events_Only %>%
    select(everything()) %>%
    kable(escape = F, align = "c", col.names = c("Facility", "Specimen(s) Lost", "QNS - specimen that cannot be recollected", "Treatment based on mislabeled/misidentified specimen", "Treatment based on false positive/false negative results")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE, position = "center", row_label_position = "c", font_size = 11) %>%
    row_spec(row = 0, font_size = 13)

Never_Events_Comments %>%
    select(everything()) %>%
    kable(escape = F, align = "c", col.names = c("Facility", "Comments if There is a Never Event")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE, position = "center", row_label_position = "c", font_size = 11) %>%
    row_spec(row = 0, font_size = 13)
```

#### Good Catches
##### *Reported Good Catches for Each Division/Facility*
```{r Lab KPI Form for Good Catches, echo=FALSE, message=FALSE, warning=FALSE}
Good_Catch %>%
    select(everything()) %>%
    kable(escape = F, align = "c", col.names = c("Facility", "Good Catch Comment")) %>%
    kable_styling(bootstrap_options = "hover", full_width = FALSE, position = "center", row_label_position = "c", font_size = 11) %>%
    row_spec(row = 0, font_size = 13)




#Blood_Bank_Melt$symbol <- icontext(ifelse(Blood_Bank_Melt$value =="Green (No issues)","thumbs-up","thumbs-down"))

#Blood_Bank_Melt$symbol <- formattable(Blood_Bank_Melt, align = c("c","c","c"), list("value" = formatter("span", style = x ~ style(color = ifelse(x =="Green (No issues)","green",ifelse((x == "Yellow (Safe/Under Stress)")| (x=="Yellow (Delays)") | (x== "Yellow (Delays in pickup/delivery)") | (x=="Yellow (Shortage with no/minimal significant impact)") | (x == "Yellow (Minor issues/Coordinating with Reference Labs)"),"orange", "red"))), x ~ icontext(ifelse(x =="Green (No issues)","thumbs-up","thumbs-down")))))

#load.fontawesome()

#create a function for formatting:
#value_col = function(value){
#  case_when(
#    is.na(value) ~ 'white',  
#    value == "Green (No issues)" ~ 'green',
#    value == "Yellow (Safe/Under Stress)" | value == "Yellow (Delays)" | value == "Yellow (Delays in pickup/delivery)" |value == #"Yellow (Shortage with no/minimal significant impact)" | value == "Yellow (Minor issues/Coordinating with Reference Labs)" ~ #'orange',
#    value == "Red (Severe shortage of consumables)" | value == "Red (Missed pickups)" | value == "Red (Not Safe/Risk)" | value == #"Red (Severe shortage that halts activity)" | value == "Red (Major issues/Requires Immediate Attention)" ~ 'red'
#  )
#}

#Clinical_Labs_colored <- Clinical_Labs_Melt %>%
#  mutate(symbol = emoji("heavy_check_mark")) %>%
#  mutate(symbol = cell_spec(symbol,'html', color = value_col(value)))

#Clinical_Labs_colored_new <- dcast(Clinical_Labs_colored , Select.your.branch.facility + Clinical.Pathology.Facility+ IF.chosen..RED.or.YELLOW.for.any.of.the.items.listed.above..please.write.a.brief.note.on.each.event ~ variable, value.var = "symbol")

#Blood_Bank_colored <- Blood_Bank_Melt %>%
#  mutate(symbol = emoji("heavy_check_mark")) %>%
#  mutate(symbol = cell_spec(symbol,'html', color = value_col(value)))
  

#Blood_Bank_colored_new <- dcast(Blood_Bank_Melt , Blood.Banks+ IF.chosen..RED.or.YELLOW.for.any.of.the.items.listed.above..please.write.a.brief.note.on.each.event ~ variable, value.var = "symbol")

```